<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>C.H ç²¾ç·»æ´—è¡£ - ä»˜æ¬¾ç®¡ç†ç³»çµ±</title>
<style>
  :root{
    --bg:#0f1535; --panel:#0d1028; --muted:#95a1c0;
    --brand:#6ea8fe; --brand2:#9b6bff; --ok:#22c55e; --warn:#f59e0b; --danger:#ef4444;
    --card:#141a3a; --card2:#10163a;
  }
  *{box-sizing:border-box}
  body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,'Noto Sans TC',sans-serif;background:radial-gradient(1200px 800px at 10% -10%, #1b2460, transparent), radial-gradient(1000px 800px at 120% 10%, #3a127a, transparent), var(--bg); color:#e7ecff}
  .container{max-width:1100px;margin:28px auto;padding:20px}
  .card{background:linear-gradient(180deg,rgba(255,255,255,.04),transparent),var(--panel);border:1px solid rgba(255,255,255,.06);border-radius:22px;box-shadow:0 20px 60px rgba(0,0,0,.35);padding:22px}
  h1{display:flex;gap:10px;align-items:center;font-size:24px;margin:0 0 14px}
  h1:before{content:"";width:36px;height:24px;background:#ffcc00;border-radius:6px;display:inline-block}
  .tabs{display:flex;gap:10px;flex-wrap:wrap;margin:8px 0 18px;border-bottom:1px solid rgba(255,255,255,.08);padding-bottom:8px}
  .tab{appearance:none;border:none;background:transparent;color:#bcd1ff;font-weight:700;padding:10px 14px;border-radius:10px;cursor:pointer}
  .tab.active,.tab:hover{color:#fff;background:rgba(255,255,255,.06)}
  .grid{display:grid;gap:16px}
  @media (min-width:900px){ .grid-2{grid-template-columns:2fr 1.1fr} }
  label{display:block;margin:12px 0 6px;color:#c9d6ff;font-weight:600}
  input,textarea,select{width:100%;background:var(--card);border:1px solid rgba(255,255,255,.1);color:#f1f5ff;border-radius:12px;padding:12px 14px;font-size:16px;outline:none}
  input:focus,textarea:focus{border-color:#7aa2ff;box-shadow:0 0 0 3px rgba(122,162,255,.15)}
  textarea{min-height:120px;resize:vertical}
  .pay-options{display:grid;gap:14px}
  @media (min-width:700px){.pay-options{grid-template-columns:repeat(3,1fr)}}
  .pay-card{background:linear-gradient(180deg,rgba(255,255,255,.04),transparent),var(--card2);border:1px solid rgba(255,255,255,.08);border-radius:18px; padding:18px; text-align:center; cursor:pointer; transition:.2s}
  .pay-card.active, .pay-card:hover{border-color:#7aa2ff; transform:translateY(-2px)}
  .pay-emoji{font-size:28px;margin-bottom:6px}
  .btn{appearance:none;border:none;border-radius:14px;padding:14px 18px;font-weight:800;cursor:pointer}
  .btn-primary{background:linear-gradient(135deg,var(--brand),var(--brand2));color:white}
  .btn-secondary{background:linear-gradient(135deg,#19c37d,#0ea561);color:white}
  .btn-danger{background:linear-gradient(135deg,#ef4444,#b91c1c);color:white}
  .pill{background:rgba(255,255,255,.08);padding:6px 10px;border-radius:999px;font-size:12px;color:#cdd7ff}
  .row{display:flex;gap:10px;flex-wrap:wrap}
  .right-pane .list{display:grid;gap:10px}
  .item{background:var(--card);border:1px solid rgba(255,255,255,.08);border-radius:14px;padding:12px}
  .item .line{color:var(--muted);font-size:13px}
  .actions{display:flex;gap:8px;margin-top:10px}
  .result{margin-top:14px;padding:14px;border-radius:12px;display:none}
  .result.ok{background:rgba(34,197,94,.14);border:1px solid rgba(34,197,94,.5)}
  .result.err{background:rgba(239,68,68,.14);border:1px solid rgba(239,68,68,.5)}
  .hint{color:var(--muted);font-size:12px}
</style>
</head>
<body>
<div class="container">
  <div class="card">
    <h1>ä»˜æ¬¾ç®¡ç†ç³»çµ±</h1>

    <div class="tabs">
      <button class="tab active" data-tab="payment">ç™¼é€ä»˜æ¬¾</button>
      <button class="tab" data-tab="orders">è¨‚å–®ç®¡ç†</button>
      <button class="tab" data-tab="customers">å®¢æˆ¶ç·¨è™Ÿ</button>
      <button class="tab" data-tab="templates">è¨Šæ¯æ¨¡æ¿</button>
      <span class="pill">æ‰‹æ©Ÿå„ªåŒ– âœ“</span>
    </div>

    <!-- ä»˜æ¬¾é  -->
    <div id="tab-payment" class="grid grid-2">
      <div>
        <div class="item">
          <label>ğŸ” å¿«é€ŸæŸ¥è©¢ï¼ˆè¼¸å…¥ã€Œç·¨è™Ÿã€æˆ–ã€Œå§“åã€ï¼‰</label>
          <div class="row">
            <input id="quickSearch" placeholder="ä¾‹ï¼š625 æˆ– ç‹å°æ˜" />
            <button class="btn pill" onclick="quickSearchCustomer()">æŸ¥è©¢</button>
          </div>
        </div>

        <div class="item">
          <label>å®¢æˆ¶å§“å *</label>
          <input id="userName" placeholder="ç‹å°æ˜" />
          <label>å®¢æˆ¶ LINE User ID *</label>
          <input id="userId" placeholder="Uxxxxxxxxxxxxxxxxxxxx" />
          <label>é‡‘é¡ï¼ˆNT$ï¼‰*</label>
          <input id="amount" type="number" min="1" placeholder="1500" />
        </div>

        <div class="item">
          <label>ä»˜æ¬¾æ–¹å¼ *</label>
          <div class="pay-options">
            <div class="pay-card active" data-val="both" onclick="selectPay(this)"><div class="pay-emoji">ğŸ’™</div>å…©è€…éƒ½ç™¼</div>
            <div class="pay-card" data-val="ecpay" onclick="selectPay(this)"><div class="pay-emoji">ğŸ’³</div>ç¶ ç•Œä¿¡ç”¨å¡</div>
            <div class="pay-card" data-val="linepay" onclick="selectPay(this)"><div class="pay-emoji">ğŸ’š</div>LINE Pay</div>
          </div>
        </div>

        <div class="item">
          <label>è¨Šæ¯å…§å®¹ï¼ˆå¯å« {amount}ï¼‰</label>
          <textarea id="customMessage" placeholder="ä¾‹å¦‚ï¼šæ‚¨å¥½ï¼Œé‡‘é¡ NT$ {amount}ï¼Œè«‹å„˜é€Ÿä»˜æ¬¾ï¼Œè¬è¬ï¼"></textarea>
          <div class="row" style="margin-top:10px;justify-content:space-between;align-items:center">
            <button class="btn btn-primary" onclick="submitPayment()">ç™¼é€ä»˜æ¬¾é€£çµ</button>
            <button class="btn pill" onclick="applyFirstTemplate()">è¼‰å…¥æ¨¡æ¿</button>
          </div>
          <div id="result" class="result"></div>
        </div>
      </div>

      <div class="right-pane">
        <div class="item">
          <div class="row" style="justify-content:space-between; align-items:center">
            <h3 style="margin:0">ğŸ‘¥ å®¢æˆ¶è¼‰å…¥</h3>
            <button class="btn pill" onclick="reloadCustomers()">é‡æ–°è¼‰å…¥</button>
          </div>
          <div id="customerCount" class="hint" style="margin:6px 0">å…± 0 ç­†</div>
          <div id="customerList" class="list"><div class="hint">å°šç„¡å®¢æˆ¶</div></div>
        </div>

        <div class="item">
          <h3 style="margin:0 0 8px">ğŸ“ å¸¸ç”¨æ¨¡æ¿</h3>
          <div id="templateButtons" class="list"></div>
        </div>
      </div>
    </div>

    <!-- å®¢æˆ¶ç·¨è™Ÿ -->
    <div id="tab-customers" style="display:none">
      <div class="grid">
        <div class="item">
          <h3 style="margin-top:0">æ–°å¢ / æ›´æ–° å®¢æˆ¶ç·¨è™Ÿ</h3>
          <label>ç·¨è™Ÿ</label><input id="newCustomerNumber" placeholder="å¦‚ 625" />
          <label>å§“å</label><input id="newCustomerName" placeholder="ç‹å°æ˜" />
          <label>LINE User ID</label><input id="newCustomerUserId" placeholder="Uxxxxxxxxxxxxxxxxxxxx" />
          <div class="row" style="margin-top:10px">
            <button class="btn btn-secondary" onclick="saveCustomerNumber()">å„²å­˜</button>
          </div>
        </div>

        <div class="item">
          <h3 style="margin-top:0">å·²å„²å­˜</h3>
          <div id="savedCustomers" class="list"><div class="hint">å°šç„¡è³‡æ–™</div></div>
        </div>
      </div>
    </div>

    <!-- æ¨¡æ¿ -->
    <div id="tab-templates" style="display:none">
      <div class="grid">
        <div class="item">
          <h3 style="margin-top:0">æ–°å¢æ¨¡æ¿ï¼ˆ{amount} ä»£è¡¨é‡‘é¡ï¼‰</h3>
          <textarea id="newTemplateContent" placeholder="æ‚¨å¥½ï¼Œé‡‘é¡ NT$ {amount}ï¼Œè«‹å„˜é€Ÿä»˜æ¬¾ï¼Œè¬è¬ï¼"></textarea>
          <div class="row" style="margin-top:10px">
            <button class="btn btn-secondary" onclick="saveTemplate()">å„²å­˜æ¨¡æ¿</button>
          </div>
        </div>
        <div class="item">
          <h3 style="margin-top:0">æˆ‘çš„æ¨¡æ¿</h3>
          <div id="templateList" class="list"><div class="hint">å°šç„¡æ¨¡æ¿</div></div>
        </div>
      </div>
    </div>

    <!-- è¨‚å–®ç®¡ç†ï¼ˆä¿ç•™å¤–è§€ï¼Œè³‡æ–™ä»èµ°ä½ å¾Œç«¯çš„ /api/ordersï¼‰ -->
    <div id="tab-orders" style="display:none">
      <div class="row" style="gap:10px;margin-bottom:12px">
        <button class="btn pill" onclick="loadOrders()">é‡æ–°æ•´ç†</button>
        <button class="btn pill" onclick="sendReminders()">ç™¼é€ä»˜æ¬¾æé†’</button>
        <button class="btn pill" onclick="cleanExpired()">æ¸…ç†éæœŸè¨‚å–®</button>
      </div>
      <div id="orderStats" class="row" style="gap:12px; flex-wrap:wrap"></div>
      <div id="orderList" class="list"><div class="hint">å°šæœªè¼‰å…¥è¨‚å–®</div></div>
    </div>
  </div>
</div>

<script>
  // ===== å…±ç”¨ç‹€æ…‹èˆ‡å°å·¥å…· =====
  const API_BASE = location.origin; // åŒç¶²åŸŸæœ€ä¿éšª
  let savedCustomers = {};
  let savedTemplates = [];
  let allOrders = [];

  const getJSON = async (u)=> (await fetch(`${API_BASE}${u}`)).json();
  const postJSON = async (u,b)=> (await fetch(`${API_BASE}${u}`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(b||{})})).json();
  const putJSON  = async (u,b)=> (await fetch(`${API_BASE}${u}`,{method:'PUT', headers:{'Content-Type':'application/json'},body:JSON.stringify(b||{})})).json();
  const delJSON  = async (u)=> (await fetch(`${API_BASE}${u}`,{method:'DELETE'})).json();

  const $ = (id)=>document.getElementById(id);
  function showOk(msg){ const el=$('result'); el.className='result ok'; el.innerHTML=msg; el.style.display='block'; el.scrollIntoView({behavior:'smooth',block:'center'}); }
  function showErr(msg){ const el=$('result'); el.className='result err'; el.innerHTML=msg; el.style.display='block'; el.scrollIntoView({behavior:'smooth',block:'center'}); }

  // ===== åˆ†é  =====
  document.querySelectorAll('.tab').forEach(btn=>{
    btn.addEventListener('click',()=>{
      document.querySelectorAll('.tab').forEach(x=>x.classList.remove('active'));
      btn.classList.add('active');
      const name = btn.dataset.tab;
      ['payment','orders','customers','templates'].forEach(t=> $('tab-'+t).style.display = (t===name?'grid':'none'));
      if(name==='orders') loadOrders();
      if(name==='customers') renderSavedCustomers();
      if(name==='templates') renderTemplates();
    });
  });

  // ===== æ”¯ä»˜æ–¹å¼é¸æ“‡ =====
  function selectPay(el){
    document.querySelectorAll('.pay-card').forEach(x=>x.classList.remove('active'));
    el.classList.add('active');
  }
  function getSelectedPay(){
    const el = document.querySelector('.pay-card.active');
    return el ? el.dataset.val : 'both';
  }

  // ===== æ¨¡æ¿ï¼šå„ªå…ˆå¾Œç«¯ï¼ŒåŒæ­¥ localStorage =====
  async function fetchTemplates(){
    try{
      const d = await getJSON('/api/templates');
      if(d.success && Array.isArray(d.templates)){
        savedTemplates = d.templates;
        localStorage.setItem('messageTemplates', JSON.stringify(savedTemplates));
        renderTemplateButtons();
      }
    }catch{}
    if(!savedTemplates || !savedTemplates.length){
      savedTemplates = JSON.parse(localStorage.getItem('messageTemplates')||'[]');
    }
    renderTemplateButtons();
  }
  function renderTemplateButtons(){
    const list = $('templateButtons');
    list.innerHTML = (savedTemplates||[]).map((t,i)=>`
      <button class="btn pill" style="text-align:left" onclick="applyTemplate(${i})">${(t.length>26?t.slice(0,26)+'â€¦':t)}</button>
    `).join('') || '<div class="hint">å°šç„¡æ¨¡æ¿</div>';
  }
  function applyTemplate(i){ const t=savedTemplates[i]||''; $('customMessage').value=t; }
  function applyFirstTemplate(){ if(savedTemplates.length) $('customMessage').value = savedTemplates[0]; }
  async function saveTemplate(){
    const t = $('newTemplateContent').value.trim();
    if(!t) return alert('è«‹è¼¸å…¥æ¨¡æ¿å…§å®¹');
    const d = await postJSON('/api/templates', {content:t});
    if(d.success){ savedTemplates=d.templates; localStorage.setItem('messageTemplates', JSON.stringify(savedTemplates)); $('newTemplateContent').value=''; renderTemplates(); renderTemplateButtons(); showOk('âœ… å·²æ–°å¢æ¨¡æ¿'); }
    else showErr(d.error||'æ–°å¢å¤±æ•—');
  }
  async function editTemplate(i){
    const nv = prompt('ä¿®æ”¹æ¨¡æ¿å…§å®¹ï¼š', savedTemplates[i]||'');
    if(nv===null) return;
    const d = await putJSON(`/api/templates/${i}`, {content:nv});
    if(d.success){ savedTemplates=d.templates; localStorage.setItem('messageTemplates', JSON.stringify(savedTemplates)); renderTemplates(); renderTemplateButtons(); }
    else showErr(d.error||'æ›´æ–°å¤±æ•—');
  }
  async function deleteTemplate(i){
    if(!confirm('ç¢ºå®šåˆªé™¤æ­¤æ¨¡æ¿ï¼Ÿ')) return;
    const d = await delJSON(`/api/templates/${i}`);
    if(d.success){ savedTemplates=d.templates; localStorage.setItem('messageTemplates', JSON.stringify(savedTemplates)); renderTemplates(); renderTemplateButtons(); }
    else showErr(d.error||'åˆªé™¤å¤±æ•—');
  }
  function renderTemplates(){
    const wrap=$('templateList');
    if(!savedTemplates.length){ wrap.innerHTML='<div class="hint">å°šç„¡æ¨¡æ¿</div>'; return; }
    wrap.innerHTML = savedTemplates.map((t,i)=>`
      <div class="item">
        <div style="white-space:pre-wrap">${t}</div>
        <div class="actions">
          <button class="btn pill" onclick="editTemplate(${i})">ç·¨è¼¯</button>
          <button class="btn btn-danger" onclick="deleteTemplate(${i})">åˆªé™¤</button>
        </div>
      </div>
    `).join('');
  }

  // ===== å®¢æˆ¶ç·¨è™Ÿï¼šå„ªå…ˆå¾Œç«¯ï¼ŒåŒæ­¥ localStorage =====
  async function fetchCustomerMeta(){
    try{
      const d = await getJSON('/api/customer-meta');
      if(d.success && d.map){
        savedCustomers = d.map;
        localStorage.setItem('customerNumbers', JSON.stringify(savedCustomers));
      }
    }catch{}
    if(!savedCustomers || !Object.keys(savedCustomers).length){
      savedCustomers = JSON.parse(localStorage.getItem('customerNumbers')||'{}');
    }
    renderSavedCustomers();
    renderCustomerList();
  }
  async function saveCustomerNumber(){
    const no = $('newCustomerNumber').value.trim();
    const name = $('newCustomerName').value.trim();
    const userId = $('newCustomerUserId').value.trim();
    if(!name || !userId) return alert('è«‹å®Œæ•´è¼¸å…¥ å§“å / User ID');
    const d = await postJSON('/api/customer-meta/save', {number:no?Number(no):undefined, name, userId});
    if(d.success){
      savedCustomers[d.number] = d.data;
      localStorage.setItem('customerNumbers', JSON.stringify(savedCustomers));
      $('newCustomerNumber').value=''; $('newCustomerName').value=''; $('newCustomerUserId').value='';
      renderSavedCustomers(); renderCustomerList();
      showOk('âœ… å·²å„²å­˜å®¢æˆ¶ç·¨è™Ÿ');
    }else showErr(d.error||'å„²å­˜å¤±æ•—');
  }
  async function removeSavedCustomer(no){
    if(!confirm(`åˆªé™¤ç·¨è™Ÿ #${no} ?`)) return;
    const d = await delJSON(`/api/customer-meta/${no}`);
    if(d.success){ delete savedCustomers[no]; localStorage.setItem('customerNumbers', JSON.stringify(savedCustomers)); renderSavedCustomers(); renderCustomerList(); }
    else showErr(d.error||'åˆªé™¤å¤±æ•—');
  }
  function renderSavedCustomers(){
    const wrap = $('savedCustomers');
    const rows = Object.entries(savedCustomers||{});
    if(!rows.length){ wrap.innerHTML='<div class="hint">å°šç„¡è³‡æ–™</div>'; return; }
    wrap.innerHTML = rows.map(([no,c])=>`
      <div class="item">
        <div><strong>#${no}</strong>ã€€${c.name||'-'}</div>
        <div class="line">User IDï¼š${c.userId||'-'}</div>
        <div class="actions">
          <button class="btn pill" onclick="prefill('${c.userId||''}','${c.name||''}')">å¸¶å…¥ä»˜æ¬¾</button>
          <button class="btn btn-danger" onclick="removeSavedCustomer('${no}')">åˆªé™¤</button>
        </div>
      </div>
    `).join('');
  }

  // å³å´å®¢æˆ¶è¼‰å…¥ï¼ˆåŒä¸€ä»½è³‡æ–™ï¼‰
  function renderCustomerList(){
    const list=$('customerList');
    const rows = Object.entries(savedCustomers||{});
    $('customerCount').innerText = `å…± ${rows.length} ç­†`;
    if(!rows.length){ list.innerHTML='<div class="hint">å°šç„¡å®¢æˆ¶</div>'; return; }
    list.innerHTML = rows.map(([no,c])=>`
      <div class="item">
        <div><strong>${c.name||'-'}</strong>ã€€<span class="pill">#${no}</span></div>
        <div class="line">User IDï¼š${c.userId||'-'}</div>
        <div class="actions">
          <button class="btn pill" onclick="prefill('${c.userId||''}','${c.name||''}')">å¸¶å…¥</button>
          <button class="btn btn-danger" onclick="removeSavedCustomer('${no}')">åˆªé™¤</button>
        </div>
      </div>
    `).join('');
  }
  function prefill(uid,name){ $('userId').value=uid||''; $('userName').value=name||''; }

  // å¿«é€ŸæŸ¥è©¢
  function quickSearchCustomer(){
    const q = $('quickSearch').value.trim();
    if(!q){ alert('è«‹è¼¸å…¥ç·¨è™Ÿæˆ–å§“å'); return; }
    if(savedCustomers[q]){ const c=savedCustomers[q]; prefill(c.userId,c.name); return; }
    const found = Object.entries(savedCustomers).find(([no,c])=> (c.name||'').includes(q));
    if(found){ const [no,c]=found; prefill(c.userId,c.name); return; }
    alert('æ‰¾ä¸åˆ°æ­¤å®¢æˆ¶');
  }
  function reloadCustomers(){ fetchCustomerMeta(); }

  // ===== é€ä»˜æ¬¾ï¼ˆæ”¹ç‚º /send-paymentï¼Œä¸¦é€ Flex è¨Šæ¯ï¼‰ =====
  async function submitPayment(){
    const userId = $('userId').value.trim();
    const userName = $('userName').value.trim();
    const amount = parseInt($('amount').value,10);
    const paymentType = getSelectedPay(); // both / ecpay / linepay
    const customMessage = ($('customMessage').value||'').trim().replace('{amount}', (amount||0).toLocaleString());
    if(!userId || !userName || !amount){ showErr('è«‹å¡«å¯«æ‰€æœ‰å¿…å¡«æ¬„ä½'); return; }
    $('result').style.display='none';
    try{
      const r = await fetch('/send-payment', { // << é‡è¦ï¼šæ­£ç¢ºè·¯å¾‘
        method:'POST', headers:{'Content-Type':'application/json'},
        body: JSON.stringify({userId, userName, amount, paymentType, customMessage})
      });
      const d = await r.json().catch(()=>({success:false,error:'å¾Œç«¯æœªå›å‚³ JSON'}));
      if(d.success){ showOk('âœ… ä»˜æ¬¾é€£çµå·²ç™¼é€'); $('customMessage').value=''; }
      else showErr(JSON.stringify(d));
    }catch(e){ showErr('é€£ç·šå¤±æ•—ï¼š'+e.message); }
  }

  // ===== è¨‚å–®ç®¡ç†ï¼ˆæ²¿ç”¨ä½ çš„ APIï¼‰ =====
  async function loadOrders(){
    const box=$('orderList'); box.innerHTML='<div class="hint">è¼‰å…¥ä¸­...</div>';
    try{
      const d = await getJSON('/api/orders');
      if(!d.success) throw new Error(d.error||'è¼‰å…¥å¤±æ•—');
      allOrders = d.orders||[];
      const s = d.statistics||{total:0,pending:0,paid:0,expired:0,needReminder:0};
      $('orderStats').innerHTML = `
        <span class="pill">ç¸½æ•¸ ${s.total}</span>
        <span class="pill">å¾…ä»˜ ${s.pending}</span>
        <span class="pill">å·²ä»˜ ${s.paid}</span>
        <span class="pill">éæœŸ ${s.expired}</span>
        <span class="pill">éœ€æé†’ ${s.needReminder}</span>`;
      box.innerHTML = (allOrders||[]).map(o=>`
        <div class="item">
          <div class="row" style="justify-content:space-between">
            <div><strong>${o.userName||'-'}</strong>ã€€<span class="pill">${o.status==='paid'?'å·²ä»˜æ¬¾':(o.isExpired?'å·²éæœŸ':`å‰© ${o.remainingHours||'-'} å°æ™‚`)}</span></div>
            <div style="font-weight:800">NT$ ${(o.amount||0).toLocaleString()}</div>
          </div>
          <div class="line">è¨‚å–®ï¼š${o.orderId||'-'}</div>
          <div class="actions">
            ${o.isExpired? `<button class="btn pill" onclick="renewOrder('${o.orderId}')">çºŒç´„é‡ç™¼</button>` : `<button class="btn pill" onclick="sendSingleReminder('${o.orderId}')">æé†’</button>`}
            <button class="btn btn-danger" onclick="deleteOrder('${o.orderId}')">åˆªé™¤</button>
          </div>
        </div>
      `).join('') || '<div class="hint">å°šç„¡è¨‚å–®è¨˜éŒ„</div>';
    }catch(e){ box.innerHTML='<div class="hint">è¼‰å…¥å¤±æ•—ï¼š'+e.message+'</div>'; }
  }
  async function sendReminders(){ const d=await postJSON('/api/orders/send-reminders',{}); if(d.success){ showOk(d.message||'å·²ç™¼é€'); loadOrders(); } else showErr(d.error||'ç™¼é€å¤±æ•—'); }
  async function cleanExpired(){ const d=await postJSON('/api/orders/clean-expired',{}); if(d.success){ showOk(d.message||'å·²æ¸…ç†'); loadOrders(); } else showErr(d.error||'æ¸…ç†å¤±æ•—'); }
  async function renewOrder(id){ const d=await postJSON(`/api/order/${id}/renew`,{}); if(d.success){ showOk('å·²çºŒç´„ä¸¦é‡ç™¼'); loadOrders(); } else showErr(d.error||'çºŒç´„å¤±æ•—'); }
  async function deleteOrder(id){ if(!confirm('ç¢ºå®šåˆªé™¤æ­¤è¨‚å–®ï¼Ÿ')) return; const d=await delJSON(`/api/order/${id}`); if(d.success){ loadOrders(); } else showErr(d.error||'åˆªé™¤å¤±æ•—'); }

  // ===== å•Ÿå‹•ï¼šå…ˆæ‹‰è³‡æ–™å†ç•«é¢ =====
  document.addEventListener('DOMContentLoaded', ()=>{
    fetchTemplates();
    fetchCustomerMeta();
  });
</script>
</body>
</html>