<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>C.H 精緻洗衣 - 付款管理系統</title>
<style>
  :root{
    --bg:#0f1535; --panel:#0d1028; --muted:#95a1c0;
    --brand:#6ea8fe; --brand2:#9b6bff; --ok:#22c55e; --warn:#f59e0b; --danger:#ef4444;
    --card:#141a3a; --card2:#10163a;
  }
  *{box-sizing:border-box}
  body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,'Noto Sans TC',sans-serif;background:radial-gradient(1200px 800px at 10% -10%, #1b2460, transparent), radial-gradient(1000px 800px at 120% 10%, #3a127a, transparent), var(--bg); color:#e7ecff}
  .container{max-width:1100px;margin:28px auto;padding:20px}
  .card{background:linear-gradient(180deg,rgba(255,255,255,.04),transparent),var(--panel);border:1px solid rgba(255,255,255,.06);border-radius:22px;box-shadow:0 20px 60px rgba(0,0,0,.35);padding:22px}
  h1{display:flex;gap:10px;align-items:center;font-size:24px;margin:0 0 14px}
  h1:before{content:"";width:36px;height:24px;background:#ffcc00;border-radius:6px;display:inline-block}
  .tabs{display:flex;gap:10px;flex-wrap:wrap;margin:8px 0 18px;border-bottom:1px solid rgba(255,255,255,.08);padding-bottom:8px}
  .tab{appearance:none;border:none;background:transparent;color:#bcd1ff;font-weight:700;padding:10px 14px;border-radius:10px;cursor:pointer}
  .tab.active,.tab:hover{color:#fff;background:rgba(255,255,255,.06)}
  .grid{display:grid;gap:16px}
  @media (min-width:900px){ .grid-2{grid-template-columns:2fr 1.1fr} }
  label{display:block;margin:12px 0 6px;color:#c9d6ff;font-weight:600}
  input,textarea,select{width:100%;background:var(--card);border:1px solid rgba(255,255,255,.1);color:#f1f5ff;border-radius:12px;padding:12px 14px;font-size:16px;outline:none}
  input:focus,textarea:focus{border-color:#7aa2ff;box-shadow:0 0 0 3px rgba(122,162,255,.15)}
  textarea{min-height:120px;resize:vertical}
  .pay-options{display:grid;gap:14px}
  @media (min-width:700px){.pay-options{grid-template-columns:repeat(3,1fr)}}
  .pay-card{background:linear-gradient(180deg,rgba(255,255,255,.04),transparent),var(--card2);border:1px solid rgba(255,255,255,.08);border-radius:18px; padding:18px; text-align:center; cursor:pointer; transition:.2s}
  .pay-card.active, .pay-card:hover{border-color:#7aa2ff; transform:translateY(-2px)}
  .pay-emoji{font-size:28px;margin-bottom:6px}
  .btn{appearance:none;border:none;border-radius:14px;padding:14px 18px;font-weight:800;cursor:pointer}
  .btn-primary{background:linear-gradient(135deg,var(--brand),var(--brand2));color:white}
  .btn-secondary{background:linear-gradient(135deg,#19c37d,#0ea561);color:white}
  .btn-danger{background:linear-gradient(135deg,#ef4444,#b91c1c);color:white}
  .pill{background:rgba(255,255,255,.08);padding:6px 10px;border-radius:999px;font-size:12px;color:#cdd7ff}
  .row{display:flex;gap:10px;flex-wrap:wrap}
  .right-pane .list{display:grid;gap:10px}
  .item{background:var(--card);border:1px solid rgba(255,255,255,.08);border-radius:14px;padding:12px}
  .item .line{color:var(--muted);font-size:13px}
  .actions{display:flex;gap:8px;margin-top:10px}
  .result{margin-top:14px;padding:14px;border-radius:12px;display:none}
  .result.ok{background:rgba(34,197,94,.14);border:1px solid rgba(34,197,94,.5)}
  .result.err{background:rgba(239,68,68,.14);border:1px solid rgba(239,68,68,.5)}
  .hint{color:var(--muted);font-size:12px}
</style>
</head>
<body>
<div class="container">
  <div class="card">
    <h1>付款管理系統</h1>

    <div class="tabs">
      <button class="tab active" data-tab="payment">發送付款</button>
      <button class="tab" data-tab="orders">訂單管理</button>
      <button class="tab" data-tab="customers">客戶編號</button>
      <button class="tab" data-tab="templates">訊息模板</button>
      <span class="pill">手機優化 ✓</span>
    </div>

    <!-- 付款頁 -->
    <div id="tab-payment" class="grid grid-2">
      <div>
        <div class="item">
          <label>🔎 快速查詢（輸入「編號」或「姓名」）</label>
          <div class="row">
            <input id="quickSearch" placeholder="例：625 或 王小明" />
            <button class="btn pill" onclick="quickSearchCustomer()">查詢</button>
          </div>
        </div>

        <div class="item">
          <label>客戶姓名 *</label>
          <input id="userName" placeholder="王小明" />
          <label>客戶 LINE User ID *</label>
          <input id="userId" placeholder="Uxxxxxxxxxxxxxxxxxxxx" />
          <label>金額（NT$）*</label>
          <input id="amount" type="number" min="1" placeholder="1500" />
        </div>

        <div class="item">
          <label>付款方式 *</label>
          <div class="pay-options">
            <div class="pay-card active" data-val="both" onclick="selectPay(this)"><div class="pay-emoji">💙</div>兩者都發</div>
            <div class="pay-card" data-val="ecpay" onclick="selectPay(this)"><div class="pay-emoji">💳</div>綠界信用卡</div>
            <div class="pay-card" data-val="linepay" onclick="selectPay(this)"><div class="pay-emoji">💚</div>LINE Pay</div>
          </div>
        </div>

        <div class="item">
          <label>訊息內容（可含 {amount}）</label>
          <textarea id="customMessage" placeholder="例如：您好，金額 NT$ {amount}，請儘速付款，謝謝！"></textarea>
          <div class="row" style="margin-top:10px;justify-content:space-between;align-items:center">
            <button class="btn btn-primary" onclick="submitPayment()">發送付款連結</button>
            <button class="btn pill" onclick="applyFirstTemplate()">載入模板</button>
          </div>
          <div id="result" class="result"></div>
        </div>
      </div>

      <div class="right-pane">
        <div class="item">
          <div class="row" style="justify-content:space-between; align-items:center">
            <h3 style="margin:0">👥 客戶載入</h3>
            <button class="btn pill" onclick="reloadCustomers()">重新載入</button>
          </div>
          <div id="customerCount" class="hint" style="margin:6px 0">共 0 筆</div>
          <div id="customerList" class="list"><div class="hint">尚無客戶</div></div>
        </div>

        <div class="item">
          <h3 style="margin:0 0 8px">📝 常用模板</h3>
          <div id="templateButtons" class="list"></div>
        </div>
      </div>
    </div>

    <!-- 客戶編號 -->
    <div id="tab-customers" style="display:none">
      <div class="grid">
        <div class="item">
          <h3 style="margin-top:0">新增 / 更新 客戶編號</h3>
          <label>編號</label><input id="newCustomerNumber" placeholder="如 625" />
          <label>姓名</label><input id="newCustomerName" placeholder="王小明" />
          <label>LINE User ID</label><input id="newCustomerUserId" placeholder="Uxxxxxxxxxxxxxxxxxxxx" />
          <div class="row" style="margin-top:10px">
            <button class="btn btn-secondary" onclick="saveCustomerNumber()">儲存</button>
          </div>
        </div>

        <div class="item">
          <h3 style="margin-top:0">已儲存</h3>
          <div id="savedCustomers" class="list"><div class="hint">尚無資料</div></div>
        </div>
      </div>
    </div>

    <!-- 模板 -->
    <div id="tab-templates" style="display:none">
      <div class="grid">
        <div class="item">
          <h3 style="margin-top:0">新增模板（{amount} 代表金額）</h3>
          <textarea id="newTemplateContent" placeholder="您好，金額 NT$ {amount}，請儘速付款，謝謝！"></textarea>
          <div class="row" style="margin-top:10px">
            <button class="btn btn-secondary" onclick="saveTemplate()">儲存模板</button>
          </div>
        </div>
        <div class="item">
          <h3 style="margin-top:0">我的模板</h3>
          <div id="templateList" class="list"><div class="hint">尚無模板</div></div>
        </div>
      </div>
    </div>

    <!-- 訂單管理（保留外觀，資料仍走你後端的 /api/orders） -->
    <div id="tab-orders" style="display:none">
      <div class="row" style="gap:10px;margin-bottom:12px">
        <button class="btn pill" onclick="loadOrders()">重新整理</button>
        <button class="btn pill" onclick="sendReminders()">發送付款提醒</button>
        <button class="btn pill" onclick="cleanExpired()">清理過期訂單</button>
      </div>
      <div id="orderStats" class="row" style="gap:12px; flex-wrap:wrap"></div>
      <div id="orderList" class="list"><div class="hint">尚未載入訂單</div></div>
    </div>
  </div>
</div>

<script>
  // ===== 共用狀態與小工具 =====
  const API_BASE = location.origin; // 同網域最保險
  let savedCustomers = {};
  let savedTemplates = [];
  let allOrders = [];

  const getJSON = async (u)=> (await fetch(`${API_BASE}${u}`)).json();
  const postJSON = async (u,b)=> (await fetch(`${API_BASE}${u}`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(b||{})})).json();
  const putJSON  = async (u,b)=> (await fetch(`${API_BASE}${u}`,{method:'PUT', headers:{'Content-Type':'application/json'},body:JSON.stringify(b||{})})).json();
  const delJSON  = async (u)=> (await fetch(`${API_BASE}${u}`,{method:'DELETE'})).json();

  const $ = (id)=>document.getElementById(id);
  function showOk(msg){ const el=$('result'); el.className='result ok'; el.innerHTML=msg; el.style.display='block'; el.scrollIntoView({behavior:'smooth',block:'center'}); }
  function showErr(msg){ const el=$('result'); el.className='result err'; el.innerHTML=msg; el.style.display='block'; el.scrollIntoView({behavior:'smooth',block:'center'}); }

  // ===== 分頁 =====
  document.querySelectorAll('.tab').forEach(btn=>{
    btn.addEventListener('click',()=>{
      document.querySelectorAll('.tab').forEach(x=>x.classList.remove('active'));
      btn.classList.add('active');
      const name = btn.dataset.tab;
      ['payment','orders','customers','templates'].forEach(t=> $('tab-'+t).style.display = (t===name?'grid':'none'));
      if(name==='orders') loadOrders();
      if(name==='customers') renderSavedCustomers();
      if(name==='templates') renderTemplates();
    });
  });

  // ===== 支付方式選擇 =====
  function selectPay(el){
    document.querySelectorAll('.pay-card').forEach(x=>x.classList.remove('active'));
    el.classList.add('active');
  }
  function getSelectedPay(){
    const el = document.querySelector('.pay-card.active');
    return el ? el.dataset.val : 'both';
  }

  // ===== 模板：優先後端，同步 localStorage =====
  async function fetchTemplates(){
    try{
      const d = await getJSON('/api/templates');
      if(d.success && Array.isArray(d.templates)){
        savedTemplates = d.templates;
        localStorage.setItem('messageTemplates', JSON.stringify(savedTemplates));
        renderTemplateButtons();
      }
    }catch{}
    if(!savedTemplates || !savedTemplates.length){
      savedTemplates = JSON.parse(localStorage.getItem('messageTemplates')||'[]');
    }
    renderTemplateButtons();
  }
  function renderTemplateButtons(){
    const list = $('templateButtons');
    list.innerHTML = (savedTemplates||[]).map((t,i)=>`
      <button class="btn pill" style="text-align:left" onclick="applyTemplate(${i})">${(t.length>26?t.slice(0,26)+'…':t)}</button>
    `).join('') || '<div class="hint">尚無模板</div>';
  }
  function applyTemplate(i){ const t=savedTemplates[i]||''; $('customMessage').value=t; }
  function applyFirstTemplate(){ if(savedTemplates.length) $('customMessage').value = savedTemplates[0]; }
  async function saveTemplate(){
    const t = $('newTemplateContent').value.trim();
    if(!t) return alert('請輸入模板內容');
    const d = await postJSON('/api/templates', {content:t});
    if(d.success){ savedTemplates=d.templates; localStorage.setItem('messageTemplates', JSON.stringify(savedTemplates)); $('newTemplateContent').value=''; renderTemplates(); renderTemplateButtons(); showOk('✅ 已新增模板'); }
    else showErr(d.error||'新增失敗');
  }
  async function editTemplate(i){
    const nv = prompt('修改模板內容：', savedTemplates[i]||'');
    if(nv===null) return;
    const d = await putJSON(`/api/templates/${i}`, {content:nv});
    if(d.success){ savedTemplates=d.templates; localStorage.setItem('messageTemplates', JSON.stringify(savedTemplates)); renderTemplates(); renderTemplateButtons(); }
    else showErr(d.error||'更新失敗');
  }
  async function deleteTemplate(i){
    if(!confirm('確定刪除此模板？')) return;
    const d = await delJSON(`/api/templates/${i}`);
    if(d.success){ savedTemplates=d.templates; localStorage.setItem('messageTemplates', JSON.stringify(savedTemplates)); renderTemplates(); renderTemplateButtons(); }
    else showErr(d.error||'刪除失敗');
  }
  function renderTemplates(){
    const wrap=$('templateList');
    if(!savedTemplates.length){ wrap.innerHTML='<div class="hint">尚無模板</div>'; return; }
    wrap.innerHTML = savedTemplates.map((t,i)=>`
      <div class="item">
        <div style="white-space:pre-wrap">${t}</div>
        <div class="actions">
          <button class="btn pill" onclick="editTemplate(${i})">編輯</button>
          <button class="btn btn-danger" onclick="deleteTemplate(${i})">刪除</button>
        </div>
      </div>
    `).join('');
  }

  // ===== 客戶編號：優先後端，同步 localStorage =====
  async function fetchCustomerMeta(){
    try{
      const d = await getJSON('/api/customer-meta');
      if(d.success && d.map){
        savedCustomers = d.map;
        localStorage.setItem('customerNumbers', JSON.stringify(savedCustomers));
      }
    }catch{}
    if(!savedCustomers || !Object.keys(savedCustomers).length){
      savedCustomers = JSON.parse(localStorage.getItem('customerNumbers')||'{}');
    }
    renderSavedCustomers();
    renderCustomerList();
  }
  async function saveCustomerNumber(){
    const no = $('newCustomerNumber').value.trim();
    const name = $('newCustomerName').value.trim();
    const userId = $('newCustomerUserId').value.trim();
    if(!name || !userId) return alert('請完整輸入 姓名 / User ID');
    const d = await postJSON('/api/customer-meta/save', {number:no?Number(no):undefined, name, userId});
    if(d.success){
      savedCustomers[d.number] = d.data;
      localStorage.setItem('customerNumbers', JSON.stringify(savedCustomers));
      $('newCustomerNumber').value=''; $('newCustomerName').value=''; $('newCustomerUserId').value='';
      renderSavedCustomers(); renderCustomerList();
      showOk('✅ 已儲存客戶編號');
    }else showErr(d.error||'儲存失敗');
  }
  async function removeSavedCustomer(no){
    if(!confirm(`刪除編號 #${no} ?`)) return;
    const d = await delJSON(`/api/customer-meta/${no}`);
    if(d.success){ delete savedCustomers[no]; localStorage.setItem('customerNumbers', JSON.stringify(savedCustomers)); renderSavedCustomers(); renderCustomerList(); }
    else showErr(d.error||'刪除失敗');
  }
  function renderSavedCustomers(){
    const wrap = $('savedCustomers');
    const rows = Object.entries(savedCustomers||{});
    if(!rows.length){ wrap.innerHTML='<div class="hint">尚無資料</div>'; return; }
    wrap.innerHTML = rows.map(([no,c])=>`
      <div class="item">
        <div><strong>#${no}</strong>　${c.name||'-'}</div>
        <div class="line">User ID：${c.userId||'-'}</div>
        <div class="actions">
          <button class="btn pill" onclick="prefill('${c.userId||''}','${c.name||''}')">帶入付款</button>
          <button class="btn btn-danger" onclick="removeSavedCustomer('${no}')">刪除</button>
        </div>
      </div>
    `).join('');
  }

  // 右側客戶載入（同一份資料）
  function renderCustomerList(){
    const list=$('customerList');
    const rows = Object.entries(savedCustomers||{});
    $('customerCount').innerText = `共 ${rows.length} 筆`;
    if(!rows.length){ list.innerHTML='<div class="hint">尚無客戶</div>'; return; }
    list.innerHTML = rows.map(([no,c])=>`
      <div class="item">
        <div><strong>${c.name||'-'}</strong>　<span class="pill">#${no}</span></div>
        <div class="line">User ID：${c.userId||'-'}</div>
        <div class="actions">
          <button class="btn pill" onclick="prefill('${c.userId||''}','${c.name||''}')">帶入</button>
          <button class="btn btn-danger" onclick="removeSavedCustomer('${no}')">刪除</button>
        </div>
      </div>
    `).join('');
  }
  function prefill(uid,name){ $('userId').value=uid||''; $('userName').value=name||''; }

  // 快速查詢
  function quickSearchCustomer(){
    const q = $('quickSearch').value.trim();
    if(!q){ alert('請輸入編號或姓名'); return; }
    if(savedCustomers[q]){ const c=savedCustomers[q]; prefill(c.userId,c.name); return; }
    const found = Object.entries(savedCustomers).find(([no,c])=> (c.name||'').includes(q));
    if(found){ const [no,c]=found; prefill(c.userId,c.name); return; }
    alert('找不到此客戶');
  }
  function reloadCustomers(){ fetchCustomerMeta(); }

  // ===== 送付款（改為 /send-payment，並送 Flex 訊息） =====
  async function submitPayment(){
    const userId = $('userId').value.trim();
    const userName = $('userName').value.trim();
    const amount = parseInt($('amount').value,10);
    const paymentType = getSelectedPay(); // both / ecpay / linepay
    const customMessage = ($('customMessage').value||'').trim().replace('{amount}', (amount||0).toLocaleString());
    if(!userId || !userName || !amount){ showErr('請填寫所有必填欄位'); return; }
    $('result').style.display='none';
    try{
      const r = await fetch('/send-payment', { // << 重要：正確路徑
        method:'POST', headers:{'Content-Type':'application/json'},
        body: JSON.stringify({userId, userName, amount, paymentType, customMessage})
      });
      const d = await r.json().catch(()=>({success:false,error:'後端未回傳 JSON'}));
      if(d.success){ showOk('✅ 付款連結已發送'); $('customMessage').value=''; }
      else showErr(JSON.stringify(d));
    }catch(e){ showErr('連線失敗：'+e.message); }
  }

  // ===== 訂單管理（沿用你的 API） =====
  async function loadOrders(){
    const box=$('orderList'); box.innerHTML='<div class="hint">載入中...</div>';
    try{
      const d = await getJSON('/api/orders');
      if(!d.success) throw new Error(d.error||'載入失敗');
      allOrders = d.orders||[];
      const s = d.statistics||{total:0,pending:0,paid:0,expired:0,needReminder:0};
      $('orderStats').innerHTML = `
        <span class="pill">總數 ${s.total}</span>
        <span class="pill">待付 ${s.pending}</span>
        <span class="pill">已付 ${s.paid}</span>
        <span class="pill">過期 ${s.expired}</span>
        <span class="pill">需提醒 ${s.needReminder}</span>`;
      box.innerHTML = (allOrders||[]).map(o=>`
        <div class="item">
          <div class="row" style="justify-content:space-between">
            <div><strong>${o.userName||'-'}</strong>　<span class="pill">${o.status==='paid'?'已付款':(o.isExpired?'已過期':`剩 ${o.remainingHours||'-'} 小時`)}</span></div>
            <div style="font-weight:800">NT$ ${(o.amount||0).toLocaleString()}</div>
          </div>
          <div class="line">訂單：${o.orderId||'-'}</div>
          <div class="actions">
            ${o.isExpired? `<button class="btn pill" onclick="renewOrder('${o.orderId}')">續約重發</button>` : `<button class="btn pill" onclick="sendSingleReminder('${o.orderId}')">提醒</button>`}
            <button class="btn btn-danger" onclick="deleteOrder('${o.orderId}')">刪除</button>
          </div>
        </div>
      `).join('') || '<div class="hint">尚無訂單記錄</div>';
    }catch(e){ box.innerHTML='<div class="hint">載入失敗：'+e.message+'</div>'; }
  }
  async function sendReminders(){ const d=await postJSON('/api/orders/send-reminders',{}); if(d.success){ showOk(d.message||'已發送'); loadOrders(); } else showErr(d.error||'發送失敗'); }
  async function cleanExpired(){ const d=await postJSON('/api/orders/clean-expired',{}); if(d.success){ showOk(d.message||'已清理'); loadOrders(); } else showErr(d.error||'清理失敗'); }
  async function renewOrder(id){ const d=await postJSON(`/api/order/${id}/renew`,{}); if(d.success){ showOk('已續約並重發'); loadOrders(); } else showErr(d.error||'續約失敗'); }
  async function deleteOrder(id){ if(!confirm('確定刪除此訂單？')) return; const d=await delJSON(`/api/order/${id}`); if(d.success){ loadOrders(); } else showErr(d.error||'刪除失敗'); }

  // ===== 啟動：先拉資料再畫面 =====
  document.addEventListener('DOMContentLoaded', ()=>{
    fetchTemplates();
    fetchCustomerMeta();
  });
</script>
</body>
</html>