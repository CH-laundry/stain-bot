<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>付款管理系統</title>
  <style>
    :root{
      --bg:#0f172a; --panel:#111827; --panel2:#0b1220; --text:#e5e7eb;
      --muted:#94a3b8; --primary:#60a5fa; --ok:#22c55e; --warn:#f59e0b; --err:#ef4444;
      --card:#1f2937; --chip:#0ea5e9;
    }
    *{box-sizing:border-box}
    body{margin:0;background:radial-gradient(1200px 800px at 20% -20%,#1e3a8a11,transparent),linear-gradient(180deg,#0b1220,#0f172a);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,"Noto Sans TC","PingFang TC",sans-serif}
    .wrap{max-width:1100px;margin:24px auto;padding:16px}
    .nav{display:flex;gap:16px;flex-wrap:wrap;margin-bottom:16px}
    .tab{padding:10px 14px;border-radius:12px;background:var(--panel);color:var(--text);text-decoration:none;opacity:.9}
    .tab.active{background:#1d2a44}
    .grid{display:grid;grid-template-columns:1fr 340px;gap:16px}
    @media (max-width:960px){.grid{grid-template-columns:1fr}}
    .card{background:linear-gradient(180deg,#101827,#0c1424);border:1px solid #1f2a44;border-radius:16px;padding:16px}
    h1{display:flex;align-items:center;gap:10px;font-size:22px;margin:0 0 12px}
    label{display:block;font-size:13px;color:var(--muted);margin:8px 2px}
    input,select,textarea{width:100%;background:#0b1220;border:1px solid #1f2a44;color:var(--text);border-radius:12px;padding:12px 14px;outline:none}
    textarea{min-height:120px;resize:vertical}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .btn{display:inline-flex;align-items:center;justify-content:center;gap:8px;padding:12px 16px;border-radius:12px;background:#22304f;color:#eaf2ff;border:1px solid #2a3a62;cursor:pointer}
    .btn.primary{background:#2a5ad7}
    .btn.success{background:#0f9d58}
    .btn.warn{background:#d97706}
    .btn.danger{background:#b91c1c}
    .btn.block{width:100%}
    .btnGroup{display:grid;grid-template-columns:repeat(3,1fr);gap:12px}
    .pill{display:inline-flex;align-items:center;gap:8px;padding:10px 14px;border-radius:14px;background:#10203a;border:1px solid #1f3258;cursor:pointer;text-align:center}
    .pill.active{outline:2px solid #3b82f6;background:#122a52}
    .list{display:flex;flex-direction:column;gap:10px}
    .item{display:flex;align-items:center;justify-content:space-between;background:#0b1220;border:1px solid #1f2a44;border-radius:12px;padding:10px 12px;font-size:14px}
    .muted{color:var(--muted);font-size:12px}
    .chips{display:flex;flex-wrap:wrap;gap:8px}
    .chip{background:#093144;border:1px solid #0b4b66;color:#9ae6ff;padding:8px 10px;border-radius:999px;font-size:12px}
    .rightSticky{position:sticky;top:12px}
    .tag{font-size:12px;color:#a1cdfc;background:#0e2344;border:1px solid #1b3c76;padding:6px 8px;border-radius:999px}
    .hr{height:1px;background:#1f2a44;margin:12px 0}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>🧾 付款管理系統</h1>

    <div class="grid">
      <!-- 左：主要操作 -->
      <div class="col-left">
        <!-- 發送付款 -->
        <div class="card">
          <div class="nav">
            <span class="tab active">發送付款</span>
            <a class="tab" href="#orders">訂單管理</a>
            <a class="tab" href="#meta">客戶編號</a>
            <a class="tab" href="#tpl">訊息模板</a>
          </div>

          <label>🔎 快速查詢（輸入「編號」或「姓名」）</label>
          <div class="row">
            <input id="q" placeholder="例如：625 或 王小明" />
            <button class="btn" id="btnQ">查詢</button>
          </div>

          <div class="row" style="margin-top:10px">
            <div>
              <label>客戶姓名 *</label>
              <input id="name" placeholder="姓名" />
            </div>
            <div>
              <label>客戶 LINE User ID *</label>
              <input id="uid" placeholder="Uxxxxxxxxxxxxxxxxxxxx" />
            </div>
          </div>

          <div class="row">
            <div>
              <label>金額（NT$）*</label>
              <input id="amount" inputmode="numeric" placeholder="例如：1500" />
            </div>
            <div>
              <label>付款方式 *</label>
              <div class="btnGroup" id="payGroup">
                <div class="pill active" data-type="both">💙 兩者都發</div>
                <div class="pill" data-type="ecpay">💳 綠界信用卡</div>
                <div class="pill" data-type="linepay">💚 LINE Pay</div>
              </div>
            </div>
          </div>

          <label style="margin-top:6px">訊息內容（可含 {amount}）</label>
          <textarea id="msg" placeholder="例如：您好，金額 NT$ {amount}，請儘速付款，謝謝！"></textarea>

          <div class="row" style="margin-top:10px">
            <button class="btn primary block" id="btnSend">發送付款連結</button>
            <button class="btn" id="btnTpl">載入模板</button>
          </div>

          <div class="hr"></div>
          <div>
            <div class="muted">在右側有「客戶載入」清單</div>
          </div>
        </div>

        <!-- 客戶編號：新增/刪除 -->
        <div class="card" id="meta">
          <div class="nav"><span class="tab active">客戶編號</span></div>

          <div class="row">
            <div>
              <label>編號（可空白自動遞增）</label>
              <input id="mNo" placeholder="例如：625（空白會自動給）" />
            </div>
            <div>
              <label>姓名 *</label>
              <input id="mName" placeholder="王小明" />
            </div>
          </div>
          <label>LINE User ID *</label>
          <input id="mUid" placeholder="Uxxxxxxxxxxxxxxxxxxxx" />

          <div style="margin-top:10px">
            <button class="btn success" id="btnSaveMeta">儲存</button>
          </div>

          <div class="hr"></div>
          <div>
            <div class="muted">已儲存</div>
            <div class="list" id="metaList"></div>
            <div style="margin-top:8px">
              <button class="btn" id="btnReloadMeta">重新載入</button>
            </div>
          </div>
        </div>

        <!-- 訊息模板 -->
        <div class="card" id="tpl">
          <div class="nav"><span class="tab active">訊息模板</span></div>
          <div class="chips" id="tplList"></div>
          <div class="muted" style="margin-top:10px">點一下模板即可套用到上方訊息框。</div>
        </div>
      </div>

      <!-- 右：客戶載入 -->
      <div class="col-right">
        <div class="card rightSticky">
          <div style="display:flex;align-items:center;justify-content:space-between">
            <span class="tag">客戶載入</span>
            <button class="btn" id="btnReloadSide">重新載入</button>
          </div>
          <div class="hr"></div>
          <div id="sideCustomers" class="list"></div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // 小工具
    const $ = (id)=>document.getElementById(id);
    const state = { payType:'both', templates:[], meta:null };

    // 付款方式切換
    document.querySelectorAll('#payGroup .pill').forEach(p=>{
      p.addEventListener('click', ()=>{
        document.querySelectorAll('#payGroup .pill').forEach(x=>x.classList.remove('active'));
        p.classList.add('active');
        state.payType = p.dataset.type;
      });
    });

    // 查詢（輸入編號或姓名）
    $('btnQ').onclick = async ()=>{
      const q = $('q').value.trim();
      if (!q) return;

      // 先用 /api/customer-meta 取得 map
      try{
        const r = await fetch('/api/customer-meta');
        const txt = await r.text();
        let d;
        try{ d = JSON.parse(txt) } catch(e){ alert('讀取客戶資料失敗：\n'+txt); return; }
        if (!d.success) return alert('讀取客戶資料失敗：'+(d.error||''));
        const { map } = d;
        // 依編號或姓名找
        if (map[q]) {
          $('name').value = map[q].name || '';
          $('uid').value  = map[q].userId || '';
        } else {
          // 以姓名反查
          const entry = Object.entries(map).find(([no,v]) => (v.name||'').includes(q));
          if (entry){
            $('name').value = entry[1].name || '';
            $('uid').value  = entry[1].userId || '';
          } else {
            alert('找不到相符資料');
          }
        }
      }catch(e){ alert('連線錯誤：'+e.message); }
    };

    // 發送付款連結
    $('btnSend').onclick = async ()=>{
      const name = $('name').value.trim();
      const userId = $('uid').value.trim();
      const amount = $('amount').value.trim();
      const customMessage = $('msg').value.trim();
      if (!name || !userId || !amount) return alert('姓名、User ID、金額必填');

      try{
        const r = await fetch('/send-payment',{
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify({
            userId, userName:name, amount,
            paymentType: state.payType,
            customMessage
          })
        });
        const txt = await r.text();
        let d;
        try{ d = JSON.parse(txt) } catch(e){ alert('伺服器未回 JSON，原文：\n'+txt); return; }
        if (!d.success) return alert('發送失敗：'+(d.error||''));
        alert('✅ 已發送！');
      }catch(e){ alert('連線錯誤：'+e.message); }
    };

    // 載入模板（點按鈕會把第一筆放入）
    $('btnTpl').onclick = async ()=>{
      await fetchTemplates();
      if (state.templates.length){
        $('msg').value = state.templates[0];
      }else{
        alert('沒有模板資料');
      }
    };

    // 儲存客戶編號（← 這段是重點，先用 text 再 JSON.parse）
    $('btnSaveMeta').onclick = async ()=>{
      const number = $('mNo').value.trim();
      const name   = $('mName').value.trim();
      const userId = $('mUid').value.trim();
      if (!name || !userId) return alert('請輸入 姓名 與 LINE User ID');

      try{
        const r = await fetch('/api/customer-meta/save',{
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ number: number?Number(number):undefined, name, userId })
        });
        const txt = await r.text();
        let d;
        try{ d = JSON.parse(txt) } catch(e){ alert('伺服器未回 JSON，原始內容：\n'+txt); return; }
        if (!d.success) return alert('儲存失敗：'+(d.error||''));
        await fetchMeta(); renderMeta(); renderSide();
        $('mNo').value=''; $('mName').value=''; $('mUid').value='';
      }catch(e){ alert('連線錯誤：'+e.message); }
    };

    $('btnReloadMeta').onclick = async ()=>{ await fetchMeta(); renderMeta(); };
    $('btnReloadSide').onclick = async ()=>{ await fetchMeta(); renderSide(); };

    // 刪除單筆
    async function deleteMeta(no){
      if (!confirm(`確定刪除 #${no} ?`)) return;
      try{
        const r = await fetch(`/api/customer-meta/${encodeURIComponent(no)}`,{method:'DELETE'});
        const txt = await r.text();
        let d; try{ d=JSON.parse(txt) }catch(e){ alert('伺服器未回 JSON：\n'+txt); return; }
        if (!d.success) return alert('刪除失敗：'+(d.error||''));
        await fetchMeta(); renderMeta(); renderSide();
      }catch(e){ alert('連線錯誤：'+e.message); }
    }

    // 讀取模板
    async function fetchTemplates(){
      try{
        const r = await fetch('/api/templates');
        const txt = await r.text();
        let d; try{ d=JSON.parse(txt) }catch(e){ alert('讀取模板錯誤：\n'+txt); return; }
        if (!d.success) return alert('讀取模板失敗：'+(d.error||''));
        state.templates = d.templates || [];
        renderTpl();
      }catch(e){ alert('連線錯誤：'+e.message); }
    }
    function renderTpl(){
      const box = $('tplList'); box.innerHTML='';
      (state.templates||[]).forEach((t,i)=>{
        const b = document.createElement('div');
        b.className='chip'; b.textContent = t; b.title='點擊套用';
        b.onclick = ()=>{ $('msg').value = t; };
        box.appendChild(b);
      });
    }

    // 讀取 / 渲染客戶編號
    async function fetchMeta(){
      try{
        const r = await fetch('/api/customer-meta');
        const txt = await r.text();
        let d; try{ d=JSON.parse(txt) }catch(e){ alert('讀取客戶資料錯誤：\n'+txt); return; }
        if (!d.success) return alert('讀取客戶資料失敗：'+(d.error||''));
        state.meta = d;
      }catch(e){ alert('連線錯誤：'+e.message); }
    }
    function renderMeta(){
      const list = $('metaList'); list.innerHTML='';
      if (!state.meta || !state.meta.map || !Object.keys(state.meta.map).length){
        const x = document.createElement('div'); x.className='muted'; x.textContent='尚無資料';
        list.appendChild(x); return;
      }
      Object.entries(state.meta.map).sort((a,b)=>Number(a[0])-Number(b[0])).forEach(([no,v])=>{
        const el = document.createElement('div'); el.className='item';
        const left = document.createElement('div');
        left.innerHTML = `<strong>#${no}</strong>　${v.name||''}<div class="muted">${v.userId||''}</div>`;
        const del = document.createElement('button'); del.className='btn danger'; del.textContent='刪除';
        del.onclick = ()=>deleteMeta(no);
        el.appendChild(left); el.appendChild(del); list.appendChild(el);
      });
    }
    function renderSide(){
      const box = $('sideCustomers'); box.innerHTML='';
      if (!state.meta || !state.meta.map || !Object.keys(state.meta.map).length){
        const x = document.createElement('div'); x.className='muted'; x.textContent='尚無客戶';
        box.appendChild(x); return;
      }
      Object.entries(state.meta.map).sort((a,b)=>Number(a[0])-Number(b[0])).forEach(([no,v])=>{
        const el = document.createElement('div'); el.className='item';
        const btn = document.createElement('button'); btn.className='btn'; btn.textContent='套用';
        btn.onclick = ()=>{
          $('name').value = v.name||''; $('uid').value = v.userId||'';
        };
        el.innerHTML = `<div><strong>#${no}</strong>　${v.name||''}<div class="muted">${v.userId||''}</div></div>`;
        el.appendChild(btn);
        box.appendChild(el);
      });
    }

    // 初始化
    (async ()=>{
      await fetchTemplates();
      await fetchMeta(); renderMeta(); renderSide();
    })();
  </script>
</body>
</html>