<!doctype html>
<html lang="zh-TW">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>C.H ç²¾ç·»æ´—è¡£ - ä»˜æ¬¾ç®¡ç†ç³»çµ±</title>
<style>
  body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;background:linear-gradient(135deg,#667eea,#764ba2);min-height:100vh;margin:0;padding:20px}
  .container{max-width:900px;margin:0 auto;background:#111827;color:#e5e7eb;border-radius:18px;padding:24px;box-shadow:0 24px 60px rgba(0,0,0,.4)}
  .tabs{display:flex;gap:16px;border-bottom:1px solid #374151;flex-wrap:wrap}
  .tab{padding:10px 14px;border:0;background:transparent;color:#9ca3af;font-weight:600;cursor:pointer;border-bottom:3px solid transparent}
  .tab.active{color:#60a5fa;border-bottom-color:#60a5fa}
  .tab-content{display:none;padding-top:18px}
  .tab-content.active{display:block}
  label{display:block;margin:10px 0 6px}
  input,textarea,select{width:100%;background:#111827;color:#e5e7eb;border:1px solid #374151;border-radius:10px;padding:12px}
  textarea{min-height:120px}
  .btn{display:inline-block;background:#2563eb;color:#fff;border:0;border-radius:10px;padding:12px 16px;font-weight:700;cursor:pointer}
  .btn:disabled{opacity:.6;cursor:not-allowed}
  .btn.secondary{background:#16a34a}
  .btn.danger{background:#dc2626}
  .grid{display:grid;gap:12px}
  .grid.cols-3{grid-template-columns:repeat(3,1fr)}
  .card{background:#0b1220;border:1px solid #1f2937;border-radius:12px;padding:12px}
  .pill{padding:4px 8px;border-radius:999px;font-size:12px}
  .pill.warn{background:#92400e;color:#fff}
  .pill.ok{background:#065f46;color:#fff}
  .pill.bad{background:#7f1d1d;color:#fff}
  @media (max-width:768px){ .grid.cols-3{grid-template-columns:1fr} }
</style>
</head>
<body>
  <div class="container">
    <h2 style="margin:0 0 6px">ğŸ’³ ä»˜æ¬¾ç®¡ç†ç³»çµ±</h2>
    <div class="tabs">
      <button class="tab active" data-tab="payment">ç™¼é€ä»˜æ¬¾</button>
      <button class="tab" data-tab="orders">è¨‚å–®ç®¡ç†</button>
      <button class="tab" data-tab="customers">å®¢æˆ¶ç·¨è™Ÿ</button>
      <button class="tab" data-tab="templates">è¨Šæ¯æ¨¡æ¿</button>
    </div>

    <!-- ç™¼é€ä»˜æ¬¾ -->
    <section id="payment" class="tab-content active">
      <label>å®¢æˆ¶ LINE User ID *</label>
      <input id="userId" placeholder="Uxxxxxxxxxxxxxxxxxxxx"/>

      <label>å®¢æˆ¶å§“å *</label>
      <input id="userName" placeholder="ç‹å°æ˜"/>

      <label>é‡‘é¡ (NT$) *</label>
      <input id="amount" type="number" min="1" placeholder="1500"/>

      <label>ä»˜æ¬¾æ–¹å¼ *</label>
      <select id="paymentType">
        <option value="both">å…©è€…éƒ½ç™¼</option>
        <option value="ecpay">ç¶ ç•Œä¿¡ç”¨å¡</option>
        <option value="linepay">LINE Pay</option>
      </select>

      <label>è¨Šæ¯å…§å®¹ï¼ˆå¯å« {amount}ï¼‰</label>
      <textarea id="customMessage" placeholder="ä¾‹å¦‚ï¼šæ‚¨å¥½ï¼Œé‡‘é¡ NT$ {amount}ï¼Œè¬è¬ï¼"></textarea>

      <div style="margin-top:14px">
        <button class="btn" id="sendBtn">ç™¼é€ä»˜æ¬¾é€£çµ</button>
      </div>

      <div id="result" class="card" style="display:none;margin-top:12px"></div>
    </section>

    <!-- è¨‚å–®ç®¡ç† -->
    <section id="orders" class="tab-content">
      <div style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:10px">
        <button class="btn secondary" id="btnReload">é‡æ–°æ•´ç†</button>
        <button class="btn secondary" id="btnRemind">ç™¼é€ä»˜æ¬¾æé†’</button>
        <button class="btn secondary" id="btnClean">æ¸…ç†éæœŸè¨‚å–®</button>
      </div>
      <div id="orderStats" class="grid cols-3"></div>
      <div id="orderList" style="margin-top:12px"></div>
    </section>

    <!-- å®¢æˆ¶ç·¨è™Ÿ -->
    <section id="customers" class="tab-content">
      <div class="grid cols-3">
        <div>
          <label>ç·¨è™Ÿ</label><input id="newCustomerNumber" placeholder="ä¾‹å¦‚ï¼š755"/>
        </div>
        <div>
          <label>å§“å</label><input id="newCustomerName" placeholder="ä¾‹å¦‚ï¼šç‹å°æ˜"/>
        </div>
        <div>
          <label>User ID</label><input id="newCustomerUserId" placeholder="Uxxxxxxxx"/>
        </div>
      </div>
      <div style="margin:12px 0"><button class="btn secondary" id="btnSaveCustomer">å„²å­˜</button></div>
      <div id="savedCustomers"></div>
    </section>

    <!-- æ¨¡æ¿ -->
    <section id="templates" class="tab-content">
      <label>æ–°å¢æ¨¡æ¿ï¼ˆ{amount} ä»£è¡¨é‡‘é¡ï¼‰</label>
      <textarea id="newTemplateContent"></textarea>
      <div style="margin-top:10px"><button class="btn secondary" id="btnSaveTpl">å„²å­˜æ¨¡æ¿</button></div>
      <div id="templateList" style="margin-top:12px"></div>
    </section>
  </div>

<script>
  // ==== è¨­å®šï¼šç›¸å°è·¯å¾‘ â†’ æ‰‹æ©Ÿ/é›»è…¦éƒ½ OK ====
  const API_BASE = location.origin;

  const $ = sel => document.querySelector(sel);
  const showMsg = (html, ok=true) => {
    const el = $('#result');
    el.style.display='block';
    el.style.borderColor = ok ? '#14532d' : '#7f1d1d';
    el.innerHTML = html;
  };
  const getJSON = url => fetch(API_BASE + url).then(r=>r.json());
  const postJSON = (url, body) => fetch(API_BASE + url, { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(body||{}) }).then(r=>r.json());

  // ==== åˆ†é  ====
  document.querySelectorAll('.tab').forEach(b=>{
    b.addEventListener('click', ()=>{
      document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
      document.querySelectorAll('.tab-content').forEach(p=>p.classList.remove('active'));
      b.classList.add('active');
      document.getElementById(b.dataset.tab).classList.add('active');
      if (b.dataset.tab==='orders') loadOrders();
      if (b.dataset.tab==='customers') renderCustomers();
      if (b.dataset.tab==='templates') renderTemplates();
    });
  });

  // ==== ç™¼é€ä»˜æ¬¾ï¼ˆé‡é»ï¼šæ‰‹æ©Ÿï¼‰ ====
  $('#sendBtn').addEventListener('click', async ()=>{
    const userId = $('#userId').value.trim();
    const userName= $('#userName').value.trim();
    const amount  = parseInt($('#amount').value,10);
    const paymentType = $('#paymentType').value;
    const customMessage = ($('#customMessage').value||'').replace('{amount}', (amount||0).toLocaleString());

    if (!userId || !userName || !amount) return showMsg('âŒ è«‹å®Œæ•´å¡«å¯« User ID / å§“å / é‡‘é¡', false);

    $('#sendBtn').disabled = true;
    try{
      const d = await postJSON('/send-payment', { userId, userName, amount, paymentType, customMessage });
      if (d.success){
        showMsg(`âœ… å·²ç™¼é€ Flex è¨Šæ¯çµ¦ï¼š${userName}<br>é‡‘é¡ï¼šNT$ ${amount.toLocaleString()}`);
        $('#userId').value = $('#userName').value = $('#amount').value = $('#customMessage').value = '';
      }else{
        showMsg('âŒ ç™¼é€å¤±æ•—ï¼š' + (d.error||'æœªçŸ¥éŒ¯èª¤'), false);
      }
    }catch(e){
      showMsg('âŒ é€£ç·šå¤±æ•—ï¼š' + e.message, false);
    }finally{
      $('#sendBtn').disabled = false;
    }
  });

  // ==== è¨‚å–®ç®¡ç†ï¼ˆç²¾ç°¡ç‰ˆï¼‰ ====
  async function loadOrders(){
    const wrap = $('#orderList');
    wrap.innerHTML = '<div class="card">è¼‰å…¥ä¸­...</div>';
    try{
      const d = await getJSON('/api/orders');
      const arr = d.success ? d.orders : [];
      if (!arr.length){ wrap.innerHTML = '<div class="card">å°šç„¡è¨‚å–®è¨˜éŒ„</div>'; return; }
      wrap.innerHTML = arr.map(o=>`
        <div class="card">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <div><b>${o.userName||'-'}</b>ã€€NT$ ${(o.amount||0).toLocaleString()}</div>
            <div>${o.status==='paid' ? '<span class="pill ok">å·²ä»˜æ¬¾</span>' : (o.isExpired ? '<span class="pill bad">å·²éæœŸ</span>' : '<span class="pill warn">å¾…ä»˜æ¬¾</span>')}</div>
          </div>
          <div style="font-size:12px;opacity:.8;margin-top:6px">#${o.orderId}</div>
          <div style="margin-top:8px;display:flex;gap:8px;flex-wrap:wrap">
            <button class="btn secondary" onclick="renewOrder('${o.orderId}')">çºŒæœŸé‡ç™¼</button>
            <button class="btn danger" onclick="deleteOrder('${o.orderId}')">åˆªé™¤</button>
          </div>
        </div>
      `).join('');
    }catch(e){
      wrap.innerHTML = '<div class="card">è¼‰å…¥å¤±æ•—ï¼š'+e.message+'</div>';
    }
  }
  async function renewOrder(id){
    try{ const d = await postJSON(`/api/order/${id}/renew`); if (d.success) showMsg('âœ… å·²çºŒæœŸä¸¦é‡æ–°ç™¼é€'); else showMsg('âŒ çºŒæœŸå¤±æ•—ï¼š'+(d.error||''), false); }
    catch(e){ showMsg('âŒ çºŒæœŸéŒ¯èª¤ï¼š'+e.message, false); }
  }
  async function deleteOrder(id){
    if (!confirm('åˆªé™¤æ­¤è¨‚å–®ï¼Ÿ')) return;
    try{ const d = await fetch(API_BASE+`/api/order/${id}`, { method:'DELETE' }).then(r=>r.json()); if (d.success){ showMsg('ğŸ—‘ï¸ å·²åˆªé™¤'); loadOrders(); } else showMsg('âŒ åˆªé™¤å¤±æ•—', false); }
    catch(e){ showMsg('âŒ åˆªé™¤éŒ¯èª¤ï¼š'+e.message, false); }
  }
  $('#btnReload').onclick = loadOrders;
  $('#btnRemind').onclick = ()=> postJSON('/api/orders/send-reminders').then(d=>showMsg(d.message, true)).catch(e=>showMsg(e.message,false));
  $('#btnClean').onclick  = ()=> postJSON('/api/orders/clean-expired').then(d=>showMsg(d.message, true)).catch(e=>showMsg(e.message,false));

  // ==== å®¢æˆ¶ç·¨è™Ÿ ====
  let savedCustomers = JSON.parse(localStorage.getItem('customerNumbers')||'{}');
  async function syncCustomers(){ try{ const d = await getJSON('/api/customer-meta'); if (d.success && d.map){ savedCustomers=d.map; localStorage.setItem('customerNumbers', JSON.stringify(savedCustomers)); } }catch{} }
  function renderCustomers(){
    const wrap = $('#savedCustomers');
    const list = Object.entries(savedCustomers);
    if (!list.length){ wrap.innerHTML='<div class="card">å°šç„¡è³‡æ–™</div>'; return; }
    wrap.innerHTML = list.map(([no,c])=>`
      <div class="card" style="display:flex;justify-content:space-between;align-items:center">
        <div><b>#${no}</b>ã€€${c.name}ã€€<span style="opacity:.7">(${c.userId})</span></div>
        <button class="btn" onclick="prefill('${c.userId}','${c.name}')">å¸¶å…¥</button>
      </div>
    `).join('');
  }
  window.prefill = (uid,name)=>{ $('#userId').value=uid; $('#userName').value=name; document.querySelector('.tab[data-tab="payment"]').click(); };
  $('#btnSaveCustomer').onclick = async ()=>{
    const number = $('#newCustomerNumber').value.trim();
    const name   = $('#newCustomerName').value.trim();
    const userId = $('#newCustomerUserId').value.trim();
    if (!name || !userId) return showMsg('âŒ è«‹è¼¸å…¥ å§“å / User ID', false);
    const d = await postJSON('/api/customer-meta/save', { number:number?Number(number):undefined, name, userId });
    if (d.success){ savedCustomers[d.number]=d.data; localStorage.setItem('customerNumbers', JSON.stringify(savedCustomers)); $('#newCustomerNumber').value=$('#newCustomerName').value=$('#newCustomerUserId').value=''; renderCustomers(); showMsg('âœ… å·²å„²å­˜å®¢æˆ¶ç·¨è™Ÿ'); }
    else showMsg('âŒ å„²å­˜å¤±æ•—ï¼š'+(d.error||''), false);
  };

  // ==== æ¨¡æ¿ ====
  let savedTemplates = JSON.parse(localStorage.getItem('messageTemplates')||'[]');
  async function syncTemplates(){ try{ const d = await getJSON('/api/templates'); if (d.success && Array.isArray(d.templates)){ savedTemplates=d.templates; localStorage.setItem('messageTemplates', JSON.stringify(savedTemplates)); } }catch{} }
  function renderTemplates(){
    const wrap = $('#templateList');
    if (!savedTemplates.length){ wrap.innerHTML='<div class="card">å°šç„¡æ¨¡æ¿</div>'; return; }
    wrap.innerHTML = savedTemplates.map((t,i)=>`
      <div class="card">
        <div style="white-space:pre-wrap">${t}</div>
        <div style="margin-top:8px;display:flex;gap:8px">
          <button class="btn" onclick="useTpl(${i})">ä½¿ç”¨</button>
          <button class="btn danger" onclick="delTpl(${i})">åˆªé™¤</button>
        </div>
      </div>`).join('');
  }
  window.useTpl = i => { const a=parseInt($('#amount').value||'0',10); $('#customMessage').value = (savedTemplates[i]||'').replace('{amount}', a.toLocaleString()); document.querySelector('.tab[data-tab="payment"]').click(); };
  window.delTpl = async i => { if(!confirm('åˆªé™¤æ­¤æ¨¡æ¿ï¼Ÿ'))return; const d = await fetch(API_BASE+`/api/templates/${i}`,{method:'DELETE'}).then(r=>r.json()); if (d.success){ savedTemplates=d.templates; localStorage.setItem('messageTemplates', JSON.stringify(savedTemplates)); renderTemplates(); } };

  $('#btnSaveTpl').onclick = async ()=>{
    const content = $('#newTemplateContent').value.trim();
    if (!content) return showMsg('âŒ è«‹è¼¸å…¥æ¨¡æ¿å…§å®¹', false);
    const d = await postJSON('/api/templates', { content });
    if (d.success){ savedTemplates=d.templates; localStorage.setItem('messageTemplates', JSON.stringify(savedTemplates)); $('#newTemplateContent').value=''; renderTemplates(); showMsg('âœ… å·²æ–°å¢æ¨¡æ¿'); }
    else showMsg('âŒ å„²å­˜å¤±æ•—ï¼š'+(d.error||''), false);
  };

  // ==== åˆå§‹åŒ–ï¼ˆè¡Œå‹•è£ç½®æœ€é‡è¦ï¼‰ ====
  (async function init(){
    await syncCustomers();
    await syncTemplates();
  })();
</script>
</body>
</html>
