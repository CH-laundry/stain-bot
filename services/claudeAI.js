// ====================================
// C.H ç²¾ç·»æ´—è¡£ - Claude AI æ™ºèƒ½å®¢æœæ¨¡çµ„
// å„ªåŒ–ç‰ˆï¼šå¤§å¹…é™ä½ API è²»ç”¨ï¼Œä¿ç•™æ‰€æœ‰åŠŸèƒ½
// ====================================

const Anthropic = require('@anthropic-ai/sdk');
const OpenAI = require('openai');

const anthropic = new Anthropic({
  apiKey: process.env.CLAUDE_API_KEY
});

const openai = new OpenAI({
  apiKey: process.env.OPENAI_API_KEY
});

// ====================================
// å¿«é€Ÿå›è¦†ç³»çµ±ï¼ˆä¸å‘¼å« APIï¼ŒçœéŒ¢ï¼ï¼‰
// ====================================
function quickReply(userMessage) {
  const msg = userMessage.toLowerCase();
  
  // 1. å¼·åˆ¶ä¸å›æ‡‰æ¸…å–®ï¼ˆå·²æœ‰è‡ªå‹•å›æ‡‰çš„é …ç›®ï¼‰
  const autoResponseKeywords = [
    'å¸¸è¦‹å•é¡Œ', 'ä»˜æ¬¾æ–¹å¼', 'å¸¸è¦‹å•é¡Œ&ä»˜æ¬¾æ–¹å¼',
    'æœå‹™åƒ¹ç›®', 'å„²å€¼å„ªæƒ ', 'æœå‹™åƒ¹ç›®&å„²å€¼å„ªæƒ ',
    'åˆ°åºœæ”¶é€', 'åº—é¢åœ°å€', 'ç‡Ÿæ¥­æ™‚é–“', 'åº—é¢åœ°å€&ç‡Ÿæ¥­æ™‚é–“',
    'æ™ºèƒ½æ±¡æ¼¬åˆ†æ', 'æ™ºèƒ½æ±™æ¼¬åˆ†æ', 'å¯¶å¯¶æ±½åº§&æ‰‹æ¨è»Š', 'é¡§å®¢é ˆçŸ¥'
  ];
  
  for (const keyword of autoResponseKeywords) {
    if (userMessage.includes(keyword)) {
      return 'UNRELATED';
    }
  }
  
  // 2. ç„¡é—œå•é¡Œéæ¿¾
  const unrelatedPatterns = [
    /^(ä½ å¥½|hi|hello|å—¨|åœ¨å—|å“ˆå›‰)$/i,
    /å¤©æ°£|æ°£è±¡|æº«åº¦/,
    /ç¾é£Ÿ|é¤å»³|å¥½åƒ/,
    /æ•¸å­¸|è¨ˆç®—|[0-9]+[\+\-\*\/][0-9]+/,
    /^(è¬è¬|æ„Ÿè¬|thanks|thank you)$/i
  ];
  
  for (const pattern of unrelatedPatterns) {
    if (pattern.test(userMessage)) {
      return 'UNRELATED';
    }
  }
  
  // 3. ç°¡å–®è©¢å•æ˜¯å¦æœ‰æœå‹™ï¼ˆä¸å•åƒ¹æ ¼ï¼‰
  if (/^.{0,15}(å¯ä»¥|èƒ½|æœ‰)?.{0,5}æ´—.{0,10}(å—|ã„‡|\?|ï¼Ÿ)$/.test(userMessage)) {
    if (/ç¾½çµ¨/.test(userMessage)) return 'æœ‰çš„ ğŸ’™ æˆ‘å€‘æœ‰æ¸…æ´—ç¾½çµ¨è¡£çš„æœå‹™';
    if (/å¤–å¥—|å¤§è¡£|å¤¾å…‹/.test(userMessage)) return 'æœ‰çš„ ğŸ’™ æˆ‘å€‘æœ‰æ¸…æ´—å¤–å¥—çš„æœå‹™';
    if (/è¥¯è¡«|ä¸Šè¡£|t.?shirt|polo/i.test(userMessage)) return 'æœ‰çš„ ğŸ’™ æˆ‘å€‘æœ‰æ¸…æ´—è¥¯è¡«ä¸Šè¡£çš„æœå‹™';
    if (/è¤²å­|é•·è¤²|çŸ­è¤²/.test(userMessage)) return 'æœ‰çš„ ğŸ’™ æˆ‘å€‘æœ‰æ¸…æ´—è¤²å­çš„æœå‹™';
    if (/è£™å­|æ´‹è£/.test(userMessage)) return 'æœ‰çš„ ğŸ’™ æˆ‘å€‘æœ‰æ¸…æ´—è£™å­çš„æœå‹™';
    if (/æ£‰è¢«|è¢«å­/.test(userMessage)) {
      const replies = [
        'æ£‰è¢«å¯ä»¥æ¸…æ½”ï¼›æˆ‘å€‘æœƒå…¼é¡§è“¬é¬†åº¦èˆ‡ä¹¾çˆ½åº¦ï¼Œç¡æ„Ÿå¯æœ›æ›´èˆ’é© ğŸ˜Š',
        'è¢«å­å¯è™•ç†ï¼›æµç¨‹æœƒä¿è­·çº–ç¶­çµæ§‹ä¸¦å……åˆ†çƒ˜é€ï¼Œä½¿ç”¨ä¸Šæ›´è¡›ç”Ÿ ğŸ’™',
        'å¯ä»¥æ¸…æ´—æ£‰è¢«ï¼›å®Œæˆå¾Œæœƒæ›´ä¹¾æ·¨æ¸…æ–°ï¼Œæ”¶ç´ä¹Ÿæ›´å®‰å¿ƒ âœ¨'
      ];
      return replies[Math.floor(Math.random() * replies.length)];
    }
    if (/çª—ç°¾/.test(userMessage)) {
      const replies = [
        'å¯ä»¥æ¸…æ½”çª—ç°¾ï¼Œæˆ‘å€‘æœƒä¾å¸ƒæ–™èˆ‡ç¹”æ³•èª¿æ•´æµç¨‹ï¼Œå…¼é¡§æ½”æ·¨èˆ‡ç‰ˆå‹ ğŸ‘Œ',
        'çª—ç°¾å¯è™•ç†ï¼›æœƒå…ˆè©•ä¼°ç¸®æ°´èˆ‡æ‰è‰²é¢¨éšªï¼Œå†å®‰æ’åˆé©æ–¹å¼ ğŸ˜Š',
        'å¯æ¸…æ½”ï¼›è‹¥æœ‰ç‰¹æ®Šå¡—å±¤æœƒå…ˆåšå°ç¯„åœæ¸¬è©¦ï¼Œè™•ç†å¾Œæ›´æ¸…çˆ½ ğŸ’™',
        'çª—ç°¾å¯ä»¥æ¸…æ´—ï¼Œæœƒæ³¨æ„å°ºå¯¸ç©©å®šèˆ‡å‚å¢œæ„Ÿï¼Œå®Œæˆå¾Œæ›´ä¿è½ âœ¨'
      ];
      return replies[Math.floor(Math.random() * replies.length)];
    }
    if (/æ‰‹æ¨è»Š|å¬°å…’è»Š|å¨ƒå¨ƒè»Š|æ¨è»Š/.test(userMessage)) return 'æœ‰çš„ ğŸ’™ æˆ‘å€‘æœ‰æ¸…æ´—å¯¶å¯¶æ‰‹æ¨è»Šçš„æœå‹™';
    if (/æ±½åº§|å®‰å…¨åº§æ¤…/.test(userMessage)) return 'æœ‰çš„ ğŸ’™ æˆ‘å€‘æœ‰æ¸…æ´—æ±½åº§çš„æœå‹™';
  }
  
  // 4. åŒ…åŒ…ç›¸é—œï¼ˆéœ€å€åˆ†æ˜¯å¦å•åƒ¹æ ¼ï¼‰
  if (/åŒ…|åŒ…åŒ…/.test(userMessage)) {
    const askingPrice = /(å¤šå°‘|åƒ¹æ ¼|åƒ¹éŒ¢|è²»ç”¨|æ”¶è²»)/.test(userMessage);
    const luxuryBrands = /lv|gucci|chanel|hermÃ¨s|hermes|prada|dior|celine|fendi|burberry|coach|mk|longchamp/i.test(userMessage);
    
    if (luxuryBrands && askingPrice) {
      return 'é€™é‚Šæœƒç”±å°ˆäººè·Ÿæ‚¨å›è¦†ï¼Œè¬è¬æ‚¨ ğŸ’™';
    }
    
    if (luxuryBrands && !askingPrice) {
      return 'æœ‰çš„ ğŸ’™ ç²¾å“åŒ…æˆ‘å€‘æœ‰å°ˆæ¥­æ¸…æ´—æœå‹™ï¼Œæœƒä¾æè³ªå’Œç‹€æ³ç´°å¿ƒè™•ç†';
    }
    
    if (!askingPrice) {
      const replies = [
        'åŒ…åŒ…æ¸…æ½”æˆ‘å€‘æœ‰å°ˆæ¥­æµç¨‹ ğŸ’¼ æœƒå…ˆç¢ºèªæè³ªèˆ‡ç™¼éœ‰æˆ–è®Šè‰²æƒ…æ³ï¼Œå†è©•ä¼°é©åˆçš„è™•ç†æ–¹å¼ã€‚çš®é©é¡æœƒç›¡é‡æ¸…æ½”ä¸¦ä¿é¤Šè­·ç†ï¼Œè‹¥æè³ªè€åŒ–å‰‡æœƒå…ˆå‘ŠçŸ¥é¢¨éšªã€‚',
        'æˆ‘å€‘å¯ä»¥å”åŠ©è™•ç†åŒ…åŒ… ğŸ‘ ä¸åŒæè³ªæœƒæ¡å–ä¸åŒæ–¹å¼ï¼Œçš®é©æœƒé‡è¦–ä¿é¤Šã€å¸ƒé¢å‰‡æœƒåŠ å¼·æ¸…æ½”èˆ‡å®šå‹ã€‚ä¸éè‹¥æœ‰åš´é‡ç™¼éœ‰æˆ–æ‰è‰²ï¼Œæœƒå…ˆè©•ä¼°å†é€²è¡Œã€‚',
        'å¯ä»¥çš„å–”ï¼Œè‹¥åŒ…åŒ…æœ‰ç™¼éœ‰æˆ–æ±¡æ¼¬å¤šå¯æ”¹å–„ ğŸ’¼ ä½†ä»æœƒä¾å¯¦éš›æè³ªç‹€æ³è€Œå®šï¼Œæˆ‘å€‘æœƒå…ˆè©•ä¼°å¾Œå†è™•ç†ï¼Œç›¡é‡å…¼é¡§æ½”æ·¨èˆ‡å¤–è§€ä¿è­· âœ¨'
      ];
      return replies[Math.floor(Math.random() * replies.length)];
    }
  }
  
  // 5. é‹å­ç›¸é—œ
  if (/(é‹|çƒé‹|é‹å‹•é‹|çš®é‹)/.test(userMessage) && !/(å¤šå°‘|åƒ¹æ ¼|åƒ¹éŒ¢|è²»ç”¨)/.test(userMessage)) {
    const replies = [
      'å¯ä»¥æ¸…æ½”é‹å­ï¼Œæˆ‘å€‘æœƒä¾æè³ª(å¸ƒé¢/çš®é©/éº‚çš®)èª¿æ•´æ–¹å¼ï¼Œç›¡é‡æ¢å¾©å¤–è§€ ğŸ‘Ÿ',
      'å¯ä»¥æ¸…æ½”é‹å­ï¼›å¦‚æœæœ‰ç™¼éœ‰ã€ç•°å‘³æˆ–é»ƒæ–‘å¤šèƒ½æ”¹å–„ï¼Œæœƒå…ˆåšä¸é¡¯çœ¼è™•æ¸¬è©¦å†é€²è¡Œ ğŸ˜Š',
      'å¯æ¸…æ½”ï¼›å¦‚æœæ˜¯çš®é©é‹æœƒæ³¨æ„ä¸Šæ²¹è­·ç†ï¼Œå¸ƒé¢é‹æœƒåŠ å¼·æ¸…æ½”èˆ‡å®šå‹ ğŸ’™',
      'å¯ä»¥æ¸…æ´—ï¼›é‹åº•èˆ‡ç¸«ç·šæ˜“è—æ±¡ï¼Œæˆ‘å€‘æœƒç´°æ¸…èˆ‡é™¤å‘³ï¼Œç©¿è‘—æ„Ÿæ›´å¥½ âœ¨'
    ];
    return replies[Math.floor(Math.random() * replies.length)];
  }
  
  // 6. é€²åº¦æŸ¥è©¢
  if (/(æ´—å¥½|å®Œæˆ|é€²åº¦|å¯ä»¥æ‹¿|èƒ½æ‹¿|å–ä»¶)/.test(userMessage)) {
    return 'æ‚¨å¯ä»¥ç·šä¸ŠæŸ¥è©¢ C.Hç²¾ç·»æ´—è¡£ ğŸ”\nhttps://liff.line.me/2004612704-JnzA1qN6#/home\næˆ–æ˜¯ç‡Ÿæ¥­æ™‚é–“æœƒæœ‰å°ˆäººå›è¦†æ‚¨ï¼Œè¬è¬ ğŸ™';
  }
  
  // ç„¡æ³•å¿«é€Ÿåˆ¤æ–·ï¼Œéœ€è¦ Claude
  return null;
}

// ====================================
// ç²¾ç°¡ç‰ˆçŸ¥è­˜åº«ï¼ˆå¤§å¹…æ¸›å°‘ tokenï¼‰
// ====================================
const LAUNDRY_KNOWLEDGE_COMPACT = `ä½ æ˜¯ C.H ç²¾ç·»æ´—è¡£å®¢æœã€‚ç°¡æ½”è¦ªåˆ‡å›ç­”ï¼Œé©åº¦ç”¨ğŸ’™ã€‚

ã€æ ¸å¿ƒè¦å‰‡ã€‘
1. åªç­”æ´—è¡£ç›¸é—œï¼Œå…¶ä»–ç­” UNRELATED
2. ä¸æä¾›é›»è©±ã€ä¸å•åœ°å€
3. ä¸ä¸»å‹•å ±åƒ¹æ ¼/å®Œå·¥æ™‚é–“ï¼Œé™¤éå®¢äººæ˜ç¢ºå•
4. æ±™æ¼¬å•é¡Œå¿…èªªã€Œä¸ä¿è­‰å®Œå…¨å»é™¤ã€

ã€åƒ¹æ ¼è¡¨ã€‘(åƒ…åœ¨å®¢äººå•ã€Œå¤šå°‘éŒ¢/åƒ¹æ ¼/è²»ç”¨ã€æ™‚æ‰å ±åƒ¹)
- è¥¯è¡«/Tæ¤/POLO:88 å¥³ä¸Šè¡£:90 é‡ç¹”:110 æ¯›è¡£:150
- çŸ­è¤²:90 é•·è¤²/è¥¿è£è¤²:120 çŸ­è£™:130 é•·è£™:160 çŸ­æ´‹è£:230 é•·æ´‹è£:270
- å¤¾å…‹/å¤–å¥—:200 åšå¤–å¥—:300 å¤§è¡£:320 é•·å¤§è¡£:380 ç¾½çµ¨è¡£:330 é•·ç¾½çµ¨:400
- è¥¿è£å…©æˆª:230 æ¯›æ–™è¥¿è£:300
- å–®äººåºŠå–®/è¢«å¥—:170 å–®äººè¢«:250 åšå–®äººè¢«:360 é›™äººåºŠå–®/è¢«å¥—:220 é›™äººè¢«:420 åšé›™äººè¢«:550
- é‹å‹•é‹:300/350(éº‚çš®) é«˜åƒ¹é‹(5åƒä»¥ä¸Š):400/450 ç²¾å“é‹(1è¬ä»¥ä¸Š):800/1000
- åŒ…åŒ…:600-1000 ç²¾å“åŒ…:ç”±å°ˆäººè©•ä¼°å ±åƒ¹
- å¯¶å¯¶æ‰‹æ¨è»Š:1200 æ±½åº§:900
- åœ°æ¯¯:ä¾å°ºå¯¸(60x90cm:800 / 180x270cmæ¨™æº–å®¢å»³:2000 / 300x400cm:5000)

ã€ç²¾å“é¡å¤–è²»ç”¨ã€‘(å®¢äººå•åƒ¹æ ¼+æåˆ°å“ç‰Œæ™‚èªªæ˜)
Canada Goose/Moncler/Burberry/Gucci/Prada/Dior/Chanelç­‰:
- ä¸Šè¡£è¤²è£™ç²¾å“:åŸºæœ¬åƒ¹+150
- å¤§è¡£å¤–å¥—ç²¾å“:åŸºæœ¬åƒ¹+250

ç¯„ä¾‹ï¼šåŠ æ‹¿å¤§éµç¾½çµ¨è¡£ï¼Ÿâ†’ã€Œç¾½çµ¨è¡£æ¸…æ´—:NT$330å…ƒï¼Œç²¾å“è¡£ç‰©ç‰¹åˆ¥è™•ç†+NT$250å…ƒï¼Œç¸½è¨ˆNT$580å…ƒğŸ’™ã€

ã€ç²¾å“åŒ…è™•ç†ã€‘
å•ã€Œèƒ½æ´—å—ã€â†’ã€Œæœ‰çš„ğŸ’™ç²¾å“åŒ…æˆ‘å€‘æœ‰å°ˆæ¥­æ¸…æ´—æœå‹™ï¼Œæœƒä¾æè³ªå’Œç‹€æ³ç´°å¿ƒè™•ç†ã€
å•ã€Œå¤šå°‘éŒ¢ã€â†’ã€Œé€™é‚Šæœƒç”±å°ˆäººè·Ÿæ‚¨å›è¦†ï¼Œè¬è¬æ‚¨ğŸ’™ã€

ã€æ”¶ä»¶åˆ¤æ–·ã€‘(ä½ è¦æ ¹æ“šç•¶å‰æ™‚é–“è‡ªå‹•åˆ¤æ–·)
ä»Šå¤©æ”¶ä»¶ï¼š
- ä»Šå¤©=é€±å…­â†’ã€Œå› é€±å…­å›ºå®šå…¬ä¼‘ï¼Œæ˜å¤©æœƒå»æ”¶å›çš„ğŸ’™ã€
- æ¿æ©‹+ä¸‹åˆ6é»å‰â†’ã€Œå¥½çš„ğŸ’™ã€
- å…¶ä»–â†’ã€Œå¥½çš„ğŸ’™æ˜å¤©æœƒå»æ”¶ã€

æ˜å¤©æ”¶ä»¶ï¼š
- æ˜å¤©=é€±å…­â†’ã€Œæ˜å¤©æ˜¯é€±å…­å›ºå®šå…¬ä¼‘ï¼Œæˆ‘å€‘é€±æ—¥æœƒå»æ”¶å›çš„ğŸ’™ã€
- å…¶ä»–â†’ã€Œå¥½çš„ğŸ’™æ˜å¤©æœƒå»æ”¶ã€

å®¢äººå•ã€Œå¯ä»¥åˆ°åºœæ”¶é€å—ã€â†’ã€Œå¥½çš„ğŸ’™ã€
å®¢äººèªªã€Œè¡£æœæº–å‚™å¥½äº†/è«‹ä¾†æ”¶ã€â†’ã€Œå¥½çš„ğŸ’™ã€

ã€ç‰¹æ®Šå•é¡Œã€‘
Q:å¤–å¥—å…§å±¤å¯æ‹†ï¼ŸA:å¯æ‹†ä»¥2ä»¶è¨ˆåƒ¹
Q:æ±™æ¼¬/é«’æ±¡/æ²¹æ¼¬èƒ½æ´—æ‰ï¼ŸA:å¥½ï¼æˆ‘å€‘æœƒé‡å°æ±™æ¼¬åŠ å¼·è™•ç†ğŸ’™ âš ï¸é‡è¦æé†’ï¼šæ±™æ¼¬è™•ç†ã€ä¸ä¿è­‰èƒ½å®Œå…¨å»é™¤ã€‘è‹¥æ±™æ¼¬å·²æ·±å…¥çº–ç¶­æˆ–æ™‚é–“éä¹…ï¼Œå¯èƒ½ç„¡æ³•å®Œå…¨è™•ç†
Q:å®Œå·¥æ™‚é–“ï¼ŸA:å®Œå·¥æ™‚é–“ç´„7-10å€‹å·¥ä½œæ—¥
Q:åœ°æ¯¯ï¼ŸA:(å®Œæ•´æµç¨‹+åƒ¹æ ¼è¡¨)
Q:æ‰‹æ¨è»Š/æ±½åº§ï¼ŸA:(å®Œæ•´æ¸…æ´—å…§å®¹+åƒ¹æ ¼+å«åˆ°åºœæ”¶é€)

ã€ç‡Ÿæ¥­è³‡è¨Šã€‘
ç‡Ÿæ¥­æ™‚é–“:æ¯æ—¥10:30-20:00(é€±å…­å…¬ä¼‘)
ä»˜æ¬¾:ç¾é‡‘/è½‰å¸³/LINE PAY/ECPay
å®Œå·¥:7-10å·¥ä½œæ—¥

ã€å›è¦†é¢¨æ ¼ã€‘
ç°¡æ½”ã€è¦ªåˆ‡ã€å°ˆæ¥­ã€ä¸é‡è¤‡ã€é©åº¦emojiğŸ’™ğŸ§ºâœ¨ğŸ‘”ğŸ‘ŸğŸ‘œ`;

// ====================================
// æ‰‹æ¨è»Š/æ±½åº§å®Œæ•´å›è¦†
// ====================================
const BABY_ITEMS_REPLY = `ğŸ’™ æœ‰çš„ï¼æˆ‘å€‘æœ‰æ¸…æ´—å¯¶å¯¶æ‰‹æ¨è»Šå’Œæ±½åº§çš„æœå‹™

ã€ğŸ”µ æ¸…æ´—é …ç›®&åƒ¹æ ¼ã€‘
- å¯¶å¯¶å–®äººæ‰‹æ¨è»Šï¼šNT$ 1,200
- å¯¶å¯¶æ±½åº§(å®‰å…¨åº§æ¤…)ï¼šNT$ 900

ã€ğŸ”µ æ¸…æ´—å…§å®¹ã€‘
âœ… æ‹†è§£æ¸…æ´—(åº§æ¤…å¸ƒå¥—ã€å®‰å…¨å¸¶ç­‰)
âœ… éª¨æ¶æ¸…æ½”æ¶ˆæ¯’
âœ… é™¤è‡­æ®ºèŒ
âœ… çµ„è£å¾©åŸ

ğŸ’™ å«åˆ°åºœæ”¶é€æœå‹™

å¦‚éœ€äº†è§£æ›´å¤šè©³æƒ…ï¼Œè«‹å›è¦†æ•¸å­—ã€2ã€‘`;

// ====================================
// åœ°æ¯¯å®Œæ•´å›è¦†
// ====================================
const CARPET_REPLY = `ğŸ’™ æˆ‘å€‘æœ‰å°ˆæ¥­åœ°æ¯¯æ¸…æ´—æœå‹™

ã€ğŸ”µ å°ˆæ¥­æ¸…æ´—æµç¨‹ã€‘

1ï¸âƒ£ å¤šé‡æ¸…æ´—ç¨‹åº
   â€¢ é™¤å¡µå¸èŸ(å»é™¤ 90% å¡µèŸ)
   â€¢ é«˜æº«è’¸æ°£æ·±å±¤æ¸…æ½”
   â€¢ å°ˆæ¥­ç’°ä¿è—¥åŠ‘
   â€¢ äºŒæ¬¡éæ°´ç¢ºä¿ç„¡æ®˜ç•™

2ï¸âƒ£ æ®ºèŒé™¤è‡­
   â€¢ é«˜æº«æ®ºèŒ(99.9% ç´°èŒ)
   â€¢ å¯µç‰©ç•°å‘³æ·±åº¦è™•ç†
   â€¢ ä½¿ç”¨å¤©ç„¶æŸ‘æ©˜é™¤è‡­

3ï¸âƒ£ å°ˆæ¥­çƒ˜ä¹¾
   â€¢ å®Œå…¨ä¹¾ç‡¥,ä¸ç™¼éœ‰
   â€¢ é˜²æ­¢äºŒæ¬¡æ±¡æŸ“

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

ã€ğŸ’° æ¸…æ´—åƒ¹æ ¼åƒè€ƒã€‘

ğŸ”¸ 60Ã—90cm - $800
   (ç„é—œå°åœ°å¢Š)

ğŸ”¸ 80Ã—120cm - $1,000
   (åºŠé‚Šå°åœ°æ¯¯)

ğŸ”¸ 120Ã—180cm - $1,300
   (è‡¥å®¤åœ°æ¯¯)

ğŸ”¸ 140Ã—200cm - $1,500
   (æ¨™æº–è‡¥å®¤)

ğŸ”¸ 160Ã—230cm - $1,800
   (å¤§è‡¥å®¤/å°å®¢å»³)

ğŸ”¸ 180Ã—270cm - $2,000 â­
   (æ¨™æº–å®¢å»³)

ğŸ”¸ 200Ã—290cm - $2,300
   (å¤§å®¢å»³)

ğŸ”¸ 240Ã—300cm - $3,000
   (è±ªå®…å®¢å»³)

ğŸ”¸ 240Ã—340cm - $3,300
   (è¶…å¤§å®¢å»³)

ğŸ”¸ 270Ã—360cm - $4,000
   (åˆ¥å¢…/è¾¦å…¬å®¤)

ğŸ”¸ 300Ã—400cm - $5,000
   (å•†æ¥­ç©ºé–“)

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

âœ¨ å«åˆ°åºœæ”¶é€æœå‹™
ğŸ“· è’¸æ±½æ®ºèŒ!æº«å’Œæ´—åŠ‘ä¸å‚·æè³ª`;

// ====================================
// æ”¶ä»¶å›è¦†è¨˜æ†¶ï¼ˆé¿å…é‡è¤‡ï¼‰
// ====================================
const pickupRepliedUsers = new Map();

setInterval(() => {
  const now = Date.now();
  for (const [userId, timestamp] of pickupRepliedUsers.entries()) {
    if (now - timestamp > 30 * 60 * 1000) {
      pickupRepliedUsers.delete(userId);
    }
  }
}, 5 * 60 * 1000);

// ====================================
// è™•ç†æ–‡å­—è¨Šæ¯ï¼ˆå„ªåŒ–ç‰ˆï¼‰
// ====================================
async function handleTextMessage(userMessage, userId = null) {
  try {
    // æ­¥é©Ÿ1: å…ˆç”¨å¿«é€Ÿå›è¦†ï¼ˆå…è²»ï¼ï¼‰
    const quickAnswer = quickReply(userMessage);
    if (quickAnswer) {
      if (quickAnswer === 'UNRELATED') {
        return null; // ä¸å›æ‡‰
      }
      
      // ç‰¹æ®Šå®Œæ•´å›è¦†
      if (/åœ°æ¯¯/.test(userMessage) && /(å¤šå°‘|åƒ¹æ ¼|åƒ¹éŒ¢|è²»ç”¨|æ¸…æ´—)/.test(userMessage)) {
        return CARPET_REPLY;
      }
      
      if (/(æ‰‹æ¨è»Š|å¬°å…’è»Š|å¨ƒå¨ƒè»Š|æ¨è»Š|æ±½åº§|å®‰å…¨åº§æ¤…)/.test(userMessage) && /(å¤šå°‘|åƒ¹æ ¼|åƒ¹éŒ¢|è²»ç”¨)/.test(userMessage)) {
        return BABY_ITEMS_REPLY;
      }
      
      return quickAnswer;
    }
    
    // æ­¥é©Ÿ2: æª¢æŸ¥æ˜¯å¦ç‚ºæ”¶ä»¶å•é¡Œï¼ˆé¿å…é‡è¤‡å›è¦†ï¼‰
    const isPickupQuestion = /æ”¶|ä¾†æ”¶|æ”¶ä»¶|åˆ°åºœ|æ”¶è¡£|æ”¶é€/.test(userMessage);
    if (isPickupQuestion && userId && pickupRepliedUsers.has(userId)) {
      return null;
    }
    
    // æ­¥é©Ÿ3: è¤‡é›œå•é¡Œæ‰ç”¨ Claudeï¼ˆä½¿ç”¨ Haiku çœéŒ¢ï¼‰
    const now = new Date();
    const taipeiTime = new Date(now.toLocaleString('en-US', { timeZone: 'Asia/Taipei' }));
    const currentHour = taipeiTime.getHours();
    const currentDay = taipeiTime.getDay();
    const dayNames = ['é€±æ—¥', 'é€±ä¸€', 'é€±äºŒ', 'é€±ä¸‰', 'é€±å››', 'é€±äº”', 'é€±å…­'];
    const timeInfo = `${dayNames[currentDay]} ${currentHour}:${taipeiTime.getMinutes().toString().padStart(2, '0')}`;
    
    const message = await anthropic.messages.create({
      model: "claude-haiku-4-5-20251001",
      max_tokens: 400,
      system: LAUNDRY_KNOWLEDGE_COMPACT,
      messages: [{
        role: "user",
        content: `${timeInfo} | ${userMessage}`
      }]
    });

    const claudeReply = message.content[0].text;

    // è¨˜éŒ„ token ä½¿ç”¨é‡ï¼ˆç›£æ§æˆæœ¬ï¼‰
    console.log(`[Claude] Input: ${message.usage.input_tokens} tokens, Output: ${message.usage.output_tokens} tokens, Cost: $${(message.usage.input_tokens * 0.0000008 + message.usage.output_tokens * 0.000004).toFixed(6)}`);

    if (claudeReply.includes('UNRELATED')) {
      return null;
    }

    // å¦‚æœæ˜¯æ”¶ä»¶å•é¡Œä¸”æœ‰å›è¦†ï¼Œè¨˜ä½é€™å€‹å®¢äºº
    if (isPickupQuestion && userId && claudeReply) {
      pickupRepliedUsers.set(userId, Date.now());
    }

    return claudeReply;

  } catch (error) {
    console.error('[Claude AI] éŒ¯èª¤:', error);
    return null;
  }
}

// ====================================
// è™•ç†åœ–ç‰‡è¨Šæ¯ï¼ˆOpenAI æ±™æ¼¬åˆ†æï¼‰
// ====================================
async function handleImageMessage(imageBuffer) {
  try {
    const base64Image = imageBuffer.toString('base64');

    const response = await openai.chat.completions.create({
      model: "gpt-4o",
      messages: [
        {
          role: "user",
          content: [
            { 
              type: "text", 
              text: "è«‹åˆ†æé€™å¼µè¡£ç‰©ç…§ç‰‡ä¸Šçš„æ±™æ¼¬é¡å‹ï¼Œä¸¦å»ºè­°æ¸…æ´—æ–¹å¼ã€‚è«‹ç”¨ç¹é«”ä¸­æ–‡ç°¡æ½”å›ç­”ï¼ŒåŒ…å«ï¼š1)æ±™æ¼¬é¡å‹ 2)å»ºè­°è™•ç†æ–¹å¼ 3)é ä¼°æ¸…æ´—æ•ˆæœï¼ˆä½†è¦èªªæ˜ä¸ä¿è­‰å®Œå…¨å»é™¤ï¼‰" 
            },
            {
              type: "image_url",
              image_url: {
                url: `data:image/jpeg;base64,${base64Image}`
              }
            }
          ]
        }
      ],
      max_tokens: 500
    });

    const analysis = response.choices[0].message.content;

    const replyMessage = `ğŸ” AI æ±™æ¼¬åˆ†æçµæœ

${analysis}

âš ï¸ é‡è¦æé†’ï¼š
æ±™æ¼¬è™•ç†ã€ä¸ä¿è­‰èƒ½å®Œå…¨å»é™¤ã€‘
å¯¦éš›æ¸…æ´—æ•ˆæœéœ€ç”±å°ˆæ¥­å¸«å‚…è©•ä¼°
è‹¥æ±™æ¼¬å·²æ·±å…¥çº–ç¶­æˆ–æ™‚é–“éä¹…ï¼Œå¯èƒ½ç„¡æ³•å®Œå…¨è™•ç†

C.H ç²¾ç·»æ´—è¡£ ğŸ’™`;

    return replyMessage;

  } catch (error) {
    console.error('[OpenAI] æ±™æ¼¬åˆ†æéŒ¯èª¤:', error);
    return 'æ„Ÿè¬æ‚¨æä¾›ç…§ç‰‡ï¼æˆ‘å€‘çš„å°ˆæ¥­å¸«å‚…æœƒä»”ç´°è©•ä¼°æ±™æ¼¬ç‹€æ³ã€‚\n\nâš ï¸ æé†’ï¼šæ±™æ¼¬è™•ç†ä¸ä¿è­‰èƒ½å®Œå…¨å»é™¤ ğŸ’™';
  }
}

// ====================================
// åŒ¯å‡ºåŠŸèƒ½
// ====================================
module.exports = {
  handleTextMessage,
  handleImageMessage
};
