<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>C.H ç²¾ç·»æ´—è¡£ - ä»˜æ¬¾ç®¡ç†ç³»çµ±</title>
  <link rel="manifest" href="/manifest.json">
  <meta name="theme-color" content="#667eea">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="C.Hæ´—è¡£">
  <link rel="apple-touch-icon" href="/icon-192.png">
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: 'Segoe UI', sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; padding: 20px; }
    .container { max-width: 900px; margin: 0 auto; background: #fff; border-radius: 20px; padding: 30px; box-shadow: 0 20px 60px rgba(0,0,0,.3); }
    h1 { color: #667eea; text-align: center; margin-bottom: 10px; font-size: 28px; }
    .subtitle { text-align: center; color: #666; margin-bottom: 30px; font-size: 14px; }
    .tabs { display: flex; gap: 10px; margin-bottom: 30px; border-bottom: 2px solid #e0e0e0; flex-wrap: wrap; }
    .tab { padding: 12px 20px; background: none; border: none; color: #666; font-size: 15px; font-weight: 600; cursor: pointer; border-bottom: 3px solid transparent; transition: all .3s; }
    .tab:hover { color: #667eea; }
    .tab.active { color: #667eea; border-bottom-color: #667eea; }
    .tab-content { display: none; }
    .tab-content.active { display: block; }
    .form-group { margin-bottom: 20px; }
    label { display: block; margin-bottom: 8px; color: #333; font-weight: 600; font-size: 14px; }
    input, textarea, select { width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 10px; font-size: 16px; transition: all .3s; font-family: inherit; }
    textarea { min-height: 120px; resize: vertical; }
    input:focus, textarea:focus, select:focus { outline: none; border-color: #667eea; box-shadow: 0 0 0 3px rgba(102,126,234,.1); }
    .quick-search { display: flex; gap: 10px; }
    .btn { width: 100%; padding: 15px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: #fff; border: none; border-radius: 12px; font-size: 18px; font-weight: 600; cursor: pointer; transition: all .3s; }
    .btn:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(102,126,234,.6); }
    .btn:disabled { background: #ccc; cursor: not-allowed; transform: none; }
    .btn-small { padding: 10px 20px; font-size: 14px; width: auto; }
    .btn-secondary { background: linear-gradient(135deg, #52c41a 0%, #389e0d 100%); }
    .btn-danger { background: linear-gradient(135deg, #dc3545 0%, #c82333 100%); }
    .payment-options { display: grid; grid-template-columns: repeat(3,1fr); gap: 15px; margin-bottom: 20px; }
    .payment-option { position: relative; }
    .payment-option input[type="radio"] { position: absolute; opacity: 0; }
    .payment-option label { display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 15px; border: 2px solid #e0e0e0; border-radius: 15px; cursor: pointer; transition: all .3s; text-align: center; height: 100%; }
    .payment-option input[type="radio"]:checked + label { border-color: #667eea; background: #f0f4ff; transform: translateY(-2px); box-shadow: 0 5px 15px rgba(102,126,234,.2); }
    .payment-icon { font-size: 28px; margin-bottom: 5px; }
    .payment-name { font-size: 13px; font-weight: 600; color: #333; }
    .message-templates { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; margin-bottom: 15px; }
    .template-btn { padding: 12px; background: #f5f5f5; border: 2px solid #e0e0e0; border-radius: 8px; cursor: pointer; font-size: 14px; transition: all .3s; text-align: left; }
    .template-btn:hover { border-color: #667eea; background: #f0f4ff; }
    .template-btn.active { border-color: #667eea; background: #e7f0ff; }
    .result { margin-top: 20px; padding: 20px; border-radius: 12px; display: none; }
    .result.success { background: #d4edda; border: 2px solid #28a745; color: #155724; }
    .result.error { background: #f8d7da; border: 2px solid #dc3545; color: #721c24; }
    .loading { display: none; text-align: center; margin-top: 20px; }
    .loading-spinner { border: 4px solid #f3f3f3; border-top: 4px solid #667eea; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin: 0 auto 10px; }
    @keyframes spin { 0%{transform:rotate(0)} 100%{transform:rotate(360deg)} }
    .user-item { background: #f8f9fa; padding: 15px; margin-bottom: 10px; border-radius: 8px; border: 1px solid #e0e0e0; transition: all .3s; display: flex; align-items: center; gap: 15px; }
    .user-item:hover { border-color: #667eea; box-shadow: 0 2px 8px rgba(102,126,234,.2); }
    .user-info { flex: 1; cursor: pointer; }
    .user-info strong { color: #333; font-size: 16px; display: block; margin-bottom: 5px; }
    .user-info small { display: block; color: #999; font-size: 12px; margin-top: 3px; }
    .customer-card { background: #f0f4ff; padding: 15px; border-radius: 10px; margin-bottom: 20px; border-left: 4px solid #667eea; }
    .customer-card h4 { color: #667eea; margin-bottom: 10px; }
    .customer-card p { margin: 5px 0; font-size: 14px; color: #333; }
    .template-item { background: #fff; padding: 12px; margin-bottom: 10px; border-radius: 8px; border: 1px solid #e0e0e0; }
    @media (max-width: 768px){
      .container{padding:20px}
      h1{font-size:24px}
      .payment-options{grid-template-columns:1fr}
      .message-templates{grid-template-columns:1fr}
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>ğŸ’³ ä»˜æ¬¾ç®¡ç†ç³»çµ±</h1>
    <p class="subtitle">C.H ç²¾ç·»æ´—è¡£ - ç™¼é€ä»˜æ¬¾é€£çµçµ¦å®¢æˆ¶</p>

    <div class="tabs">
      <button class="tab active" onclick="switchTab(event,'payment')">ğŸ’³ ç™¼é€ä»˜æ¬¾</button>
      <button class="tab" onclick="switchTab(event,'notify')">ğŸ“¢ ç´”æ–‡å­—é€šçŸ¥</button>
      <button class="tab" onclick="switchTab(event,'orders')">ğŸ“¦ è¨‚å–®ç®¡ç†</button>
      <button class="tab" onclick="switchTab(event,'customers')">ğŸ“‹ å®¢æˆ¶ç·¨è™Ÿ</button>
      <button class="tab" onclick="switchTab(event,'templates')">ğŸ“ è¨Šæ¯æ¨¡æ¿</button>
      <button class="tab" onclick="switchTab(event,'users')">ğŸ‘¥ å®¢æˆ¶åˆ—è¡¨</button>
      <button class="tab" onclick="switchTab(event,'pickup')">ğŸ§º å–ä»¶è¿½è¹¤</button>
      <button class="tab" onclick="switchTab(event,'delivery')">ğŸšš å¤–é€æ’ç¨‹</button>
      <button class="tab" onclick="switchTab(event,'manual')">ğŸ“ äººå·¥é€šçŸ¥</button>
      <button class="tab" onclick="switchTab(event,'records')">ğŸ‘¤ å®¢äººç´€éŒ„</button>
      <button class="tab" onclick="switchTab(event,'urgent')">âš¡ æ€¥ä»¶è¿½è¹¤</button>
    </div>

    <div id="payment-tab" class="tab-content active">
      <div class="form-group">
        <label>ğŸ” å¿«é€ŸæŸ¥è©¢</label>
        <div class="quick-search">
          <input type="text" id="quickSearch" placeholder="è¼¸å…¥ç·¨è™Ÿæˆ–å§“å">
          <button class="btn btn-small" onclick="quickSearchCustomer()">æŸ¥è©¢</button>
        </div>
      </div>

      <div id="customerCard" class="customer-card" style="display:none;">
        <h4>âœ… å®¢æˆ¶è³‡è¨Š</h4>
        <p><strong>ç·¨è™Ÿ:</strong> <span id="cardNumber"></span></p>
        <p><strong>å§“å:</strong> <span id="cardName"></span></p>
        <p><strong>User ID:</strong> <span id="cardUserId"></span></p>
      </div>

      <form id="paymentForm">
        <div class="form-group">
          <label>å®¢æˆ¶ LINE User ID *</label>
          <input type="text" id="userId" placeholder="U1234567890abcdef" required>
        </div>
        <div class="form-group">
          <label>å®¢æˆ¶å§“å *</label>
          <input type="text" id="userName" placeholder="ç‹å°æ˜" required>
        </div>
        <div class="form-group">
          <label>ä»˜æ¬¾é‡‘é¡ (NT$) *</label>
          <input type="number" id="amount" placeholder="1500" min="1" required>
        </div>

        <div class="form-group">
          <label>ä»˜æ¬¾æ–¹å¼ *</label>
          <div class="payment-options">
            <div class="payment-option">
              <input type="radio" id="both" name="paymentType" value="both" checked>
              <label for="both"><div class="payment-icon">ğŸ’™</div><div class="payment-name">å…©è€…éƒ½ç™¼</div></label>
            </div>
            <div class="payment-option">
              <input type="radio" id="ecpay" name="paymentType" value="ecpay">
              <label for="ecpay"><div class="payment-icon">ğŸ’³</div><div class="payment-name">ç¶ ç•Œæ”¯ä»˜</div></label>
            </div>
            <div class="payment-option">
              <input type="radio" id="linepay" name="paymentType" value="linepay">
              <label for="linepay"><div class="payment-icon">ğŸ’š</div><div class="payment-name">LINE Pay</div></label>
            </div>
          </div>
        </div>

        <div class="form-group">
          <label>è¨Šæ¯å…§å®¹</label>
          <div id="customTemplates" class="message-templates"></div>
          <textarea id="customMessage" placeholder="è¼¸å…¥è¨Šæ¯å…§å®¹,ä½¿ç”¨ {amount} æœƒè‡ªå‹•æ›¿æ›æˆé‡‘é¡&#10;&#10;ä¾‹å¦‚: æ‚¨å¥½,å·²æ”¶å›è¡£ç‰©,é‡‘é¡ NT$ {amount},è«‹å„˜é€Ÿä»˜æ¬¾,è¬è¬!"></textarea>
        </div>

       <button type="submit" class="btn" id="submitBtn">ğŸ’™ ç™¼é€ä»˜æ¬¾é€£çµ</button>
      </form>

     
      <div class="loading" id="loading">
        <div class="loading-spinner"></div>
        <p>æ­£åœ¨ç™¼é€...</p>
      </div>
      <div class="result" id="result"></div>
    </div>

    <div id="orders-tab" class="tab-content">
      <h3 style="color:#667eea; margin-bottom:20px;">ğŸ“¦ è¨‚å–®ç®¡ç†</h3>
      <div style="display:flex; gap:10px; margin-bottom:20px; flex-wrap:wrap;">
        <button class="btn btn-secondary btn-small" onclick="loadOrders()">ğŸ”„ é‡æ–°æ•´ç†</button>
        <button class="btn btn-secondary btn-small" onclick="sendReminders()">â° ç™¼é€ä»˜æ¬¾æé†’</button>
        <button class="btn btn-secondary btn-small" onclick="cleanExpired()">ğŸ§¹ æ¸…ç†éæœŸè¨‚å–®</button>
      </div>

      <div id="orderStats" style="display:grid; grid-template-columns:repeat(auto-fit, minmax(150px, 1fr)); gap:15px; margin-bottom:20px;"></div>

      <div class="form-group">
        <label>ğŸ” å¿«é€Ÿæœå°‹è¨‚å–®</label>
        <input type="text" id="orderSearchInput" placeholder="è¼¸å…¥è¨‚å–®ç·¨è™Ÿæˆ–å®¢æˆ¶å§“å" oninput="searchOrders()">
      </div>

      <div style="margin-bottom:15px;">
        <label style="font-size:14px; color:#666;">ç¯©é¸ç‹€æ…‹:</label>
        <select id="orderStatusFilter" onchange="filterOrders()" style="padding:8px; border-radius:8px; border:2px solid #e0e0e0;">
          <option value="">å…¨éƒ¨è¨‚å–®</option>
          <option value="pending">å¾…ä»˜æ¬¾</option>
          <option value="paid">å·²ä»˜æ¬¾</option>
          <option value="expired">å·²éæœŸ</option>
        </select>
      </div>

      <div id="orderList"><p style="text-align:center; color:#999;">å°šæœªè¼‰å…¥è¨‚å–®ï¼Œè«‹é»ã€Œé‡æ–°æ•´ç†ã€ã€‚</p></div>

      <div id="customerHistoryModal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,.5); z-index:1000; padding:20px; overflow:auto;">
        <div style="background:#fff; max-width:800px; margin:50px auto; border-radius:20px; padding:30px; position:relative;">
          <button onclick="closeCustomerHistory()" style="position:absolute; top:15px; right:15px; background:#dc3545; color:#fff; border:none; padding:8px 15px; border-radius:5px; cursor:pointer; font-size:16px;">âœ•</button>
          <h3 style="color:#667eea; margin-bottom:20px;">ğŸ‘¤ å®¢æˆ¶ä»˜æ¬¾æ­·å²</h3>
          <div id="customerHistoryContent"></div>
        </div>
      </div>
    </div>

    <div id="customers-tab" class="tab-content">
      <h3 style="color:#667eea; margin-bottom:20px;">ğŸ“‹ å®¢æˆ¶ç·¨è™Ÿç®¡ç†</h3>
      ### å®¢æˆ¶ç·¨è™Ÿç®¡ç†
    <input id="user-id-input" placeholder="User ID (e.g. Uxxxxxx)" style="width:300px;margin:5px;">
    <input id="user-name-input" placeholder="å§“å" style="width:150px;margin:5px;">
    <button id="save-user" style="margin:5px;">å„²å­˜ User ID</button>
    <button id="send-payment" style="margin:5px;">ç™¼é€æ”¯ä»˜é€£çµ</button>
    <input id="amount" type="number" placeholder="é‡‘é¡" style="width:120px;margin:5px;">

<div id="customer-list" style="margin-top:15px; max-height:200px; overflow-y:auto; border:1px solid #ccc; padding:10px;"></div>
      <div class="form-group">
        <label>å®¢æˆ¶ç·¨è™Ÿ</label>
        <input type="text" id="newCustomerNumber" placeholder="ä¾‹å¦‚: 755">
      </div>
      <div class="form-group">
        <label>å®¢æˆ¶å§“å</label>
        <input type="text" id="newCustomerName" placeholder="ä¾‹å¦‚: ç‹å°æ˜">
      </div>
      <div class="form-group">
        <label>User ID</label>
        <input type="text" id="newCustomerUserId" placeholder="U1234567890abcdef">
      </div>
      <button class="btn btn-secondary" onclick="saveCustomerNumber()">ğŸ’¾ å„²å­˜å®¢æˆ¶ç·¨è™Ÿ</button>

      <div style="margin-top:30px;">
        <h4 style="color:#667eea; margin-bottom:15px;">å·²å„²å­˜çš„å®¢æˆ¶ç·¨è™Ÿ</h4>
        <div id="savedCustomers"></div>
      </div>
    </div>

    <div id="templates-tab" class="tab-content">
      <h3 style="color:#667eea; margin-bottom:20px;">ğŸ“ è¨Šæ¯æ¨¡æ¿ç®¡ç†</h3>
      <div class="form-group">
        <label>æ–°å¢æ¨¡æ¿ (ä½¿ç”¨ {amount} ä»£è¡¨é‡‘é¡)</label>
        <textarea id="newTemplateContent" placeholder="ä¾‹å¦‚: æ‚¨å¥½,å·²æ”¶å›è¡£ç‰©,é‡‘é¡ NT$ {amount},è«‹å„˜é€Ÿä»˜æ¬¾,è¬è¬!"></textarea>
      </div>
      <button class="btn btn-secondary" onclick="saveTemplate()">ğŸ’¾ å„²å­˜æ¨¡æ¿</button>

      <div style="margin-top:30px;">
        <h4 style="color:#667eea; margin-bottom:15px;">æˆ‘çš„æ¨¡æ¿</h4>
        <div id="templateList"></div>
      </div>
    </div>

    <div id="users-tab" class="tab-content">
      <h3 style="color:#667eea; margin-bottom:20px;">ğŸ‘¥ å®¢æˆ¶åˆ—è¡¨</h3>
      <button class="btn btn-secondary btn-small" onclick="loadUsers()" style="margin-bottom:20px;">ğŸ”„ é‡æ–°è¼‰å…¥</button>
      <div id="userList"><p style="text-align:center; color:#999;">å°šæœªè¼‰å…¥ï¼Œè«‹é»ã€Œé‡æ–°è¼‰å…¥ã€ã€‚</p></div>
    </div>
  </div>
<!-- ğŸ§º å–ä»¶è¿½è¹¤åˆ†é  -->
    <div id="pickup-tab" class="tab-content">
      <h3 style="color:#667eea; margin-bottom:20px;">ğŸ§º å–ä»¶è¿½è¹¤ç®¡ç†</h3>
      
      <div class="form-group">
        <label>ğŸ” å¿«é€ŸæŸ¥è©¢å®¢æˆ¶ï¼ˆç”¨å®¢æˆ¶ç·¨è™Ÿï¼‰</label>
        <div class="quick-search">
          <input type="text" id="pickupSearch" placeholder="è¼¸å…¥ç·¨è™Ÿï¼ˆä¾‹å¦‚: 001ã€625ï¼‰">
          <button class="btn btn-small" onclick="searchForPickup()">æŸ¥è©¢</button>
        </div>
      </div>

      <div id="pickupCustomerCard" class="customer-card" style="display:none;">
        <h4>âœ… å®¢æˆ¶è³‡è¨Š</h4>
        <p><strong>ç·¨è™Ÿ:</strong> <span id="pickupCardNumber"></span></p>
        <p><strong>å§“å:</strong> <span id="pickupCardName"></span></p>
        <p><strong>User ID:</strong> <span id="pickupCardUserId"></span></p>
      </div>

      <div style="background:#f8f9fa; padding:20px; border-radius:10px; margin-bottom:20px;">
        <h4 style="color:#667eea; margin-bottom:15px;">â• æ–°å¢å–ä»¶è¿½è¹¤</h4>
        <div class="form-group">
          <label>å®¢æˆ¶ç·¨è™Ÿ *</label>
          <input type="text" id="pickupNumber" placeholder="001">
        </div>
        <div class="form-group">
          <label>å®¢æˆ¶å§“å *</label>
          <input type="text" id="pickupName" placeholder="ç‹å°æ˜">
        </div>
        <div class="form-group">
          <label>User ID *</label>
          <input type="text" id="pickupUserId" placeholder="U123...">
        </div>
        <button class="btn btn-secondary" onclick="startPickup()">ğŸ¯ é–‹å§‹è¿½è¹¤ï¼ˆ7å¤©å¾Œ11é»æé†’ï¼‰</button>
      </div>

      <div style="display:flex; gap:10px; margin-bottom:20px; flex-wrap:wrap;">
        <button class="btn btn-small btn-secondary" onclick="loadPickups()">ğŸ”„ é‡æ–°æ•´ç†</button>
        <button class="btn btn-small btn-secondary" onclick="editTemplate()">ğŸ“ ç·¨è¼¯æ¨¡æ¿</button>
      </div>

      <div id="pickupList"><p style="text-align:center; color:#999;">å°šæœªè¼‰å…¥ï¼Œè«‹é»ã€Œé‡æ–°æ•´ç†ã€ã€‚</p></div>
    </div>

  <!-- ğŸšš å¤–é€æ’ç¨‹åˆ†é  -->
<div id="delivery-tab" class="tab-content">
  <h3 style="color:#667eea; margin-bottom:20px;">ğŸšš å¤–é€æ’ç¨‹ / ç´€éŒ„</h3>
  
  <!-- å¿«é€ŸæŸ¥è©¢ -->
  <div class="form-group">
    <label>ğŸ” å¿«é€ŸæŸ¥è©¢å®¢æˆ¶ï¼ˆç”¨å®¢æˆ¶ç·¨è™Ÿï¼‰</label>
    <div class="quick-search">
      <input type="text" id="deliverySearch" placeholder="è¼¸å…¥ç·¨è™Ÿï¼ˆä¾‹å¦‚: 001ã€625ï¼‰">
      <button class="btn btn-small" onclick="searchForDelivery()">æŸ¥è©¢</button>
    </div>
  </div>

  <!-- å®¢æˆ¶è³‡è¨Šå¡ç‰‡ -->
  <div id="deliveryCustomerCard" class="customer-card" style="display:none;">
    <h4>âœ… å®¢æˆ¶è³‡è¨Š</h4>
    <p><strong>ç·¨è™Ÿ:</strong> <span id="deliveryCardNumber"></span></p>
    <p><strong>å§“å:</strong> <span id="deliveryCardName"></span></p>
  </div>

  <!-- æ–°å¢å¤–é€ç´€éŒ„ -->
  <div style="background:#f8f9fa; padding:20px; border-radius:10px; margin-bottom:20px;">
    <h4 style="color:#667eea; margin-bottom:15px;">â• æ–°å¢å¤–é€ç´€éŒ„</h4>

    <div class="form-group">
      <label>å®¢æˆ¶ç·¨è™Ÿ *</label>
      <input type="text" id="deliveryNumber" placeholder="001">
    </div>

    <div class="form-group">
      <label>å®¢æˆ¶å§“å *</label>
      <input type="text" id="deliveryName" placeholder="ç‹å°æ˜">
    </div>

    <div class="form-group">
      <label>é‡‘é¡ (NT$) *</label>
      <input type="number" id="deliveryAmount" min="0" placeholder="300">
    </div>

    <div class="form-group">
      <label>é€šçŸ¥ç‹€æ…‹</label>
      <div style="display:flex; gap:15px; flex-wrap:wrap;">
        <label style="display:flex; align-items:center; gap:5px; font-size:14px;">
          <input type="radio" name="deliveryNotifyStatus" value="not_sent" checked> æœªç™¼é€è‡ªå‹•é€šçŸ¥
        </label>
        <label style="display:flex; align-items:center; gap:5px; font-size:14px;">
          <input type="radio" name="deliveryNotifyStatus" value="sent"> å·²ç™¼é€è‡ªå‹•é€šçŸ¥
        </label>
      </div>
    </div>

    <div class="form-group">
      <label>æŒ‡å®šå¤–é€æ—¥æœŸï¼ˆå¯é¸ï¼‰</label>
      <input type="date" id="deliveryDate">
      <small style="display:block; color:#999; margin-top:5px;">
        è‹¥æœ‰æŒ‡å®šï¼Œç•¶å¤©æ‰“é–‹ç³»çµ±æœƒè‡ªå‹•æé†’ä½ ä»Šå¤©æœ‰å“ªäº›å¤–é€ã€‚
      </small>
    </div>

    <div class="form-group">
      <label>å‚™è¨»</label>
      <textarea id="deliveryNote" placeholder="ä¾‹å¦‚ï¼šæ™šä¸Š 8 é»å‰é€é”ã€éœ€å…ˆé›»è©±è¯çµ¡ç­‰"></textarea>
    </div>

    <button class="btn btn-secondary" onclick="addDelivery()">ğŸ’¾ æ–°å¢å¤–é€ç´€éŒ„</button>
  </div>

  <!-- æ“ä½œåˆ— -->
  <div style="display:flex; gap:10px; margin-bottom:20px; flex-wrap:wrap;">
    <button class="btn btn-small btn-secondary" onclick="loadDeliveries(true)">ğŸ”„ é‡æ–°æ•´ç†</button>
  </div>

  <!-- å¤–é€ç´€éŒ„åˆ—è¡¨ï¼ˆä¾æ—¥æœŸåˆ†çµ„ï¼‰ -->
  <div id="deliveryList">
    <p style="text-align:center; color:#999;">å°šæœªè¼‰å…¥ï¼Œè«‹é»ã€Œé‡æ–°æ•´ç†ã€ã€‚</p>
  </div>
</div>

<!-- âš¡ æ€¥ä»¶è¿½è¹¤åˆ†é  -->
<div id="urgent-tab" class="tab-content">
  <h3 style="color:#667eea; margin-bottom:20px;">âš¡ æ€¥ä»¶è¿½è¹¤ç®¡ç†</h3>
  
  <!-- å¿«é€ŸæŸ¥è©¢ -->
  <div class="form-group">
    <label>ğŸ” å¿«é€ŸæŸ¥è©¢å®¢æˆ¶ï¼ˆç”¨å®¢æˆ¶ç·¨è™Ÿï¼‰</label>
    <div class="quick-search">
      <input type="text" id="urgentSearch" placeholder="è¼¸å…¥ç·¨è™Ÿï¼ˆä¾‹å¦‚: 001ã€625ï¼‰">
      <button class="btn btn-small" onclick="searchForUrgent()">æŸ¥è©¢</button>
    </div>
  </div>

  <!-- å®¢æˆ¶è³‡è¨Šå¡ç‰‡ -->
  <div id="urgentCustomerCard" class="customer-card" style="display:none;">
    <h4>âœ… å®¢æˆ¶è³‡è¨Š</h4>
    <p><strong>ç·¨è™Ÿ:</strong> <span id="urgentCardNumber"></span></p>
    <p><strong>å§“å:</strong> <span id="urgentCardName"></span></p>
  </div>

  <!-- æ–°å¢æ€¥ä»¶è¿½è¹¤ -->
  <div style="background:#f8f9fa; padding:20px; border-radius:10px; margin-bottom:20px;">
    <h4 style="color:#667eea; margin-bottom:15px;">â• æ–°å¢æ€¥ä»¶è¿½è¹¤</h4>

    <div class="form-group">
      <label>å®¢æˆ¶ç·¨è™Ÿ *</label>
      <input type="text" id="urgentNumber" placeholder="001">
    </div>

    <div class="form-group">
      <label>å®¢æˆ¶å§“å *</label>
      <input type="text" id="urgentName" placeholder="ç‹å°æ˜">
    </div>

    <div class="form-group">
      <label>è¡£ç‰©ç·¨è™Ÿç¯„åœ *</label>
      <input type="text" id="urgentClothesRange" placeholder="ä¾‹å¦‚: 001-005">
      <small style="display:block; color:#999; margin-top:5px;">
        æ ¼å¼ï¼šèµ·å§‹ç·¨è™Ÿ-çµæŸç·¨è™Ÿ
      </small>
    </div>

    <div class="form-group">
      <label>æ€¥ä»¶è¿½è¹¤æ—¥æœŸï¼ˆå»å·¥å» æé†’ï¼‰*</label>
      <input type="date" id="urgentTrackDate">
      <small style="display:block; color:#999; margin-top:5px;">
        ç•¶å¤©æ‰“é–‹ç³»çµ±æœƒè‡ªå‹•æé†’ä½ å»å·¥å» è¿½è¹¤è¡£ç‰©
      </small>
    </div>

    <div class="form-group">
      <label>å–ä»¶æé†’æ—¥æœŸï¼ˆå®¢æˆ¶è¦æ‹¿ï¼‰*</label>
      <input type="date" id="urgentPickupDate">
      <small style="display:block; color:#999; margin-top:5px;">
        ç•¶å¤©æ‰“é–‹ç³»çµ±æœƒè‡ªå‹•æé†’ä½ å®¢æˆ¶è¦å–ä»¶äº†
      </small>
    </div>

    <div class="form-group">
      <label>å‚™è¨»</label>
      <textarea id="urgentNote" placeholder="ä¾‹å¦‚ï¼šå®¢æˆ¶è¦åƒåŠ å©šç¦®ã€æ€¥éœ€ç­‰"></textarea>
    </div>

    <button class="btn btn-secondary" onclick="addUrgent()">ğŸ’¾ æ–°å¢æ€¥ä»¶è¿½è¹¤</button>
  </div>

  <!-- æ“ä½œåˆ— -->
  <div style="display:flex; gap:10px; margin-bottom:20px; flex-wrap:wrap;">
    <button class="btn btn-small btn-secondary" onclick="loadUrgents(true)">ğŸ”„ é‡æ–°æ•´ç†</button>
  </div>

  <!-- æ€¥ä»¶è¿½è¹¤åˆ—è¡¨ -->
  <div id="urgentList">
    <p style="text-align:center; color:#999;">å°šæœªè¼‰å…¥ï¼Œè«‹é»ã€Œé‡æ–°æ•´ç†ã€ã€‚</p>
  </div>
</div>

<!-- ğŸ“ äººå·¥é€šçŸ¥åˆ†é  -->
<div id="manual-tab" class="tab-content">
  <h3 style="color:#667eea; margin-bottom:20px;">ğŸ“ äººå·¥é€šçŸ¥ç´€éŒ„</h3>
  
  <!-- å¿«é€ŸæŸ¥è©¢ -->
  <div class="form-group">
    <label>ğŸ” å¿«é€ŸæŸ¥è©¢å®¢æˆ¶ï¼ˆç”¨å®¢æˆ¶ç·¨è™Ÿï¼‰</label>
    <div class="quick-search">
      <input type="text" id="manualSearch" placeholder="è¼¸å…¥ç·¨è™Ÿï¼ˆä¾‹å¦‚: 001ã€625ï¼‰">
      <button class="btn btn-small" onclick="searchForManual()">æŸ¥è©¢</button>
    </div>
  </div>

  <!-- å®¢æˆ¶è³‡è¨Šå¡ç‰‡ -->
  <div id="manualCustomerCard" class="customer-card" style="display:none;">
    <h4>âœ… å®¢æˆ¶è³‡è¨Š</h4>
    <p><strong>ç·¨è™Ÿ:</strong> <span id="manualCardNumber"></span></p>
    <p><strong>å§“å:</strong> <span id="manualCardName"></span></p>
  </div>

  <!-- æ–°å¢äººå·¥é€šçŸ¥ -->
  <div style="background:#f8f9fa; padding:20px; border-radius:10px; margin-bottom:20px;">
    <h4 style="color:#667eea; margin-bottom:15px;">â• æ–°å¢äººå·¥é€šçŸ¥ç´€éŒ„</h4>

    <div class="form-group">
      <label>å®¢æˆ¶ç·¨è™Ÿ *</label>
      <input type="text" id="manualNumber" placeholder="001">
    </div>

    <div class="form-group">
      <label>å®¢æˆ¶å§“å *</label>
      <input type="text" id="manualName" placeholder="ç‹å°æ˜">
    </div>

<!-- â­ æ–°å¢é‡‘é¡æ¬„ä½ -->
    <div class="form-group">
      <label>é‡‘é¡ (NT$)</label>
      <input type="number" id="manualAmount" min="0" placeholder="300">
      <small style="display:block; color:#999; margin-top:5px;">
        è‹¥ä¸éœ€è¦æ”¶è²»ï¼Œè«‹å¡« 0 æˆ–ç•™ç©º
      </small>
    </div>
    
    <div class="form-group">
      <label>æ˜¯å¦éœ€è¦å¤–é€ *</label>
      <div style="display:flex; gap:15px; flex-wrap:wrap;">
        <label style="display:flex; align-items:center; gap:5px; font-size:14px;">
          <input type="radio" name="manualNeedDelivery" value="yes" checked> éœ€è¦å¤–é€
        </label>
        <label style="display:flex; align-items:center; gap:5px; font-size:14px;">
          <input type="radio" name="manualNeedDelivery" value="no"> ä¸éœ€è¦å¤–é€
        </label>
      </div>
    </div>

    <div class="form-group">
      <label>é€šçŸ¥å…§å®¹</label>
      <textarea id="manualContent" placeholder="ä¾‹å¦‚ï¼šå·²é€šçŸ¥å®¢æˆ¶è¡£ç‰©è™•ç†å®Œæˆã€å·²å‘ŠçŸ¥å–ä»¶æ™‚é–“ç­‰"></textarea>
    </div>

    <button class="btn btn-secondary" onclick="addManual()">ğŸ’¾ æ–°å¢äººå·¥é€šçŸ¥ç´€éŒ„</button>
  </div>

  <!-- æ“ä½œåˆ— -->
  <div style="display:flex; gap:10px; margin-bottom:20px; flex-wrap:wrap;">
    <button class="btn btn-small btn-secondary" onclick="loadManuals()">ğŸ”„ é‡æ–°æ•´ç†</button>
  </div>

  <!-- äººå·¥é€šçŸ¥åˆ—è¡¨ï¼ˆä¾æ—¥æœŸåˆ†çµ„ï¼‰ -->
  <div id="manualList">
    <p style="text-align:center; color:#999;">å°šæœªè¼‰å…¥ï¼Œè«‹é»ã€Œé‡æ–°æ•´ç†ã€ã€‚</p>
  </div>
</div>

<!-- ğŸ‘¤ å®¢äººç´€éŒ„åˆ†é  -->
<div id="records-tab" class="tab-content">
  <h3 style="color:#667eea; margin-bottom:20px;">ğŸ‘¤ å®¢äººå°è©±ç´€éŒ„</h3>
  <p style="color:#666; font-size:14px; margin-bottom:20px;">
    è‡ªå‹•è¨˜éŒ„æ‰€æœ‰åœ¨ LINE å®˜æ–¹å¸³è™Ÿèˆ‡æ‚¨å°è©±éçš„å®¢äºº
  </p>

  <!-- æœå°‹åŠŸèƒ½ -->
  <div class="form-group">
    <label>ğŸ” æœå°‹å®¢äºº</label>
    <input type="text" id="recordSearchInput" placeholder="è¼¸å…¥å§“åæˆ– User ID" oninput="searchRecords()">
  </div>

  <!-- çµ±è¨ˆè³‡è¨Š -->
  <div id="recordStats" style="display:grid; grid-template-columns:repeat(auto-fit, minmax(150px, 1fr)); gap:15px; margin-bottom:20px;">
    <div style="background:#f0f4ff; padding:15px; border-radius:10px; text-align:center;">
      <div style="font-size:24px; font-weight:bold; color:#667eea;" id="totalRecords">0</div>
      <div style="font-size:14px; color:#666;">ç¸½å®¢äººæ•¸</div>
    </div>
    <div style="background:#e7f0ff; padding:15px; border-radius:10px; text-align:center;">
      <div style="font-size:24px; font-weight:bold; color:#1890ff;" id="todayRecords">0</div>
      <div style="font-size:14px; color:#666;">ä»Šæ—¥æ–°å¢</div>
    </div>
    <div style="background:#d4edda; padding:15px; border-radius:10px; text-align:center;">
      <div style="font-size:24px; font-weight:bold; color:#28a745;" id="weekRecords">0</div>
      <div style="font-size:14px; color:#666;">æœ¬é€±æ–°å¢</div>
    </div>
  </div>

  <!-- æ“ä½œåˆ— -->
  <div style="display:flex; gap:10px; margin-bottom:20px; flex-wrap:wrap;">
    <button class="btn btn-small btn-secondary" onclick="loadRecords()">ğŸ”„ é‡æ–°æ•´ç†</button>
    <button class="btn btn-small" style="background:#52c41a;" onclick="exportRecords()">ğŸ“Š åŒ¯å‡ºè³‡æ–™</button>
  </div>

  <!-- å®¢äººåˆ—è¡¨ -->
  <div id="recordList">
    <p style="text-align:center; color:#999;">å°šæœªè¼‰å…¥ï¼Œè«‹é»ã€Œé‡æ–°æ•´ç†ã€ã€‚</p>
  </div>
</div>  

  
  <!-- ğŸ“¢ ç´”æ–‡å­—é€šçŸ¥åˆ†é  -->
<div id="notify-tab" class="tab-content">
  <h3 style="color:#667eea; margin-bottom:20px;">ğŸ“¢ ç´”æ–‡å­—é€šçŸ¥ï¼ˆç„¡ä»˜æ¬¾é€£çµï¼‰</h3>
  <p style="color: #666; font-size: 14px; margin-bottom: 20px;">é©ç”¨æ–¼ï¼šå·²ä»˜æ¬¾å®¢æˆ¶ã€åƒ…éœ€é€šçŸ¥é€é”ç­‰æƒ…æ³</p>

  <!-- å¿«é€Ÿæœå°‹ -->
  <div class="form-group">
    <label>ğŸ” å¿«é€ŸæŸ¥è©¢å®¢æˆ¶</label>
    <div class="quick-search">
      <input type="text" id="notifySearch" placeholder="è¼¸å…¥ç·¨è™Ÿæˆ–å§“å">
      <button class="btn btn-small" onclick="searchForNotify()">æŸ¥è©¢</button>
    </div>
  </div>

  <!-- å®¢æˆ¶è³‡è¨Šå¡ç‰‡ -->
  <div id="notifyCustomerCard" class="customer-card" style="display:none;">
    <h4>âœ… å®¢æˆ¶è³‡è¨Š</h4>
    <p><strong>ç·¨è™Ÿ:</strong> <span id="notifyCardNumber"></span></p>
    <p><strong>å§“å:</strong> <span id="notifyCardName"></span></p>
    <p><strong>User ID:</strong> <span id="notifyCardUserId"></span></p>
  </div>

  <!-- ç™¼é€è¡¨å–® -->
  <form id="notificationForm">
    <div class="form-group">
      <label>å®¢æˆ¶ User ID *</label>
      <input type="text" id="notifyUserId" placeholder="U1234567890abcdef" required>
    </div>
    <div class="form-group">
      <label>å®¢æˆ¶å§“å *</label>
      <input type="text" id="notifyUserName" placeholder="ç‹å°æ˜" required>
    </div>
    
    <div class="form-group">
      <label>é€šçŸ¥è¨Šæ¯æ¨¡æ¿</label>
      <div id="notifyTemplateList" style="max-height: 300px; overflow-y: auto; border: 2px solid #e0e0e0; border-radius: 10px; padding: 15px; background: #f8f9fa; margin-bottom: 15px;">
        <p style="color:#999; text-align:center;">å°šç„¡æ¨¡æ¿ï¼Œè«‹å…ˆæ–°å¢æ¨¡æ¿</p>
      </div>
      <textarea id="notifyMessage" placeholder="è¼¸å…¥é€šçŸ¥å…§å®¹ï¼Œä¾‹å¦‚ï¼š&#10;&#10;è¦ªæ„›çš„å®¢æˆ¶æ‚¨å¥½ï¼Œæ‚¨çš„è¡£ç‰©å·²é€é”åº—å…§ï¼Œæ­¡è¿å–ä»¶ï¼Œè¬è¬ï¼" required style="min-height: 150px;"></textarea>
    </div>

    <button type="submit" class="btn" style="background: linear-gradient(135deg, #52c41a 0%, #389e0d 100%);">ğŸ“¢ ç™¼é€ç´”æ–‡å­—é€šçŸ¥</button>
  </form>

  <!-- æ¨¡æ¿ç®¡ç†å€ -->
  <div style="margin-top: 40px; padding-top: 30px; border-top: 3px solid #e0e0e0;">
    <h4 style="color:#667eea; margin-bottom:20px;">ğŸ“ ç®¡ç†é€šçŸ¥æ¨¡æ¿</h4>
    
    <div class="form-group">
      <label>æ–°å¢é€šçŸ¥æ¨¡æ¿</label>
      <textarea id="newNotifyTemplate" placeholder="è¼¸å…¥æ–°æ¨¡æ¿å…§å®¹&#10;&#10;ä¾‹å¦‚ï¼šè¦ªæ„›çš„å®¢æˆ¶æ‚¨å¥½ï¼Œæ‚¨çš„è¡£ç‰©å·²é€é”åº—å…§ï¼Œæ­¡è¿å–ä»¶ï¼" style="min-height: 100px;"></textarea>
    </div>
    
    <div style="display: flex; gap: 10px; margin-bottom: 20px;">
      <button type="button" class="btn btn-secondary" onclick="addNotifyTemplate()">â• æ–°å¢æ¨¡æ¿</button>
      <button type="button" class="btn btn-small" style="background: #ff9800;" onclick="loadNotifyTemplates()">ğŸ”„ é‡æ–°è¼‰å…¥</button>
    </div>
  </div>
</div>

    <!-- æ¨¡æ¿ç·¨è¼¯ Modal -->
    <div id="templateModal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,.6); z-index:9999;">
      <div style="background:#fff; max-width:600px; margin:50px auto; padding:30px; border-radius:15px;">
        <h3>ğŸ“ ç·¨è¼¯æé†’æ¨¡æ¿</h3>
        <p style="font-size:13px; color:#666; margin-bottom:15px;">å¯ç”¨è®Šæ•¸ï¼š{å®¢æˆ¶å§“å}ã€{å®¢æˆ¶ç·¨è™Ÿ}ã€{å·²éå¤©æ•¸}</p>
        <textarea id="templateText" style="width:100%; min-height:120px; padding:10px; margin:15px 0; border:2px solid #e0e0e0; border-radius:8px;"></textarea>
        <div style="display:flex; gap:10px;">
          <button class="btn btn-secondary" onclick="saveTemplatePickup()">ğŸ’¾ å„²å­˜</button>
          <button class="btn" onclick="closeTemplateModal()">å–æ¶ˆ</button>
        </div>
      </div>
    </div>
  <script>
    var allUsers = [];
    var allOrders = [];
    var savedCustomers = {};
    var savedTemplates = [];
    var allPickupOrders = [];
    var allDeliveries = [];
    var allUrgents = [];
    var allManuals = [];
    var allRecords = [];

    async function initLoad() {
      try {
        await loadCustomerNumbers();
        await loadTemplates();
        loadCustomTemplates();
      } catch (error) {
        console.error('åˆå§‹åŒ–å¤±æ•—:', error);
      }
    }

    function switchTab(evt, tabName) {
      document.querySelectorAll('.tab').forEach(function(tab) { tab.classList.remove('active'); });
      document.querySelectorAll('.tab-content').forEach(function(content) { content.classList.remove('active'); });
      if (evt && evt.currentTarget) evt.currentTarget.classList.add('active');
      var pane = document.getElementById(tabName + '-tab');
      if (pane) pane.classList.add('active');

      if (tabName === 'payment') loadCustomTemplates();
      if (tabName === 'customers') displaySavedCustomers();
      if (tabName === 'templates') displayTemplates();
      if (tabName === 'users') loadUsers();
      if (tabName === 'orders') loadOrders();
      if (tabName === 'pickup') loadPickups();
      if (tabName === 'notify') loadNotifyTemplates();
      if (tabName === 'delivery') loadDeliveries(true);
      if (tabName === 'urgent') loadUrgents(true);
      if (tabName === 'manual') loadManuals();
      if (tabName === 'records') loadRecords();
    }

    async function loadCustomerNumbers() {
      try {
        var res = await fetch('/api/customer-numbers');
        var data = await res.json();
        if (data.success) {
          savedCustomers = {};
          (data.customers || []).forEach(function(c) {
            savedCustomers[c.number] = { name: c.name, userId: c.userId };
          });
        }
      } catch (error) {
        console.error('è¼‰å…¥å®¢æˆ¶ç·¨è™Ÿå¤±æ•—:', error);
      }
    }

   async function saveCustomerNumber() {
     var number = document.getElementById('newCustomerNumber').value.trim();
     var name = document.getElementById('newCustomerName').value.trim();
     var userId = document.getElementById('newCustomerUserId').value.trim();
     if (!number || !name || !userId) {
       alert('è«‹å®Œæ•´è¼¸å…¥ ç·¨è™Ÿ / å§“å / User ID');
       return;
     }

     // â­ æ–°å¢ï¼šæª¢æŸ¥ç·¨è™Ÿæ˜¯å¦é‡è¤‡
     if (savedCustomers[number]) {
       showResult('error', 'âŒ æ­¤ç·¨è™Ÿå·²å­˜åœ¨ï¼š#' + number + ' (' + savedCustomers[number].name + ')');
       return;
     }

     // â­ æ–°å¢ï¼šæª¢æŸ¥ User ID æ˜¯å¦é‡è¤‡
     var existingUser = Object.entries(savedCustomers).find(function(item) {
       return item[1].userId === userId;
     });
     if (existingUser) {
       showResult('error', 'âŒ æ­¤ User ID å·²å­˜åœ¨ï¼š#' + existingUser[0] + ' (' + existingUser[1].name + ')');
       return;
     }

      try {
        var res = await fetch('/api/customer-numbers', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ number: number, name: name, userId: userId })
        });
        var data = await res.json();
        if (data.success) {
          showResult('success', 'âœ… å·²å„²å­˜å®¢æˆ¶ç·¨è™Ÿ');
          document.getElementById('newCustomerNumber').value = '';
          document.getElementById('newCustomerName').value = '';
          document.getElementById('newCustomerUserId').value = '';
          await loadCustomerNumbers();
          displaySavedCustomers();
        } else {
          showResult('error', 'âŒ å„²å­˜å¤±æ•—: ' + (data.error || 'æœªçŸ¥éŒ¯èª¤'));
        }
      } catch (error) {
        showResult('error', 'âŒ é€£ç·šå¤±æ•—: ' + error.message);
      }
    }

   function displaySavedCustomers() {
      var wrap = document.getElementById('savedCustomers');
      
      // âœ… æŒ‰ç·¨è™Ÿæ’åºï¼ˆ001, 002, 003...ï¼‰
      var entries = Object.entries(savedCustomers).sort(function(a, b) {
        return parseInt(a[0]) - parseInt(b[0]);
      });
      
      if (entries.length === 0) {
        wrap.innerHTML = '<p style="color:#999;">å°šç„¡è³‡æ–™</p>';
        return;
      }
      
      wrap.innerHTML = entries.map(function(item) {
        var no = item[0];
        var c = item[1];
        return '<div class="user-item" style="justify-content:space-between;">' +
          '<div class="user-info" onclick="fillCustomer(\'' + c.userId + '\',\'' + c.name + '\')">' +
          '<strong>#' + no + ' - ' + c.name + '</strong>' +
          '<small>User ID: ' + c.userId + '</small>' +
          '</div>' +
          '<button class="btn btn-small btn-danger" onclick="removeSavedCustomer(\'' + no + '\')">åˆªé™¤</button>' +
          '</div>';
      }).join('');
    }

    async function removeSavedCustomer(number) {
      if (!confirm('åˆªé™¤ç·¨è™Ÿ #' + number + ' ?')) return;
      try {
        var res = await fetch('/api/customer-numbers/' + encodeURIComponent(number), { method: 'DELETE' });
        var data = await res.json();
        if (data.success) {
          await loadCustomerNumbers();
          displaySavedCustomers();
        } else {
          alert('åˆªé™¤å¤±æ•—: ' + (data.error || 'æœªçŸ¥éŒ¯èª¤'));
        }
      } catch (error) {
        alert('é€£ç·šå¤±æ•—: ' + error.message);
      }
    }

    function fillCustomer(userId, name) {
      document.getElementById('userId').value = userId;
      document.getElementById('userName').value = name;
      switchTab({ currentTarget: document.querySelector('.tab') }, 'payment');
    }

    async function loadTemplates() {
      try {
        var res = await fetch('/api/templates');
        var data = await res.json();
        if (data.success) {
          savedTemplates = data.templates || [];
        }
      } catch (error) {
        console.error('è¼‰å…¥æ¨¡æ¿å¤±æ•—:', error);
      }
    }

    function loadCustomTemplates() {
      var container = document.getElementById('customTemplates');
      if (!container) return;
      var html = '';
      savedTemplates.forEach(function(template, index) {
        var preview = template.length > 30 ? template.substring(0, 30) + '...' : template;
        html += '<button type="button" class="template-btn" onclick="selectTemplate(event, ' + index + ')">' + preview + '</button>';
      });
      container.innerHTML = html;
    }

    function selectTemplate(evt, index) {
      var el = document.getElementById('customMessage');
      if (el) el.value = savedTemplates[index] || '';
      document.querySelectorAll('.template-btn').forEach(function(btn) { btn.classList.remove('active'); });
      if (evt && evt.currentTarget) evt.currentTarget.classList.add('active');
    }

    async function saveTemplate() {
      var content = document.getElementById('newTemplateContent').value.trim();
      if (!content) {
        alert('è«‹è¼¸å…¥æ¨¡æ¿å…§å®¹');
        return;
      }

      try {
        var res = await fetch('/api/templates', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ content: content })
        });
        var data = await res.json();
        if (data.success) {
          showResult('success', 'âœ… å·²æ–°å¢æ¨¡æ¿');
          document.getElementById('newTemplateContent').value = '';
          await loadTemplates();
          displayTemplates();
          loadCustomTemplates();
        } else {
          showResult('error', 'âŒ å„²å­˜å¤±æ•—: ' + (data.error || 'æœªçŸ¥éŒ¯èª¤'));
        }
      } catch (error) {
        showResult('error', 'âŒ é€£ç·šå¤±æ•—: ' + error.message);
      }
    }

    function displayTemplates() {
      var wrap = document.getElementById('templateList');
      if (savedTemplates.length === 0) {
        wrap.innerHTML = '<p style="color:#999;">å°šç„¡æ¨¡æ¿</p>';
        return;
      }
      wrap.innerHTML = savedTemplates.map(function(t, i) {
        return '<div class="template-item">' +
          '<div style="white-space:pre-wrap;">' + t + '</div>' +
          '<div style="margin-top:10px; display:flex; gap:10px;">' +
          '<button class="btn btn-small btn-secondary" onclick="editTemplate(' + i + ')">ç·¨è¼¯</button>' +
          '<button class="btn btn-small btn-danger" onclick="deleteTemplate(' + i + ')">åˆªé™¤</button>' +
          '</div>' +
          '</div>';
      }).join('');
    }

    async function editTemplate(index) {
      var newContent = prompt('ä¿®æ”¹æ¨¡æ¿å…§å®¹ï¼š', savedTemplates[index] || '');
      if (newContent === null) return;

      try {
        var res = await fetch('/api/templates/' + index, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ content: newContent })
        });
        var data = await res.json();
        if (data.success) {
          await loadTemplates();
          displayTemplates();
          loadCustomTemplates();
        } else {
          alert('æ›´æ–°å¤±æ•—: ' + (data.error || 'æœªçŸ¥éŒ¯èª¤'));
        }
      } catch (error) {
        alert('é€£ç·šå¤±æ•—: ' + error.message);
      }
    }

    async function deleteTemplate(index) {
      if (!confirm('ç¢ºå®šåˆªé™¤æ­¤æ¨¡æ¿ï¼Ÿ')) return;

      try {
        var res = await fetch('/api/templates/' + index, { method: 'DELETE' });
        var data = await res.json();
        if (data.success) {
          await loadTemplates();
          displayTemplates();
          loadCustomTemplates();
        } else {
          alert('åˆªé™¤å¤±æ•—: ' + (data.error || 'æœªçŸ¥éŒ¯èª¤'));
        }
      } catch (error) {
        alert('é€£ç·šå¤±æ•—: ' + error.message);
      }
    }

    function quickSearchCustomer() {
      var query = document.getElementById('quickSearch').value.trim();
      if (!query) {
        alert('è«‹è¼¸å…¥ç·¨è™Ÿæˆ–å§“å');
        return;
      }

      if (savedCustomers[query]) {
        var c = savedCustomers[query];
        document.getElementById('userId').value = c.userId || '';
        document.getElementById('userName').value = c.name || '';
        showCustomerCard(query, c.name, c.userId);
        return;
      }

      var found = Object.entries(savedCustomers).find(function(item) {
        return (item[1].name || '').includes(query);
      });
      if (found) {
        var number = found[0];
        var c = found[1];
        document.getElementById('userId').value = c.userId || '';
        document.getElementById('userName').value = c.name || '';
        showCustomerCard(number, c.name, c.userId);
        return;
      }

      alert('æ‰¾ä¸åˆ°æ­¤å®¢æˆ¶');
    }

    function showCustomerCard(number, name, userId) {
      document.getElementById('cardNumber').textContent = number;
      document.getElementById('cardName').textContent = name;
      document.getElementById('cardUserId').textContent = userId;
      document.getElementById('customerCard').style.display = 'block';
    }

    document.getElementById('paymentForm').addEventListener('submit', async function(e) {
      e.preventDefault();
      var userId = document.getElementById('userId').value.trim();
      var userName = document.getElementById('userName').value.trim();
      var amount = parseInt(document.getElementById('amount').value, 10);
      var paymentType = document.querySelector('input[name="paymentType"]:checked').value;
      var customMessage = document.getElementById('customMessage').value.trim().replace('{amount}', (amount || 0).toLocaleString());

      if (!userId || !userName || !amount) {
        showResult('error', 'è«‹å¡«å¯«æ‰€æœ‰å¿…å¡«æ¬„ä½!');
        return;
      }

      document.getElementById('submitBtn').disabled = true;
      document.getElementById('loading').style.display = 'block';
      document.getElementById('result').style.display = 'none';

      try {
        var res = await fetch('/send-payment', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ userId: userId, userName: userName, amount: amount, paymentType: paymentType, customMessage: customMessage })
        });
        var data = {};
        try {
          data = await res.json();
        } catch {
          data = { success: false, error: 'å¾Œç«¯æœªå›å‚³ JSON' };
        }

        if (data.success) {
          var msg = 'âœ… ä»˜æ¬¾é€£çµå·²ç™¼é€çµ¦ ' + userName + '!<br><br>é‡‘é¡: NT$ ' + amount.toLocaleString() + '<br>';
          if (paymentType === 'both') msg += 'ä»˜æ¬¾æ–¹å¼: ä¿¡ç”¨å¡ + LINE Pay<br>';
          else if (paymentType === 'ecpay') msg += 'ä»˜æ¬¾æ–¹å¼: ç¶ ç•Œæ”¯ä»˜<br>';
          else msg += 'ä»˜æ¬¾æ–¹å¼: LINE Pay<br>';
          if (customMessage) msg += '<br>é™„åŠ è¨Šæ¯: ' + customMessage;
          showResult('success', msg);
          document.getElementById('paymentForm').reset();
          document.getElementById('customerCard').style.display = 'none';
        } else {
          showResult('error', 'âŒ ç™¼é€å¤±æ•—: ' + (data.error || 'ä¼ºæœå™¨ç„¡å›æ‡‰'));
        }
      } catch (err) {
        showResult('error', 'âŒ éŒ¯èª¤: ' + err.message);
      } finally {
        document.getElementById('submitBtn').disabled = false;
        document.getElementById('loading').style.display = 'none';
      }
    });
   async function loadOrders() {
      var orderListDiv = document.getElementById('orderList');
      orderListDiv.innerHTML = '<p style="text-align:center; color:#999;">è¼‰å…¥ä¸­...</p>';
      try {
        var res = await fetch('/api/orders');
        var data = await res.json();
        if (!data.success) throw new Error(data.error || 'è¼‰å…¥å¤±æ•—');
        allOrders = Array.isArray(data.orders) ? data.orders : [];
        displayOrderStats(data.statistics || { total: 0, pending: 0, paid: 0, expired: 0, needReminder: 0 });
        displayOrders(allOrders);
      } catch (err) {
        allOrders = [];
        displayOrderStats({ total: 0, pending: 0, paid: 0, expired: 0, needReminder: 0 });
        orderListDiv.innerHTML = '<p style="color:#dc3545; text-align:center;">è¼‰å…¥å¤±æ•—ï¼š' + err.message + '</p>';
      }
    }

    function displayOrderStats(stats) {
      var s = stats || {};
      var el = document.getElementById('orderStats');
      el.innerHTML = 
        '<div style="background:#f0f4ff; padding:15px; border-radius:10px; text-align:center;">' +
        '<div style="font-size:24px; font-weight:bold; color:#667eea;">' + (s.total || 0) + '</div>' +
        '<div style="font-size:14px; color:#666;">ç¸½è¨‚å–®æ•¸</div>' +
        '</div>' +
        '<div style="background:#fff3cd; padding:15px; border-radius:10px; text-align:center;">' +
        '<div style="font-size:24px; font-weight:bold; color:#ffc107;">' + (s.pending || 0) + '</div>' +
        '<div style="font-size:14px; color:#666;">å¾…ä»˜æ¬¾</div>' +
        '</div>' +
        '<div style="background:#d4edda; padding:15px; border-radius:10px; text-align:center;">' +
        '<div style="font-size:24px; font-weight:bold; color:#28a745;">' + (s.paid || 0) + '</div>' +
        '<div style="font-size:14px; color:#666;">å·²ä»˜æ¬¾</div>' +
        '</div>' +
        '<div style="background:#f8d7da; padding:15px; border-radius:10px; text-align:center;">' +
        '<div style="font-size:24px; font-weight:bold; color:#dc3545;">' + (s.expired || 0) + '</div>' +
        '<div style="font-size:14px; color:#666;">å·²éæœŸ</div>' +
        '</div>' +
        '<div style="background:#e7f0ff; padding:15px; border-radius:10px; text-align:center;">' +
        '<div style="font-size:24px; font-weight:bold; color:#0066cc;">' + (s.needReminder || 0) + '</div>' +
        '<div style="font-size:14px; color:#666;">éœ€æé†’</div>' +
        '</div>';
    }

    function displayOrders(orders) {
      var wrap = document.getElementById('orderList');
      if (!orders || orders.length === 0) {
        wrap.innerHTML = '<p style="text-align:center; color:#999;">å°šç„¡è¨‚å–®è¨˜éŒ„</p>';
        return;
      }
      var html = '';
      orders.forEach(function(order) {
        var createdDate = order.createdAt ? new Date(order.createdAt).toLocaleString('zh-TW') : '-';
        var expiryDate = order.expiryTime ? new Date(order.expiryTime).toLocaleString('zh-TW') : '-';
        var statusBadge = '';
        var actionButtons = '';

        if (order.status === 'paid') {
          statusBadge = '<span style="background:#28a745; color:#fff; padding:5px 10px; border-radius:5px; font-size:12px;">âœ… å·²ä»˜æ¬¾</span>';
        } else if (order.isExpired) {
          statusBadge = '<span style="background:#dc3545; color:#fff; padding:5px 10px; border-radius:5px; font-size:12px;">âŒ å·²éæœŸ</span>';
          actionButtons = '<button class="btn btn-small btn-secondary" onclick="renewOrder(\'' + (order.orderId || '') + '\')">ğŸ”„ çºŒç´„é‡ç™¼</button>';
        } else {
          statusBadge = '<span style="background:#ffc107; color:#fff; padding:5px 10px; border-radius:5px; font-size:12px;">â° å‰©é¤˜ ' + (order.remainingHours || '-') + ' å°æ™‚</span>';
          actionButtons = 
            '<button class="btn btn-small btn-secondary" onclick="copyPaymentLink(\'' + (order.orderId || '') + '\')">ğŸ“‹ è¤‡è£½é€£çµ</button>' +
            '<button class="btn btn-small btn-secondary" onclick="sendSingleReminder(\'' + (order.orderId || '') + '\')">â° æé†’</button>';
        }
        actionButtons += ' <button class="btn btn-small btn-danger" onclick="deleteOrder(\'' + (order.orderId || '') + '\')">åˆªé™¤</button>';

        html += 
          '<div class="user-item" style="display:block;">' +
          '<div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">' +
          '<div>' +
          '<strong style="font-size:16px; cursor:pointer; color:#667eea;" onclick="showCustomerHistory(\'' + (order.userId || '') + '\', \'' + (order.userName || '') + '\')" title="é»æ“ŠæŸ¥çœ‹ä»˜æ¬¾æ­·å²">' + (order.userName || '-') + '</strong>' +
          statusBadge +
          '</div>' +
          '<div style="font-size:18px; font-weight:bold; color:#667eea;">NT$ ' + ((order.amount || 0).toLocaleString()) + '</div>' +
          '</div>' +
          '<div style="font-size:13px; color:#666; margin-bottom:10px;">' +
          '<div>è¨‚å–®ç·¨è™Ÿ: ' + (order.orderId || '-') + '</div>' +
          '<div>å»ºç«‹æ™‚é–“: ' + createdDate + '</div>' +
          '<div>éæœŸæ™‚é–“: ' + expiryDate + '</div>' +
          (order.retryCount > 0 ? '<div>é‡è©¦æ¬¡æ•¸: ' + order.retryCount + '</div>' : '') +
          (order.paymentMethod ? '<div>ä»˜æ¬¾æ–¹å¼: <span style="color:#28a745; font-weight:bold;">' + order.paymentMethod + '</span></div>' : '') +
          '</div>' +
          '<div style="display:flex; gap:10px; flex-wrap:wrap;">' +
          actionButtons +
          '</div>' +
          '</div>';
      });
      wrap.innerHTML = html;
    }

    function searchOrders() {
      var q = (document.getElementById('orderSearchInput').value || '').toLowerCase().trim();
      if (!q) {
        filterOrders();
        return;
      }
      var filtered = (allOrders || []).filter(function(o) {
        return (o.orderId || '').toLowerCase().includes(q) || (o.userName || '').toLowerCase().includes(q);
      });
      displayOrders(filtered);
      if (filtered.length === 0) {
        document.getElementById('orderList').innerHTML = '<p style="text-align:center; color:#999;">æ‰¾ä¸åˆ°ç¬¦åˆçš„è¨‚å–®</p>';
      }
    }

    function filterOrders() {
      var status = document.getElementById('orderStatusFilter').value;
      if (!status) {
        displayOrders(allOrders);
        return;
      }
      var filtered = (allOrders || []).filter(function(o) {
        if (status === 'expired') return !!o.isExpired;
        return (o.status || '') === status;
      });
      displayOrders(filtered);
    }

    async function sendReminders() {
      try {
        var r = await fetch('/api/orders/send-reminders', { method: 'POST' });
        var d = await r.json();
        if (d.success) {
          showResult('success', d.message || ('âœ… å·²ç™¼é€æé†’ï¼š' + (d.sent || 0) + ' ç­†'));
          loadOrders();
        } else {
          showResult('error', 'âŒ ç™¼é€å¤±æ•—ï¼š' + (d.error || 'æœªçŸ¥éŒ¯èª¤'));
        }
      } catch (e) {
        showResult('error', 'âŒ ç„¡æ³•é€£ç·šæé†’ APIï¼š' + e.message);
      }
    }

    async function cleanExpired() {
      try {
        var r = await fetch('/api/orders/clean-expired', { method: 'POST' });
        var d = await r.json();
        if (d.success) {
          showResult('success', d.message || ('ğŸ§¹ å·²æ¸…ç† ' + (d.cleaned || 0) + ' ç­†éæœŸè¨‚å–®'));
          loadOrders();
        } else {
          showResult('error', 'âŒ æ¸…ç†å¤±æ•—ï¼š' + (d.error || 'æœªçŸ¥éŒ¯èª¤'));
        }
      } catch (e) {
        showResult('error', 'âŒ ç„¡æ³•é€£ç·šæ¸…ç† APIï¼š' + e.message);
      }
    }

    async function renewOrder(orderId) {
      if (!orderId) return alert('æ‰¾ä¸åˆ°è¨‚å–®ç·¨è™Ÿ');
      try {
        var r = await fetch('/api/order/' + orderId + '/renew', { method: 'POST' });
        var d = await r.json();
        if (d.success) {
          showResult('success', 'ğŸ”„ å·²çºŒç´„ä¸¦é‡æ–°ç™¼é€ä»˜æ¬¾é€£çµ');
          loadOrders();
        } else {
          showResult('error', 'âŒ çºŒç´„å¤±æ•—ï¼š' + (d.error || 'æœªçŸ¥éŒ¯èª¤'));
        }
      } catch (e) {
        showResult('error', 'âŒ ç„¡æ³•é€£ç·šçºŒç´„ APIï¼š' + e.message);
      }
    }

    function copyPaymentLink(orderId) {
      var url = window.location.origin + '/payment/linepay/pay/' + orderId;
      navigator.clipboard.writeText(url).then(
        function() { showResult('success', 'ğŸ“‹ å·²è¤‡è£½ä»˜æ¬¾é€£çµ'); },
        function() { showResult('error', 'âŒ è¤‡è£½å¤±æ•—ï¼Œè«‹æ‰‹å‹•è¤‡è£½ï¼š<br>' + url); }
      );
    }

    function sendSingleReminder(orderId) {
      return renewOrder(orderId);
    }

    async function deleteOrder(orderId) {
      if (!confirm('ç¢ºå®šè¦åˆªé™¤è¨‚å–®ï¼š' + orderId + ' å—ï¼Ÿ')) return;
      try {
        var r = await fetch('/api/order/' + orderId, { method: 'DELETE' });
        var d = await r.json();
        if (d.success) {
          showResult('success', 'ğŸ—‘ï¸ è¨‚å–®å·²åˆªé™¤');
          loadOrders();
        } else {
          showResult('error', 'âŒ åˆªé™¤å¤±æ•—ï¼š' + (d.error || 'æœªçŸ¥éŒ¯èª¤'));
        }
      } catch (e) {
        showResult('error', 'âŒ ç„¡æ³•é€£ç·šåˆªé™¤ APIï¼š' + e.message);
      }
    }

    async function showCustomerHistory(userId, userName) {
      var modal = document.getElementById('customerHistoryModal');
      var content = document.getElementById('customerHistoryContent');
      modal.style.display = 'block';
      content.innerHTML = '<p style="text-align:center; color:#999;">è¼‰å…¥ä¸­...</p>';

      try {
        var hist = (allOrders || []).filter(function(o) { return o.userId === userId; });
        if (!hist || hist.length === 0) {
          content.innerHTML = '<p style="text-align:center; color:#999;">å®¢æˆ¶ ' + userName + ' å°šç„¡è¨‚å–®è¨˜éŒ„</p>';
          return;
        }
        var html = '<div class="customer-card"><h4>' + userName + '</h4><p>User IDï¼š' + userId + '</p></div>';
        hist.forEach(function(o) {
          var created = o.createdAt ? new Date(o.createdAt).toLocaleString('zh-TW') : '-';
          var status = o.status || (o.isExpired ? 'expired' : 'pending');
          html += 
            '<div class="template-item">' +
            '<div><strong>è¨‚å–®ç·¨è™Ÿï¼š</strong>' + (o.orderId || '-') + '</div>' +
            '<div><strong>é‡‘é¡ï¼š</strong>NT$ ' + ((o.amount || 0).toLocaleString()) + '</div>' +
            '<div><strong>ç‹€æ…‹ï¼š</strong>' + status + '</div>' +
            '<div><strong>å»ºç«‹æ™‚é–“ï¼š</strong>' + created + '</div>' +
            '</div>';
        });
        content.innerHTML = html;
      } catch (e) {
        content.innerHTML = '<p style="color:#dc3545;">è¼‰å…¥å¤±æ•—ï¼š' + e.message + '</p>';
      }
    }

    function closeCustomerHistory() {
      document.getElementById('customerHistoryModal').style.display = 'none';
    }

    async function loadUsers() {
      var wrap = document.getElementById('userList');
      wrap.innerHTML = '<p style="text-align:center; color:#999;">è¼‰å…¥ä¸­...</p>';
      
      // âœ… ç›´æ¥å¾ savedCustomers è®€å–ä¸¦æ’åº
      var entries = Object.entries(savedCustomers).sort(function(a, b) {
        return parseInt(a[0]) - parseInt(b[0]);
      });
      
      if (entries.length === 0) {
        wrap.innerHTML = '<p style="text-align:center; color:#999;">å°šç„¡å®¢æˆ¶è³‡æ–™</p>';
        return;
      }
      
      wrap.innerHTML = entries.map(function(item) {
        var no = item[0];
        var c = item[1];
        return '<div class="user-item">' +
          '<div class="user-info" onclick="fillCustomer(\'' + c.userId + '\',\'' + c.name + '\')">' +
          '<strong>#' + no + ' - ' + c.name + '</strong>' +
          '<small>User ID: ' + c.userId + '</small>' +
          '</div>' +
          '<button class="btn btn-small btn-secondary" onclick="fillCustomer(\'' + c.userId + '\',\'' + c.name + '\')">å¸¶å…¥</button>' +
          '</div>';
      }).join('');
    }

    function showResult(type, html) {
      var el = document.getElementById('result');
      el.className = 'result ' + (type === 'success' ? 'success' : 'error');
      el.innerHTML = html;
      el.style.display = 'block';
      el.scrollIntoView({ behavior: 'smooth', block: 'center' });
    }

    document.addEventListener('DOMContentLoaded', function() {
      initLoad();
    });
    // ========================================
    // ğŸ§º å–ä»¶è¿½è¹¤åŠŸèƒ½
    // ========================================

    function searchForPickup() {
      var num = document.getElementById('pickupSearch').value.trim();
      if (!num) return alert('è«‹è¼¸å…¥ç·¨è™Ÿ');
      
      if (savedCustomers[num]) {
        var c = savedCustomers[num];
        document.getElementById('pickupNumber').value = num;
        document.getElementById('pickupName').value = c.name;
        document.getElementById('pickupUserId').value = c.userId;
        document.getElementById('pickupCardNumber').textContent = num;
        document.getElementById('pickupCardName').textContent = c.name;
        document.getElementById('pickupCardUserId').textContent = c.userId;
        document.getElementById('pickupCustomerCard').style.display = 'block';
      } else {
        alert('æ‰¾ä¸åˆ°æ­¤å®¢æˆ¶ç·¨è™Ÿ');
      }
    }

    async function startPickup() {
      var num = document.getElementById('pickupNumber').value.trim();
      var name = document.getElementById('pickupName').value.trim();
      var userId = document.getElementById('pickupUserId').value.trim();
      
      if (!num || !name || !userId) return alert('è«‹å¡«å¯«å®Œæ•´');
      
      try {
        var res = await fetch('/api/pickup/add', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ customerNumber: num, customerName: name, userId: userId })
        });
        var data = await res.json();
        
        if (data.success) {
          showResult('success', 'âœ… å·²é–‹å§‹è¿½è¹¤ï¼7å¤©å¾Œ11é»è‡ªå‹•æé†’');
          document.getElementById('pickupNumber').value = '';
          document.getElementById('pickupName').value = '';
          document.getElementById('pickupUserId').value = '';
          document.getElementById('pickupCustomerCard').style.display = 'none';
          loadPickups();
        } else {
          showResult('error', 'âŒ ' + data.message);
        }
      } catch (e) {
        showResult('error', 'âŒ é€£ç·šå¤±æ•—');
      }
    }

    async function loadPickups() {
      try {
        var res = await fetch('/api/pickup/orders');
        var data = await res.json();
        
        if (data.success) {
          allPickupOrders = data.orders || [];
          var html = '';
          if (allPickupOrders.length === 0) {
            html = '<p style="color:#999; text-align:center;">å°šç„¡è¿½è¹¤è¨‚å–®</p>';
          } else {
            allPickupOrders.forEach(function(o) {
              var status = o.pickedUp ? 'âœ… å·²ç°½æ”¶' : 'â° è¿½è¹¤ä¸­ (' + o.daysPassed + 'å¤©)';
              html += '<div class="user-item" style="display:block; opacity:' + (o.pickedUp ? '0.6' : '1') + ';">' +
                '<div style="margin-bottom:10px;"><strong style="font-size:16px;">#' + o.customerNumber + ' - ' + o.customerName + '</strong> <span style="background:' + (o.pickedUp ? '#28a745' : '#ffc107') + '; color:#fff; padding:5px 10px; border-radius:5px; font-size:12px;">' + status + '</span></div>' +
                '<div style="font-size:13px; color:#666; margin-bottom:10px;">' +
                'ä¸‹æ¬¡æé†’: ' + new Date(o.nextReminderAt).toLocaleString('zh-TW') + '<br>' +
                'å·²æé†’: ' + o.reminderCount + ' æ¬¡</div>' +
                '<div style="display:flex; gap:5px; flex-wrap:wrap;">';
              
              if (!o.pickedUp) {
                html += '<button class="btn btn-small btn-secondary" onclick="remindNow(\'' + o.customerNumber + '\')">ğŸ”” ç«‹å³æé†’</button>' +
                        '<button class="btn btn-small" style="background:#ff9800;color:#fff;" onclick="delay14(\'' + o.customerNumber + '\')">â° å»¶14å¤©</button>' +
                        '<button class="btn btn-small btn-secondary" onclick="markDone(\'' + o.customerNumber + '\')">âœ… ç°½æ”¶</button>';
              }
              html += '<button class="btn btn-small btn-danger" onclick="deletePick(\'' + o.customerNumber + '\')">åˆªé™¤</button>' +
                      '</div></div>';
            });
          }
          document.getElementById('pickupList').innerHTML = html;
        }
      } catch (e) {
        showResult('error', 'âŒ è¼‰å…¥å¤±æ•—');
      }
    }

    async function remindNow(num) {
      try {
        var res = await fetch('/api/pickup/remind/' + num, { method: 'POST' });
        var data = await res.json();
        if (data.success) {
          showResult('success', 'âœ… æé†’å·²ç™¼é€');
          loadPickups();
        } else {
          showResult('error', 'âŒ ' + data.message);
        }
      } catch (e) {
        showResult('error', 'âŒ ç™¼é€å¤±æ•—');
      }
    }

    async function delay14(num) {
      if (!confirm('å»¶é²14å¤©å¾Œæé†’ï¼Ÿ')) return;
      try {
        var res = await fetch('/api/pickup/delay', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ customerNumber: num })
        });
        var data = await res.json();
        if (data.success) {
          showResult('success', 'âœ… å·²å»¶é²14å¤©');
          loadPickups();
        } else {
          showResult('error', 'âŒ ' + data.message);
        }
      } catch (e) {
        showResult('error', 'âŒ æ“ä½œå¤±æ•—');
      }
    }

    async function markDone(num) {
      if (!confirm('æ¨™è¨˜ç‚ºå·²ç°½æ”¶ï¼Ÿ')) return;
      try {
        var res = await fetch('/api/pickup/complete', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ customerNumber: num })
        });
        var data = await res.json();
        if (data.success) {
          showResult('success', 'âœ… å·²ç°½æ”¶');
          loadPickups();
        } else {
          showResult('error', 'âŒ ' + data.message);
        }
      } catch (e) {
        showResult('error', 'âŒ æ“ä½œå¤±æ•—');
      }
    }

    async function deletePick(num) {
      if (!confirm('åˆªé™¤æ­¤è¿½è¹¤ï¼Ÿ')) return;
      try {
        var res = await fetch('/api/pickup/order/' + num, { method: 'DELETE' });
        var data = await res.json();
        if (data.success) {
          showResult('success', 'âœ… å·²åˆªé™¤');
          loadPickups();
        } else {
          showResult('error', 'âŒ ' + data.message);
        }
      } catch (e) {
        showResult('error', 'âŒ åˆªé™¤å¤±æ•—');
      }
    }

    async function editTemplate() {
      try {
        var res = await fetch('/api/pickup/template');
        var data = await res.json();
        if (data.success) {
          document.getElementById('templateText').value = data.template;
          document.getElementById('templateModal').style.display = 'block';
        }
      } catch (e) {
        showResult('error', 'âŒ è¼‰å…¥å¤±æ•—');
      }
    }

    function closeTemplateModal() {
      document.getElementById('templateModal').style.display = 'none';
    }

    async function saveTemplatePickup() {
      var text = document.getElementById('templateText').value.trim();
      if (!text) return alert('è«‹è¼¸å…¥æ¨¡æ¿');
      
      try {
        var res = await fetch('/api/pickup/template', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ template: text })
        });
        var data = await res.json();
        if (data.success) {
          showResult('success', 'âœ… æ¨¡æ¿å·²å„²å­˜');
          closeTemplateModal();
        } else {
          showResult('error', 'âŒ å„²å­˜å¤±æ•—');
        }
      } catch (e) {
        showResult('error', 'âŒ é€£ç·šå¤±æ•—');
      }
    }

    // ========================================
// ğŸšš å¤–é€æ’ç¨‹ / ç´€éŒ„ åŠŸèƒ½
// ========================================

// ä¾å®¢æˆ¶ç·¨è™Ÿå¿«é€Ÿå¸¶å…¥
function searchForDelivery() {
  var num = document.getElementById('deliverySearch').value.trim();
  if (!num) return alert('è«‹è¼¸å…¥ç·¨è™Ÿ');

  if (savedCustomers[num]) {
    var c = savedCustomers[num];
    document.getElementById('deliveryNumber').value = num;
    document.getElementById('deliveryName').value = c.name || '';
    document.getElementById('deliveryCardNumber').textContent = num;
    document.getElementById('deliveryCardName').textContent = c.name || '';
    document.getElementById('deliveryCustomerCard').style.display = 'block';
  } else {
    alert('æ‰¾ä¸åˆ°æ­¤å®¢æˆ¶ç·¨è™Ÿ');
  }
}

// æ–°å¢å¤–é€ç´€éŒ„
async function addDelivery() {
  var num   = document.getElementById('deliveryNumber').value.trim();
  var name  = document.getElementById('deliveryName').value.trim();
  var amt   = document.getElementById('deliveryAmount').value.trim();
  var note  = document.getElementById('deliveryNote').value.trim();
  var date  = document.getElementById('deliveryDate').value || null;
  var notifyStatus = document.querySelector('input[name="deliveryNotifyStatus"]:checked').value; // 'not_sent' or 'sent'

  if (!num || !name || !amt) {
    alert('è«‹è‡³å°‘å¡«å¯« ç·¨è™Ÿ / å§“å / é‡‘é¡');
    return;
  }

  var amount = parseInt(amt, 10);
  if (isNaN(amount) || amount < 0) {
    alert('é‡‘é¡æ ¼å¼ä¸æ­£ç¢º');
    return;
  }

  try {
    var res = await fetch('/api/delivery/add', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        customerNumber: num,
        customerName : name,
        amount       : amount,
        notifyStatus : notifyStatus,  // 'not_sent' | 'sent'
        note         : note,
        scheduledDate: date          // 'YYYY-MM-DD' æˆ– null
      })
    });

    var data = await res.json();
    if (data.success) {
      showResult('success', 'âœ… å·²æ–°å¢å¤–é€ç´€éŒ„');
      document.getElementById('deliveryNumber').value = '';
      document.getElementById('deliveryName').value  = '';
      document.getElementById('deliveryAmount').value = '';
      document.getElementById('deliveryNote').value = '';
      document.getElementById('deliveryDate').value = '';
      document.querySelector('input[name="deliveryNotifyStatus"][value="not_sent"]').checked = true;
      document.getElementById('deliveryCustomerCard').style.display = 'none';
      loadDeliveries(false);
    } else {
      showResult('error', 'âŒ æ–°å¢å¤±æ•—ï¼š' + (data.error || 'æœªçŸ¥éŒ¯èª¤'));
    }
  } catch (e) {
    showResult('error', 'âŒ é€£ç·šå¤±æ•—ï¼š' + e.message);
  }
}

// è¼‰å…¥å¤–é€ç´€éŒ„
async function loadDeliveries(showAlert) {
  var wrap = document.getElementById('deliveryList');
  if (!wrap) return;

  wrap.innerHTML = '<p style="text-align:center; color:#999;">è¼‰å…¥ä¸­...</p>';

  try {
    var res = await fetch('/api/delivery/orders');
    var data = await res.json();
    if (!data.success) throw new Error(data.error || 'è¼‰å…¥å¤±æ•—');

    allDeliveries = Array.isArray(data.orders) ? data.orders : [];
    renderDeliveryList();

    if (showAlert) {
      checkTodayDeliveryAlerts();
    }
  } catch (e) {
    allDeliveries = [];
    wrap.innerHTML = '<p style="text-align:center; color:#dc3545;">è¼‰å…¥å¤±æ•—ï¼š' + e.message + '</p>';
  }
}

// ä¾æ—¥æœŸåˆ†çµ„é¡¯ç¤ºå¤–é€ç´€éŒ„
function renderDeliveryList() {
  var wrap = document.getElementById('deliveryList');
  if (!wrap) return;

  if (!allDeliveries || allDeliveries.length === 0) {
    wrap.innerHTML = '<p style="text-align:center; color:#999;">ç›®å‰æ²’æœ‰å¤–é€ç´€éŒ„</p>';
    return;
  }

  // ä¾æ—¥æœŸåˆ†çµ„ï¼ˆåªå–æ—¥æœŸï¼Œä¸å«æ™‚é–“ï¼‰
  var groups = {};
  allDeliveries.forEach(function(o) {
    var rawDate =
      (o.createdDate || o.createdAt || '').toString().substring(0, 10) ||
      'æœªæŒ‡å®šæ—¥æœŸ';
    if (!groups[rawDate]) groups[rawDate] = [];
    groups[rawDate].push(o);
  });

  var dates = Object.keys(groups).sort().reverse(); // æ–°çš„æ—¥æœŸåœ¨å‰
  var todayStr = new Date().toISOString().substring(0, 10);

  var html = '';
  dates.forEach(function(dk) {
    var tag = (dk === todayStr) ? 'ï¼ˆä»Šå¤©ï¼‰' : '';
    html +=
      '<h4 style="margin-top:10px; margin-bottom:8px; color:#667eea;">ğŸ“… ' +
      dk +
      ' ' +
      tag +
      '</h4>';

    groups[dk].forEach(function(o) {
      var id = o.id || o.recordId || '';
      var notifyStatus = o.notifyStatus || 'not_sent';
      var signed = !!(o.signed || o.isSigned);
      var badgeNotify =
        notifyStatus === 'sent'
          ? '<span style="background:#1890ff;color:#fff;padding:3px 8px;border-radius:5px;font-size:12px;">ğŸ“¨ å·²ç™¼é€è‡ªå‹•é€šçŸ¥</span>'
          : '<span style="background:#faad14;color:#fff;padding:3px 8px;border-radius:5px;font-size:12px;">âŒ› æœªç™¼é€è‡ªå‹•é€šçŸ¥</span>';

      var badgeSigned = signed
        ? '<span style="background:#52c41a;color:#fff;padding:3px 8px;border-radius:5px;font-size:12px;margin-left:5px;">âœ… å·²ç°½æ”¶</span>'
        : '';

      var scheduled = o.scheduledDate
        ? new Date(o.scheduledDate).toLocaleDateString('zh-TW')
        : 'æœªæŒ‡å®š';

      html +=
        '<div class="user-item" style="display:block; margin-bottom:8px; opacity:' +
        (signed ? '0.6' : '1') +
        ';">' +
        '<div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:6px;">' +
        '<div>' +
        '<strong style="font-size:15px;">#' +
        (o.customerNumber || '') +
        ' - ' +
        (o.customerName || '') +
        '</strong> ' +
        badgeNotify +
        badgeSigned +
        '</div>' +
        '<div style="font-size:18px; font-weight:bold; color:#667eea;">NT$ ' +
        ((o.amount || 0).toLocaleString()) +
        '</div>' +
        '</div>' +
        '<div style="font-size:13px; color:#666; margin-bottom:8px;">' +
        '<div>æŒ‡å®šå¤–é€æ—¥æœŸï¼š' +
        scheduled +
        '</div>' +
        (o.note
          ? '<div>å‚™è¨»ï¼š' + (o.note || '').replace(/\n/g, '<br>') + '</div>'
          : '') +
        '</div>' +
        '<div style="display:flex; gap:5px; flex-wrap:wrap;">';

      if (!signed) {
        html +=
          '<button class="btn btn-small btn-secondary" onclick="markDeliverySigned(\'' +
          id +
          '\')">âœ… å·²ç°½æ”¶</button>';
      }

      html +=
        '<button class="btn btn-small" style="background:#ff9800;color:#fff;" onclick="editDelivery(\'' +
        id +
        '\')">âœï¸ ç·¨è¼¯</button>' +
        '<button class="btn btn-small btn-danger" onclick="deleteDelivery(\'' +
        id +
        '\')">ğŸ—‘ï¸ åˆªé™¤</button>' +
        '</div>' +
        '</div>';
    });
  });

  wrap.innerHTML = html;
}

// ä¾ ID æ‰¾åˆ°ç´€éŒ„
function findDeliveryById(id) {
  return (allDeliveries || []).find(function(o) {
    return (o.id || o.recordId || '') === id;
  });
}


// âœ… æ¨™è¨˜å·²ç°½æ”¶
async function markDeliverySigned(id) {
  if (!id) return;
  
  var record = findDeliveryById(id);
  if (!record) {
    alert('æ‰¾ä¸åˆ°æ­¤ç´€éŒ„');
    return;
  }

  var amount = parseInt(record.amount || 0, 10);
  var customerNumber = record.customerNumber;
  var customerName = record.customerName;
  
  // æƒ…æ³ 1: é‡‘é¡ = 0 â†’ åªç™¼é€ç°¡å–®è¨Šæ¯
  if (amount === 0) {
    if (!confirm('ç¢ºèªå°‡æ­¤å¤–é€ç´€éŒ„æ¨™è¨˜ç‚ºã€Œå·²ç°½æ”¶ã€?\n\nå°‡ç™¼é€è¨Šæ¯:\nã€Œå·²ç¶“é€å›ç®¡ç†å®¤äº†ğŸ’™è¬è¬æ‚¨ã€')) {
      return;
    }
    
    try {
      var res = await fetch('/api/delivery/mark-signed-simple', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ 
          id: id,
          customerNumber: customerNumber,
          customerName: customerName
        })
      });
      
      var data = await res.json();
      
      if (data.success) {
        showResult('success', 'âœ… å·²æ¨™è¨˜ç‚ºå·²ç°½æ”¶ä¸¦ç™¼é€é€šçŸ¥');
        loadDeliveries(false);
      } else {
        showResult('error', 'âŒ æ“ä½œå¤±æ•—: ' + (data.error || 'æœªçŸ¥éŒ¯èª¤'));
      }
    } catch (e) {
      showResult('error', 'âŒ é€£ç·šå¤±æ•—: ' + e.message);
    }
    return;
  }

  // æƒ…æ³ 2: é‡‘é¡ > 0 â†’ ç™¼é€æ”¯ä»˜é€£çµ
  if (!confirm(
    'ç¢ºèªå°‡æ­¤å¤–é€ç´€éŒ„æ¨™è¨˜ç‚ºã€Œå·²ç°½æ”¶ã€?\n\n' +
    'å®¢æˆ¶: #' + customerNumber + ' - ' + customerName + '\n' +
    'é‡‘é¡: NT$ ' + amount.toLocaleString() + '\n\n' +
    'å°‡è‡ªå‹•:\n' +
    '1. ç™¼é€ä»˜æ¬¾è¨Šæ¯ + LINE Pay å’Œ ECPay é€£çµ\n' +
    '2. å»ºç«‹è¨‚å–®è¿½è¹¤\n' +
    '3. ä»˜æ¬¾æˆåŠŸå¾Œè‡ªå‹•é€šçŸ¥'
  )) {
    return;
  }

  try {
    var res = await fetch('/api/delivery/mark-signed-with-payment', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ 
        id: id,
        customerNumber: customerNumber,
        customerName: customerName,
        amount: amount
      })
    });
    
    var data = await res.json();
    
    if (data.success) {
      showResult('success', 
        'âœ… å·²æ¨™è¨˜ç‚ºå·²ç°½æ”¶ä¸¦ç™¼é€ä»˜æ¬¾é€£çµ\n\n' +
        'è¨‚å–®ç·¨è™Ÿ: ' + (data.orderId || '-') + '\n' +
        'é‡‘é¡: NT$ ' + amount.toLocaleString()
      );
      
      loadDeliveries(false);
      loadOrders();
    } else {
      showResult('error', 'âŒ æ“ä½œå¤±æ•—: ' + (data.error || 'æœªçŸ¥éŒ¯èª¤'));
    }
  } catch (e) {
    showResult('error', 'âŒ é€£ç·šå¤±æ•—: ' + e.message);
  }
}

// åˆªé™¤å¤–é€ç´€éŒ„
async function deleteDelivery(id) {
  if (!id) return;
  if (!confirm('ç¢ºå®šè¦åˆªé™¤æ­¤å¤–é€ç´€éŒ„ï¼Ÿ')) return;
  // ... ä¸‹é¢ä¿æŒä¸è®Š

  try {
    var res = await fetch('/api/delivery/order/' + encodeURIComponent(id), {
      method: 'DELETE'
    });
    var data = await res.json();
    if (data.success) {
      showResult('success', 'âœ… å·²åˆªé™¤å¤–é€ç´€éŒ„');
      loadDeliveries(false);
    } else {
      showResult('error', 'âŒ åˆªé™¤å¤±æ•—ï¼š' + (data.error || 'æœªçŸ¥éŒ¯èª¤'));
    }
  } catch (e) {
    showResult('error', 'âŒ é€£ç·šå¤±æ•—ï¼š' + e.message);
  }
}

// ç·¨è¼¯å¤–é€ç´€éŒ„ï¼ˆç°¡å–®ç‰ˆï¼Œç”¨ promptï¼‰
async function editDelivery(id) {
  var record = findDeliveryById(id);
  if (!record) {
    alert('æ‰¾ä¸åˆ°æ­¤ç´€éŒ„');
    return;
  }

  var amountStr = prompt('ä¿®æ”¹é‡‘é¡ï¼ˆç›®å‰ï¼š' + (record.amount || 0) + 'ï¼‰', record.amount || 0);
  if (amountStr === null) return;
  var amount = parseInt(amountStr, 10);
  if (isNaN(amount) || amount < 0) {
    alert('é‡‘é¡æ ¼å¼ä¸æ­£ç¢º');
    return;
  }

  var note = prompt('ä¿®æ”¹å‚™è¨»ï¼ˆå¯ä»¥ç•™ç©ºï¼‰', record.note || '');
  if (note === null) note = record.note || '';

  var notifyOk = confirm('æ˜¯å¦å·²ç™¼é€è‡ªå‹•é€šçŸ¥ï¼Ÿ\nã€Œç¢ºå®šã€= å·²ç™¼é€è‡ªå‹•é€šçŸ¥\nã€Œå–æ¶ˆã€= æœªç™¼é€è‡ªå‹•é€šçŸ¥');
  var notifyStatus = notifyOk ? 'sent' : 'not_sent';

  var dateStr = prompt(
    'æŒ‡å®šå¤–é€æ—¥æœŸï¼ˆæ ¼å¼ï¼šYYYY-MM-DDï¼Œå¯ç•™ç©ºè¡¨ç¤ºä¸è®Šï¼‰\nç›®å‰ï¼š' +
      (record.scheduledDate || 'æœªæŒ‡å®š'),
    record.scheduledDate || ''
  );
  if (dateStr !== null && dateStr.trim() === '') dateStr = null;

  try {
    var res = await fetch('/api/delivery/update', {
      method: 'POST', // ä¹Ÿå¯ä»¥æ”¹æˆ PUTï¼Œçœ‹ä½ å¾Œç«¯æ€éº¼å¯«
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        id          : id,
        amount      : amount,
        note        : note,
        notifyStatus: notifyStatus,
        scheduledDate: dateStr
      })
    });
    var data = await res.json();
    if (data.success) {
      showResult('success', 'âœ… å¤–é€ç´€éŒ„å·²æ›´æ–°');
      loadDeliveries(false);
    } else {
      showResult('error', 'âŒ æ›´æ–°å¤±æ•—ï¼š' + (data.error || 'æœªçŸ¥éŒ¯èª¤'));
    }
  } catch (e) {
    showResult('error', 'âŒ é€£ç·šå¤±æ•—ï¼š' + e.message);
  }
}

// ä»Šå¤©æœ‰æ’ç¨‹å°±è‡ªå‹•è·³æé†’
function checkTodayDeliveryAlerts() {
  if (!allDeliveries || allDeliveries.length === 0) return;

  var today = new Date().toISOString().substring(0, 10);

  var todayList = allDeliveries.filter(function(o) {
    var sd = (o.scheduledDate || '').toString().substring(0, 10);
    var signed = !!(o.signed || o.isSigned);
    return sd === today && !signed;
  });

  if (todayList.length === 0) return;

  var msg = 'ğŸ“£ ä»Šå¤©å…±æœ‰ ' + todayList.length + ' ç­†å¤–é€æ’ç¨‹ï¼š\n\n';
  todayList.forEach(function(o) {
    msg +=
      '#'+ (o.customerNumber || '') +
      ' ' + (o.customerName || '') +
      ' é‡‘é¡ NT$ ' + ((o.amount || 0).toLocaleString()) +
      '\n';
  });

  alert(msg);
}

    // ========================================
   // ========================================
// ğŸ“¢ ç´”æ–‡å­—é€šçŸ¥åŠŸèƒ½ï¼ˆç¨ç«‹åˆ†é ç‰ˆï¼‰
// ========================================

var notifyTemplatesData = [];

// å¿«é€Ÿæœå°‹å®¢æˆ¶ï¼ˆç´”æ–‡å­—é€šçŸ¥ç”¨ï¼‰
function searchForNotify() {
  var query = document.getElementById('notifySearch').value.trim();
  if (!query) {
    alert('è«‹è¼¸å…¥ç·¨è™Ÿæˆ–å§“å');
    return;
  }

  // å…ˆæ‰¾ç·¨è™Ÿ
  if (savedCustomers[query]) {
    var c = savedCustomers[query];
    document.getElementById('notifyUserId').value = c.userId || '';
    document.getElementById('notifyUserName').value = c.name || '';
    document.getElementById('notifyCardNumber').textContent = query;
    document.getElementById('notifyCardName').textContent = c.name;
    document.getElementById('notifyCardUserId').textContent = c.userId;
    document.getElementById('notifyCustomerCard').style.display = 'block';
    return;
  }

  // å†æ‰¾å§“å
  var found = Object.entries(savedCustomers).find(function(item) {
    return (item[1].name || '').includes(query);
  });
  if (found) {
    var number = found[0];
    var c = found[1];
    document.getElementById('notifyUserId').value = c.userId || '';
    document.getElementById('notifyUserName').value = c.name || '';
    document.getElementById('notifyCardNumber').textContent = number;
    document.getElementById('notifyCardName').textContent = c.name;
    document.getElementById('notifyCardUserId').textContent = c.userId;
    document.getElementById('notifyCustomerCard').style.display = 'block';
    return;
  }

  alert('æ‰¾ä¸åˆ°æ­¤å®¢æˆ¶');
}

// è¼‰å…¥é€šçŸ¥æ¨¡æ¿
async function loadNotifyTemplates() {
  try {
    var res = await fetch('/api/notify-templates');
    var data = await res.json();
    if (data.success) {
      notifyTemplatesData = data.templates || [];
      displayNotifyTemplates();
    }
  } catch (error) {
    console.error('è¼‰å…¥é€šçŸ¥æ¨¡æ¿å¤±æ•—:', error);
  }
}

// é¡¯ç¤ºé€šçŸ¥æ¨¡æ¿åˆ—è¡¨ï¼ˆå¯é¸æ“‡ã€ç·¨è¼¯ã€åˆªé™¤ï¼‰
function displayNotifyTemplates() {
  var container = document.getElementById('notifyTemplateList');
  if (!container) return;
  
  if (notifyTemplatesData.length === 0) {
    container.innerHTML = '<p style="color:#999; text-align:center;">å°šç„¡æ¨¡æ¿ï¼Œè«‹å…ˆæ–°å¢æ¨¡æ¿</p>';
    return;
  }
  
  var html = '';
  notifyTemplatesData.forEach(function(template, index) {
    html += '<div class="template-item" style="margin-bottom: 10px;">' +
      '<div style="background: #fff; padding: 12px; border-radius: 8px; border: 2px solid #e0e0e0;">' +
      '<div style="white-space: pre-wrap; margin-bottom: 10px; color: #333; line-height: 1.6;">' + template + '</div>' +
      '<div style="display: flex; gap: 8px; flex-wrap: wrap;">' +
      '<button class="btn btn-small" style="background: #667eea;" onclick="useNotifyTemplate(' + index + ')">âœ… ä½¿ç”¨</button>' +
      '<button class="btn btn-small btn-secondary" onclick="editNotifyTemplate(' + index + ')">âœï¸ ç·¨è¼¯</button>' +
      '<button class="btn btn-small btn-danger" onclick="deleteNotifyTemplate(' + index + ')">ğŸ—‘ï¸ åˆªé™¤</button>' +
      '</div>' +
      '</div>' +
      '</div>';
  });
  container.innerHTML = html;
}

// ä½¿ç”¨æ¨¡æ¿
function useNotifyTemplate(index) {
  var el = document.getElementById('notifyMessage');
  if (el) el.value = notifyTemplatesData[index] || '';
  showResult('success', 'âœ… å·²å¥—ç”¨æ¨¡æ¿');
}

// æ–°å¢é€šçŸ¥æ¨¡æ¿
async function addNotifyTemplate() {
  var content = document.getElementById('newNotifyTemplate').value.trim();
  if (!content) {
    alert('è«‹è¼¸å…¥æ¨¡æ¿å…§å®¹');
    return;
  }

  try {
    var res = await fetch('/api/notify-templates', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ content: content })
    });
    var data = await res.json();
    if (data.success) {
      showResult('success', 'âœ… å·²æ–°å¢é€šçŸ¥æ¨¡æ¿');
      document.getElementById('newNotifyTemplate').value = '';
      await loadNotifyTemplates();
    } else {
      showResult('error', 'âŒ æ–°å¢å¤±æ•—: ' + (data.error || 'æœªçŸ¥éŒ¯èª¤'));
    }
  } catch (error) {
    showResult('error', 'âŒ é€£ç·šå¤±æ•—: ' + error.message);
  }
}

// ç·¨è¼¯é€šçŸ¥æ¨¡æ¿
async function editNotifyTemplate(index) {
  var newContent = prompt('ä¿®æ”¹æ¨¡æ¿å…§å®¹ï¼š', notifyTemplatesData[index] || '');
  if (newContent === null) return;
  if (!newContent.trim()) {
    alert('æ¨¡æ¿å…§å®¹ä¸èƒ½ç‚ºç©º');
    return;
  }

  try {
    var res = await fetch('/api/notify-templates/' + index, {
      method: 'PUT',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ content: newContent.trim() })
    });
    var data = await res.json();
    if (data.success) {
      showResult('success', 'âœ… æ¨¡æ¿å·²æ›´æ–°');
      await loadNotifyTemplates();
    } else {
      showResult('error', 'âŒ æ›´æ–°å¤±æ•—: ' + (data.error || 'æœªçŸ¥éŒ¯èª¤'));
    }
  } catch (error) {
    showResult('error', 'âŒ é€£ç·šå¤±æ•—: ' + error.message);
  }
}

// åˆªé™¤é€šçŸ¥æ¨¡æ¿
async function deleteNotifyTemplate(index) {
  if (!confirm('ç¢ºå®šåˆªé™¤æ­¤æ¨¡æ¿ï¼Ÿ')) return;

  try {
    var res = await fetch('/api/notify-templates/' + index, { method: 'DELETE' });
    var data = await res.json();
    if (data.success) {
      showResult('success', 'âœ… æ¨¡æ¿å·²åˆªé™¤');
      await loadNotifyTemplates();
    } else {
      showResult('error', 'âŒ åˆªé™¤å¤±æ•—: ' + (data.error || 'æœªçŸ¥éŒ¯èª¤'));
    }
  } catch (error) {
    showResult('error', 'âŒ é€£ç·šå¤±æ•—: ' + error.message);
  }
}

// ç™¼é€ç´”æ–‡å­—é€šçŸ¥
document.getElementById('notificationForm').addEventListener('submit', async function(e) {
  e.preventDefault();
  
  var userId = document.getElementById('notifyUserId').value.trim();
  var userName = document.getElementById('notifyUserName').value.trim();
  var message = document.getElementById('notifyMessage').value.trim();

  if (!userId || !userName || !message) {
    showResult('error', 'âŒ è«‹å¡«å¯«æ‰€æœ‰æ¬„ä½ï¼');
    return;
  }

  try {
    var res = await fetch('/send-notification', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        userId: userId,
        userName: userName,
        message: message
      })
    });

    var data = await res.json();

    if (data.success) {
      showResult('success', 'âœ… é€šçŸ¥å·²æˆåŠŸç™¼é€çµ¦ ' + userName + 'ï¼<br><br>è¨Šæ¯å…§å®¹ï¼š<br>' + message);
      document.getElementById('notificationForm').reset();
      document.getElementById('notifyCustomerCard').style.display = 'none';
    } else {
      showResult('error', 'âŒ ç™¼é€å¤±æ•—: ' + (data.error || 'ä¼ºæœå™¨ç„¡å›æ‡‰'));
    }
  } catch (err) {
    showResult('error', 'âŒ éŒ¯èª¤: ' + err.message);
  }
});

// é é¢è¼‰å…¥æ™‚åˆå§‹åŒ–
document.addEventListener('DOMContentLoaded', function() {
  initLoad();
  loadNotifyTemplates();
  loadDeliveries(true);
  checkTodayDeliveryAlerts();
});

// ========================================
// ğŸ‘¤ å®¢äººç´€éŒ„åŠŸèƒ½
// ========================================

// è¼‰å…¥å®¢äººç´€éŒ„
async function loadRecords() {
  var wrap = document.getElementById('recordList');
  if (!wrap) return;
  
  wrap.innerHTML = '<p style="text-align:center; color:#999;">è¼‰å…¥ä¸­...</p>';
  
  try {
    var res = await fetch('/api/customer-records');
    
    // â­ å…ˆæª¢æŸ¥ HTTP ç‹€æ…‹
    if (!res.ok) {
      throw new Error('HTTP ' + res.status + ': ' + res.statusText);
    }
    
    // â­ æª¢æŸ¥å›æ‡‰æ ¼å¼
    var contentType = res.headers.get('content-type');
    if (!contentType || !contentType.includes('application/json')) {
      throw new Error('ä¼ºæœå™¨å›æ‡‰æ ¼å¼éŒ¯èª¤ï¼ˆé JSONï¼‰');
    }
    
    var data = await res.json();
    
    if (!data.success) {
      throw new Error(data.error || 'è¼‰å…¥å¤±æ•—');
    }
    
    allRecords = Array.isArray(data.records) ? data.records : [];
    updateRecordStats(data.statistics || {});
    displayRecords(allRecords);
    
  } catch (e) {
    console.error('è¼‰å…¥å®¢äººç´€éŒ„å¤±æ•—:', e);
    allRecords = [];
    wrap.innerHTML = '<p style="text-align:center; color:#dc3545;">è¼‰å…¥å¤±æ•—ï¼š' + e.message + '</p>';
  }
}

// æ›´æ–°çµ±è¨ˆè³‡è¨Š
function updateRecordStats(stats) {
  document.getElementById('totalRecords').textContent = stats.total || 0;
  document.getElementById('todayRecords').textContent = stats.today || 0;
  document.getElementById('weekRecords').textContent = stats.week || 0;
}

// é¡¯ç¤ºå®¢äººç´€éŒ„åˆ—è¡¨
function displayRecords(records) {
  var wrap = document.getElementById('recordList');
  if (!wrap) return;
  
  if (!records || records.length === 0) {
    wrap.innerHTML = '<p style="text-align:center; color:#999;">å°šç„¡å®¢äººç´€éŒ„</p>';
    return;
  }
  
  var html = '';
  records.forEach(function(r) {
    var firstContactDate = r.firstContact ? new Date(r.firstContact).toLocaleString('zh-TW') : '-';
    var lastContactDate = r.lastContact ? new Date(r.lastContact).toLocaleString('zh-TW') : '-';
    var messageCount = r.messageCount || 0;
    
    // åˆ¤æ–·æ˜¯å¦ç‚ºæ–°å®¢äººï¼ˆ7å¤©å…§ï¼‰
    var isNew = false;
    if (r.firstContact) {
      var daysDiff = (Date.now() - new Date(r.firstContact).getTime()) / (1000 * 60 * 60 * 24);
      isNew = daysDiff <= 7;
    }
    
    var newBadge = isNew 
      ? '<span style="background:#52c41a;color:#fff;padding:3px 8px;border-radius:5px;font-size:12px;margin-left:5px;">ğŸ†• æ–°å®¢äºº</span>'
      : '';
    
    html +=
      '<div class="user-item" style="display:block; margin-bottom:10px;">' +
      '<div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px;">' +
      '<div>' +
      '<strong style="font-size:16px;">' + (r.displayName || 'æœªçŸ¥') + '</strong> ' +
      newBadge +
      '</div>' +
      '<div style="font-size:14px; color:#667eea; font-weight:600;">å°è©± ' + messageCount + ' æ¬¡</div>' +
      '</div>' +
      '<div style="font-size:13px; color:#666; margin-bottom:8px;">' +
      '<div><strong>User ID:</strong> ' + (r.userId || '-') + '</div>' +
      '<div><strong>é¦–æ¬¡å°è©±:</strong> ' + firstContactDate + '</div>' +
      '<div><strong>æœ€å¾Œå°è©±:</strong> ' + lastContactDate + '</div>' +
      '</div>' +
      '<div style="display:flex; gap:5px; flex-wrap:wrap;">' +
      '<button class="btn btn-small btn-secondary" onclick="copyUserId(\'' + (r.userId || '') + '\')">ğŸ“‹ è¤‡è£½ User ID</button>' +
      '<button class="btn btn-small" style="background:#1890ff;color:#fff;" onclick="viewRecordDetail(\'' + (r.userId || '') + '\')">ğŸ‘ï¸ æŸ¥çœ‹è©³æƒ…</button>' +
      '<button class="btn btn-small" style="background:#52c41a;color:#fff;" onclick="addCustomerNumber(\'' + (r.userId || '') + '\', \'' + (r.displayName || '') + '\')">â• æ–°å¢ç·¨è™Ÿ</button>' +
      '</div>' +
      '</div>';
  });
  
  wrap.innerHTML = html;
}

// æœå°‹å®¢äººç´€éŒ„
function searchRecords() {
  var query = (document.getElementById('recordSearchInput').value || '').toLowerCase().trim();
  
  if (!query) {
    displayRecords(allRecords);
    return;
  }
  
  var filtered = (allRecords || []).filter(function(r) {
    return (r.displayName || '').toLowerCase().includes(query) || 
           (r.userId || '').toLowerCase().includes(query);
  });
  
  displayRecords(filtered);
  
  if (filtered.length === 0) {
    document.getElementById('recordList').innerHTML = '<p style="text-align:center; color:#999;">æ‰¾ä¸åˆ°ç¬¦åˆçš„å®¢äºº</p>';
  }
}

// è¤‡è£½ User ID
function copyUserId(userId) {
  if (!userId) return;
  
  navigator.clipboard.writeText(userId).then(
    function() { 
      showResult('success', 'ğŸ“‹ å·²è¤‡è£½ User ID'); 
    },
    function() { 
      showResult('error', 'âŒ è¤‡è£½å¤±æ•—ï¼ŒUser ID: ' + userId); 
    }
  );
}

// æŸ¥çœ‹å®¢äººè©³æƒ…ï¼ˆæ”¹é€²ç‰ˆ - é¡¯ç¤ºåœ¨è¦–çª—ä¸­ï¼‰
async function viewRecordDetail(userId) {
  if (!userId) return;
  
  try {
    var res = await fetch('/api/customer-records/' + encodeURIComponent(userId));
    var data = await res.json();
    
    if (!data.success) {
      alert('ç„¡æ³•è¼‰å…¥å®¢äººè©³æƒ…');
      return;
    }
    
    var record = data.record;
    
    // å»ºç«‹å½ˆå‡ºè¦–çª—
    var modal = document.createElement('div');
    modal.style.cssText = 'position:fixed; inset:0; background:rgba(0,0,0,0.6); z-index:9999; display:flex; align-items:center; justify-content:center; padding:20px;';
    
    var content = document.createElement('div');
    content.style.cssText = 'background:#fff; border-radius:20px; padding:30px; max-width:600px; width:100%; max-height:80vh; overflow-y:auto;';
    
    var html = '<h3 style="color:#667eea; margin-bottom:20px;">ğŸ‘¤ å®¢äººè©³ç´°è³‡è¨Š</h3>';
    html += '<div style="background:#f0f4ff; padding:20px; border-radius:10px; margin-bottom:20px;">';
    html += '<p style="margin:8px 0;"><strong>å§“åï¼š</strong>' + (record.displayName || 'æœªçŸ¥') + '</p>';
    html += '<p style="margin:8px 0;"><strong>User IDï¼š</strong><br><span style="font-size:12px; word-break:break-all;">' + (record.userId || '-') + '</span></p>';
    html += '<p style="margin:8px 0;"><strong>é¦–æ¬¡å°è©±ï¼š</strong>' + (record.firstContact ? new Date(record.firstContact).toLocaleString('zh-TW') : '-') + '</p>';
    html += '<p style="margin:8px 0;"><strong>æœ€å¾Œå°è©±ï¼š</strong>' + (record.lastContact ? new Date(record.lastContact).toLocaleString('zh-TW') : '-') + '</p>';
    html += '<p style="margin:8px 0;"><strong>å°è©±æ¬¡æ•¸ï¼š</strong>' + (record.messageCount || 0) + ' æ¬¡</p>';
    html += '</div>';
    
    if (record.lastMessage) {
      html += '<div style="background:#f8f9fa; padding:15px; border-radius:10px; margin-bottom:20px;">';
      html += '<p style="margin:0 0 8px 0; font-weight:600; color:#333;">ğŸ“ æœ€å¾Œè¨Šæ¯ï¼š</p>';
      html += '<p style="margin:0; color:#666; white-space:pre-wrap; line-height:1.6;">' + record.lastMessage + '</p>';
      html += '</div>';
    }
    
    html += '<div style="display:flex; gap:10px;">';
    html += '<button class="btn btn-secondary" style="flex:1;" onclick="this.closest(\'[data-modal]\').remove()">é—œé–‰</button>';
    html += '<button class="btn" style="flex:1; background:#52c41a;" onclick="addCustomerNumberFromDetail(\'' + record.userId + '\', \'' + (record.displayName || '') + '\')">â• æ–°å¢ç·¨è™Ÿ</button>';
    html += '</div>';
    
    content.innerHTML = html;
    modal.setAttribute('data-modal', 'true');
    modal.appendChild(content);
    document.body.appendChild(modal);
    
    // é»æ“ŠèƒŒæ™¯é—œé–‰
    modal.addEventListener('click', function(e) {
      if (e.target === modal) modal.remove();
    });
    
  } catch (e) {
    alert('è¼‰å…¥å¤±æ•—ï¼š' + e.message);
  }
}

// åŒ¯å‡ºå®¢äººè³‡æ–™
function exportRecords() {
  if (!allRecords || allRecords.length === 0) {
    alert('ç›®å‰æ²’æœ‰å®¢äººç´€éŒ„å¯åŒ¯å‡º');
    return;
  }
  
  // å»ºç«‹ CSV å…§å®¹
  var csv = 'å§“å,User ID,é¦–æ¬¡å°è©±,æœ€å¾Œå°è©±,å°è©±æ¬¡æ•¸\n';
  
  allRecords.forEach(function(r) {
    var name = (r.displayName || 'æœªçŸ¥').replace(/,/g, '');
    var userId = r.userId || '';
    var first = r.firstContact ? new Date(r.firstContact).toLocaleString('zh-TW') : '';
    var last = r.lastContact ? new Date(r.lastContact).toLocaleString('zh-TW') : '';
    var count = r.messageCount || 0;
    
    csv += name + ',' + userId + ',' + first + ',' + last + ',' + count + '\n';
  });
  
  // ä¸‹è¼‰ CSV
  var blob = new Blob(['\uFEFF' + csv], { type: 'text/csv;charset=utf-8;' });
  var link = document.createElement('a');
  var url = URL.createObjectURL(blob);
  var timestamp = new Date().toISOString().substring(0, 10);
  
  link.setAttribute('href', url);
  link.setAttribute('download', 'customer_records_' + timestamp + '.csv');
  link.style.visibility = 'hidden';
  
  document.body.appendChild(link);
  link.click();
  document.body.removeChild(link);
  
  showResult('success', 'âœ… å®¢äººç´€éŒ„å·²åŒ¯å‡º');
}
    
// ========================================
// ğŸ“ äººå·¥é€šçŸ¥åŠŸèƒ½
// ========================================

// å¿«é€Ÿæœå°‹å®¢æˆ¶
function searchForManual() {
  var num = document.getElementById('manualSearch').value.trim();
  if (!num) return alert('è«‹è¼¸å…¥ç·¨è™Ÿ');
  
  if (savedCustomers[num]) {
    var c = savedCustomers[num];
    document.getElementById('manualNumber').value = num;
    document.getElementById('manualName').value = c.name || '';
    document.getElementById('manualCardNumber').textContent = num;
    document.getElementById('manualCardName').textContent = c.name || '';
    document.getElementById('manualCustomerCard').style.display = 'block';
  } else {
    alert('æ‰¾ä¸åˆ°æ­¤å®¢æˆ¶ç·¨è™Ÿ');
  }
}

// æ–°å¢äººå·¥é€šçŸ¥ç´€éŒ„
async function addManual() {
  var num = document.getElementById('manualNumber').value.trim();
  var name = document.getElementById('manualName').value.trim();
  var needDelivery = document.querySelector('input[name="manualNeedDelivery"]:checked').value;
  var content = document.getElementById('manualContent').value.trim();
  var amount = document.getElementById('manualAmount').value.trim();
  
  if (!num || !name) {
    alert('è«‹è‡³å°‘å¡«å¯« ç·¨è™Ÿ / å§“å');
    return;
  }
  var amountValue = parseInt(amount) || 0; // â­ è½‰æ›é‡‘é¡
  
  try {
    var res = await fetch('/api/manual/add', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        customerNumber: num,
        customerName: name,
        needDelivery: needDelivery,
        content: content,
        amount: amountValue,
      })
    });
    
    var data = await res.json();
    if (data.success) {
      showResult('success', 'âœ… å·²æ–°å¢äººå·¥é€šçŸ¥ç´€éŒ„');
      document.getElementById('manualNumber').value = '';
      document.getElementById('manualName').value = '';
      document.getElementById('manualAmount').value = ''; // â­ æ¸…ç©ºé‡‘é¡
      document.querySelector('input[name="manualNeedDelivery"][value="yes"]').checked = true;
      document.getElementById('manualContent').value = '';
      document.getElementById('manualCustomerCard').style.display = 'none';
      loadManuals();
    } else {
      showResult('error', 'âŒ æ–°å¢å¤±æ•—ï¼š' + (data.error || 'æœªçŸ¥éŒ¯èª¤'));
    }
  } catch (e) {
    showResult('error', 'âŒ é€£ç·šå¤±æ•—ï¼š' + e.message);
  }
}

// è¼‰å…¥äººå·¥é€šçŸ¥åˆ—è¡¨
async function loadManuals() {
  var wrap = document.getElementById('manualList');
  if (!wrap) return;
  
  wrap.innerHTML = '<p style="text-align:center; color:#999;">è¼‰å…¥ä¸­...</p>';
  
  try {
    var res = await fetch('/api/manual/orders');
    var data = await res.json();
    if (!data.success) throw new Error(data.error || 'è¼‰å…¥å¤±æ•—');
    
    allManuals = Array.isArray(data.orders) ? data.orders : [];
    renderManualList();
  } catch (e) {
    allManuals = [];
    wrap.innerHTML = '<p style="text-align:center; color:#dc3545;">è¼‰å…¥å¤±æ•—ï¼š' + e.message + '</p>';
  }
}

// é¡¯ç¤ºäººå·¥é€šçŸ¥åˆ—è¡¨ï¼ˆä¾æ—¥æœŸåˆ†çµ„ï¼‰
function renderManualList() {
  var wrap = document.getElementById('manualList');
  if (!wrap) return;
  
  if (!allManuals || allManuals.length === 0) {
    wrap.innerHTML = '<p style="text-align:center; color:#999;">ç›®å‰æ²’æœ‰äººå·¥é€šçŸ¥ç´€éŒ„</p>';
    return;
  }
  
  // ä¾æ—¥æœŸåˆ†çµ„
  var groups = {};
  allManuals.forEach(function(o) {
    var rawDate = (o.createdDate || o.createdAt || '').toString().substring(0, 10) || 'æœªæŒ‡å®šæ—¥æœŸ';
    if (!groups[rawDate]) groups[rawDate] = [];
    groups[rawDate].push(o);
  });
  
  var dates = Object.keys(groups).sort().reverse(); // æ–°çš„æ—¥æœŸåœ¨å‰
  var todayStr = new Date().toISOString().substring(0, 10);
  
  var html = '';
  dates.forEach(function(dk) {
    var tag = (dk === todayStr) ? 'ï¼ˆä»Šå¤©ï¼‰' : '';
    html += '<h4 style="margin-top:10px; margin-bottom:8px; color:#667eea;">ğŸ“… ' + dk + ' ' + tag + '</h4>';
    
    groups[dk].forEach(function(o) {
      var id = o.id || o.recordId || '';
      var notified = !!(o.notified || o.isNotified);
      var paid = !!(o.paid || o.isPaid); // â­ ä»˜æ¬¾ç‹€æ…‹
      var amount = parseInt(o.amount) || 0; // â­ é‡‘é¡
      var needDelivery = o.needDelivery === 'yes' ? 'éœ€è¦å¤–é€' : 'ä¸éœ€è¦å¤–é€';
      
      var badgeNotified = notified
        ? '<span style="background:#52c41a;color:#fff;padding:3px 8px;border-radius:5px;font-size:12px;margin-left:5px;">âœ… å·²é€šçŸ¥</span>'
        : '<span style="background:#faad14;color:#fff;padding:3px 8px;border-radius:5px;font-size:12px;margin-left:5px;">âŒ› æœªé€šçŸ¥</span>';
      
      var badgeDelivery = o.needDelivery === 'yes'
        ? '<span style="background:#1890ff;color:#fff;padding:3px 8px;border-radius:5px;font-size:12px;margin-left:5px;">ğŸšš éœ€å¤–é€</span>'
        : '<span style="background:#999;color:#fff;padding:3px 8px;border-radius:5px;font-size:12px;margin-left:5px;">ğŸ“¦ ä¸éœ€å¤–é€</span>';

       // â­ ä»˜æ¬¾ç‹€æ…‹æ¨™è¨˜
      var badgePaid = '';
      if (amount > 0) {
        badgePaid = paid
          ? '<span style="background:#52c41a;color:#fff;padding:3px 8px;border-radius:5px;font-size:12px;margin-left:5px;">ğŸ’° å·²ä»˜æ¬¾</span>'
          : '<span style="background:#ff4d4f;color:#fff;padding:3px 8px;border-radius:5px;font-size:12px;margin-left:5px;">ğŸ’³ æœªä»˜æ¬¾</span>';
      }
      
      var createdTime = '';
      if (o.createdDate || o.createdAt) {
        var d = new Date(o.createdDate || o.createdAt);
        createdTime = d.toLocaleTimeString('zh-TW', { hour: '2-digit', minute: '2-digit' });
      }
      
      html +=
        '<div class="user-item" style="display:block; margin-bottom:8px; opacity:' +
        (notified ? '0.7' : '1') +
        ';">' +
        '<div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:6px;">' +
        '<div>' +
        '<strong style="font-size:15px;">#' +
        (o.customerNumber || '') +
        ' - ' +
        (o.customerName || '') +
        '</strong> ' +
        badgeNotified +
        badgeDelivery +
        '</div>' +
        '<div style="font-size:12px; color:#999;">' + createdTime + '</div>' +
        '</div>' +
        '<div style="font-size:13px; color:#666; margin-bottom:8px;">' +
        (o.content ? '<div>ğŸ“ å…§å®¹ï¼š' + (o.content || '').replace(/\n/g, '<br>') + '</div>' : '<div style="color:#999;">ï¼ˆç„¡é€šçŸ¥å…§å®¹ï¼‰</div>') +
        '</div>' +
        '<div style="display:flex; gap:5px; flex-wrap:wrap;">';
      
      if (!notified) {
        html +=
          '<button class="btn btn-small btn-secondary" onclick="markManualNotified(\'' + id + '\')">âœ… å·²é€šçŸ¥</button>';
      }

      // â­ ä»˜æ¬¾æŒ‰éˆ•ï¼ˆåªåœ¨æœ‰é‡‘é¡ä¸”æœªä»˜æ¬¾æ™‚é¡¯ç¤ºï¼‰
      if (amount > 0 && !paid) {
        html += '<button class="btn btn-small" style="background:#52c41a;color:#fff;" onclick="markManualPaid(\'' + id + '\')">ğŸ’° å·²ä»˜æ¬¾</button>';
      }
      
      html +=
        '<button class="btn btn-small" style="background:#ff9800;color:#fff;" onclick="editManual(\'' + id + '\')">âœï¸ ç·¨è¼¯</button>' +
        '<button class="btn btn-small btn-danger" onclick="deleteManual(\'' + id + '\')">ğŸ—‘ï¸ åˆªé™¤</button>' +
        '</div>' +
        '</div>';
    });
  });
  
  wrap.innerHTML = html;
}

// æ¨™è¨˜å·²é€šçŸ¥
async function markManualNotified(id) {
  if (!confirm('ç¢ºèªæ¨™è¨˜ç‚ºã€Œå·²é€šçŸ¥ã€ï¼Ÿ')) return;
  
  try {
    var res = await fetch('/api/manual/mark-notified', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ id: id })
    });
    
    var data = await res.json();
    if (data.success) {
      showResult('success', 'âœ… å·²æ¨™è¨˜ç‚ºå·²é€šçŸ¥');
      loadManuals();
    } else {
      showResult('error', 'âŒ æ“ä½œå¤±æ•—ï¼š' + (data.error || 'æœªçŸ¥éŒ¯èª¤'));
    }
  } catch (e) {
    showResult('error', 'âŒ é€£ç·šå¤±æ•—ï¼š' + e.message);
  }
}

// â­â­â­ åœ¨é€™è£¡åŠ å…¥æ–°å‡½æ•¸ â­â­â­
// æ¨™è¨˜å·²ä»˜æ¬¾
async function markManualPaid(id) {
  if (!confirm('ç¢ºèªæ¨™è¨˜ç‚ºã€Œå·²ä»˜æ¬¾ã€ï¼Ÿ')) return;
  
  try {
    var res = await fetch('/api/manual/mark-paid', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ id: id })
    });
    
    var data = await res.json();
    if (data.success) {
      showResult('success', 'âœ… å·²æ¨™è¨˜ç‚ºå·²ä»˜æ¬¾');
      loadManuals();
    } else {
      showResult('error', 'âŒ æ“ä½œå¤±æ•—ï¼š' + (data.error || 'æœªçŸ¥éŒ¯èª¤'));
    }
  } catch (e) {
    showResult('error', 'âŒ é€£ç·šå¤±æ•—ï¼š' + e.message);
  }
}
// â­â­â­ æ–°å‡½æ•¸çµæŸ â­â­â­
    
// ç·¨è¼¯äººå·¥é€šçŸ¥
async function editManual(id) {
  var manual = allManuals.find(function(o) {
    return (o.id || o.recordId) === id;
  });
  
  if (!manual) {
    alert('æ‰¾ä¸åˆ°æ­¤ç´€éŒ„');
    return;
  }

 // â­ æ–°å¢é‡‘é¡ç·¨è¼¯
  var amountStr = prompt('ä¿®æ”¹é‡‘é¡ï¼ˆç›®å‰ï¼š' + (manual.amount || 0) + 'ï¼‰', manual.amount || 0);
  if (amountStr === null) return;
  var amount = parseInt(amountStr) || 0;
  
  var needDelivery = confirm('æ˜¯å¦éœ€è¦å¤–é€ï¼Ÿ\nã€Œç¢ºå®šã€= éœ€è¦å¤–é€\nã€Œå–æ¶ˆã€= ä¸éœ€è¦å¤–é€');
  var needDeliveryValue = needDelivery ? 'yes' : 'no';
  
  var content = prompt('ä¿®æ”¹é€šçŸ¥å…§å®¹ï¼ˆå¯ä»¥ç•™ç©ºï¼‰', manual.content || '');
  if (content === null) content = manual.content || '';
  
  try {
    var res = await fetch('/api/manual/update', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        id: id,
        needDelivery: needDeliveryValue,
        content: content,
        amount: amount,
      })
    });
    
    var data = await res.json();
    if (data.success) {
      showResult('success', 'âœ… äººå·¥é€šçŸ¥å·²æ›´æ–°');
      loadManuals();
    } else {
      showResult('error', 'âŒ æ›´æ–°å¤±æ•—ï¼š' + (data.error || 'æœªçŸ¥éŒ¯èª¤'));
    }
  } catch (e) {
    showResult('error', 'âŒ é€£ç·šå¤±æ•—ï¼š' + e.message);
  }
}

// åˆªé™¤äººå·¥é€šçŸ¥
async function deleteManual(id) {
  if (!confirm('ç¢ºå®šè¦åˆªé™¤æ­¤äººå·¥é€šçŸ¥ç´€éŒ„ï¼Ÿ')) return;
  
  try {
    var res = await fetch('/api/manual/order/' + encodeURIComponent(id), {
      method: 'DELETE'
    });
    
    var data = await res.json();
    if (data.success) {
      showResult('success', 'âœ… å·²åˆªé™¤äººå·¥é€šçŸ¥ç´€éŒ„');
      loadManuals();
    } else {
      showResult('error', 'âŒ åˆªé™¤å¤±æ•—ï¼š' + (data.error || 'æœªçŸ¥éŒ¯èª¤'));
    }
  } catch (e) {
    showResult('error', 'âŒ é€£ç·šå¤±æ•—ï¼š' + e.message);
  }
}    
    
// ========================================
// âš¡ æ€¥ä»¶è¿½è¹¤åŠŸèƒ½
// ========================================

// å¿«é€Ÿæœå°‹å®¢æˆ¶
function searchForUrgent() {
  var num = document.getElementById('urgentSearch').value.trim();
  if (!num) return alert('è«‹è¼¸å…¥ç·¨è™Ÿ');
  
  if (savedCustomers[num]) {
    var c = savedCustomers[num];
    document.getElementById('urgentNumber').value = num;
    document.getElementById('urgentName').value = c.name || '';
    document.getElementById('urgentCardNumber').textContent = num;
    document.getElementById('urgentCardName').textContent = c.name || '';
    document.getElementById('urgentCustomerCard').style.display = 'block';
  } else {
    alert('æ‰¾ä¸åˆ°æ­¤å®¢æˆ¶ç·¨è™Ÿ');
  }
}

// æ–°å¢æ€¥ä»¶è¿½è¹¤
async function addUrgent() {
  var num = document.getElementById('urgentNumber').value.trim();
  var name = document.getElementById('urgentName').value.trim();
  var clothesRange = document.getElementById('urgentClothesRange').value.trim();
  var trackDate = document.getElementById('urgentTrackDate').value;
  var pickupDate = document.getElementById('urgentPickupDate').value;
  var note = document.getElementById('urgentNote').value.trim();
  
  if (!num || !name || !clothesRange || !trackDate || !pickupDate) {
    alert('è«‹å¡«å¯«æ‰€æœ‰å¿…å¡«æ¬„ä½ï¼ˆ*ï¼‰');
    return;
  }
  
  try {
    var res = await fetch('/api/urgent/add', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        customerNumber: num,
        customerName: name,
        clothesRange: clothesRange,
        trackDate: trackDate,
        pickupDate: pickupDate,
        note: note
      })
    });
    
    var data = await res.json();
    if (data.success) {
      showResult('success', 'âœ… å·²æ–°å¢æ€¥ä»¶è¿½è¹¤');
      document.getElementById('urgentNumber').value = '';
      document.getElementById('urgentName').value = '';
      document.getElementById('urgentClothesRange').value = '';
      document.getElementById('urgentTrackDate').value = '';
      document.getElementById('urgentPickupDate').value = '';
      document.getElementById('urgentNote').value = '';
      document.getElementById('urgentCustomerCard').style.display = 'none';
      loadUrgents(false);
    } else {
      showResult('error', 'âŒ æ–°å¢å¤±æ•—ï¼š' + (data.error || 'æœªçŸ¥éŒ¯èª¤'));
    }
  } catch (e) {
    showResult('error', 'âŒ é€£ç·šå¤±æ•—ï¼š' + e.message);
  }
}

// è¼‰å…¥æ€¥ä»¶è¿½è¹¤åˆ—è¡¨
async function loadUrgents(showAlert) {
  var wrap = document.getElementById('urgentList');
  if (!wrap) return;
  
  wrap.innerHTML = '<p style="text-align:center; color:#999;">è¼‰å…¥ä¸­...</p>';
  
  try {
    var res = await fetch('/api/urgent/orders');
    var data = await res.json();
    if (!data.success) throw new Error(data.error || 'è¼‰å…¥å¤±æ•—');
    
    allUrgents = Array.isArray(data.orders) ? data.orders : [];
    renderUrgentList();
    
    if (showAlert) {
      checkTodayUrgentAlerts();
    }
  } catch (e) {
    allUrgents = [];
    wrap.innerHTML = '<p style="text-align:center; color:#dc3545;">è¼‰å…¥å¤±æ•—ï¼š' + e.message + '</p>';
  }
}

// é¡¯ç¤ºæ€¥ä»¶è¿½è¹¤åˆ—è¡¨
function renderUrgentList() {
  var wrap = document.getElementById('urgentList');
  if (!wrap) return;
  
  if (!allUrgents || allUrgents.length === 0) {
    wrap.innerHTML = '<p style="text-align:center; color:#999;">ç›®å‰æ²’æœ‰æ€¥ä»¶è¿½è¹¤</p>';
    return;
  }
  
  var html = '';
  var today = new Date().toISOString().substring(0, 10);
  
  allUrgents.forEach(function(o) {
    var id = o.id || o.recordId || '';
    var completed = !!(o.completed || o.isCompleted);
    var trackDate = o.trackDate ? o.trackDate.substring(0, 10) : '';
    var pickupDate = o.pickupDate ? o.pickupDate.substring(0, 10) : '';
    
    // åˆ¤æ–·æ˜¯å¦éœ€è¦æé†’
    var needTrackAlert = trackDate === today && !completed;
    var needPickupAlert = pickupDate === today && !completed;
    
    var alertBadge = '';
    if (needTrackAlert) {
      alertBadge = '<span style="background:#ff4d4f;color:#fff;padding:3px 8px;border-radius:5px;font-size:12px;margin-left:5px;">ğŸ”¥ ä»Šå¤©è¦å»å·¥å» è¿½è¹¤ï¼</span>';
    }
    if (needPickupAlert) {
      alertBadge += '<span style="background:#faad14;color:#fff;padding:3px 8px;border-radius:5px;font-size:12px;margin-left:5px;">ğŸ“¦ ä»Šå¤©å®¢æˆ¶è¦å–ä»¶ï¼</span>';
    }
    
    var badgeCompleted = completed
      ? '<span style="background:#52c41a;color:#fff;padding:3px 8px;border-radius:5px;font-size:12px;margin-left:5px;">âœ… å·²å®Œæˆ</span>'
      : '';
    
    html +=
      '<div class="user-item" style="display:block; margin-bottom:8px; opacity:' +
      (completed ? '0.6' : '1') +
      '; border-left: 4px solid ' + (needTrackAlert || needPickupAlert ? '#ff4d4f' : '#667eea') + ';">' +
      '<div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:6px;">' +
      '<div>' +
      '<strong style="font-size:15px; cursor:pointer;" onclick="showUrgentDetail(\'' + id + '\')">#' +
      (o.customerNumber || '') +
      ' - ' +
      (o.customerName || '') +
      '</strong> ' +
      alertBadge +
      badgeCompleted +
      '</div>' +
      '</div>' +
      '<div style="font-size:13px; color:#666; margin-bottom:8px;">' +
      '<div>ğŸ“¦ è¡£ç‰©ç·¨è™Ÿï¼š' + (o.clothesRange || '-') + '</div>' +
      '<div>âš¡ æ€¥ä»¶è¿½è¹¤æ—¥æœŸï¼š' + (trackDate || '-') + '</div>' +
      '<div>ğŸ“… å–ä»¶æé†’æ—¥æœŸï¼š' + (pickupDate || '-') + '</div>' +
      (o.note ? '<div>ğŸ“ å‚™è¨»ï¼š' + (o.note || '').replace(/\n/g, '<br>') + '</div>' : '') +
      '</div>' +
      '<div style="display:flex; gap:5px; flex-wrap:wrap;">';
    
    if (!completed) {
      html +=
        '<button class="btn btn-small btn-secondary" onclick="markUrgentCompleted(\'' + id + '\')">âœ… æ¨™è¨˜å®Œæˆ</button>';
    }
    
    html +=
      '<button class="btn btn-small" style="background:#ff9800;color:#fff;" onclick="editUrgent(\'' + id + '\')">âœï¸ ç·¨è¼¯</button>' +
      '<button class="btn btn-small btn-danger" onclick="deleteUrgent(\'' + id + '\')">ğŸ—‘ï¸ åˆªé™¤</button>' +
      '</div>' +
      '</div>';
  });
  
  wrap.innerHTML = html;
}

// é¡¯ç¤ºæ€¥ä»¶è©³æƒ…
function showUrgentDetail(id) {
  var urgent = allUrgents.find(function(o) {
    return (o.id || o.recordId) === id;
  });
  
  if (!urgent) {
    alert('æ‰¾ä¸åˆ°æ­¤æ€¥ä»¶');
    return;
  }
  
  var msg = 
    'ğŸ“‹ æ€¥ä»¶è©³æƒ…\n\n' +
    'å®¢æˆ¶ç·¨è™Ÿï¼š#' + (urgent.customerNumber || '-') + '\n' +
    'å®¢æˆ¶å§“åï¼š' + (urgent.customerName || '-') + '\n' +
    'è¡£ç‰©ç·¨è™Ÿï¼š' + (urgent.clothesRange || '-') + '\n' +
    'æ€¥ä»¶è¿½è¹¤ï¼š' + (urgent.trackDate ? urgent.trackDate.substring(0, 10) : '-') + '\n' +
    'å–ä»¶æé†’ï¼š' + (urgent.pickupDate ? urgent.pickupDate.substring(0, 10) : '-') + '\n' +
    (urgent.note ? 'å‚™è¨»ï¼š' + urgent.note : '');
  
  alert(msg);
}

// æ¨™è¨˜å®Œæˆ
async function markUrgentCompleted(id) {
  if (!confirm('ç¢ºèªæ¨™è¨˜ç‚ºå·²å®Œæˆï¼Ÿ')) return;
  
  try {
    var res = await fetch('/api/urgent/complete', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ id: id })
    });
    
    var data = await res.json();
    if (data.success) {
      showResult('success', 'âœ… å·²æ¨™è¨˜ç‚ºå®Œæˆ');
      loadUrgents(false);
    } else {
      showResult('error', 'âŒ æ“ä½œå¤±æ•—ï¼š' + (data.error || 'æœªçŸ¥éŒ¯èª¤'));
    }
  } catch (e) {
    showResult('error', 'âŒ é€£ç·šå¤±æ•—ï¼š' + e.message);
  }
}

// ç·¨è¼¯æ€¥ä»¶
async function editUrgent(id) {
  var urgent = allUrgents.find(function(o) {
    return (o.id || o.recordId) === id;
  });
  
  if (!urgent) {
    alert('æ‰¾ä¸åˆ°æ­¤æ€¥ä»¶');
    return;
  }
  
  var clothesRange = prompt('ä¿®æ”¹è¡£ç‰©ç·¨è™Ÿç¯„åœï¼š', urgent.clothesRange || '');
  if (clothesRange === null) return;
  
  var trackDate = prompt(
    'ä¿®æ”¹æ€¥ä»¶è¿½è¹¤æ—¥æœŸï¼ˆæ ¼å¼ï¼šYYYY-MM-DDï¼‰ï¼š',
    urgent.trackDate ? urgent.trackDate.substring(0, 10) : ''
  );
  if (trackDate === null) return;
  
  var pickupDate = prompt(
    'ä¿®æ”¹å–ä»¶æé†’æ—¥æœŸï¼ˆæ ¼å¼ï¼šYYYY-MM-DDï¼‰ï¼š',
    urgent.pickupDate ? urgent.pickupDate.substring(0, 10) : ''
  );
  if (pickupDate === null) return;
  
  var note = prompt('ä¿®æ”¹å‚™è¨»ï¼š', urgent.note || '');
  if (note === null) note = urgent.note || '';
  
  try {
    var res = await fetch('/api/urgent/update', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        id: id,
        clothesRange: clothesRange,
        trackDate: trackDate,
        pickupDate: pickupDate,
        note: note
      })
    });
    
    var data = await res.json();
    if (data.success) {
      showResult('success', 'âœ… æ€¥ä»¶å·²æ›´æ–°');
      loadUrgents(false);
    } else {
      showResult('error', 'âŒ æ›´æ–°å¤±æ•—ï¼š' + (data.error || 'æœªçŸ¥éŒ¯èª¤'));
    }
  } catch (e) {
    showResult('error', 'âŒ é€£ç·šå¤±æ•—ï¼š' + e.message);
  }
}

// åˆªé™¤æ€¥ä»¶
async function deleteUrgent(id) {
  if (!confirm('ç¢ºå®šè¦åˆªé™¤æ­¤æ€¥ä»¶è¿½è¹¤ï¼Ÿ')) return;
  
  try {
    var res = await fetch('/api/urgent/order/' + encodeURIComponent(id), {
      method: 'DELETE'
    });
    
    var data = await res.json();
    if (data.success) {
      showResult('success', 'âœ… å·²åˆªé™¤æ€¥ä»¶è¿½è¹¤');
      loadUrgents(false);
    } else {
      showResult('error', 'âŒ åˆªé™¤å¤±æ•—ï¼š' + (data.error || 'æœªçŸ¥éŒ¯èª¤'));
    }
  } catch (e) {
    showResult('error', 'âŒ é€£ç·šå¤±æ•—ï¼š' + e.message);
  }
}

// æª¢æŸ¥ä»Šå¤©çš„æ€¥ä»¶æé†’
function checkTodayUrgentAlerts() {
  if (!allUrgents || allUrgents.length === 0) return;
  
  var today = new Date().toISOString().substring(0, 10);
  var trackAlerts = [];
  var pickupAlerts = [];
  
  allUrgents.forEach(function(o) {
    if (o.completed || o.isCompleted) return;
    
    var trackDate = o.trackDate ? o.trackDate.substring(0, 10) : '';
    var pickupDate = o.pickupDate ? o.pickupDate.substring(0, 10) : '';
    
    if (trackDate === today) {
      trackAlerts.push(o);
    }
    if (pickupDate === today) {
      pickupAlerts.push(o);
    }
  });
  
  var msg = '';
  
  if (trackAlerts.length > 0) {
    msg += 'ğŸ”¥ ä»Šå¤©éœ€è¦å»å·¥å» è¿½è¹¤çš„æ€¥ä»¶ï¼ˆå…± ' + trackAlerts.length + ' ç­†ï¼‰ï¼š\n\n';
    trackAlerts.forEach(function(o) {
      msg += '#' + (o.customerNumber || '') + ' ' + (o.customerName || '') + 
             ' - è¡£ç‰©ï¼š' + (o.clothesRange || '') + '\n';
    });
    msg += '\n';
  }
  
  if (pickupAlerts.length > 0) {
    msg += 'ğŸ“¦ ä»Šå¤©å®¢æˆ¶è¦å–ä»¶çš„æ€¥ä»¶ï¼ˆå…± ' + pickupAlerts.length + ' ç­†ï¼‰ï¼š\n\n';
    pickupAlerts.forEach(function(o) {
      msg += '#' + (o.customerNumber || '') + ' ' + (o.customerName || '') + 
             ' - è¡£ç‰©ï¼š' + (o.clothesRange || '') + '\n';
    });
  }
  
  if (msg) {
    alert(msg);
  }
}
    
  // ========================================
// ğŸ‘¤ å®¢äººç´€éŒ„ - æ–°å¢å®¢æˆ¶ç·¨è™ŸåŠŸèƒ½
// ========================================

// æ–°å¢å®¢æˆ¶ç·¨è™Ÿï¼ˆå¾å®¢äººç´€éŒ„ï¼‰
function addCustomerNumber(userId, displayName) {
  if (!userId) return;
  
  var number = prompt('è«‹è¼¸å…¥å®¢æˆ¶ç·¨è™Ÿï¼ˆä¾‹å¦‚ï¼š001ã€625ï¼‰ï¼š', '');
  
  if (!number || !number.trim()) {
    return;
  }
  
  number = number.trim();
  
  // æª¢æŸ¥ç·¨è™Ÿæ˜¯å¦å·²å­˜åœ¨
  if (savedCustomers[number]) {
    if (!confirm('æ­¤ç·¨è™Ÿå·²å­˜åœ¨ï¼š#' + number + ' (' + savedCustomers[number].name + ')\n\næ˜¯å¦è¦è¦†è“‹ï¼Ÿ')) {
      return;
    }
  }
  
  // å„²å­˜å®¢æˆ¶ç·¨è™Ÿ
  saveCustomerNumberDirect(number, displayName, userId);
}

// å¾è©³æƒ…è¦–çª—æ–°å¢å®¢æˆ¶ç·¨è™Ÿ
function addCustomerNumberFromDetail(userId, displayName) {
  // å…ˆé—œé–‰è©³æƒ…è¦–çª—
  var modals = document.querySelectorAll('[data-modal]');
  modals.forEach(function(m) { m.remove(); });
  
  // å‘¼å«æ–°å¢ç·¨è™Ÿ
  addCustomerNumber(userId, displayName);
}

// ç›´æ¥å„²å­˜å®¢æˆ¶ç·¨è™Ÿï¼ˆä¸éœ€å¡«è¡¨å–®ï¼‰
async function saveCustomerNumberDirect(number, name, userId) {
  try {
    var res = await fetch('/api/customer-numbers', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ 
        number: number, 
        name: name, 
        userId: userId 
      })
    });
    
    var data = await res.json();
    
    if (data.success) {
      showResult('success', 'âœ… å®¢æˆ¶ç·¨è™Ÿå·²å„²å­˜ï¼š#' + number);
      await loadCustomerNumbers();
      loadRecords(); // é‡æ–°è¼‰å…¥å®¢äººç´€éŒ„
    } else {
      showResult('error', 'âŒ å„²å­˜å¤±æ•—: ' + (data.error || 'æœªçŸ¥éŒ¯èª¤'));
    }
  } catch (error) {
    showResult('error', 'âŒ é€£ç·šå¤±æ•—: ' + error.message);
  }
}
  </script>
   <script src="/payment.js"></script>
</body> 
</body>
</html>
