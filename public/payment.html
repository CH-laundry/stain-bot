<!doctype html>
<html lang="zh-TW">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>C.H ç²¾ç·»æ´—è¡£ - ä»˜æ¬¾ç®¡ç†ç³»çµ±</title>
<style>
  body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;background:linear-gradient(135deg,#667eea,#764ba2);min-height:100vh;margin:0;padding:20px}
  .container{max-width:900px;margin:0 auto;background:#111827;color:#e5e7eb;border-radius:18px;padding:24px;box-shadow:0 24px 60px rgba(0,0,0,.4)}
  .tabs{display:flex;gap:16px;border-bottom:1px solid #374151;flex-wrap:wrap}
  .tab{padding:10px 14px;border:0;background:transparent;color:#9ca3af;font-weight:600;cursor:pointer;border-bottom:3px solid transparent}
  .tab.active{color:#60a5fa;border-bottom-color:#60a5fa}
  .tab-content{display:none;padding-top:18px}
  .tab-content.active{display:block}
  label{display:block;margin:10px 0 6px}
  input,textarea,select{width:100%;background:#111827;color:#e5e7eb;border:1px solid #374151;border-radius:10px;padding:12px}
  textarea{min-height:120px}
  .btn{display:inline-block;background:#2563eb;color:#fff;border:0;border-radius:10px;padding:12px 16px;font-weight:700;cursor:pointer}
  .btn:disabled{opacity:.6;cursor:not-allowed}
  .btn.secondary{background:#16a34a}
  .btn.gray{background:#6b7280}
  .btn.danger{background:#dc2626}
  .grid{display:grid;gap:12px}
  .grid.cols-2{grid-template-columns:repeat(2,1fr)}
  .grid.cols-3{grid-template-columns:repeat(3,1fr)}
  .card{background:#0b1220;border:1px solid #1f2937;border-radius:12px;padding:12px}
  .status{margin-top:12px;display:none;border:1px solid #374151;border-radius:10px;padding:12px}
  .status.ok{display:block;border-color:#14532d;background:#052e1a}
  .status.err{display:block;border-color:#7f1d1d;background:#2a0e0e}
  .pill{padding:4px 8px;border-radius:999px;font-size:12px}
  .pill.warn{background:#92400e;color:#fff}
  .pill.ok{background:#065f46;color:#fff}
  .pill.bad{background:#7f1d1d;color:#fff}
  .pay-options{display:grid;grid-template-columns:repeat(3,1fr);gap:12px}
  .pay-tile{border:1px solid #374151;border-radius:12px;padding:14px;text-align:center;cursor:pointer;user-select:none}
  .pay-tile .icon{font-size:26px;margin-bottom:6px}
  .pay-tile.active{border-color:#60a5fa;background:#0f172a;box-shadow:0 0 0 2px rgba(96,165,250,.4) inset}
  @media (max-width:768px){ .grid.cols-3{grid-template-columns:1fr} .grid.cols-2{grid-template-columns:1fr} .pay-options{grid-template-columns:1fr} }
</style>
</head>
<body>
  <div class="container">
    <h2 style="margin:0 0 6px">ğŸ’³ ä»˜æ¬¾ç®¡ç†ç³»çµ±</h2>
    <div class="tabs">
      <button class="tab active" data-tab="payment">ç™¼é€ä»˜æ¬¾</button>
      <button class="tab" data-tab="orders">è¨‚å–®ç®¡ç†</button>
      <button class="tab" data-tab="customers">å®¢æˆ¶ç·¨è™Ÿ</button>
      <button class="tab" data-tab="templates">è¨Šæ¯æ¨¡æ¿</button>
    </div>

    <!-- ç™¼é€ä»˜æ¬¾ -->
    <section id="payment" class="tab-content active">
      <div class="card">
        <label>ğŸ” å¿«é€ŸæŸ¥è©¢ï¼ˆè¼¸å…¥ã€Œç·¨è™Ÿã€æˆ–ã€Œå§“åã€ï¼‰</label>
        <div class="grid cols-2">
          <input id="quickInput" placeholder="ä¾‹å¦‚ï¼š755 æˆ– ç‹å°æ˜"/>
          <button class="btn gray" id="btnQuick">æŸ¥è©¢</button>
        </div>
      </div>

      <label>å®¢æˆ¶å§“å *</label>
      <input id="userName" placeholder="ç‹å°æ˜"/>

      <label>å®¢æˆ¶ LINE User ID *</label>
      <input id="userId" placeholder="Uxxxxxxxxxxxxxxxxxxxx"/>

      <label>é‡‘é¡ (NT$) *</label>
      <input id="amount" type="number" min="1" placeholder="1500"/>

      <label>ä»˜æ¬¾æ–¹å¼ *</label>
      <div class="pay-options" id="payOptions">
        <div class="pay-tile active" data-val="both"><div class="icon">ğŸ’™</div><div>å…©è€…éƒ½ç™¼</div></div>
        <div class="pay-tile" data-val="ecpay"><div class="icon">ğŸ’³</div><div>ç¶ ç•Œä¿¡ç”¨å¡</div></div>
        <div class="pay-tile" data-val="linepay"><div class="icon">ğŸ’š</div><div>LINE Pay</div></div>
      </div>

      <label>è¨Šæ¯å…§å®¹ï¼ˆå¯å« {amount}ï¼‰</label>
      <textarea id="customMessage" placeholder="ä¾‹å¦‚ï¼šæ‚¨å¥½ï¼Œé‡‘é¡ NT$ {amount}ï¼Œè¬è¬ï¼"></textarea>

      <div style="margin-top:14px">
        <button class="btn" id="sendBtn">ç™¼é€ä»˜æ¬¾é€£çµ</button>
      </div>

      <div id="status" class="status"></div>
    </section>

    <!-- è¨‚å–®ç®¡ç† -->
    <section id="orders" class="tab-content">
      <div style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:10px">
        <button class="btn secondary" id="btnReload">é‡æ–°æ•´ç†</button>
        <button class="btn secondary" id="btnRemind">ç™¼é€ä»˜æ¬¾æé†’</button>
        <button class="btn secondary" id="btnClean">æ¸…ç†éæœŸè¨‚å–®</button>
      </div>
      <div id="orderStats" class="grid cols-3"></div>
      <div id="orderList" style="margin-top:12px"></div>
    </section>

    <!-- å®¢æˆ¶ç·¨è™Ÿ -->
    <section id="customers" class="tab-content">
      <div class="grid cols-3">
        <div>
          <label>ç·¨è™Ÿ</label><input id="newCustomerNumber" placeholder="ä¾‹å¦‚ï¼š755"/>
        </div>
        <div>
          <label>å§“å</label><input id="newCustomerName" placeholder="ä¾‹å¦‚ï¼šç‹å°æ˜"/>
        </div>
        <div>
          <label>User ID</label><input id="newCustomerUserId" placeholder="Uxxxxxxxx"/>
        </div>
      </div>
      <div style="margin:12px 0"><button class="btn secondary" id="btnSaveCustomer">å„²å­˜</button></div>
      <div id="savedCustomers"></div>
    </section>

    <!-- æ¨¡æ¿ -->
    <section id="templates" class="tab-content">
      <label>æ–°å¢æ¨¡æ¿ï¼ˆ{amount} ä»£è¡¨é‡‘é¡ï¼‰</label>
      <textarea id="newTemplateContent"></textarea>
      <div style="margin-top:10px"><button class="btn secondary" id="btnSaveTpl">å„²å­˜æ¨¡æ¿</button></div>
      <div id="templateList" style="margin-top:12px"></div>
    </section>
  </div>

<script>
  const API_BASE = location.origin;          // ç¢ºä¿æ°¸é æ‰“åˆ°åŒç¶²åŸŸï¼ˆæ‰‹æ©Ÿ/é›»è…¦ä¸€è‡´ï¼‰
  const $ = s => document.querySelector(s);
  const $$ = s => Array.from(document.querySelectorAll(s));
  const ok = (html)=>showStatus(html,true);
  const err= (html)=>showStatus(html,false);
  function showStatus(html, isOk){
    const el = $('#status');
    el.className = 'status ' + (isOk ? 'ok' : 'err');
    el.innerHTML = html;
    el.style.display = 'block';
  }
  async function getJSON(url){ const r = await fetch(API_BASE+url, { credentials:'same-origin' }); return r.json(); }
  async function postJSON(url, body){
    const r = await fetch(API_BASE+url, { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(body||{}) });
    const txt = await r.text();            // å…ˆè®€æ–‡å­—ï¼Œé˜²æ­¢ä¸æ˜¯ JSON æ™‚ç›´æ¥çˆ†æ‰
    try { return JSON.parse(txt); } 
    catch { throw new Error(txt || `HTTP ${r.status}`); }
  }

  // ====== tabs ======
  $$('.tab').forEach(b=>{
    b.addEventListener('click', ()=>{
      $$('.tab').forEach(t=>t.classList.remove('active'));
      $$('.tab-content').forEach(p=>p.classList.remove('active'));
      b.classList.add('active'); document.getElementById(b.dataset.tab).classList.add('active');
      if (b.dataset.tab==='orders') loadOrders();
      if (b.dataset.tab==='customers') renderCustomers();
      if (b.dataset.tab==='templates') renderTemplates();
    });
  });

  // ====== ä»˜æ¬¾æ–¹å¼åœ–å¡Š ======
  let paymentType = 'both';
  $$('#payOptions .pay-tile').forEach(tile=>{
    tile.addEventListener('click', ()=>{
      $$('#payOptions .pay-tile').forEach(t=>t.classList.remove('active'));
      tile.classList.add('active'); paymentType = tile.dataset.val;
    });
  });

  // ====== å¿«é€ŸæŸ¥è©¢ï¼šç·¨è™Ÿ / å§“å ======
  let savedCustomers = {};
  async function syncCustomers(){
    try{
      const d = await getJSON('/api/customer-meta');
      if (d.success && d.map){ savedCustomers = d.map; localStorage.setItem('customerNumbers', JSON.stringify(savedCustomers)); }
      else { savedCustomers = JSON.parse(localStorage.getItem('customerNumbers')||'{}'); }
    }catch{ savedCustomers = JSON.parse(localStorage.getItem('customerNumbers')||'{}'); }
  }
  $('#btnQuick').addEventListener('click', ()=>{
    const q = $('#quickInput').value.trim();
    if (!q){ err('è«‹è¼¸å…¥ç·¨è™Ÿæˆ–å§“å'); return; }
    // 1) å…ˆç”¨ç·¨è™ŸæŸ¥
    if (savedCustomers[q]){
      const c = savedCustomers[q];
      $('#userName').value = c.name || '';
      $('#userId').value   = c.userId || '';
      ok(`âœ… å·²å¸¶å…¥ï¼š#${q} ${c.name}`);
      return;
    }
    // 2) å†ç”¨å§“åæ¨¡ç³ŠæŸ¥
    const found = Object.entries(savedCustomers).find(([no,c])=> (c.name||'').includes(q));
    if (found){
      const [no, c] = found;
      $('#userName').value = c.name || '';
      $('#userId').value   = c.userId || '';
      ok(`âœ… å·²å¸¶å…¥ï¼š#${no} ${c.name}`);
    }else{
      err('æ‰¾ä¸åˆ°æ­¤å®¢æˆ¶');
    }
  });

  // ====== ç™¼é€ä»˜æ¬¾ï¼ˆé‡é»ï¼šæ‰‹æ©ŸéŒ¯èª¤æ”¹è‰¯ï¼‰ ======
  $('#sendBtn').addEventListener('click', async ()=>{
    const userId   = $('#userId').value.trim();
    const userName = $('#userName').value.trim();
    const amount   = parseInt($('#amount').value,10);
    const customMessage = ($('#customMessage').value||'').replace('{amount}', (amount||0).toLocaleString());

    if (!userId || !userName || !amount) return err('è«‹å®Œæ•´å¡«å¯«ã€Œå§“å / User ID / é‡‘é¡ã€');

    $('#sendBtn').disabled = true;
    try{
      const data = await postJSON('/send-payment', { userId, userName, amount, paymentType, customMessage });
      if (data.success){
        ok(`âœ… å·²ç™¼é€ã€‚å®¢æˆ¶ï¼š${userName}ï½œé‡‘é¡ï¼šNT$ ${amount.toLocaleString()}`);
        $('#userId').value = $('#userName').value = $('#amount').value = $('#customMessage').value = '';
      }else{
        err('ç™¼é€å¤±æ•—ï¼š' + (data.error || 'æœªçŸ¥éŒ¯èª¤'));
      }
    }catch(e){
      // é€™è£¡æœƒæŠŠé JSON çš„ HTML/éŒ¯èª¤é ç‰‡æ®µä¹Ÿé¡¯ç¤ºå‡ºä¾†ï¼Œä¾¿æ–¼ä½ çœ‹å•é¡Œ
      err('é€£ç·šå¤±æ•—ï¼š' + String(e.message).slice(0,300));
    }finally{
      $('#sendBtn').disabled = false;
    }
  });

  // ====== è¨‚å–®ç®¡ç†ï¼ˆç²¾ç°¡ï¼‰ ======
  async function loadOrders(){
    const wrap = $('#orderList'); wrap.innerHTML = '<div class="card">è¼‰å…¥ä¸­...</div>';
    try{
      const d = await getJSON('/api/orders');
      const arr = d.success ? d.orders : [];
      if (!arr.length){ wrap.innerHTML = '<div class="card">å°šç„¡è¨‚å–®è¨˜éŒ„</div>'; return; }
      wrap.innerHTML = arr.map(o=>`
        <div class="card">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <div><b>${o.userName||'-'}</b>ã€€NT$ ${(o.amount||0).toLocaleString()}</div>
            <div>${o.status==='paid' ? '<span class="pill ok">å·²ä»˜æ¬¾</span>' : (o.isExpired ? '<span class="pill bad">å·²éæœŸ</span>' : '<span class="pill warn">å¾…ä»˜æ¬¾</span>')}</div>
          </div>
          <div style="font-size:12px;opacity:.8;margin-top:6px">#${o.orderId}</div>
          <div style="margin-top:8px;display:flex;gap:8px;flex-wrap:wrap">
            <button class="btn secondary" onclick="renewOrder('${o.orderId}')">çºŒæœŸé‡ç™¼</button>
            <button class="btn danger" onclick="deleteOrder('${o.orderId}')">åˆªé™¤</button>
          </div>
        </div>
      `).join('');
    }catch(e){ wrap.innerHTML = '<div class="card">è¼‰å…¥å¤±æ•—ï¼š'+e.message+'</div>'; }
  }
  async function renewOrder(id){
    try{ const d = await postJSON(`/api/order/${id}/renew`); if (d.success) ok('âœ… å·²çºŒæœŸä¸¦é‡æ–°ç™¼é€'); else err('çºŒæœŸå¤±æ•—ï¼š'+(d.error||'')); }
    catch(e){ err('çºŒæœŸéŒ¯èª¤ï¼š'+e.message); }
  }
  async function deleteOrder(id){
    if (!confirm('åˆªé™¤æ­¤è¨‚å–®ï¼Ÿ')) return;
    try{
      const d = await fetch(API_BASE+`/api/order/${id}`, { method:'DELETE' }).then(r=>r.json());
      if (d.success){ ok('ğŸ—‘ï¸ å·²åˆªé™¤'); loadOrders(); } else err('åˆªé™¤å¤±æ•—');
    }catch(e){ err('åˆªé™¤éŒ¯èª¤ï¼š'+e.message); }
  }
  $('#btnReload').onclick = loadOrders;
  $('#btnRemind').onclick = ()=> postJSON('/api/orders/send-reminders').then(d=>ok(d.message)).catch(e=>err(e.message));
  $('#btnClean').onclick  = ()=> postJSON('/api/orders/clean-expired').then(d=>ok(d.message)).catch(e=>err(e.message));

  // ====== å®¢æˆ¶ç·¨è™Ÿ ======
  function renderCustomers(){
    const wrap = $('#savedCustomers');
    const list = Object.entries(savedCustomers||{});
    if (!list.length){ wrap.innerHTML='<div class="card">å°šç„¡è³‡æ–™</div>'; return; }
    wrap.innerHTML = list.map(([no,c])=>`
      <div class="card" style="display:flex;justify-content:space-between;align-items:center">
        <div><b>#${no}</b>ã€€${c.name}ã€€<span style="opacity:.7">(${c.userId})</span></div>
        <button class="btn" onclick="prefill('${c.userId}','${c.name}')">å¸¶å…¥</button>
      </div>
    `).join('');
  }
  window.prefill = (uid,name)=>{ $('#userId').value=uid; $('#userName').value=name; document.querySelector('.tab[data-tab="payment"]').click(); };
  $('#btnSaveCustomer').onclick = async ()=>{
    const number = $('#newCustomerNumber').value.trim();
    const name   = $('#newCustomerName').value.trim();
    const userId = $('#newCustomerUserId').value.trim();
    if (!name || !userId) return err('è«‹è¼¸å…¥ å§“å / User ID');
    try{
      const d = await postJSON('/api/customer-meta/save', { number:number?Number(number):undefined, name, userId });
      if (d.success){ savedCustomers[d.number]=d.data; localStorage.setItem('customerNumbers', JSON.stringify(savedCustomers)); $('#newCustomerNumber').value=$('#newCustomerName').value=$('#newCustomerUserId').value=''; renderCustomers(); ok('âœ… å·²å„²å­˜'); }
      else err('å„²å­˜å¤±æ•—ï¼š'+(d.error||''));
    }catch(e){ err('å„²å­˜éŒ¯èª¤ï¼š'+e.message); }
  };

  // ====== æ¨¡æ¿ ======
  let savedTemplates = [];
  async function syncTemplates(){
    try{
      const d = await getJSON('/api/templates');
      if (d.success && Array.isArray(d.templates)){ savedTemplates=d.templates; localStorage.setItem('messageTemplates', JSON.stringify(savedTemplates)); }
      else { savedTemplates = JSON.parse(localStorage.getItem('messageTemplates')||'[]'); }
    }catch{ savedTemplates = JSON.parse(localStorage.getItem('messageTemplates')||'[]'); }
  }
  function renderTemplates(){
    const wrap = $('#templateList');
    if (!savedTemplates.length){ wrap.innerHTML='<div class="card">å°šç„¡æ¨¡æ¿</div>'; return; }
    wrap.innerHTML = savedTemplates.map((t,i)=>`
      <div class="card">
        <div style="white-space:pre-wrap">${t}</div>
        <div style="margin-top:8px;display:flex;gap:8px">
          <button class="btn" onclick="useTpl(${i})">ä½¿ç”¨</button>
          <button class="btn danger" onclick="delTpl(${i})">åˆªé™¤</button>
        </div>
      </div>`).join('');
  }
  window.useTpl = i => { const a=parseInt($('#amount').value||'0',10); $('#customMessage').value = (savedTemplates[i]||'').replace('{amount}', a.toLocaleString()); document.querySelector('.tab[data-tab="payment"]').click(); };
  window.delTpl = async i => { if(!confirm('åˆªé™¤æ­¤æ¨¡æ¿ï¼Ÿ'))return; const d = await fetch(API_BASE+`/api/templates/${i}`,{method:'DELETE'}).then(r=>r.json()); if (d.success){ savedTemplates=d.templates; localStorage.setItem('messageTemplates', JSON.stringify(savedTemplates)); renderTemplates(); } };

  // ====== åˆå§‹åŒ– ======
  (async function init(){
    await syncCustomers();
    await syncTemplates();
  })();
</script>
</body>
</html>