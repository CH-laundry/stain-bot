// services/openai.js
const { OpenAI } = require('openai');

// ===== OpenAI Client =====
const openaiClient = new OpenAI({
  apiKey: process.env.OPENAI_API_KEY
});

// ===== å›ºå®šé€£çµï¼ˆå¯ç”¨ .env è¦†è“‹ï¼‰=====
const CHECK_STATUS_URL = process.env.CHECK_STATUS_URL || "https://liff.line.me/2004612704-JnzA1qN6#/";
const LINE_PAY_URL     = process.env.LINE_PAY_URL      || "https://qrcodepay.line.me/qr/payment/ad2fs7S%252BDxiUCtHDInEXe9tnWx7SgIlVX6Ip6PbtXOkp4tXjgCI28920qGq%252B4eIt";
const ECPAY_URL        = process.env.ECPAY_URL         || "https://p.ecpay.com.tw/55FFE71";

// ===== å°å·¥å…· =====
function ensureEmoji(s, emoji = 'ğŸ™‚') {
  if (!s) return s;
  if (/[ğŸ˜€-ğŸ™ğŸ»]|ğŸ™‚|ğŸ˜Š|âœ¨|ğŸ‘|ğŸ‘‰|ğŸ’|ğŸ§¼|ğŸ’¡|âœ…|ğŸ“|ğŸ“|ğŸ’™|â³|ğŸ”/.test(s)) return s;
  return s + ' ' + emoji;
}

function normalize(input = '') {
  const fw = 'ï¼ï¼‘ï¼’ï¼“ï¼”ï¼•ï¼–ï¼—ï¼˜ï¼™';
  const hw = '0123456789';
  let out = (input || '').trim();
  out = out.replace(/[ï¼-ï¼™]/g, ch => hw[fw.indexOf(ch)]);
  return out;
}

// å¾Œå‚™ï¼šå°ç£åœ°å€æŠ½å–ï¼ˆå«æ¨“å±¤ï¼‰
function extractTWAddress(text = '') {
  const re = /(å°åŒ—å¸‚|æ–°åŒ—å¸‚|æ¡ƒåœ’å¸‚|å°ä¸­å¸‚|å°å—å¸‚|é«˜é›„å¸‚|åŸºéš†å¸‚|æ–°ç«¹å¸‚|å˜‰ç¾©å¸‚|æ–°ç«¹ç¸£|è‹—æ —ç¸£|å½°åŒ–ç¸£|å—æŠ•ç¸£|é›²æ—ç¸£|å˜‰ç¾©ç¸£|å±æ±ç¸£|å®œè˜­ç¸£|èŠ±è“®ç¸£|å°æ±ç¸£|æ¾æ¹–ç¸£|é‡‘é–€ç¸£|é€£æ±Ÿç¸£)[^ï¼Œã€‚\s]{0,20}?(?:å€|å¸‚|é®|é„‰)[^ï¼Œã€‚\s]{0,20}?(?:è·¯|è¡—|å¤§é“|å··|å¼„)[0-9ï¼-ï¼™]{1,4}è™Ÿ(?:ä¹‹[0-9ï¼-ï¼™]{1,2})?(?:[ï¼Œ,\s]*(?:[0-9ï¼-ï¼™]{1,2}æ¨“(?:ä¹‹[0-9ï¼-ï¼™]{1,2})?|[0-9ï¼-ï¼™]{1,2}F))?/i;
  const m = text.match(re);
  return m ? m[0].replace(/\s+/g, '') : '';
}

// æ–‡å­—ä¸­çš„ç™¾åˆ†æ¯”è‡ªå‹•ä¸‹èª¿ N%
function reducePercentages(s, delta = 5) {
  return s.replace(/(\d{1,3})\s*%/g, (match, p1) => {
    let num = parseInt(p1, 10);
    if (Number.isNaN(num)) return match;
    // é¿å…æŠŠéå¸¸ä½çš„æ•¸å­—é™æˆ 0
    if (num > 5) num = Math.max(num - delta, 1);
    return `${num}%`;
  });
}

// ===== 1) æ™ºèƒ½æ±¡æ¼¬åˆ†æï¼ˆåˆ†æè©³ç›¡ã€å»ºè­°ç²¾ç°¡ï¼‰=====
async function analyzeStainWithAI(imageBuffer, materialInfo = '', labelImageBuffer = null) {
  const base64Image = imageBuffer.toString('base64');
  const base64Label = labelImageBuffer ? labelImageBuffer.toString('base64') : '';

  const userContent = [];
  userContent.push({ type: 'text', text: 'è«‹ç›¡å¯èƒ½è©³ç´°åˆ†ææ­¤ç‰©å“èˆ‡æ±¡æ¼¬ï¼Œä¸¦æä¾›ç°¡çŸ­çš„æ¸…æ½”å»ºè­°ã€‚' });
  if (materialInfo) {
    userContent.push({ type: 'text', text: `è¡£ç‰©æè³ªï¼š${materialInfo}` });
  }
  userContent.push({ type: 'image_url', image_url: { url: `data:image/png;base64,${base64Image}` } });
  if (base64Label) {
    userContent.push({ type: 'text', text: 'ä»¥ä¸‹æ˜¯æ´—æ»Œæ¨™ç±¤ï¼Œåƒ…ä¾›åƒè€ƒï¼š' });
    userContent.push({ type: 'image_url', image_url: { url: `data:image/png;base64,${base64Label}` } });
  }

  const resp = await openaiClient.chat.completions.create({
    model: 'gpt-4o',
    messages: [
      {
        role: 'system',
        content: `
ä½ æ˜¯ C.H ç²¾ç·»æ´—è¡£ çš„å°ˆæ¥­æ¸…æ½”é¡§å•ï¼Œè«‹ç”¨å£èªåŒ–ç¹é«”ä¸­æ–‡ï¼Œçµæ§‹å¦‚ä¸‹ï¼š

ã€åˆ†æã€‘
- ç‰©å“èˆ‡æ±¡æ¼¬ç‹€æ³ï¼ˆ2â€“4 å¥ï¼Œå¯è©³ç´°æè¿°å½¢ç‹€ã€ç¯„åœã€é¡è‰²ã€æ»²å…¥æ·±åº¦ï¼‰
- æè³ªç‰¹æ€§ï¼ˆå¦‚ï¼šç¾Šæ¯›æ˜“ç¸®æ°´ã€çµ²è³ªæ€•æ°´ã€å¸†å¸ƒæ˜“å¸é™„ï¼‰
- æ±¡æ¼¬å¯èƒ½ä¾†æºåˆ¤æ–·ï¼ˆå¦‚æ²¹æ¼¬ã€æ±—æ¼¬ã€å¢¨æ°´ã€å’–å•¡ï¼‰
- æ¸…æ½”æˆåŠŸæ©Ÿç‡ï¼ˆå¯é™„ç™¾åˆ†æ¯”ï¼Œä½†å‹™å¿…åä¿å®ˆï¼Œé¿å…å¤ªé«˜ï¼›ç”¨ã€Œæœ‰æ©Ÿæœƒæ”¹å–„ã€ã€Œå¯æœ›æå‡å¤–è§€ã€ç­‰å­—çœ¼ï¼‰
- å“ç‰Œæ¨æ¸¬ï¼ˆå¯ä¾èŠ±ç´‹/äº”é‡‘/ç‰ˆå‹èªªã€Œå¯èƒ½ç‚ºï¼æ¨æ¸¬ç‚ºã€ï¼‰
- è‹¥ç‚ºç²¾å“åŒ…ï¼Œè£œå……å¹´ä»½èˆ‡ç¨€æœ‰æ€§ï¼ˆå¦‚ã€Œæ­¤èŠ±ç´‹å¸¸è¦‹æ–¼ 2010 å¹´ä»£åˆæœŸï¼Œè¼ƒå°‘è¦‹ã€ï¼‰
- çµå°¾å›ºå®šåŠ ï¼šæˆ‘å€‘æœƒæ ¹æ“šæè³ªç‰¹æ€§é€²è¡Œé©ç•¶æ¸…æ½”ï¼Œç¢ºä¿æœ€ä½³æ•ˆæœã€‚

ã€æ¸…æ½”å»ºè­°ã€‘
- åªçµ¦ 1â€“2 å¥ç°¡çŸ­å»ºè­°ï¼ˆä¸æä¾› DIY æ­¥é©Ÿèˆ‡è—¥åŠ‘æ¯”ä¾‹ï¼‰
- å¯èªªã€Œè‹¥æ“”å¿ƒï¼Œå»ºè­°äº¤çµ¦ C.H ç²¾ç·»æ´—è¡£å°ˆæ¥­è™•ç†ï¼Œé¿å…è‡ªè¡Œæ“ä½œé€ æˆäºŒæ¬¡æå‚·ã€
`
      },
      { role: 'user', content: userContent }
    ],
    temperature: 0.6,
    max_tokens: 1000
  });

  let out = resp.choices?.[0]?.message?.content || '';
  out = out.replace(/\*\*/g, '');

  // æˆåŠŸæ©Ÿç‡å¾€ä¸‹èª¿ 5%
  out = reducePercentages(out, 5);

  // å®‰å…¨å…œåº•ï¼šè‹¥æ¨¡å‹å¿˜äº†å›ºå®šå¥
  if (!/æˆ‘å€‘æœƒæ ¹æ“šæè³ªç‰¹æ€§é€²è¡Œé©ç•¶æ¸…æ½”ï¼Œç¢ºä¿æœ€ä½³æ•ˆæœã€‚/.test(out)) {
    out += `\næˆ‘å€‘æœƒæ ¹æ“šæè³ªç‰¹æ€§é€²è¡Œé©ç•¶æ¸…æ½”ï¼Œç¢ºä¿æœ€ä½³æ•ˆæœã€‚`;
  }
  return out;
}

// ===== 2) æ™ºèƒ½è‡ªå‹•å›è¦†ï¼ˆAI é«˜åˆ¤æ–· â†’ å‘½ä¸­å†å¥—è¦å‰‡ï¼‰=====
async function smartAutoReply(inputText) {
  const text = normalize(inputText);

  // å…ˆç”¨ AI åšçµæ§‹åŒ–ç†è§£ï¼ˆæ„åœ– + åœ°å€ + AI å›è¦†è‰ç¨¿ï¼‰
  const classify = await openaiClient.chat.completions.create({
    model: 'gpt-4o',
    messages: [
      {
        role: 'system',
        content:
`ä½ æ˜¯ã€ŒC.H ç²¾ç·»æ´—è¡£ã€çš„å®¢æœåŠ©ç†ã€‚è«‹ç†è§£ä½¿ç”¨è€…è¨Šæ¯ä¸¦è¼¸å‡ºã€Œå”¯ä¸€ä¸€æ®µ JSONã€ï¼Œä¸è¦é¡å¤–æ–‡å­—ã€‚

éœ€è¦ï¼š
1) æ„åœ–ï¼ˆå¤šé¸å¸ƒæ—ï¼‰ï¼š
   - payment_intentï¼šä»˜æ¬¾/æ”¯ä»˜/åˆ·å¡/Line Pay
   - pickup_requestï¼šè¦åˆ°åºœæ”¶ä»¶/ä¾†æ”¶è¡£/å–ä»¶
   - address_inquiryï¼šå•æˆ‘å€‘æ˜¯å¦æœ‰ä»–çš„åœ°å€
   - duration_queryï¼šè©¢å•è™•ç†æ™‚é–“/å¹¾å¤©/å¤šä¹…
   - progress_queryï¼šæŸ¥è©¢æ¸…æ´—æ˜¯å¦å®Œæˆ/é€²åº¦/å¯ä»¥æ‹¿äº†å—
   - child_itemï¼šå…’ç«¥/å¬°å…’ç”¨å“ï¼ˆæ‰‹æ¨è»Š/å¬°å…’è»Š/æ±½åº§/å®‰å…¨åº§æ¤…/å°å­©åå¢Šç­‰å»£ç¾©æè¿°ï¼‰
   - cleaning_topicï¼šä¸€èˆ¬æ¸…æ½”/èƒ½å¦æ¸…æ´—/æ±¡æ¼¬/æè³ª/æ‰è‰²ç¸®æ°´ç­‰
   - hours_or_locationï¼šç‡Ÿæ¥­æ™‚é–“/åœ°å€/æ€éº¼å»/åœ¨å“ª
   - price_or_quoteï¼šåƒ¹æ ¼/å¤šå°‘éŒ¢/è²»ç”¨/ä¼°åƒ¹
   - service_scopeï¼šèƒ½ä¸èƒ½æ´—XXXï¼ˆåŒ…åŒ…/é‹/è¥¿è£/ç¾½çµ¨/çª—ç°¾/åœ°æ¯¯ç­‰ï¼‰
2) æ“·å–åœ°å€ï¼ˆè‹¥å¯èƒ½ï¼‰ï¼š{"full": "...", "floor": "..."}ï¼Œæ²’æœ‰å°±ç©ºå­—ä¸²
3) ç”¢å‡ºä¸€æ®µ ai_replyï¼ˆç¹é«”ä¸­æ–‡ã€å£èªåŒ–ã€æº«å’Œã€å°ˆæ¥­ï¼›é¿å…ä¿è­‰èªï¼›ç›¡é‡å®‰æ’«ã€Œæˆ‘å€‘æœƒç›¡é‡è™•ç†ï¼Œè«‹æ”¾å¿ƒã€ï¼›çµå°¾åŠ ä¸€å€‹è¡¨æƒ…ç¬¦è™Ÿï¼‰

åªè¼¸å‡º JSONï¼š
{
  "intents": { ... },
  "address": {"full":"", "floor":""},
  "ai_reply": "..."
}`
      },
      { role: 'user', content: text }
    ],
    temperature: 0.2,
    max_tokens: 600
  });

  // å®‰å…¨è§£æ JSON
  let parsed;
  const raw = classify.choices?.[0]?.message?.content || '';
  try {
    const jsonStr = (raw.match(/\{[\s\S]*\}$/) || [raw])[0];
    parsed = JSON.parse(jsonStr);
  } catch {
    // è‹¥è§£æå¤±æ•—ï¼Œé€€å›è¦å‰‡ + è‡ªç”± AI
    return await legacyFallback(text);
  }

  const intents = parsed?.intents || {};
  let addr = (parsed?.address?.full || '').trim();
  const floor = (parsed?.address?.floor || '').trim();
  const aiReply = (parsed?.ai_reply || '').trim();

  // å¾Œå‚™åœ°å€æŠ½å–
  if (!addr) addr = extractTWAddress(text);
  if (addr && floor && !addr.includes(floor)) addr += floor;

  // ===== å‘½ä¸­è¦å‰‡ï¼šå›å›ºå®šè©±è¡“ï¼ˆèªæ°£æº«å’Œï¼‰=====
  if (intents.payment_intent) {
    return (
      'ä»¥ä¸‹æä¾›å…©ç¨®ä»˜æ¬¾æ–¹å¼ï¼Œæ‚¨å¯ä»¥ä¾æ–¹ä¾¿é¸æ“‡ï¼š\n\n' +
      `1ï¸âƒ£ LINE Pay ä»˜æ¬¾é€£çµ\n${LINE_PAY_URL}\n\n` +
      `2ï¸âƒ£ ä¿¡ç”¨å¡ä»˜æ¬¾ï¼ˆç¶ ç•Œ ECPayï¼‰\n${ECPAY_URL}\n\n` +
      'æ„Ÿè¬æ‚¨çš„æ”¯æŒèˆ‡é…åˆ ğŸ’™'
    );
  }

  if (intents.pickup_request) {
    return addr
      ? `å¥½çš„ ğŸ˜Š æˆ‘å€‘æœƒå®‰æ’åˆ°åºœæ”¶ä»¶\nåœ°å€ï¼š${addr}`
      : 'å¥½çš„ ğŸ˜Š æˆ‘å€‘æœƒå®‰æ’åˆ°åºœæ”¶ä»¶';
  }

  if (intents.address_inquiry) {
    return 'æœ‰çš„ï¼Œæˆ‘å€‘éƒ½æœ‰ç´€éŒ„çš„ ğŸ˜Š';
  }

  if (intents.duration_query) {
    return 'ä¸€èˆ¬æ¸…æ½”ä½œæ¥­æ™‚é–“ç´„ 7â€“10 å¤©ï¼Œæœƒä¾æè³ªèˆ‡ç¾å ´å·¥ä½œé‡å¾®èª¿å–” â³';
  }

  if (intents.progress_query) {
    return `æ‚¨å¯ä»¥é€™é‚Šç·šä¸ŠæŸ¥è©¢é€²åº¦ ğŸ”\nğŸ‘‰ ${CHECK_STATUS_URL}`;
  }

  if (intents.child_item) {
    // æ›´å½ˆæ€§æŠ“èˆ‡å°æœ‹å‹ç”¨å“ç›¸é—œèªæ„
    return 'åƒæ‰‹æ¨è»Šã€å¬°å…’è»Šã€æ±½åº§ã€åå¢Šç­‰å…’ç«¥ç”¨å“ï¼Œæˆ‘å€‘éƒ½æœ‰ã€Œæ‹†æ´—ï¼‹æ·±å±¤æ¸…æ½”ï¼‹æ®ºèŒé™¤å‘³ã€æœå‹™ï¼Œè™•ç†æœƒç›¡é‡è²¼æè³ªå®‰å…¨ï¼Œè«‹æ”¾å¿ƒ âœ¨\nè¦è©³ç´°äº†è§£è«‹æŒ‰ 2';
  }

  if (intents.price_or_quote) {
    return 'è²»ç”¨æœƒä¾æè³ªã€å°ºå¯¸èˆ‡é«’æ±¡ç‹€æ³ç•¥æœ‰å·®ç•°ï¼Œå»ºè­°å¸¶ä¾†ç¾å ´æˆ–æ‹ç…§çµ¦æˆ‘å€‘è©•ä¼°ï¼Œæœƒæä¾›æ¸…æ¥šå ±åƒ¹èˆ‡å»ºè­°æ–¹æ¡ˆ ğŸ˜Š';
  }

  if (intents.hours_or_location) {
    return ensureEmoji(aiReply || 'æˆ‘å€‘çš„ç‡Ÿæ¥­æ™‚é–“èˆ‡åœ°å€å¯åœ¨å®˜æ–¹å¸³è™Ÿè³‡è¨ŠæŸ¥çœ‹ï¼Œè‹¥ä¸ç¢ºå®šä¹Ÿå¯ä»¥ç›´æ¥ç•™å€‹æ™‚é–“ï¼Œæˆ‘å€‘å¹«æ‚¨å®‰æ’ï½');
  }

  if (intents.service_scope) {
    return 'å¤šæ•¸æè³ªèˆ‡å“é …æˆ‘å€‘éƒ½èƒ½è™•ç†ï¼Œæœƒä¾æè³ªèˆ‡åšå·¥é¸ç”¨åˆé©æµç¨‹ï¼›æˆ‘å€‘æœƒç›¡é‡è®“ç‹€æ…‹æ›´å¥½ï¼Œæ‚¨å¯ä»¥æ”¾å¿ƒäº¤çµ¦ C.H ç²¾ç·»æ´—è¡£ âœ¨';
  }

  if (intents.cleaning_topic) {
    return ensureEmoji(
      aiReply ||
      'é‡å°æè³ªèˆ‡ç‹€æ³æˆ‘å€‘æœƒå…ˆè©•ä¼°ï¼Œå†é¸æ“‡æº«å’Œå®‰å…¨çš„æ–¹å¼è™•ç†ï¼›æ±¡æ¼¬ã€æ³›é»ƒæˆ–ç¸®æ°´ç­‰ç‹€æ³æˆ‘å€‘éƒ½æœƒç›¡é‡æ”¹å–„ï¼Œè‹¥æ“”å¿ƒä¹Ÿå¯ä»¥ç›´æ¥äº¤çµ¦ C.H ç²¾ç·»æ´—è¡£ï¼Œæˆ‘å€‘æœƒç´°å¿ƒç…§é¡§ ğŸ˜Š'
    );
  }

  // ===== å…¶ä»–ï¼šç›´æ¥ä½¿ç”¨ AI å»ºè­°å›è¦†ï¼ˆå·²å¸¶èªæ°£è¦æ±‚ï¼‰=====
  return ensureEmoji(aiReply || (await aiFreeReply(text)));
}

// ===== å¾Œå‚™ï¼šå‚³çµ±è¦å‰‡ + AI å›è¦† =====
async function legacyFallback(text) {
  const lower = text.toLowerCase();

  if (/(ä»˜æ¬¾|æ”¯ä»˜|åŒ¯æ¬¾|line pay|åˆ·å¡)/i.test(text)) {
    return (
      'ä»¥ä¸‹æä¾›å…©ç¨®ä»˜æ¬¾æ–¹å¼ï¼Œæ‚¨å¯ä»¥ä¾æ–¹ä¾¿é¸æ“‡ï¼š\n\n' +
      `1ï¸âƒ£ LINE Pay ä»˜æ¬¾é€£çµ\n${LINE_PAY_URL}\n\n` +
      `2ï¸âƒ£ ä¿¡ç”¨å¡ä»˜æ¬¾ï¼ˆç¶ ç•Œ ECPayï¼‰\n${ECPAY_URL}\n\n` +
      'æ„Ÿè¬æ‚¨çš„æ”¯æŒèˆ‡é…åˆ ğŸ’™'
    );
  }

  if (/(æ”¶è¡£|æ”¶ä»¶|å–ä»¶|ä¾†æ”¶)/.test(text)) {
    const addr = extractTWAddress(text);
    return addr
      ? `å¥½çš„ ğŸ˜Š æˆ‘å€‘æœƒå®‰æ’åˆ°åºœæ”¶ä»¶\nåœ°å€ï¼š${addr}`
      : 'å¥½çš„ ğŸ˜Š æˆ‘å€‘æœƒå®‰æ’åˆ°åºœæ”¶ä»¶';
  }

  if (/æœ‰åœ°å€å—|è¨˜éŒ„åœ°å€/.test(text)) {
    return 'æœ‰çš„ï¼Œæˆ‘å€‘éƒ½æœ‰ç´€éŒ„çš„ ğŸ˜Š';
  }

  if (/(é€²åº¦|æ´—å¥½äº†å—|å¯ä»¥æ‹¿äº†å—|å®Œæˆäº†å—)/.test(text)) {
    return `æ‚¨å¯ä»¥é€™é‚Šç·šä¸ŠæŸ¥è©¢é€²åº¦ ğŸ”\nğŸ‘‰ ${CHECK_STATUS_URL}`;
  }

  if (/(å¤šä¹…|å¹¾å¤©|æ™‚é–“)/.test(text)) {
    return 'ä¸€èˆ¬æ¸…æ½”ä½œæ¥­æ™‚é–“ç´„ 7â€“10 å¤©ï¼Œæœƒä¾æè³ªèˆ‡ç¾å ´å·¥ä½œé‡å¾®èª¿å–” â³';
  }

  if (/(æ‰‹æ¨è»Š|æ¨è»Š|å¬°å…’è»Š|æ±½åº§|å®‰å…¨åº§æ¤…|å°å­©åº§æ¤…|å…’ç«¥åå¢Š|å¬°å…’åå¢Š)/.test(text)) {
    return 'åƒæ‰‹æ¨è»Šã€å¬°å…’è»Šã€æ±½åº§ã€åå¢Šç­‰å…’ç«¥ç”¨å“ï¼Œæˆ‘å€‘éƒ½æœ‰ã€Œæ‹†æ´—ï¼‹æ·±å±¤æ¸…æ½”ï¼‹æ®ºèŒé™¤å‘³ã€æœå‹™ï¼Œè™•ç†æœƒç›¡é‡è²¼æè³ªå®‰å…¨ï¼Œè«‹æ”¾å¿ƒ âœ¨\nè¦è©³ç´°äº†è§£è«‹æŒ‰ 2';
  }

  if (/(åŒ…åŒ…|é‹|é‹å­|è¡£æœ|è¥¿è£|ç¾½çµ¨|çª—ç°¾|åœ°æ¯¯).*(å¯ä»¥æ´—|èƒ½ä¸èƒ½|èƒ½æ´—|å¯è™•ç†)/.test(text)) {
    return 'é€™äº›å“é …æˆ‘å€‘å¤§å¤šèƒ½è™•ç†ï¼Œæœƒä¾æè³ªèˆ‡åšå·¥é¸æ“‡åˆé©æ–¹å¼ï¼›æˆ‘å€‘éƒ½æœƒç›¡é‡è®“ç‹€æ…‹æ›´å¥½ï¼Œæ‚¨å¯ä»¥æ”¾å¿ƒäº¤çµ¦ C.H ç²¾ç·»æ´—è¡£ âœ¨';
  }

  if (/(æ±¡æ¼¬|é«’æ±¡|æ³›é»ƒ|æ‰è‰²|ç¸®æ°´|è®Šå½¢)/.test(text)) {
    return 'æˆ‘å€‘æœƒå…ˆè©•ä¼°æè³ªèˆ‡ç‹€æ³ï¼Œå†ä»¥æº«å’Œã€å®‰å…¨çš„æ–¹å¼è™•ç†ï¼›ä¸Šè¿°ç‹€æ³éƒ½æœƒç›¡é‡æ”¹å–„ï¼Œè‹¥æ“”å¿ƒå¯ä»¥ç›´æ¥äº¤çµ¦ C.H ç²¾ç·»æ´—è¡£ï¼Œæˆ‘å€‘æœƒç´°å¿ƒç…§é¡§ ğŸ˜Š';
  }

  return ensureEmoji(await aiFreeReply(text));
}

// ===== è‡ªç”± AI å›è¦†ï¼ˆå°ˆæ¥­ã€æº«å’Œã€ä¿å®ˆã€ä¸çµ¦ç¡¬ä¿è­‰ï¼‰=====
async function aiFreeReply(text) {
  const resp = await openaiClient.chat.completions.create({
    model: 'gpt-4o',
    messages: [
      {
        role: 'system',
        content:
`ä½ æ˜¯ã€ŒC.H ç²¾ç·»æ´—è¡£ã€çš„å°ˆæ¥­å®¢æœï¼Œè«‹ç”¨ç¹é«”ä¸­æ–‡ã€å£èªåŒ–ã€æº«å’Œæœ‰ç¦®çš„èªæ°£å›è¦†ã€‚
åŸå‰‡ï¼š
- ç›¡é‡ç›´æ¥å›ç­”å®¢äººçš„é‡é»ã€‚
- å¯è™•ç†é¡å‹ï¼ˆåŒ…åŒ…/é‹/è¡£ç‰©/çª—ç°¾/åœ°æ¯¯â€¦ï¼‰â†’ å¯èªªã€Œæˆ‘å€‘å¯ä»¥è™•ç†ï¼Œæœƒä¾æè³ªèª¿æ•´æ–¹å¼ï¼Œç›¡é‡è®“ç‹€æ…‹æ›´å¥½ã€ã€‚
- æ±¡æ¼¬/æ³›é»ƒ/æ‰è‰²/ç¸®æ°´/è®Šå½¢ â†’ ç”¨ã€Œæˆ‘å€‘æœƒç›¡é‡è™•ç†ã€ã€Œéœ€å¯¦ç‰©æª¢æŸ¥ã€ã€Œå…ˆåšä¸é¡¯çœ¼è™•æ¸¬è©¦ã€çš„ä¿å®ˆèªªæ³•ã€‚
- æ™‚é–“è‹¥è¢«å•åˆ° â†’ ä¸€èˆ¬ç´„ 7â€“10 å¤©ï¼ˆä»ä¾ç¾å ´èˆ‡æè³ªèª¿æ•´ï¼‰ã€‚
- å¬°å…’/å…’ç«¥ç”¨å“ï¼ˆæ‰‹æ¨è»Š/æ±½åº§/åå¢Šï¼‰â†’ æˆ‘å€‘æœ‰ã€Œæ‹†æ´—ï¼‹æ·±å±¤æ¸…æ½”ï¼‹æ®ºèŒé™¤å‘³ã€æœå‹™ï¼Œå¯æ”¾å¿ƒã€‚
- å¯è‡ªç„¶æåˆ°ï¼šè‹¥æ“”å¿ƒï¼Œå»ºè­°äº¤çµ¦ C.H ç²¾ç·»æ´—è¡£è©•ä¼°èˆ‡è™•ç†ã€‚
- ä¸è¦æä¾›éæ–¼è©³ç´°çš„ DIY æ­¥é©Ÿæˆ–è—¥æ°´æ¯”ä¾‹ï¼Œä»¥å…é€ æˆèª¤ç”¨ã€‚
- çµå°¾åŠ  1 å€‹åˆé©è¡¨æƒ…ç¬¦è™Ÿã€‚`
      },
      { role: 'user', content: text }
    ],
    temperature: 0.6,
    max_tokens: 600
  });
  return resp.choices?.[0]?.message?.content || '';
}

module.exports = {
  analyzeStainWithAI,
  smartAutoReply
};
