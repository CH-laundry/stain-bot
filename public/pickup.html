<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ğŸ§º å–ä»¶è¿½è¹¤ç³»çµ±</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: 'Segoe UI', sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; padding: 20px; }
    .container { max-width: 1000px; margin: 0 auto; background: #fff; border-radius: 20px; padding: 30px; box-shadow: 0 20px 60px rgba(0,0,0,.3); }
    h1 { color: #667eea; text-align: center; margin-bottom: 10px; font-size: 28px; }
    .subtitle { text-align: center; color: #666; margin-bottom: 30px; font-size: 14px; }
    .back-link { display: inline-block; margin-bottom: 20px; padding: 10px 20px; background: #f0f4ff; color: #667eea; text-decoration: none; border-radius: 8px; font-weight: 600; }
    .back-link:hover { background: #667eea; color: #fff; }
    .form-group { margin-bottom: 20px; }
    label { display: block; margin-bottom: 8px; color: #333; font-weight: 600; font-size: 14px; }
    input, textarea { width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 10px; font-size: 16px; transition: all .3s; font-family: inherit; }
    textarea { min-height: 120px; resize: vertical; }
    input:focus, textarea:focus { outline: none; border-color: #667eea; box-shadow: 0 0 0 3px rgba(102,126,234,.1); }
    .quick-search { display: flex; gap: 10px; }
    .btn { width: 100%; padding: 15px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: #fff; border: none; border-radius: 12px; font-size: 18px; font-weight: 600; cursor: pointer; transition: all .3s; }
    .btn:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(102,126,234,.6); }
    .btn-small { padding: 10px 20px; font-size: 14px; width: auto; }
    .btn-secondary { background: linear-gradient(135deg, #52c41a 0%, #389e0d 100%); }
    .btn-danger { background: linear-gradient(135deg, #dc3545 0%, #c82333 100%); }
    .customer-card { background: #f0f4ff; padding: 15px; border-radius: 10px; margin-bottom: 20px; border-left: 4px solid #667eea; }
    .customer-card h4 { color: #667eea; margin-bottom: 10px; }
    .customer-card p { margin: 5px 0; font-size: 14px; color: #333; }
    .result { margin-top: 20px; padding: 20px; border-radius: 12px; display: none; }
    .result.success { background: #d4edda; border: 2px solid #28a745; color: #155724; }
    .result.error { background: #f8d7da; border: 2px solid #dc3545; color: #721c24; }
    .user-item { background: #f8f9fa; padding: 15px; margin-bottom: 10px; border-radius: 8px; border: 1px solid #e0e0e0; transition: all .3s; }
    .user-item:hover { border-color: #667eea; box-shadow: 0 2px 8px rgba(102,126,234,.2); }
  </style>
</head>
<body>
  <div class="container">
    <a href="/payment" class="back-link">â† è¿”å›ä»˜æ¬¾ç³»çµ±</a>
    
    <h1>ğŸ§º å–ä»¶è¿½è¹¤ç³»çµ±</h1>
    <p class="subtitle">è‡ªå‹•æé†’å®¢æˆ¶å–ä»¶ - 7å¤©å¾Œæ—©ä¸Š11é»æé†’</p>

    <!-- å¿«é€ŸæŸ¥è©¢ -->
    <div class="form-group">
      <label>ğŸ” å¿«é€ŸæŸ¥è©¢å®¢æˆ¶ï¼ˆç”¨å®¢æˆ¶ç·¨è™Ÿï¼‰</label>
      <div class="quick-search">
        <input type="text" id="pickupSearch" placeholder="è¼¸å…¥ç·¨è™Ÿï¼ˆä¾‹å¦‚: 001ã€625ï¼‰">
        <button class="btn btn-small" onclick="searchForPickup()">æŸ¥è©¢</button>
      </div>
    </div>

    <div id="pickupCustomerCard" class="customer-card" style="display:none;">
      <h4>âœ… å®¢æˆ¶è³‡è¨Š</h4>
      <p><strong>ç·¨è™Ÿ:</strong> <span id="pickupCardNumber"></span></p>
      <p><strong>å§“å:</strong> <span id="pickupCardName"></span></p>
      <p><strong>User ID:</strong> <span id="pickupCardUserId"></span></p>
    </div>

    <!-- æ–°å¢è¿½è¹¤ -->
    <div style="background:#f8f9fa; padding:20px; border-radius:10px; margin-bottom:20px;">
      <h4 style="color:#667eea; margin-bottom:15px;">â• æ–°å¢å–ä»¶è¿½è¹¤</h4>
      <div class="form-group">
        <label>å®¢æˆ¶ç·¨è™Ÿ *</label>
        <input type="text" id="pickupNumber" placeholder="001">
      </div>
      <div class="form-group">
        <label>å®¢æˆ¶å§“å *</label>
        <input type="text" id="pickupName" placeholder="ç‹å°æ˜">
      </div>
      <div class="form-group">
        <label>User ID *</label>
        <input type="text" id="pickupUserId" placeholder="U123...">
      </div>
      <button class="btn btn-secondary" onclick="startPickup()">ğŸ¯ é–‹å§‹è¿½è¹¤ï¼ˆ7å¤©å¾Œ11é»æé†’ï¼‰</button>
    </div>

    <!-- æ“ä½œæŒ‰éˆ• -->
    <div style="display:flex; gap:10px; margin-bottom:20px; flex-wrap:wrap;">
      <button class="btn btn-small btn-secondary" onclick="loadPickups()">ğŸ”„ é‡æ–°æ•´ç†</button>
      <button class="btn btn-small btn-secondary" onclick="editTemplate()">ğŸ“ ç·¨è¼¯æ¨¡æ¿</button>
    </div>

    <!-- è¿½è¹¤åˆ—è¡¨ -->
    <div id="pickupList"><p style="text-align:center; color:#999;">å°šæœªè¼‰å…¥ï¼Œè«‹é»ã€Œé‡æ–°æ•´ç†ã€ã€‚</p></div>

    <div id="result" class="result"></div>
  </div>

  <!-- æ¨¡æ¿ç·¨è¼¯ Modal -->
  <div id="templateModal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,.6); z-index:9999;">
    <div style="background:#fff; max-width:600px; margin:50px auto; padding:30px; border-radius:15px;">
      <h3>ğŸ“ ç·¨è¼¯æé†’æ¨¡æ¿</h3>
      <p style="font-size:13px; color:#666; margin-bottom:15px;">å¯ç”¨è®Šæ•¸ï¼š{å®¢æˆ¶å§“å}ã€{å®¢æˆ¶ç·¨è™Ÿ}ã€{å·²éå¤©æ•¸}</p>
      <textarea id="templateText" style="width:100%; min-height:120px; padding:10px; margin:15px 0; border:2px solid #e0e0e0; border-radius:8px;"></textarea>
      <div style="display:flex; gap:10px;">
        <button class="btn btn-secondary" onclick="saveTemplate()">ğŸ’¾ å„²å­˜</button>
        <button class="btn" onclick="closeTemplateModal()">å–æ¶ˆ</button>
      </div>
    </div>
  </div>

  <script>
    var savedCustomers = {};

    // è¼‰å…¥å®¢æˆ¶ç·¨è™Ÿ
    async function loadCustomerNumbers() {
      try {
        var res = await fetch('/api/customer-numbers');
        var data = await res.json();
        if (data.success) {
          savedCustomers = {};
          (data.customers || []).forEach(function(c) {
            savedCustomers[c.number] = { name: c.name, userId: c.userId };
          });
        }
      } catch (error) {
        console.error('è¼‰å…¥å®¢æˆ¶ç·¨è™Ÿå¤±æ•—:', error);
      }
    }

    // å¿«é€ŸæŸ¥è©¢å®¢æˆ¶
    function searchForPickup() {
      var num = document.getElementById('pickupSearch').value.trim();
      if (!num) return alert('è«‹è¼¸å…¥ç·¨è™Ÿ');
      
      if (savedCustomers[num]) {
        var c = savedCustomers[num];
        document.getElementById('pickupNumber').value = num;
        document.getElementById('pickupName').value = c.name;
        document.getElementById('pickupUserId').value = c.userId;
        showPickupCard(num, c.name, c.userId);
      } else {
        alert('æ‰¾ä¸åˆ°æ­¤å®¢æˆ¶ç·¨è™Ÿ');
      }
    }

    function showPickupCard(number, name, userId) {
      document.getElementById('pickupCardNumber').textContent = number;
      document.getElementById('pickupCardName').textContent = name;
      document.getElementById('pickupCardUserId').textContent = userId;
      document.getElementById('pickupCustomerCard').style.display = 'block';
    }

    // é–‹å§‹è¿½è¹¤
    async function startPickup() {
      var num = document.getElementById('pickupNumber').value.trim();
      var name = document.getElementById('pickupName').value.trim();
      var userId = document.getElementById('pickupUserId').value.trim();
      
      if (!num || !name || !userId) return alert('è«‹å¡«å¯«å®Œæ•´');
      
      try {
        var res = await fetch('/api/pickup/add', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ customerNumber: num, customerName: name, userId: userId })
        });
        var data = await res.json();
        
        if (data.success) {
          showResult('success', 'âœ… å·²é–‹å§‹è¿½è¹¤ï¼7å¤©å¾Œ11é»è‡ªå‹•æé†’');
          document.getElementById('pickupNumber').value = '';
          document.getElementById('pickupName').value = '';
          document.getElementById('pickupUserId').value = '';
          document.getElementById('pickupCustomerCard').style.display = 'none';
          loadPickups();
        } else {
          showResult('error', 'âŒ ' + data.message);
        }
      } catch (e) {
        showResult('error', 'âŒ é€£ç·šå¤±æ•—');
      }
    }

    // è¼‰å…¥è¿½è¹¤è¨‚å–®
    async function loadPickups() {
      try {
        var res = await fetch('/api/pickup/orders');
        var data = await res.json();
        
        if (data.success) {
          var html = '';
          if (data.orders.length === 0) {
            html = '<p style="color:#999; text-align:center;">å°šç„¡è¿½è¹¤è¨‚å–®</p>';
          } else {
            data.orders.forEach(function(o) {
              var status = o.pickedUp ? 'âœ… å·²ç°½æ”¶' : 'â° è¿½è¹¤ä¸­ (' + o.daysPassed + 'å¤©)';
              html += '<div class="user-item" style="opacity:' + (o.pickedUp ? '0.6' : '1') + ';">' +
                '<div style="margin-bottom:10px;"><strong style="font-size:16px;">#' + o.customerNumber + ' - ' + o.customerName + '</strong> <span style="background:' + (o.pickedUp ? '#28a745' : '#ffc107') + '; color:#fff; padding:5px 10px; border-radius:5px; font-size:12px;">' + status + '</span></div>' +
                '<div style="font-size:13px; color:#666; margin-bottom:10px;">' +
                'ä¸‹æ¬¡æé†’: ' + new Date(o.nextReminderAt).toLocaleString('zh-TW') + '<br>' +
                'å·²æé†’: ' + o.reminderCount + ' æ¬¡</div>' +
                '<div style="display:flex; gap:5px; flex-wrap:wrap;">';
              
              if (!o.pickedUp) {
                html += '<button class="btn btn-small btn-secondary" onclick="remindNow(\'' + o.customerNumber + '\')">ğŸ”” ç«‹å³æé†’</button>' +
                        '<button class="btn btn-small" style="background:#ff9800;color:#fff;" onclick="delay14(\'' + o.customerNumber + '\')">â° å»¶14å¤©</button>' +
                        '<button class="btn btn-small btn-secondary" onclick="markDone(\'' + o.customerNumber + '\')">âœ… ç°½æ”¶</button>';
              }
              html += '<button class="btn btn-small btn-danger" onclick="deletePick(\'' + o.customerNumber + '\')">åˆªé™¤</button>' +
                      '</div></div>';
            });
          }
          document.getElementById('pickupList').innerHTML = html;
        }
      } catch (e) {
        showResult('error', 'âŒ è¼‰å…¥å¤±æ•—');
      }
    }

    // ç«‹å³æé†’
    async function remindNow(num) {
      try {
        var res = await fetch('/api/pickup/remind/' + num, { method: 'POST' });
        var data = await res.json();
        if (data.success) {
          showResult('success', 'âœ… æé†’å·²ç™¼é€');
          loadPickups();
        } else {
          showResult('error', 'âŒ ' + data.message);
        }
      } catch (e) {
        showResult('error', 'âŒ ç™¼é€å¤±æ•—');
      }
    }

    // å»¶é²14å¤©
    async function delay14(num) {
      if (!confirm('å»¶é²14å¤©å¾Œæé†’ï¼Ÿ')) return;
      try {
        var res = await fetch('/api/pickup/delay', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ customerNumber: num })
        });
        var data = await res.json();
        if (data.success) {
          showResult('success', 'âœ… å·²å»¶é²14å¤©');
          loadPickups();
        } else {
          showResult('error', 'âŒ ' + data.message);
        }
      } catch (e) {
        showResult('error', 'âŒ æ“ä½œå¤±æ•—');
      }
    }

    // æ¨™è¨˜å·²ç°½æ”¶
    async function markDone(num) {
      if (!confirm('æ¨™è¨˜ç‚ºå·²ç°½æ”¶ï¼Ÿ')) return;
      try {
        var res = await fetch('/api/pickup/complete', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ customerNumber: num })
        });
        var data = await res.json();
        if (data.success) {
          showResult('success', 'âœ… å·²ç°½æ”¶');
          loadPickups();
        } else {
          showResult('error', 'âŒ ' + data.message);
        }
      } catch (e) {
        showResult('error', 'âŒ æ“ä½œå¤±æ•—');
      }
    }

    // åˆªé™¤è¿½è¹¤
    async function deletePick(num) {
      if (!confirm('åˆªé™¤æ­¤è¿½è¹¤ï¼Ÿ')) return;
      try {
        var res = await fetch('/api/pickup/order/' + num, { method: 'DELETE' });
        var data = await res.json();
        if (data.success) {
          showResult('success', 'âœ… å·²åˆªé™¤');
          loadPickups();
        } else {
          showResult('error', 'âŒ ' + data.message);
        }
      } catch (e) {
        showResult('error', 'âŒ åˆªé™¤å¤±æ•—');
      }
    }

    // ç·¨è¼¯æ¨¡æ¿
    async function editTemplate() {
      try {
        var res = await fetch('/api/pickup/template');
        var data = await res.json();
        if (data.success) {
          document.getElementById('templateText').value = data.template;
          document.getElementById('templateModal').style.display = 'block';
        }
      } catch (e) {
        showResult('error', 'âŒ è¼‰å…¥å¤±æ•—');
      }
    }

    function closeTemplateModal() {
      document.getElementById('templateModal').style.display = 'none';
    }

    // å„²å­˜æ¨¡æ¿
    async function saveTemplate() {
      var text = document.getElementById('templateText').value.trim();
      if (!text) return alert('è«‹è¼¸å…¥æ¨¡æ¿');
      
      try {
        var res = await fetch('/api/pickup/template', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ template: text })
        });
        var data = await res.json();
        if (data.success) {
          showResult('success', 'âœ… æ¨¡æ¿å·²å„²å­˜');
          closeTemplateModal();
        } else {
          showResult('error', 'âŒ å„²å­˜å¤±æ•—');
        }
      } catch (e) {
        showResult('error', 'âŒ é€£ç·šå¤±æ•—');
      }
    }

    function showResult(type, html) {
      var el = document.getElementById('result');
      el.className = 'result ' + (type === 'success' ? 'success' : 'error');
      el.innerHTML = html;
      el.style.display = 'block';
      el.scrollIntoView({ behavior: 'smooth', block: 'center' });
    }

    // åˆå§‹åŒ–
    document.addEventListener('DOMContentLoaded', function() {
      loadCustomerNumbers();
    });
  </script>
</body>
</html>
