<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>C.H ç²¾ç·»æ´—è¡£ - ä»˜æ¬¾ç®¡ç†ç³»çµ±</title>
  <style>
    :root{
      --bg1:#1e1f2a; --bg2:#2a2b3a; --card:#0f1324; --primary:#6ea8fe; --accent:#9b8cff;
      --ok:#2ecc71; --warn:#f1c40f; --danger:#e74c3c; --muted:#9aa0ad; --ring:rgba(110,168,254,.25);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; font-family: ui-sans-serif, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial;
      background: radial-gradient(1200px 800px at 20% -10%, #2b2e4a 0%, #1b1d32 40%, #0c0f1f 100%),
                  linear-gradient(135deg, #3b82f6 0%, #8b5cf6 100%);
      background-blend-mode: overlay;
      color:#e6e9ef; padding:24px;
    }
    .shell{max-width:1100px;margin:0 auto;background:rgba(15,19,36,.7);backdrop-filter: blur(10px);border-radius:20px;box-shadow:0 30px 80px rgba(0,0,0,.4);overflow:hidden}
    .header{padding:22px 24px;border-bottom:1px solid rgba(255,255,255,.06);display:flex;align-items:center;gap:14px}
    .header .logo{font-size:28px}
    .header h1{margin:0;font-size:22px;letter-spacing:.5px}
    .tabs{display:flex;gap:18px;padding:14px 24px;border-bottom:1px solid rgba(255,255,255,.06);overflow:auto}
    .tab{background:none;border:none;color:#b7c1d6;cursor:pointer;font-weight:700;letter-spacing:.3px;padding:10px 8px;border-bottom:3px solid transparent}
    .tab.active{color:#fff;border-color:var(--primary)}
    .layout{display:grid;grid-template-columns: 1.2fr .8fr;gap:18px;padding:20px}
    @media (max-width: 900px){ .layout{grid-template-columns:1fr} }
    .card{background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));border:1px solid rgba(255,255,255,.08);border-radius:16px;padding:18px}
    .title{margin:0 0 12px;font-size:16px;color:#cbd5e1;letter-spacing:.4px}
    .row{display:grid;gap:12px;margin-bottom:12px}
    label{font-size:13px;color:#9aa5b1;margin-bottom:6px}
    input,textarea,select{
      width:100%;padding:13px 14px;border-radius:12px;border:1.5px solid rgba(255,255,255,.12);background:#0f1324;color:#e6e9ef;font-size:16px;
      outline:none; transition:.25s border, .25s box-shadow;
    }
    input:focus,textarea:focus,select:focus{border-color:var(--primary);box-shadow:0 0 0 6px var(--ring)}
    textarea{min-height:120px;resize:vertical}
    .grid3{display:grid;grid-template-columns:repeat(3,1fr);gap:10px}
    @media (max-width: 560px){ .grid3{grid-template-columns:1fr} }
    .paybtn{border:1.5px solid rgba(255,255,255,.12);background:#0f1324;border-radius:14px;cursor:pointer;padding:18px 10px;text-align:center}
    .paybtn.active{border-color:var(--primary);box-shadow:0 8px 26px rgba(110,168,254,.25), inset 0 0 0 999px rgba(110,168,254,.08)}
    .paybtn .ico{font-size:28px;margin-bottom:6px}
    .paybtn .name{font-weight:800;letter-spacing:.5px}
    .btn{display:inline-block;background:linear-gradient(135deg,#60a5fa,#8b5cf6);border:none;color:white;font-weight:800;
         padding:14px 18px;border-radius:12px;cursor:pointer;box-shadow:0 12px 35px rgba(99,102,241,.35);transition:transform .1s}
    .btn:active{transform:translateY(1px)}
    .btn.secondary{background:linear-gradient(135deg,#22c55e,#16a34a)}
    .muted{color:#94a3b8}
    .result{margin-top:12px;border-radius:12px;padding:14px;display:none}
    .result.success{background:rgba(34,197,94,.12);border:1px solid rgba(34,197,94,.3)}
    .result.error{background:rgba(239,68,68,.12);border:1px solid rgba(239,68,68,.3)}
    .searchLine{display:grid;grid-template-columns:1fr 140px;gap:10px}
    .kpi{display:grid;grid-template-columns:repeat(5,1fr);gap:10px;margin-bottom:8px}
    .kpi .k{background:#0b0f1e;border:1px solid rgba(255,255,255,.08);border-radius:12px;padding:14px;text-align:center}
    .k .n{font-size:22px;font-weight:900}
    .k .t{font-size:12px;color:#9aa5b1}
    .templ-grid{display:grid;grid-template-columns:1fr;gap:8px}
    .templ{background:#0b0f1e;border:1px dashed rgba(255,255,255,.14);padding:10px;border-radius:10px}
    .list{max-height:520px;overflow:auto;display:grid;gap:10px}
    .cust{background:#0b0f1e;border:1px solid rgba(255,255,255,.08);border-radius:12px;padding:12px;display:flex;justify-content:space-between;align-items:center}
    .cust .info{cursor:pointer}
    .pill{display:inline-block;padding:4px 8px;border-radius:999px;background:#111627;border:1px solid rgba(255,255,255,.08);font-size:12px;color:#9aa5b1}
  </style>
</head>
<body>
  <div class="shell">
    <div class="header">
      <div class="logo">ğŸ’³</div>
      <h1>ä»˜æ¬¾ç®¡ç†ç³»çµ±</h1>
    </div>

    <div class="tabs">
      <button class="tab active" data-tab="payment">ç™¼é€ä»˜æ¬¾</button>
      <button class="tab" data-tab="orders">è¨‚å–®ç®¡ç†</button>
      <button class="tab" data-tab="customers">å®¢æˆ¶ç·¨è™Ÿ</button>
      <button class="tab" data-tab="templates">è¨Šæ¯æ¨¡æ¿</button>
      <span class="pill">æ‰‹æ©Ÿå„ªåŒ– âœ“</span>
    </div>

    <!-- ä¸»è¦ layoutï¼šå·¦å´è¡¨å–® + å³å´å®¢æˆ¶æ¸…å–® -->
    <div id="payment" class="layout">
      <div class="card">
        <h3 class="title">ç™¼é€ä»˜æ¬¾</h3>

        <div class="row">
          <label>ğŸ” å¿«é€ŸæŸ¥è©¢ï¼ˆè¼¸å…¥ã€Œç·¨è™Ÿã€æˆ–ã€Œå§“åã€ï¼‰</label>
          <div class="searchLine">
            <input id="quickSearch" placeholder="ä¾‹å¦‚ï¼š625 æˆ– ç‹å°æ˜">
            <button class="btn secondary" id="btnQuick">æŸ¥è©¢</button>
          </div>
        </div>

        <form id="paymentForm">
          <div class="row">
            <label>å®¢æˆ¶å§“å *</label>
            <input id="userName" placeholder="ç‹å°æ˜" required>
          </div>

          <div class="row">
            <label>å®¢æˆ¶ LINE User ID *</label>
            <input id="userId" placeholder="Uxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx" required>
          </div>

          <div class="row">
            <label>é‡‘é¡ (NT$) *</label>
            <input id="amount" type="number" min="1" inputmode="numeric" placeholder="1500" required>
          </div>

          <div class="row">
            <label>ä»˜æ¬¾æ–¹å¼ *</label>
            <div class="grid3" id="payGrid">
              <div class="paybtn active" data-val="both">
                <div class="ico">ğŸ’™</div>
                <div class="name">å…©è€…éƒ½ç™¼</div>
              </div>
              <div class="paybtn" data-val="ecpay">
                <div class="ico">ğŸ’³</div>
                <div class="name">ç¶ ç•Œä¿¡ç”¨å¡</div>
              </div>
              <div class="paybtn" data-val="linepay">
                <div class="ico">ğŸ’š</div>
                <div class="name">LINE Pay</div>
              </div>
            </div>
          </div>

          <div class="row">
            <label>è¨Šæ¯å…§å®¹ï¼ˆå¯å« {amount}ï¼‰</label>
            <div style="display:grid;grid-template-columns:1fr 140px;gap:10px;align-items:start">
              <textarea id="customMessage" placeholder="ä¾‹å¦‚ï¼šæ‚¨å¥½ï¼Œé‡‘é¡ NT$ {amount}ï¼Œè¬è¬ï¼"></textarea>
              <div>
                <button type="button" class="btn" id="btnLoadT">è¼‰å…¥æ¨¡æ¿</button>
                <div class="muted" style="font-size:12px;margin-top:8px">åœ¨å³å´æœ‰ã€Œå®¢æˆ¶è¼‰å…¥ã€æ¸…å–®</div>
              </div>
            </div>
          </div>

          <button class="btn" type="submit">ç™¼é€ä»˜æ¬¾é€£çµ</button>
          <div id="result" class="result"></div>
        </form>
      </div>

      <!-- å³å´ï¼šå®¢æˆ¶è¼‰å…¥ / æ¨¡æ¿é€Ÿé¸ -->
      <div class="card">
        <h3 class="title">ğŸ‘¥ å®¢æˆ¶è¼‰å…¥</h3>
        <div style="display:flex;gap:8px;margin-bottom:10px">
          <button class="btn secondary" id="btnReloadUsers">é‡æ–°è¼‰å…¥</button>
          <span class="muted" id="usersCount">â€”</span>
        </div>
        <div id="userList" class="list">
          <div class="muted">å°šæœªè¼‰å…¥ï¼ˆé»ã€Œé‡æ–°è¼‰å…¥ã€ï¼‰</div>
        </div>

        <h3 class="title" style="margin-top:18px">ğŸ“ å¸¸ç”¨æ¨¡æ¿</h3>
        <div id="templList" class="templ-grid"></div>
      </div>
    </div>

    <!-- å…¶å®ƒåˆ†é ï¼šç°¡åŒ–éª¨æ¶ï¼ˆå¯ä¿ç•™ä½ åŸæœ‰å…§å®¹ï¼‰ -->
    <div id="orders" class="layout" style="display:none">
      <div class="card">
        <h3 class="title">è¨‚å–®ç®¡ç†</h3>
        <div class="kpi">
          <div class="k"><div class="n" id="kTotal">0</div><div class="t">ç¸½è¨‚å–®</div></div>
          <div class="k"><div class="n" id="kPending">0</div><div class="t">å¾…ä»˜æ¬¾</div></div>
          <div class="k"><div class="n" id="kPaid">0</div><div class="t">å·²ä»˜æ¬¾</div></div>
          <div class="k"><div class="n" id="kExpired">0</div><div class="t">å·²éæœŸ</div></div>
          <div class="k"><div class="n" id="kNeed">0</div><div class="t">éœ€æé†’</div></div>
        </div>
        <div id="orderList" class="list"></div>
      </div>
      <div class="card">
        <h3 class="title">ç¾¤çµ„å‹•ä½œ</h3>
        <button class="btn" id="btnRefreshOrders">é‡æ–°æ•´ç†</button>
        <button class="btn secondary" id="btnRemind">ç™¼é€ä»˜æ¬¾æé†’</button>
        <button class="btn" id="btnClean">æ¸…ç†éæœŸè¨‚å–®</button>
      </div>
    </div>

    <div id="customers" class="layout" style="display:none">
      <div class="card">
        <h3 class="title">æ–°å¢/æ›´æ–° å®¢æˆ¶ç·¨è™Ÿ</h3>
        <div class="row"><label>ç·¨è™Ÿ</label><input id="newNo" placeholder="å¦‚ 625"></div>
        <div class="row"><label>å§“å</label><input id="newName" placeholder="ç‹å°æ˜"></div>
        <div class="row"><label>LINE User ID</label><input id="newUid" placeholder="Uxxxxxxxxxx"></div>
        <button class="btn secondary" id="btnSaveNo">å„²å­˜</button>
      </div>
      <div class="card">
        <h3 class="title">å·²å„²å­˜</h3>
        <div id="savedCustomers" class="list"></div>
      </div>
    </div>

    <div id="templates" class="layout" style="display:none">
      <div class="card">
        <h3 class="title">æ–°å¢æ¨¡æ¿</h3>
        <div class="row"><textarea id="newTpl" placeholder="æ‚¨å¥½ï¼Œé‡‘é¡ NT$ {amount}ï¼Œè¬è¬ï¼"></textarea></div>
        <button class="btn secondary" id="btnSaveTpl">å„²å­˜æ¨¡æ¿</button>
      </div>
      <div class="card">
        <h3 class="title">æˆ‘çš„æ¨¡æ¿</h3>
        <div id="tplManage" class="list"></div>
      </div>
    </div>
  </div>

  <script>
    // ===== ç‹€æ…‹ =====
    const API_BASE = location.origin;
    let savedCustomers = {};
    let savedTemplates = [];
    let allOrders = [];
    let allUsers = [];

    // ===== å°å·¥å…· =====
    const $ = sel => document.querySelector(sel);
    const $all = sel => Array.from(document.querySelectorAll(sel));
    function showResult(type, msg){
      const el = $('#result');
      el.className = 'result ' + (type==='success'?'success':'error');
      el.innerHTML = msg;
      el.style.display = 'block';
      el.scrollIntoView({behavior:'smooth', block:'center'});
    }
    async function getJSON(u){ const r=await fetch(u); if(!r.ok) throw new Error(await r.text()); return r.json(); }
    async function postJSON(u,b){ const r=await fetch(u,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(b||{})}); let t=''; try{t=await r.text()}catch{}; try{const j=JSON.parse(t); if(!r.ok) throw new Error(j.error||t); return j;}catch{ if(!r.ok) throw new Error(t||'HTTP '+r.status); return {success:false, raw:t}; } }
    async function putJSON(u,b){ const r=await fetch(u,{method:'PUT',headers:{'Content-Type':'application/json'},body:JSON.stringify(b||{})}); return r.json(); }
    async function del(u){ const r=await fetch(u,{method:'DELETE'}); return r.json(); }

    // ===== åˆ†é  =====
    $all('.tab').forEach(btn=>{
      btn.addEventListener('click',()=>{
        $all('.tab').forEach(b=>b.classList.remove('active')); btn.classList.add('active');
        const id = btn.dataset.tab;
        ['payment','orders','customers','templates'].forEach(t => { document.getElementById(t).style.display = (t===id?'grid':'none'); });
        if(id==='orders') loadOrders();
        if(id==='customers') renderSavedCustomers();
        if(id==='templates') renderTplManage();
      });
    });

    // ===== æ”¯ä»˜é¸æ“‡ =====
    let paymentType = 'both';
    $('#payGrid').addEventListener('click', e=>{
      const card = e.target.closest('.paybtn'); if(!card) return;
      $all('.paybtn').forEach(x=>x.classList.remove('active'));
      card.classList.add('active');
      paymentType = card.dataset.val;
    });

    // ===== å¿«é€ŸæŸ¥è©¢ï¼ˆç·¨è™Ÿ/å§“åï¼‰â†’ å¥—å…¥å§“å + UIDï¼ˆæ³¨æ„ï¼šå§“åèˆ‡ UID å·²ä¿®æ­£ç‚ºæ­£ç¢ºå°æ‡‰ï¼‰=====
    $('#btnQuick').addEventListener('click', ()=>{
      const q = $('#quickSearch').value.trim();
      if(!q){ alert('è«‹è¼¸å…¥ç·¨è™Ÿæˆ–å§“å'); return; }
      // å…ˆç”¨ã€Œç·¨è™Ÿã€æ‰¾
      if(savedCustomers[q]){
        const c = savedCustomers[q];
        $('#userName').value = c.name || '';
        $('#userId').value = c.userId || '';
        return;
      }
      // å†ç”¨ã€Œå§“åã€æ‰¾
      const found = Object.entries(savedCustomers).find(([no,c]) => (c.name||'').includes(q));
      if(found){
        const [, c] = found;
        $('#userName').value = c.name || '';
        $('#userId').value = c.userId || '';
      }else{
        alert('æ‰¾ä¸åˆ°æ­¤å®¢æˆ¶');
      }
    });

    // ===== é€å‡ºä»˜æ¬¾ =====
    $('#paymentForm').addEventListener('submit', async (e)=>{
      e.preventDefault();
      const userId = $('#userId').value.trim();
      const userName = $('#userName').value.trim();
      const amount = parseInt($('#amount').value,10);
      const msg = ($('#customMessage').value||'').replace('{amount}', (amount||0).toLocaleString());

      if(!userId || !userName || !amount){ showResult('error','è«‹å®Œæ•´å¡«å¯«ï¼šå§“åã€User IDã€é‡‘é¡'); return; }

      try{
        const d = await postJSON(`${API_BASE}/api/send-payment`, { userId, userName, amount, paymentType, customMessage: msg });
        if(d.success){
          showResult('success', `âœ… å·²ç™¼é€ï¼<br>è¨‚å–®ï¼š${d.orderId}<br>å¯é‡è¤‡é»æ“Šï¼š<br>ç¶ ç•Œä¿¡ç”¨å¡ã€LINE Pay æŒ‰éˆ•`);
          $('#paymentForm').reset(); paymentType='both'; $all('.paybtn').forEach(x=>x.classList.remove('active')); $all('.paybtn')[0].classList.add('active');
        }else{
          showResult('error', `âŒ å¤±æ•—ï¼š${d.error||'æœªçŸ¥éŒ¯èª¤'}`);
        }
      }catch(err){
        showResult('error', `é€£ç·šå¤±æ•—ï¼š${err.message}`);
      }
    });

    // ===== å®¢æˆ¶æ¸…å–®ï¼ˆå³å´ï¼‰ =====
    async function loadUsers(){
      $('#userList').innerHTML = '<div class="muted">è¼‰å…¥ä¸­...</div>';
      try{
        const d = await getJSON(`${API_BASE}/api/users`);
        allUsers = Array.isArray(d.users)? d.users : [];
        $('#usersCount').textContent = `å…± ${allUsers.length} ç­†`;
        if(allUsers.length===0){ $('#userList').innerHTML = '<div class="muted">å°šç„¡å®¢æˆ¶</div>'; return; }
        $('#userList').innerHTML = allUsers.map(u=>`
          <div class="cust">
            <div class="info" data-uid="${u.userId||''}" data-name="${u.name||''}">
              <div style="font-weight:800">${u.name||'-'}</div>
              <div class="muted" style="font-size:12px">${u.userId||''}${u.number? 'ï½œç·¨è™Ÿ '+u.number : ''}</div>
            </div>
            <button class="btn" data-fill="${u.userId||''}" data-n="${u.name||''}">å¸¶å…¥</button>
          </div>
        `).join('');
      }catch{
        // å¾Œç«¯å–ä¸åˆ°å°±ç”¨ meta
        const list = Object.entries(savedCustomers).map(([no,c])=>({userId:c.userId,name:c.name,number:no}));
        $('#usersCount').textContent = `å…± ${list.length} ç­†ï¼ˆé›¢ç·šï¼‰`;
        if(list.length===0){ $('#userList').innerHTML = '<div class="muted">å°šç„¡å®¢æˆ¶</div>'; return; }
        $('#userList').innerHTML = list.map(u=>`
          <div class="cust">
            <div class="info" data-uid="${u.userId||''}" data-name="${u.name||''}">
              <div style="font-weight:800">${u.name||'-'}</div>
              <div class="muted" style="font-size:12px">${u.userId||''}${u.number? 'ï½œç·¨è™Ÿ '+u.number : ''}</div>
            </div>
            <button class="btn" data-fill="${u.userId||''}" data-n="${u.name||''}">å¸¶å…¥</button>
          </div>
        `).join('');
      }
    }
    $('#userList').addEventListener('click', e=>{
      const info = e.target.closest('.info');
      const btn = e.target.closest('button[data-fill]');
      const uid = info?.dataset.uid || btn?.dataset.fill;
      const name = info?.dataset.name || btn?.dataset.n;
      if(uid!==undefined){
        $('#userId').value = uid || '';
        $('#userName').value = name || '';
        // åˆ‡å›è¡¨å–®åˆ†é ï¼ˆè‹¥ä¸åœ¨ï¼‰
        $all('.tab').forEach(b=>b.classList.remove('active')); document.querySelector('.tab[data-tab="payment"]').classList.add('active');
        ['payment','orders','customers','templates'].forEach(t => { document.getElementById(t).style.display = (t==='payment'?'grid':'none'); });
      }
    });
    $('#btnReloadUsers').addEventListener('click', loadUsers);

    // ===== æ¨¡æ¿ =====
    async function fetchTemplates(){
      try{
        const d = await getJSON(`${API_BASE}/api/templates`);
        if(d.success && Array.isArray(d.templates)){ savedTemplates = d.templates; }
      }catch{}
      if(!savedTemplates || savedTemplates.length===0){
        savedTemplates = [
          'æ‚¨å¥½ï¼Œé‡‘é¡ NT$ {amount}ï¼Œè«‹å„˜é€Ÿä»˜æ¬¾ï¼Œè¬è¬ï¼',
          'è¡£ç‰©å·²å®Œæˆæ¸…æ´—ï¼Œè²»ç”¨ NT$ {amount}ï¼Œå¯ä¾†åº—å–ä»¶å›‰ï¼'
        ];
      }
      renderTemplates();
      renderTplManage();
    }
    function renderTemplates(){
      const box = $('#templList');
      box.innerHTML = savedTemplates.map((t,i)=>`
        <div class="templ">
          <div style="white-space:pre-wrap;font-size:14px">${t}</div>
          <div style="margin-top:8px"><button class="btn" data-usetpl="${i}">å¥—ç”¨</button></div>
        </div>
      `).join('');
    }
    $('#templList').addEventListener('click', e=>{
      const i = e.target.getAttribute('data-usetpl');
      if(i!==null){
        $('#customMessage').value = savedTemplates[Number(i)] || '';
        $('#customMessage').focus();
      }
    });
    $('#btnLoadT').addEventListener('click', renderTemplates);

    function renderTplManage(){
      const wrap = $('#tplManage');
      wrap.innerHTML = savedTemplates.map((t,i)=>`
        <div class="cust">
          <div style="white-space:pre-wrap;max-width:70%">${t}</div>
          <div style="display:flex;gap:8px">
            <button class="btn" data-edit="${i}">ç·¨è¼¯</button>
            <button class="btn" data-del="${i}">åˆªé™¤</button>
          </div>
        </div>
      `).join('');
    }
    $('#tplManage').addEventListener('click', async e=>{
      const di = e.target.getAttribute('data-del');
      const ei = e.target.getAttribute('data-edit');
      if(di!==null){
        const i = Number(di);
        await del(`${API_BASE}/api/templates/${i}`);
        await fetchTemplates();
      }else if(ei!==null){
        const i = Number(ei);
        const nv = prompt('ä¿®æ”¹æ¨¡æ¿ï¼š', savedTemplates[i]||'');
        if(nv===null) return;
        await putJSON(`${API_BASE}/api/templates/${i}`, { content:nv });
        await fetchTemplates();
      }
    });
    $('#btnSaveTpl').addEventListener('click', async ()=>{
      const c = $('#newTpl').value.trim();
      if(!c) return alert('è«‹è¼¸å…¥æ¨¡æ¿å…§å®¹');
      await postJSON(`${API_BASE}/api/templates`, { content:c });
      $('#newTpl').value='';
      await fetchTemplates();
    });

    // ===== å®¢æˆ¶ç·¨è™Ÿï¼ˆå¾Œç«¯åŒæ­¥ï¼‰ =====
    async function fetchCustomerMeta(){
      try{
        const d = await getJSON(`${API_BASE}/api/customer-meta`);
        if(d.success && d.map){ savedCustomers = d.map; }
      }catch{}
      renderSavedCustomers();
    }
    function renderSavedCustomers(){
      const wrap = $('#savedCustomers');
      const items = Object.entries(savedCustomers);
      if(!wrap) return;
      if(items.length===0){ wrap.innerHTML = '<div class="muted">å°šç„¡è³‡æ–™</div>'; return; }
      wrap.innerHTML = items.map(([no,c])=>`
        <div class="cust">
          <div class="info" data-uid="${c.userId||''}" data-name="${c.name||''}">
            <div style="font-weight:800">#${no} ${c.name||'-'}</div>
            <div class="muted" style="font-size:12px">User IDï¼š${c.userId||''}</div>
          </div>
          <button class="btn" data-delno="${no}">åˆªé™¤</button>
        </div>
      `).join('');
    }
    $('#savedCustomers')?.addEventListener('click', async e=>{
      const d = e.target.getAttribute('data-delno');
      const info = e.target.closest('.info');
      if(d){
        if(!confirm(`åˆªé™¤ç·¨è™Ÿ #${d} ?`)) return;
        await del(`${API_BASE}/api/customer-meta/${d}`);
        await fetchCustomerMeta();
      }else if(info){
        $('#userId').value = info.dataset.uid || '';
        $('#userName').value = info.dataset.name || '';
        // åˆ‡å›è¡¨å–®
        $all('.tab').forEach(b=>b.classList.remove('active')); document.querySelector('.tab[data-tab="payment"]').classList.add('active');
        ['payment','orders','customers','templates'].forEach(t => { document.getElementById(t).style.display = (t==='payment'?'grid':'none'); });
      }
    });
    $('#btnSaveNo').addEventListener('click', async ()=>{
      const number = ($('#newNo').value||'').trim();
      const name   = ($('#newName').value||'').trim();
      const userId = ($('#newUid').value||'').trim();
      if(!name || !userId){ alert('è«‹è¼¸å…¥ å§“å / User ID'); return; }
      const d = await postJSON(`${API_BASE}/api/customer-meta/save`, { number: number? Number(number):undefined, name, userId });
      if(d.success){
        $('#newNo').value=''; $('#newName').value=''; $('#newUid').value='';
        await fetchCustomerMeta();
        alert('âœ… å·²å„²å­˜');
      }else alert(d.error||'å„²å­˜å¤±æ•—');
    });

    // ===== è¨‚å–®ï¼ˆç°¡ç‰ˆï¼‰ =====
    async function loadOrders(){
      $('#orderList').innerHTML = '<div class="muted">è¼‰å…¥ä¸­...</div>';
      try{
        const d = await getJSON(`${API_BASE}/api/orders`);
        if(!d.success) throw new Error(d.error||'è¼‰å…¥å¤±æ•—');
        allOrders = d.orders||[];
        $('#kTotal').textContent = d.statistics?.total ?? 0;
        $('#kPending').textContent = d.statistics?.pending ?? 0;
        $('#kPaid').textContent = d.statistics?.paid ?? 0;
        $('#kExpired').textContent = d.statistics?.expired ?? 0;
        $('#kNeed').textContent = d.statistics?.needReminder ?? 0;
        if(allOrders.length===0){ $('#orderList').innerHTML = '<div class="muted">å°šç„¡è¨‚å–®</div>'; return; }
        $('#orderList').innerHTML = allOrders.map(o=>`
          <div class="cust">
            <div>
              <div style="font-weight:800">${o.userName||'-'}ã€€<span class="muted" style="font-size:12px">${o.orderId||''}</span></div>
              <div class="muted" style="font-size:12px">NT$ ${(o.amount||0).toLocaleString()}ï½œ${o.status|| (o.isExpired?'expired':'pending')}</div>
            </div>
            <div style="display:flex;gap:8px">
              ${o.isExpired? `<button class="btn" data-renew="${o.orderId}">çºŒç´„é‡ç™¼</button>` :
                              `<button class="btn" data-copy="${o.orderId}">è¤‡è£½é€£çµ</button>`}
              <button class="btn" data-del="${o.orderId}">åˆªé™¤</button>
            </div>
          </div>
        `).join('');
      }catch(e){
        $('#orderList').innerHTML = `<div class="muted">è¼‰å…¥å¤±æ•—ï¼š${e.message}</div>`;
      }
    }
    $('#orderList').addEventListener('click', async e=>{
      const r = e.target.getAttribute('data-renew');
      const d = e.target.getAttribute('data-del');
      const c = e.target.getAttribute('data-copy');
      if(r){
        const j = await postJSON(`${API_BASE}/api/order/${r}/renew`, {});
        alert(j.success? 'å·²çºŒç´„ä¸¦é‡ç™¼' : `å¤±æ•—ï¼š${j.error||'æœªçŸ¥éŒ¯èª¤'}`);
        loadOrders();
      }else if(d){
        if(!confirm('åˆªé™¤æ­¤è¨‚å–®ï¼Ÿ')) return;
        const j = await del(`${API_BASE}/api/order/${d}`);
        alert(j.success? 'å·²åˆªé™¤' : `å¤±æ•—ï¼š${j.error||'æœªçŸ¥éŒ¯èª¤'}`);
        loadOrders();
      }else if(c){
        const base = location.origin;
        const txt = `ã€ç¶ ç•Œä¿¡ç”¨å¡ã€‘\n${base}/pay/ec/${c}\n\nã€LINE Payã€‘\n${base}/pay/line/${c}`;
        try{ await navigator.clipboard.writeText(txt); alert('å·²è¤‡è£½'); }catch{ alert('è¤‡è£½å¤±æ•—'); }
      }
    });
    $('#btnRefreshOrders').addEventListener('click', loadOrders);
    $('#btnRemind').addEventListener('click', async ()=>{
      const j = await postJSON(`${API_BASE}/api/orders/send-reminders`, {});
      alert(j.message||'å·²ç™¼é€'); loadOrders();
    });
    $('#btnClean').addEventListener('click', async ()=>{
      const j = await postJSON(`${API_BASE}/api/orders/clean-expired`, {});
      alert(j.message||'å·²æ¸…ç†'); loadOrders();
    });

    // ===== åˆå§‹åŒ– =====
    document.addEventListener('DOMContentLoaded', async ()=>{
      await fetchCustomerMeta();
      await fetchTemplates();
      await loadUsers();
    });
  </script>
</body>
</html>