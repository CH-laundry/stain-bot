<!doctype html>
<html lang="zh-TW">
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>C.H ç²¾ç·»æ´—è¡£ - ä»˜æ¬¾ç®¡ç†ç³»çµ±</title>
<style>
* { box-sizing: border-box; }
body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background: #0f172a; color: #e2e8f0; margin: 0; padding: 0; }
.header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 20px; text-align: center; }
.header h1 { margin: 0; font-size: 28px; color: #fff; }
.container { max-width: 1400px; margin: 0 auto; padding: 20px; }
.grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
@media (max-width: 1024px) { .grid { grid-template-columns: 1fr; } }
.card { background: #1e293b; border: 1px solid #334155; border-radius: 12px; padding: 20px; }
.card h2 { margin: 0 0 16px; font-size: 18px; color: #f1f5f9; border-bottom: 2px solid #667eea; padding-bottom: 8px; }
label { display: block; margin-top: 12px; font-size: 13px; color: #cbd5e1; font-weight: 600; }
input, select, textarea { width: 100%; padding: 10px; margin-top: 6px; border: 1px solid #475569; background: #0f172a; color: #e2e8f0; border-radius: 6px; font-size: 14px; }
input:focus, select:focus, textarea:focus { outline: none; border-color: #667eea; box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1); }
.row { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
.col-full { grid-column: 1 / -1; }
.btn { padding: 10px 16px; border: none; border-radius: 6px; font-weight: 600; cursor: pointer; font-size: 14px; transition: all 0.2s; }
.btn-primary { background: #667eea; color: #fff; }
.btn-primary:hover { background: #5568d3; transform: translateY(-1px); }
.btn-success { background: #10b981; color: #fff; }
.btn-success:hover { background: #059669; }
.btn-danger { background: #ef4444; color: #fff; }
.btn-danger:hover { background: #dc2626; }
.btn-secondary { background: #64748b; color: #fff; }
.btn-secondary:hover { background: #475569; }
.btn-small { padding: 6px 12px; font-size: 12px; }
.flex { display: flex; gap: 8px; flex-wrap: wrap; }
.flex-between { display: flex; justify-content: space-between; align-items: center; }
.status-msg { padding: 10px; border-radius: 6px; margin-top: 8px; font-size: 13px; }
.status-success { background: #10b981; color: #fff; }
.status-error { background: #ef4444; color: #fff; }
.list { margin-top: 12px; }
.item { background: #0f172a; border: 1px solid #334155; border-radius: 6px; padding: 10px; margin-bottom: 8px; display: flex; justify-content: space-between; align-items: center; }
.item-info { flex: 1; }
.item-name { font-weight: 600; color: #f1f5f9; }
.item-meta { font-size: 12px; color: #94a3b8; margin-top: 4px; }
.pill { display: inline-block; background: #334155; color: #cbd5e1; padding: 3px 8px; border-radius: 12px; font-size: 12px; margin-right: 4px; }
.stat { background: #0f172a; border: 1px solid #334155; border-radius: 6px; padding: 12px; text-align: center; }
.stat-number { font-size: 24px; font-weight: 700; color: #667eea; }
.stat-label { font-size: 12px; color: #94a3b8; margin-top: 4px; }
.tabs { display: flex; gap: 0; border-bottom: 1px solid #334155; margin-bottom: 16px; }
.tab { padding: 10px 16px; cursor: pointer; border-bottom: 2px solid transparent; color: #94a3b8; font-weight: 600; transition: all 0.2s; }
.tab.active { border-bottom-color: #667eea; color: #667eea; }
.tab-content { display: none; }
.tab-content.active { display: block; }
textarea { min-height: 80px; resize: vertical; font-family: inherit; }
.payment-options { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 12px; margin-top: 12px; }
.payment-btn { padding: 12px; border: 2px solid #334155; background: transparent; border-radius: 6px; cursor: pointer; transition: all 0.2s; font-size: 13px; }
.payment-btn:hover { border-color: #667eea; background: rgba(102, 126, 234, 0.1); }
.payment-btn.selected { border-color: #667eea; background: rgba(102, 126, 234, 0.2); }
</style>

<div class="header">
  <h1>ğŸ’³ C.H ç²¾ç·»æ´—è¡£ - ä»˜æ¬¾ç®¡ç†ç³»çµ±</h1>
</div>

<div class="container">
  <div class="grid">
    <!-- å·¦å´ï¼šç™¼é€ä»˜æ¬¾ -->
    <div class="card">
      <h2>ğŸ“¤ ç™¼é€ä»˜æ¬¾é€£çµ</h2>
      
      <div class="row">
        <div>
          <label>å®¢æˆ¶å§“å *</label>
          <input id="userName" placeholder="è¼¸å…¥å®¢æˆ¶å§“å">
        </div>
        <div>
          <label>å®¢æˆ¶ç·¨è™Ÿ</label>
          <input id="customerNo" placeholder="å¦‚ 625ï¼ˆå¯é¸ï¼‰">
        </div>
      </div>

      <label>LINE User ID *</label>
      <input id="userId" placeholder="Uxxxxxxxxxxxxxxxxxxxxxxx">

      <label>é‡‘é¡ (NT$) *</label>
      <input id="amount" type="number" min="1" placeholder="1500">

      <label>ä»˜æ¬¾æ–¹å¼é¸æ“‡ *</label>
      <div class="payment-options">
        <button class="payment-btn selected" data-type="both">
          ğŸ’™ å…©è€…éƒ½ç™¼<br><small>ç¶ ç•Œ + LINE Pay</small>
        </button>
        <button class="payment-btn" data-type="ecpay">
          ğŸ’³ åªç™¼ç¶ ç•Œ<br><small>ä¿¡ç”¨å¡</small>
        </button>
        <button class="payment-btn" data-type="linepay">
          ğŸŸ¢ åªç™¼ LINE Pay
        </button>
      </div>

      <label style="margin-top: 16px;">è¨Šæ¯å…§å®¹</label>
      <textarea id="customMessage" placeholder="æ‚¨å¥½ï¼Œé‡‘é¡ NT$ {amount}ï¼Œè«‹é»æ“Šä»˜æ¬¾ï¼Œè¬è¬ï¼"></textarea>
      <small style="color: #94a3b8; display: block; margin-top: 4px;">æç¤ºï¼š{amount} æœƒè‡ªå‹•æ›¿æ›æˆé‡‘é¡</small>

      <button class="btn btn-primary" id="sendBtn" style="width: 100%; margin-top: 16px; padding: 12px;">
        ğŸš€ ç™¼é€ä»˜æ¬¾é€£çµ
      </button>
      <div id="sendStatus"></div>

      <hr style="border: none; border-top: 1px solid #334155; margin: 20px 0;">

      <h2>ğŸ—‚ï¸ å®¢æˆ¶ç®¡ç†</h2>
      <div class="row">
        <input id="newNo" placeholder="ç·¨è™Ÿï¼ˆç•™ç©ºè‡ªå‹•éå¢ï¼‰">
        <input id="newName" placeholder="å§“å *">
      </div>
      <input id="newUid" placeholder="LINE User ID *" style="grid-column: 1 / -1;">
      
      <div class="flex" style="margin-top: 12px;">
        <button class="btn btn-success" id="saveCustomerBtn">ğŸ’¾ å„²å­˜å®¢æˆ¶</button>
        <button class="btn btn-secondary" id="loadCustomersBtn">ğŸ”„ é‡æ–°è¼‰å…¥</button>
      </div>

      <label style="margin-top: 16px;">å¿«é€ŸæŸ¥è©¢</label>
      <div class="row">
        <input id="searchInput" placeholder="ç·¨è™Ÿæˆ–å§“å">
        <button class="btn btn-primary" id="searchBtn" style="padding: 10px;">ğŸ” æŸ¥è©¢</button>
      </div>
    </div>

    <!-- å³å´ï¼šçµ±è¨ˆå’Œæ¸…å–® -->
    <div class="card">
      <h2>ğŸ“Š ç³»çµ±çµ±è¨ˆ</h2>
      <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
        <div class="stat">
          <div class="stat-number" id="stat-total">0</div>
          <div class="stat-label">ç¸½è¨‚å–®</div>
        </div>
        <div class="stat">
          <div class="stat-number" id="stat-pending">0</div>
          <div class="stat-label">å¾…ä»˜æ¬¾</div>
        </div>
        <div class="stat">
          <div class="stat-number" id="stat-paid">0</div>
          <div class="stat-label">å·²ä»˜æ¬¾</div>
        </div>
        <div class="stat">
          <div class="stat-number" id="stat-remind">0</div>
          <div class="stat-label">å¾…æé†’</div>
        </div>
      </div>

      <hr style="border: none; border-top: 1px solid #334155; margin: 20px 0;">

      <h2>ğŸ‘¥ å®¢æˆ¶æ¸…å–®</h2>
      <div id="customerList" class="list">
        <div style="color: #94a3b8; text-align: center; padding: 20px;">å°šç„¡å®¢æˆ¶è³‡æ–™</div>
      </div>

      <hr style="border: none; border-top: 1px solid #334155; margin: 20px 0;">

      <h2>ğŸ“ è¨Šæ¯æ¨¡æ¿</h2>
      <div class="row">
        <input id="newTemplate" placeholder="è¼¸å…¥æ–°æ¨¡æ¿" style="grid-column: 1 / -1;">
      </div>
      <button class="btn btn-success" id="addTemplateBtn" style="width: 100%; margin-top: 8px;">â• æ–°å¢æ¨¡æ¿</button>
      
      <div id="templateList" class="list" style="margin-top: 12px;">
        <div style="color: #94a3b8; text-align: center; padding: 20px;">å°šç„¡æ¨¡æ¿</div>
      </div>
    </div>
  </div>
</div>

<script>
const $ = id => document.getElementById(id);
let selectedPaymentType = 'both';
let customers = {};
let templates = [];

// API å‘¼å«
async function apiCall(method, url, body = null) {
  try {
    const opts = {
      method,
      headers: { 'Content-Type': 'application/json' }
    };
    if (body) opts.body = JSON.stringify(body);
    const res = await fetch(url, opts);
    return await res.json();
  } catch (err) {
    console.error('API éŒ¯èª¤:', err);
    return { success: false, error: err.message };
  }
}

// ä»˜æ¬¾æ–¹å¼é¸æ“‡
document.querySelectorAll('.payment-btn').forEach(btn => {
  btn.addEventListener('click', () => {
    document.querySelectorAll('.payment-btn').forEach(b => b.classList.remove('selected'));
    btn.classList.add('selected');
    selectedPaymentType = btn.dataset.type;
  });
});

// ç™¼é€ä»˜æ¬¾
$('sendBtn').onclick = async () => {
  const userId = $('userId').value.trim();
  const userName = $('userName').value.trim();
  const amount = parseInt($('amount').value, 10);
  
  if (!userId || !userName || !amount) {
    showStatus('sendStatus', 'âŒ è«‹å¡«å¯«æ‰€æœ‰å¿…å¡«æ¬„ä½', 'error');
    return;
  }

  $('sendBtn').disabled = true;
  showStatus('sendStatus', 'â³ ç™¼é€ä¸­...', 'success');

  const customMsg = $('customMessage').value.trim() || 'æ‚¨å¥½ï¼Œé‡‘é¡ NT$ {amount}ï¼Œè«‹é»æ“Šä»˜æ¬¾ï¼Œè¬è¬ï¼';
  const msg = customMsg.replace('{amount}', amount.toLocaleString());

  const data = await apiCall('POST', '/send-payment', {
    userId, userName, amount, paymentType: selectedPaymentType, customMessage: msg
  });

  $('sendBtn').disabled = false;
  if (data.success) {
    showStatus('sendStatus', 'âœ… å·²ç™¼é€åˆ° LINEï¼', 'success');
    $('userName').value = '';
    $('userId').value = '';
    $('amount').value = '';
    $('customMessage').value = '';
    loadStats();
    setTimeout(() => showStatus('sendStatus', '', ''), 3000);
  } else {
    showStatus('sendStatus', 'âŒ ç™¼é€å¤±æ•—: ' + (data.error || 'æœªçŸ¥éŒ¯èª¤'), 'error');
  }
};

// å®¢æˆ¶ç®¡ç†
$('saveCustomerBtn').onclick = async () => {
  const no = $('newNo').value.trim();
  const name = $('newName').value.trim();
  const uid = $('newUid').value.trim();
  
  if (!name || !uid) {
    alert('è«‹å¡«å¯«å§“åå’Œ User ID');
    return;
  }

  const data = await apiCall('POST', '/api/customer-meta/save', {
    number: no ? parseInt(no) : undefined, name, userId: uid
  });

  if (data.success) {
    customers[data.number] = data.data;
    $('newNo').value = '';
    $('newName').value = '';
    $('newUid').value = '';
    drawCustomers();
    alert('âœ… å®¢æˆ¶å·²å„²å­˜');
  } else {
    alert('âŒ å„²å­˜å¤±æ•—: ' + (data.error || 'æœªçŸ¥éŒ¯èª¤'));
  }
};

$('loadCustomersBtn').onclick = loadCustomers;

$('searchBtn').onclick = () => {
  const q = $('searchInput').value.trim();
  if (!q) return;
  
  if (customers[q]) {
    const c = customers[q];
    $('userName').value = c.name;
    $('userId').value = c.userId;
    $('customerNo').value = q;
  } else {
    const found = Object.entries(customers).find(([_, c]) => c.name.includes(q));
    if (found) {
      $('userName').value = found[1].name;
      $('userId').value = found[1].userId;
      $('customerNo').value = found[0];
    } else {
      alert('æ‰¾ä¸åˆ°å®¢æˆ¶');
    }
  }
};

async function loadCustomers() {
  const data = await apiCall('GET', '/api/customer-meta');
  if (data.success) {
    customers = data.map || {};
    drawCustomers();
  }
}

function drawCustomers() {
  const list = $('customerList');
  const items = Object.entries(customers);
  if (items.length === 0) {
    list.innerHTML = '<div style="color: #94a3b8; text-align: center; padding: 20px;">å°šç„¡å®¢æˆ¶</div>';
    return;
  }
  
  list.innerHTML = items.sort((a, b) => Number(a[0]) - Number(b[0]))
    .map(([no, c]) => `
      <div class="item">
        <div class="item-info">
          <div class="item-name">#${no} ${c.name}</div>
          <div class="item-meta">${c.userId.substring(0, 20)}...</div>
        </div>
        <div class="flex">
          <button class="btn btn-primary btn-small" onclick="fillCustomer('${no}', '${c.name}', '${c.userId}')">å¸¶å…¥</button>
          <button class="btn btn-danger btn-small" onclick="delCustomer('${no}')">åˆªé™¤</button>
        </div>
      </div>
    `).join('');
}

async function fillCustomer(no, name, uid) {
  $('customerNo').value = no;
  $('userName').value = name;
  $('userId').value = uid;
  window.scrollTo({ top: 0, behavior: 'smooth' });
}

async function delCustomer(no) {
  if (!confirm(`ç¢ºå®šåˆªé™¤ #${no}?`)) return;
  const data = await apiCall('DELETE', '/api/customer-meta/' + no);
  if (data.success) {
    delete customers[no];
    drawCustomers();
  }
}

// æ¨¡æ¿ç®¡ç†
$('addTemplateBtn').onclick = async () => {
  const tpl = $('newTemplate').value.trim();
  if (!tpl) return;
  
  const data = await apiCall('POST', '/api/templates', { content: tpl });
  if (data.success) {
    templates = data.templates;
    $('newTemplate').value = '';
    drawTemplates();
  }
};

async function loadTemplates() {
  const data = await apiCall('GET', '/api/templates');
  if (data.success) {
    templates = data.templates || [];
    drawTemplates();
  }
}

function drawTemplates() {
  const list = $('templateList');
  if (templates.length === 0) {
    list.innerHTML = '<div style="color: #94a3b8; text-align: center; padding: 20px;">å°šç„¡æ¨¡æ¿</div>';
    return;
  }
  
  list.innerHTML = templates.map((t, i) => `
    <div class="item">
      <div class="item-info" style="font-size: 13px;">${t}</div>
      <div class="flex">
        <button class="btn btn-primary btn-small" onclick="useTemplate('${t.replace(/'/g, "\\'")}')">ä½¿ç”¨</button>
        <button class="btn btn-danger btn-small" onclick="delTemplate(${i})">åˆªé™¤</button>
      </div>
    </div>
  `).join('');
}

function useTemplate(t) {
  $('customMessage').value = t;
}

async function delTemplate(idx) {
  const data = await apiCall('DELETE', '/api/templates/' + idx);
  if (data.success) {
    templates = data.templates;
    drawTemplates();
  }
}

// çµ±è¨ˆ
async function loadStats() {
  const data = await apiCall('GET', '/api/orders');
  if (data.success && data.statistics) {
    $('stat-total').textContent = data.statistics.total;
    $('stat-pending').textContent = data.statistics.pending;
    $('stat-paid').textContent = data.statistics.paid;
    $('stat-remind').textContent = data.statistics.needReminder;
  }
}

function showStatus(elemId, msg, type) {
  const el = $(elemId);
  if (!msg) {
    el.innerHTML = '';
    return;
  }
  el.innerHTML = '<div class="status-msg status-' + type + '">' + msg + '</div>';
}

// åˆå§‹åŒ–
(async () => {
  await loadCustomers();
  await loadTemplates();
  await loadStats();
  setInterval(loadStats, 30000);
})();
</script>