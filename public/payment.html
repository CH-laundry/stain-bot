<!doctype html>
<html lang="zh-TW">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>C.H 精緻洗衣｜付款管理系統</title>
<style>
  :root{
    --bg1:#0f172a; --bg2:#1e293b; --card:#111827; --pri:#60a5fa; --ok:#22c55e; --warn:#f59e0b; --err:#ef4444;
  }
  *{box-sizing:border-box} body{margin:0;font-family:-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;background:radial-gradient(80vw 80vh at 10% -10%,#1f2937,#0b1020);}
  .wrap{max-width:1180px;margin:24px auto;padding:16px}
  .title{display:flex;gap:10px;align-items:center;color:#fff;font-weight:800;font-size:28px;margin:6px 0 14px}
  .pane{display:grid;grid-template-columns:1fr 360px;gap:18px}
  .card{background:linear-gradient(180deg,#0b1222,#0a0f1c);border:1px solid #22304d;border-radius:16px;padding:16px;color:#dbeafe}
  .tabs{display:flex;gap:8px;border-bottom:1px solid #21304d;margin-bottom:12px}
  .tab{background:transparent;border:0;color:#9bb7ff;padding:10px 14px;border-bottom:3px solid transparent;cursor:pointer;font-weight:700}
  .tab.act{color:#fff;border-bottom-color:#60a5fa}
  .grid2{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  label{display:block;font-size:13px;color:#94a3b8;margin:12px 4px 6px}
  input,textarea{width:100%;padding:12px 14px;border-radius:10px;border:1px solid #263a66;background:#0d1530;color:#e5e7eb;font-size:16px}
  textarea{min-height:120px;resize:vertical}
  .radio3{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin-top:8px}
  .opt{padding:18px;border-radius:14px;border:2px solid #243558;background:#0b1222;cursor:pointer;text-align:center}
  .opt.sel{border-color:#60a5fa;box-shadow:0 0 0 3px rgba(96,165,250,.15)}
  .btn{padding:14px 18px;border:0;border-radius:12px;background:linear-gradient(135deg,#60a5fa,#7c3aed);color:#fff;font-weight:800;cursor:pointer}
  .btn.small{padding:8px 12px;border-radius:10px}
  .btn.green{background:linear-gradient(135deg,#22c55e,#16a34a)}
  .btn.red{background:linear-gradient(135deg,#ef4444,#b91c1c)}
  .row{display:flex;gap:10px;align-items:center}
  .side h4{margin:.2rem 0 10px;color:#9cc2ff}
  .list{display:flex;flex-direction:column;gap:10px;max-height:560px;overflow:auto}
  .item{padding:10px 12px;border:1px solid #243558;border-radius:12px;background:#0b1222;color:#dbeafe;display:flex;justify-content:space-between;gap:8px}
  .muted{color:#94a3b8;font-size:12px}
  .pill{padding:4px 8px;border-radius:9999px;font-size:12px;font-weight:700}
  .pill.ok{background:#052f18;color:#86efac;border:1px solid #14532d}
  .result{margin-top:12px;padding:12px;border-radius:10px;display:none}
  .result.ok{background:#052f18;border:1px solid #14532d;color:#86efac}
  .result.err{background:#3b0b10;border:1px solid #7f1d1d;color:#fecaca}
  @media (max-width:960px){ .pane{grid-template-columns:1fr} }
</style>
</head>
<body>
  <div class="wrap">
    <div class="title">🧾 付款管理系統</div>

    <div class="pane">
      <!-- 左：主操作 -->
      <div class="card">
        <div class="tabs">
          <button class="tab act" data-tab="send">發送付款</button>
          <button class="tab" data-tab="orders">訂單管理</button>
          <button class="tab" data-tab="meta">客戶編號</button>
          <button class="tab" data-tab="tpl">訊息模板</button>
        </div>

        <!-- 發送付款 -->
        <section id="tab-send">
          <label>🔍 快速查詢（輸入「編號」或「姓名」）</label>
          <div class="row">
            <input id="q" placeholder="例如 625 或 王小明"/>
            <button class="btn small" id="btnQ">查詢</button>
          </div>

          <div class="grid2">
            <div>
              <label>客戶姓名 *</label>
              <input id="userName" placeholder="王小明"/>
            </div>
            <div>
              <label>客戶 LINE User ID *</label>
              <input id="userId" placeholder="Uxxxxxxxxxxxxxxxxxxxxxx"/>
            </div>
          </div>

          <label>金額（NT$） *</label>
          <input id="amount" type="number" min="1" placeholder="1500"/>

          <label>付款方式 *</label>
          <div class="radio3" id="payType">
            <div class="opt sel" data-v="both">💙 兩者都發</div>
            <div class="opt" data-v="ecpay">💳 綠界信用卡</div>
            <div class="opt" data-v="linepay">💚 LINE Pay</div>
          </div>

          <label>訊息內容（可含 {amount}）</label>
          <textarea id="msg" placeholder="例如：您好，金額 NT$ {amount}，謝謝！"></textarea>

          <div class="row" style="margin-top:12px;gap:12px">
            <button class="btn" id="btnSend">發送付款連結</button>
            <button class="btn green small" id="btnLoadTpl">載入模板</button>
          </div>

          <div class="result" id="tip"></div>
        </section>

        <!-- 訂單管理 -->
        <section id="tab-orders" style="display:none">
          <div class="row" style="gap:8px;margin:4px 0 10px">
            <button class="btn green small" id="btnReloadOrders">重新整理</button>
            <button class="btn green small" id="btnRemind">發送付款提醒</button>
          </div>
          <div id="orderList" class="list"></div>
        </section>

        <!-- 客戶編號 -->
        <section id="tab-meta" style="display:none">
          <div class="grid2">
            <div>
              <label>編號（可空白自動遞增）</label>
              <input id="mNo" placeholder="例如 625"/>
            </div>
            <div>
              <label>姓名 *</label>
              <input id="mName" placeholder="王小明"/>
            </div>
          </div>
          <label>LINE User ID *</label>
          <input id="mUid" placeholder="Uxxxxxxxxxxxxxxxxxxxx"/>

          <div class="row" style="margin-top:12px;gap:8px">
            <button class="btn green" id="btnSaveMeta">儲存</button>
          </div>

          <h4 style="margin-top:16px">已儲存</h4>
          <div id="savedMeta" class="list"></div>
          <div class="muted" id="metaNone">尚無資料</div>
        </section>

        <!-- 模板 -->
        <section id="tab-tpl" style="display:none">
          <label>新增模板</label>
          <textarea id="newTpl" placeholder="您好，金額 NT$ {amount}，請儘速付款，謝謝！"></textarea>
          <div class="row" style="margin-top:12px">
            <button class="btn green" id="btnSaveTpl">儲存模板</button>
          </div>
          <h4 style="margin-top:16px">我的模板</h4>
          <div id="tplList" class="list"></div>
        </section>
      </div>

      <!-- 右：客戶載入 -->
      <aside class="card side">
        <div class="row" style="justify-content:space-between">
          <h4>👥 客戶載入</h4>
          <button class="btn small green" id="btnReloadUsers">重新載入</button>
        </div>
        <div class="muted">點一下「姓名」即可帶入到發送區。</div>
        <div id="userList" class="list"></div>
        <div class="muted" id="userNone">尚無客戶</div>

        <h4 style="margin-top:16px">📌 常用模板</h4>
        <div id="quickTpls" class="list"></div>
      </aside>
    </div>
  </div>

<script>
const $ = (id)=>document.getElementById(id);
const API = (p)=>p; // 同網域
let savedTemplates = [];
let meta = { nextNo:1, map:{} };
let allOrders = [];

// tabs
document.querySelectorAll('.tab').forEach(t=>{
  t.onclick = ()=>{
    document.querySelectorAll('.tab').forEach(x=>x.classList.remove('act'));
    t.classList.add('act');
    const k = t.dataset.tab;
    ['send','orders','meta','tpl'].forEach(s=>{
      $('tab-'+s).style.display = (s===k?'block':'none');
    });
    if (k==='orders') loadOrders();
    if (k==='tpl')    renderTpls();
    if (k==='meta')   renderMeta();
  };
});

// pay type
let payType = 'both';
document.querySelectorAll('#payType .opt').forEach(x=>{
  x.onclick = ()=>{
    document.querySelectorAll('#payType .opt').forEach(y=>y.classList.remove('sel'));
    x.classList.add('sel'); payType = x.dataset.v;
  };
});

// 快速查詢
$('btnQ').onclick = ()=>{
  const q = $('q').value.trim();
  if (!q) return alert('請輸入編號或姓名');
  // 先編號
  if (meta.map[q]) {
    const c = meta.map[q];
    $('userName').value = c.name||'';
    $('userId').value = c.userId||'';
    return;
  }
  // 模糊姓名
  const hit = Object.values(meta.map).find(v=> (v.name||'').includes(q));
  if (hit) {
    $('userName').value = hit.name||'';
    $('userId').value = hit.userId||'';
  } else alert('找不到');
};

// 發送
$('btnSend').onclick = async ()=>{
  const userId = $('userId').value.trim();
  const userName = $('userName').value.trim();
  const amount = parseInt($('amount').value,10);
  const customMessage = ($('msg').value||'').replace('{amount}', (amount||0).toLocaleString());
  if (!userId || !userName || !amount) return tip('err','請把姓名、UserID、金額填好');

  try{
    $('btnSend').disabled = true;
    const r = await fetch(API('/api/send-payment'),{
      method:'POST', headers:{'Content-Type':'application/json'},
      body: JSON.stringify({ userId, userName, amount, paymentType:payType, customMessage })
    });
    const d = await r.json();
    if (!d.success) throw new Error(d.error||'發送失敗');
    tip('ok','✅ 已發送付款連結'); $('msg').value='';
  }catch(e){ tip('err','❌ '+e.message); }
  finally{ $('btnSend').disabled = false; }
};

function tip(type, msg){
  const el = $('tip');
  el.className = 'result '+(type==='ok'?'ok':'err');
  el.textContent = msg; el.style.display='block';
  el.scrollIntoView({behavior:'smooth',block:'center'});
}

// 模板
$('btnLoadTpl').onclick = ()=> renderQuickTpls();
$('btnSaveTpl').onclick = async ()=>{
  const t = $('newTpl').value.trim(); if (!t) return alert('請輸入內容');
  const r = await fetch(API('/api/templates'),{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({content:t})});
  const d = await r.json(); if (!d.success) return alert(d.error||'失敗');
  savedTemplates = d.templates; $('newTpl').value=''; renderTpls(); renderQuickTpls();
};

async function fetchTpls(){
  const r = await fetch(API('/api/templates')); const d = await r.json();
  if (d.success) savedTemplates = d.templates;
}
function renderTpls(){
  const box = $('tplList');
  if (!savedTemplates.length) { box.innerHTML = '<div class="muted">尚無模板</div>'; return; }
  box.innerHTML = savedTemplates.map((t,i)=>`
    <div class="item">
      <div style="white-space:pre-wrap">${t}</div>
      <div class="row">
        <button class="btn small green" onclick="editTpl(${i})">編輯</button>
        <button class="btn small red" onclick="delTpl(${i})">刪除</button>
      </div>
    </div>`).join('');
}
function renderQuickTpls(){
  const box = $('quickTpls');
  if (!savedTemplates.length){ box.innerHTML='<div class="muted">尚無模板</div>'; return; }
  box.innerHTML = savedTemplates.map((t)=>`
    <div class="item" style="cursor:pointer" onclick="setMsg(${JSON.stringify(t).replace(/"/g,'&quot;')})">
      <div>📝 ${t.length>38?t.slice(0,38)+'…':t}</div>
    </div>`).join('');
}
function setMsg(t){ $('msg').value = t; }

async function editTpl(i){
  const nv = prompt('修改模板內容：', savedTemplates[i]||''); if (nv===null) return;
  const r = await fetch(API('/api/templates/'+i),{method:'PUT',headers:{'Content-Type':'application/json'},body:JSON.stringify({content:nv})});
  const d = await r.json(); if (!d.success) return alert(d.error||'失敗');
  savedTemplates = d.templates; renderTpls(); renderQuickTpls();
}
async function delTpl(i){
  if(!confirm('確定刪除此模板？')) return;
  const r = await fetch(API('/api/templates/'+i),{method:'DELETE'});
  const d = await r.json(); if (!d.success) return alert(d.error||'失敗');
  savedTemplates = d.templates; renderTpls(); renderQuickTpls();
}

// 客戶編號
$('btnSaveMeta').onclick = async ()=>{
  const number = $('mNo').value.trim();
  const name = $('mName').value.trim();
  const userId = $('mUid').value.trim();
  if (!name || !userId) return alert('請輸入 姓名 與 LINE User ID');
  const r = await fetch(API('/api/customer-meta/save'),{
    method:'POST', headers:{'Content-Type':'application/json'},
    body: JSON.stringify({ number: number?Number(number):undefined, name, userId })
  });
  const d = await r.json(); if (!d.success) return alert('儲存失敗：'+(d.error||''));
  await fetchMeta(); renderMeta();
  $('mNo').value=''; $('mName').value=''; $('mUid').value='';
};

async function fetchMeta(){
  const r = await fetch(API('/api/customer-meta')); const d = await r.json();
  if (d.success) meta = { nextNo:d.nextNo, map:d.map||{} };
}
function renderMeta(){
  const keys = Object.keys(meta.map||{});
  const box = $('savedMeta');
  $('metaNone').style.display = keys.length? 'none':'block';
  if (!keys.length) { box.innerHTML=''; return; }
  box.innerHTML = keys.sort((a,b)=>a-b).map(no=>{
    const c = meta.map[no];
    return `<div class="item">
      <div style="cursor:pointer" onclick="prefill('${c.userId}','${c.name}')">
        <div>#${no}　${c.name}</div>
        <div class="muted">User ID：${c.userId}</div>
      </div>
      <button class="btn small red" onclick="delMeta('${no}')">刪除</button>
    </div>`;
  }).join('');
}
async function delMeta(no){
  if(!confirm(`刪除編號 #${no} ？`)) return;
  const r = await fetch(API('/api/customer-meta/'+no),{method:'DELETE'});
  const d = await r.json(); if (!d.success) return alert(d.error||'刪除失敗');
  await fetchMeta(); renderMeta();
}
function prefill(uid,name){
  $('userId').value = uid||''; $('userName').value=name||'';
  document.querySelector('.tab[data-tab="send"]').click();
}

// 右側載入客戶
$('btnReloadUsers').onclick = loadUsers;
async function loadUsers(){
  const r = await fetch(API('/api/users')); const d = await r.json();
  const box = $('userList');
  if (!d.success || !d.users?.length){ box.innerHTML=''; $('userNone').style.display='block'; return; }
  $('userNone').style.display='none';
  box.innerHTML = d.users.map(u=>`
    <div class="item">
      <div style="cursor:pointer" onclick="prefill('${u.userId}','${u.name}')">
        <div>${u.name||'-'}</div>
        <div class="muted">User ID：${u.userId||'-'}${u.number? '｜編號：'+u.number:''}</div>
      </div>
      <button class="btn small green" onclick="prefill('${u.userId}','${u.name}')">帶入</button>
    </div>`).join('');
}

// 訂單
$('btnReloadOrders').onclick = loadOrders;
$('btnRemind').onclick = async ()=>{
  const r = await fetch(API('/api/orders/send-reminders'),{method:'POST'});
  const d = await r.json(); alert(d.success? d.message : d.error||'失敗');
};
async function loadOrders(){
  const r = await fetch(API('/api/orders')); const d = await r.json();
  const box = $('orderList');
  if (!d.success){ box.innerHTML='<div class="muted">載入失敗</div>'; return; }
  allOrders = d.orders||[];
  if (!allOrders.length){ box.innerHTML='<div class="muted">尚無訂單</div>'; return; }
  box.innerHTML = allOrders.map(o=>{
    const badge = o.status==='paid'
      ? '<span class="pill ok">已付款</span>'
      : (o.isExpired? '<span class="pill" style="background:#2b0d10;color:#fecaca;border:1px solid #7f1d1d">已過期</span>'
                    : `<span class="pill" style="background:#221805;color:#fde68a;border:1px solid #92400e">剩餘 ${o.remainingHours} 小時</span>`);
    return `<div class="item">
      <div>
        <div style="font-weight:700">${o.userName}　${badge}</div>
        <div class="muted">#${o.orderId}｜NT$ ${(o.amount||0).toLocaleString()}</div>
      </div>
      <div class="row">
        ${o.status==='paid'?'':`<button class="btn small green" onclick="renew('${o.orderId}')">續約重發</button>`}
      </div>
    </div>`;
  }).join('');
}
async function renew(id){
  const r = await fetch(API('/api/order/'+id+'/renew'),{method:'POST'});
  const d = await r.json(); alert(d.success? d.message : d.error||'失敗'); loadOrders();
}

// 初始化
(async function init(){
  await Promise.all([fetchTpls(), fetchMeta(), loadUsers()]);
  renderTpls(); renderQuickTpls(); renderMeta();
})();
</script>
</body>
</html>