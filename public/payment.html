<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>C.H ç²¾ç·»æ´—è¡£ - ä»˜æ¬¾ç®¡ç†ç³»çµ±</title>
<style>
  :root{
    --bg:#0f1442; --bg2:#1a215c; --card:#0f162e; --pri:#5e8bff; --pri2:#7b6cff;
    --ok:#21c17a; --warn:#ffc107; --err:#ff5d6c; --text:#e9eefb; --sub:#a7b0d6; --line:#29315b;
  }
  *{box-sizing:border-box}
  body{margin:0;font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Helvetica,Arial,sans-serif;background:radial-gradient(1200px 800px at 20% -10%,#2f3da8 0%,transparent 60%), radial-gradient(1000px 700px at 110% 10%,#6a35c1 0%,transparent 50%), var(--bg);color:var(--text)}
  .wrap{max-width:1100px;margin:24px auto;padding:16px}
  .panel{background:linear-gradient(180deg,var(--bg2),#0c1138);border:1px solid var(--line);border-radius:18px;box-shadow:0 10px 40px rgba(0,0,0,.3);padding:24px}
  h1{display:flex;gap:10px;align-items:center;margin:0 0 8px;font-size:22px}
  .tabs{display:flex;gap:16px;margin:12px 0 20px;border-bottom:1px solid var(--line);flex-wrap:wrap}
  .tab{appearance:none;background:none;border:none;color:var(--sub);padding:12px 4px;font-weight:700;cursor:pointer;border-bottom:3px solid transparent}
  .tab.active{color:var(--text);border-bottom-color:var(--pri)}
  .grid{display:grid;grid-template-columns:1fr 340px;gap:18px}
  @media (max-width: 920px){.grid{grid-template-columns:1fr}}
  label{display:block;font-size:13px;color:var(--sub);margin:14px 0 6px}
  input,textarea,select{width:100%;padding:14px 12px;border-radius:12px;background:#0b1030;border:1px solid var(--line);color:var(--text);outline:none}
  textarea{min-height:120px;resize:vertical}
  input:focus,textarea:focus,select:focus{border-color:#3a54ff;box-shadow:0 0 0 3px rgba(90,120,255,.25)}
  .row{display:flex;gap:10px}
  .btn{display:inline-flex;align-items:center;justify-content:center;gap:8px;padding:14px 18px;border-radius:12px;border:1px solid transparent;cursor:pointer;font-weight:800;letter-spacing:.5px}
  .btn-primary{background:linear-gradient(135deg,var(--pri),var(--pri2));color:white}
  .btn-ghost{background:#0b1030;border-color:var(--line);color:var(--text)}
  .btn-danger{background:linear-gradient(135deg,#ff4d6d,#ff2550);color:#fff}
  .btn-ok{background:linear-gradient(135deg,#18ba84,#00a56a);color:#fff}
  .btn:disabled{opacity:.5;cursor:not-allowed}
  .radio3{display:grid;grid-template-columns:repeat(3,1fr);gap:12px}
  .payopt{border:1px solid var(--line);border-radius:14px;padding:14px 10px;text-align:center;background:#0b1030;cursor:pointer}
  .payopt.active{outline:3px solid rgba(94,139,255,.45);border-color:transparent}
  .payopt .emoji{font-size:28px;margin-bottom:6px}
  .templates{display:grid;grid-template-columns:1fr 1fr;gap:10px}
  .tpl{background:#0b1030;border:1px solid var(--line);border-radius:10px;padding:10px;text-align:left;cursor:pointer}
  .tpl:hover{border-color:#3a54ff}
  .card{background:#0b1030;border:1px solid var(--line);border-radius:14px;padding:16px}
  .list{display:flex;flex-direction:column;gap:10px;max-height:460px;overflow:auto;margin-top:10px}
  .item{display:flex;gap:10px;align-items:center;justify-content:space-between;background:#0f1438;border:1px solid var(--line);border-radius:12px;padding:10px}
  .hint{font-size:12px;color:var(--sub)}
  .pill{display:inline-block;padding:6px 10px;border-radius:999px;background:#14205a;color:var(--sub);font-size:12px}
  .result{margin-top:14px;border-radius:12px;padding:14px 12px;display:none}
  .result.ok{display:block;background:rgba(24,186,132,.15);border:1px solid #22c38a}
  .result.err{display:block;background:rgba(255,93,108,.15);border:1px solid #ff6c7a}
  .stat{display:grid;grid-template-columns:repeat(5,1fr);gap:10px}
  .chip{background:#0b1030;border:1px solid var(--line);border-radius:12px;padding:10px;text-align:center}
  .chip b{display:block;font-size:22px;margin-bottom:2px}
</style>
</head>
<body>
<div class="wrap">
  <div class="panel">
    <h1>ğŸ’³ ä»˜æ¬¾ç®¡ç†ç³»çµ±</h1>
    <div class="tabs">
      <button class="tab active" data-tab="send">ç™¼é€ä»˜æ¬¾</button>
      <button class="tab" data-tab="orders">è¨‚å–®ç®¡ç†</button>
      <button class="tab" data-tab="customers">å®¢æˆ¶ç·¨è™Ÿ</button>
      <button class="tab" data-tab="templates">è¨Šæ¯æ¨¡æ¿</button>
    </div>

    <!-- å…§å®¹ -->
    <div id="tab-send" class="grid">
      <!-- å·¦ï¼šè¡¨å–® -->
      <div>
        <div class="card">
          <label>ğŸ” å¿«é€ŸæŸ¥è©¢ï¼ˆè¼¸å…¥ã€Œç·¨è™Ÿã€æˆ–ã€Œå§“åã€ï¼‰</label>
          <div class="row">
            <input id="quickSearch" placeholder="ä¾‹å¦‚ï¼š625 æˆ– ç‹å°æ˜" />
            <button class="btn btn-ghost" id="btnQuickSearch">æŸ¥è©¢</button>
          </div>

          <label>å®¢æˆ¶å§“å *</label>
          <input id="userName" placeholder="ç‹å°æ˜" />

          <label>å®¢æˆ¶ LINE User ID *</label>
          <input id="userId" placeholder="Uxxxxxxxxxxxxxxxxxxxx" />

          <label>é‡‘é¡ï¼ˆNT$ï¼‰*</label>
          <input id="amount" type="number" min="1" placeholder="1500" />

          <label>ä»˜æ¬¾æ–¹å¼ *</label>
          <div class="radio3" id="payGroup">
            <div class="payopt active" data-v="both"><div class="emoji">ğŸ’™</div>å…©è€…éƒ½ç™¼</div>
            <div class="payopt" data-v="ecpay"><div class="emoji">ğŸ’³</div>ç¶ ç•Œä¿¡ç”¨å¡</div>
            <div class="payopt" data-v="linepay"><div class="emoji">ğŸ’š</div>LINE Pay</div>
          </div>

          <label>è¨Šæ¯å…§å®¹ï¼ˆå¯å« {amount}ï¼‰</label>
          <div class="row" style="align-items:center">
            <textarea id="customMessage" placeholder="ä¾‹å¦‚ï¼šæ‚¨å¥½ï¼Œé‡‘é¡ NT$ {amount}ï¼Œè¬è¬ï¼"></textarea>
            <button class="btn btn-ghost" id="btnLoadTpl">è¼‰å…¥æ¨¡æ¿</button>
          </div>

          <button class="btn btn-primary" id="btnSend">ç™¼é€ä»˜æ¬¾é€£çµ</button>
          <div id="sendResult" class="result"></div>
        </div>

        <div class="card" style="margin-top:14px">
          <div class="stat" id="stats">
            <div class="chip"><b>0</b>ç¸½è¨‚å–®æ•¸</div>
            <div class="chip"><b>0</b>å¾…ä»˜æ¬¾</div>
            <div class="chip"><b>0</b>å·²ä»˜æ¬¾</div>
            <div class="chip"><b>0</b>å·²éæœŸ</div>
            <div class="chip"><b>0</b>éœ€æé†’</div>
          </div>
        </div>
      </div>

      <!-- å³ï¼šå®¢æˆ¶è¼‰å…¥ / æ¨¡æ¿ -->
      <div>
        <div class="card">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <div>ğŸ‘¥ å®¢æˆ¶è¼‰å…¥ <span class="pill" id="custCount">å…± 0 ç­†</span></div>
            <button class="btn btn-ok" id="btnReloadCustomers">é‡æ–°è¼‰å…¥</button>
          </div>
          <div class="list" id="customerList"><div class="hint">å°šç„¡å®¢æˆ¶</div></div>
        </div>

        <div class="card" style="margin-top:14px">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <div>ğŸ“ å¸¸ç”¨æ¨¡æ¿</div>
            <button class="btn btn-ok" id="btnAddTpl">æ–°å¢æ¨¡æ¿</button>
          </div>
          <div class="templates" id="tplList" style="margin-top:10px"></div>
        </div>
      </div>
    </div>

    <!-- è¨‚å–®ç®¡ç† -->
    <div id="tab-orders" style="display:none">
      <div class="row" style="gap:10px;margin-bottom:10px">
        <button class="btn btn-ok" id="btnRefreshOrders">é‡æ–°æ•´ç†</button>
        <button class="btn btn-ok" id="btnSendReminders">ç™¼é€ä»˜æ¬¾æé†’</button>
        <button class="btn btn-danger" id="btnCleanExpired">æ¸…ç†éæœŸè¨‚å–®</button>
      </div>
      <div id="orderList" class="list card"></div>
    </div>

    <!-- å®¢æˆ¶ç·¨è™Ÿ -->
    <div id="tab-customers" style="display:none">
      <div class="grid">
        <div class="card">
          <label>ç·¨è™Ÿï¼ˆå¯ç©ºç™½è‡ªå‹•éå¢ï¼‰</label>
          <input id="newNo" placeholder="ä¾‹å¦‚ï¼š625" />
          <label>å§“å *</label>
          <input id="newName" placeholder="ç‹å°æ˜" />
          <label>LINE User ID *</label>
          <input id="newUid" placeholder="Uxxxxxxxxxxxxxxxxxxxx" />
          <button class="btn btn-ok" id="btnSaveNo">å„²å­˜</button>
          <div class="hint">å„²å­˜æˆåŠŸå¾ŒæœƒåŒæ­¥åˆ°å¾Œç«¯èˆ‡æœ¬æ©Ÿ</div>
        </div>
        <div class="card">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <div>å·²å„²å­˜</div>
            <button class="btn btn-ghost" id="btnReloadMeta">é‡æ–°è¼‰å…¥</button>
          </div>
          <div id="metaList" class="list" style="margin-top:10px"></div>
        </div>
      </div>
    </div>

    <!-- æ¨¡æ¿ç®¡ç† -->
    <div id="tab-templates" style="display:none">
      <div class="card">
        <label>æ–°å¢æ¨¡æ¿</label>
        <div class="row">
          <input id="newTpl" placeholder="å…§å®¹å¯å« {amount}" />
          <button class="btn btn-ok" id="btnCreateTpl">æ–°å¢</button>
        </div>
        <div id="tplAdmin" class="list" style="margin-top:12px"></div>
      </div>
    </div>

  </div>
</div>

<script>
/* ----------------- å…¨åŸŸç‹€æ…‹ ----------------- */
let savedCustomers = JSON.parse(localStorage.getItem('customerNumbers') || '{}'); // { no: {name,userId} }
let savedTemplates = JSON.parse(localStorage.getItem('messageTemplates') || '[]');
let allOrders = [];
const $ = sel => document.querySelector(sel);

/* ----------------- å·¥å…·ï¼šå®‰å…¨å– JSONï¼ˆé¿å… Unexpected token '<'ï¼‰ ----------------- */
async function safeJSON(res){
  const txt = await res.text();
  try { return JSON.parse(txt); } catch(e){
    return { success:false, error: txt?.slice(0,180) || 'é JSON å›æ‡‰' };
  }
}
/* API æ ¹ï¼šèˆ‡åŒç¶²åŸŸéƒ¨ç½²æœ€ä¿éšª */
const API = location.origin;

/* åŸºæœ¬ fetch helpers */
async function getJSON(url){ const r = await fetch(API+url); return safeJSON(r); }
async function postJSON(url, body){ const r = await fetch(API+url,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(body||{})}); return safeJSON(r); }
async function putJSON(url, body){ const r = await fetch(API+url,{method:'PUT',headers:{'Content-Type':'application/json'},body:JSON.stringify(body||{})}); return safeJSON(r); }
async function del(url){ const r = await fetch(API+url,{method:'DELETE'}); return safeJSON(r); }

/* ----------------- Tab åˆ‡æ› ----------------- */
document.querySelectorAll('.tab').forEach(b=>{
  b.addEventListener('click',()=>{
    document.querySelectorAll('.tab').forEach(x=>x.classList.remove('active'));
    b.classList.add('active');
    const key = b.dataset.tab;
    ['send','orders','customers','templates'].forEach(k=>$('#tab-'+k).style.display = (k===key)?'block':'none');
    if(key==='orders') loadOrders();
    if(key==='customers') renderMeta();
    if(key==='templates') renderTplAdmin();
  });
});

/* ----------------- ä»˜æ¬¾æ–¹å¼é¸æ“‡ ----------------- */
let payType='both';
document.querySelectorAll('#payGroup .payopt').forEach(el=>{
  el.addEventListener('click',()=>{
    document.querySelectorAll('#payGroup .payopt').forEach(x=>x.classList.remove('active'));
    el.classList.add('active');
    payType = el.dataset.v;
  });
});

/* ----------------- åˆå§‹è¼‰å…¥ï¼šæ¨¡æ¿ + å®¢æˆ¶Meta ----------------- */
async function init(){
  await fetchTemplates();
  await fetchCustomerMeta();
  loadTemplatesPanel();
  renderMeta();
  loadOrders();
}
document.addEventListener('DOMContentLoaded', init);

/* ----------------- æ¨¡æ¿ï¼šè®€/å¢/ä¿®/åˆª ----------------- */
async function fetchTemplates(){
  const d = await getJSON('/api/templates');
  if (d.success && Array.isArray(d.templates)){
    savedTemplates = d.templates;
    localStorage.setItem('messageTemplates', JSON.stringify(savedTemplates));
  } else if (savedTemplates.length===0){
    savedTemplates = ['æ‚¨å¥½ï¼Œé‡‘é¡ NT$ {amount}ï¼Œè«‹å„˜é€Ÿä»˜æ¬¾ï¼Œè¬è¬ï¼','è¡£ç‰©å·²å®Œæˆï¼Œè²»ç”¨ NT$ {amount}ï¼Œå¯ä¾†åº—å–ä»¶å–”ï¼'];
    localStorage.setItem('messageTemplates', JSON.stringify(savedTemplates));
  }
}
function loadTemplatesPanel(){
  const list = $('#tplList');
  list.innerHTML = savedTemplates.map((t,i)=>`<button class="tpl" onclick="$('#customMessage').value=\`${t.replace(/`/g,'\\`')}\`">${(t.length>36?t.slice(0,36)+'â€¦':t)}</button>`).join('') || '<div class="hint">å°šç„¡æ¨¡æ¿</div>';
}
function renderTplAdmin(){
  const wrap = $('#tplAdmin');
  wrap.innerHTML = savedTemplates.map((t,i)=>`
    <div class="item">
      <div style="flex:1;white-space:pre-wrap">${t}</div>
      <div class="row">
        <button class="btn btn-ghost" onclick="editTpl(${i})">ç·¨è¼¯</button>
        <button class="btn btn-danger" onclick="delTpl(${i})">åˆªé™¤</button>
      </div>
    </div>
  `).join('') || '<div class="hint">å°šç„¡æ¨¡æ¿</div>';
}
$('#btnCreateTpl').onclick = async ()=>{
  const c = $('#newTpl').value.trim(); if(!c) return alert('è«‹è¼¸å…¥å…§å®¹');
  const d = await postJSON('/api/templates', { content:c });
  if (d.success){ savedTemplates=d.templates; localStorage.setItem('messageTemplates', JSON.stringify(savedTemplates)); $('#newTpl').value=''; renderTplAdmin(); loadTemplatesPanel(); alert('âœ… å·²æ–°å¢æ¨¡æ¿');}
  else alert('âŒ å¤±æ•—ï¼š'+(d.error||'æœªçŸ¥éŒ¯èª¤'));
};
function editTpl(i){
  const nv = prompt('ä¿®æ”¹æ¨¡æ¿å…§å®¹ï¼š', savedTemplates[i]||''); if(nv===null) return;
  putJSON('/api/templates/'+i,{content:nv}).then(d=>{
    if(d.success){ savedTemplates=d.templates; localStorage.setItem('messageTemplates', JSON.stringify(savedTemplates)); renderTplAdmin(); loadTemplatesPanel(); }
    else alert('âŒ å¤±æ•—ï¼š'+(d.error||'æœªçŸ¥éŒ¯èª¤'));
  });
}
function delTpl(i){
  if(!confirm('ç¢ºå®šåˆªé™¤æ­¤æ¨¡æ¿ï¼Ÿ')) return;
  del('/api/templates/'+i).then(d=>{
    if(d.success){ savedTemplates=d.templates; localStorage.setItem('messageTemplates', JSON.stringify(savedTemplates)); renderTplAdmin(); loadTemplatesPanel(); }
    else alert('âŒ å¤±æ•—ï¼š'+(d.error||'æœªçŸ¥éŒ¯èª¤'));
  });
}
/* å¿«æ·æŒ‰éˆ•ï¼šè¼‰å…¥æ¨¡æ¿ */
$('#btnLoadTpl').onclick = loadTemplatesPanel;

/* ----------------- å®¢æˆ¶ç·¨è™Ÿï¼ˆMetaï¼‰ ----------------- */
async function fetchCustomerMeta(){
  const d = await getJSON('/api/customer-meta');
  if (d.success && d.map){
    savedCustomers = d.map;
    localStorage.setItem('customerNumbers', JSON.stringify(savedCustomers));
  }
  renderMeta();
}
function renderMeta(){
  const L = Object.entries(savedCustomers);
  $('#custCount').textContent = 'å…± '+L.length+' ç­†';
  /* å³å´ç°¡è¡¨ */
  $('#customerList').innerHTML = L.length? L.map(([no,c])=>`
    <div class="item">
      <div style="flex:1;cursor:pointer" onclick="fill('${c.name||''}','${c.userId||''}')">
        <b>#${no}</b>ã€€${c.name||'-'} <span class="pill">${(c.userId||'').slice(0,6)}â€¦</span>
      </div>
      <button class="btn btn-danger" onclick="removeNo('${no}')">åˆªé™¤</button>
    </div>
  `).join('') : '<div class="hint">å°šç„¡å®¢æˆ¶</div>';

  /* å®¢æˆ¶ç·¨è™Ÿé  tab */
  $('#metaList').innerHTML = L.length? L.map(([no,c])=>`
    <div class="item">
      <div style="flex:1">
        <div><b>#${no}</b>ã€€${c.name||'-'}</div>
        <div class="hint">${c.userId||'-'}</div>
      </div>
      <div class="row">
        <button class="btn btn-ghost" onclick="fill('${c.name||''}','${c.userId||''}'); document.querySelector('[data-tab=send]').click();">å¸¶å…¥</button>
        <button class="btn btn-danger" onclick="removeNo('${no}')">åˆªé™¤</button>
      </div>
    </div>
  `).join('') : '<div class="hint">å°šç„¡è³‡æ–™</div>';
}
function fill(name, uid){ $('#userName').value=name; $('#userId').value=uid; }
async function saveNo(){
  const number = $('#newNo').value.trim();
  const name = $('#newName').value.trim();
  const userId = $('#newUid').value.trim();
  if (!name || !userId) return alert('è«‹å®Œæ•´è¼¸å…¥ å§“å / User ID');
  const d = await postJSON('/api/customer-meta/save',{ number:number?Number(number):undefined, name, userId });
  if (d.success){
    savedCustomers[d.number]=d.data; localStorage.setItem('customerNumbers', JSON.stringify(savedCustomers));
    $('#newNo').value=''; $('#newName').value=''; $('#newUid').value='';
    renderMeta(); alert('âœ… å·²å„²å­˜');
  } else alert('âŒ å¤±æ•—ï¼š'+(d.error||'æœªçŸ¥éŒ¯èª¤'));
}
async function removeNo(no){
  if(!confirm(`åˆªé™¤ç·¨è™Ÿ #${no} ?`)) return;
  const d = await del('/api/customer-meta/'+no);
  if(d.success){ delete savedCustomers[no]; localStorage.setItem('customerNumbers', JSON.stringify(savedCustomers)); renderMeta(); }
  else alert('âŒ å¤±æ•—ï¼š'+(d.error||'æœªçŸ¥éŒ¯èª¤'));
}
$('#btnSaveNo').onclick = saveNo;
$('#btnReloadMeta').onclick = fetchCustomerMeta;
$('#btnReloadCustomers').onclick = fetchCustomerMeta;

/* å¿«é€ŸæŸ¥è©¢ */
$('#btnQuickSearch').onclick = ()=>{
  const q = $('#quickSearch').value.trim(); if(!q) return alert('è«‹è¼¸å…¥ç·¨è™Ÿæˆ–å§“å');
  if (savedCustomers[q]){ const c=savedCustomers[q]; fill(c.name||'', c.userId||''); return; }
  const found = Object.entries(savedCustomers).find(([no,c])=> (c.name||'').includes(q));
  if (found){ const [,c]=found; fill(c.name||'', c.userId||''); return; }
  alert('æ‰¾ä¸åˆ°æ­¤å®¢æˆ¶');
};

/* ----------------- ç™¼é€ä»˜æ¬¾é€£çµ ----------------- */
// æ³¨æ„ï¼šä½ çš„å¾Œç«¯æ˜¯ POST /send-paymentï¼ˆä¸æ˜¯ /api/send-paymentï¼‰
$('#btnSend').onclick = async ()=>{
  const userId = $('#userId').value.trim();
  const userName = $('#userName').value.trim();
  const amount = parseInt($('#amount').value,10);
  const customMessage = ($('#customMessage').value||'').trim().replace('{amount}', (amount||0).toLocaleString('zh-TW'));
  if(!userId || !userName || !amount){ return showResult(false,'è«‹æŠŠå¿…å¡«æ¬„ä½å¡«å¥½'); }
  $('#btnSend').disabled = true;
  const d = await postJSON('/send-payment',{ userId, userName, amount, paymentType: payType, customMessage });
  $('#btnSend').disabled = false;
  if (d && d.success){ showResult(true, `âœ… å·²ç™¼é€çµ¦ ${userName}ã€‚é‡‘é¡ NT$ ${amount.toLocaleString('zh-TW')}`); $('#customMessage').value=''; }
  else showResult(false, d?.error||'ç™¼é€å¤±æ•—');
};
function showResult(ok, msg){
  const el = $('#sendResult'); el.className='result '+(ok?'ok':'err'); el.innerHTML = msg; el.style.display='block'; el.scrollIntoView({behavior:'smooth',block:'center'});
}

/* ----------------- è¨‚å–®ç®¡ç† ----------------- */
async function loadOrders(){
  const d = await getJSON('/api/orders');
  if (!d.success){ $('#orderList').innerHTML='<div class="hint">è¼‰å…¥å¤±æ•—</div>'; return; }
  allOrders = d.orders||[];
  const s = d.statistics||{total:0,pending:0,paid:0,expired:0,needReminder:0};
  const statDom = $('#stats').querySelectorAll('.chip b');
  [s.total,s.pending,s.paid,s.expired,s.needReminder].forEach((v,i)=>statDom[i].textContent=v);

  $('#orderList').innerHTML = allOrders.length? allOrders.map(o=>{
    const status = o.status==='paid' ? 'âœ… å·²ä»˜æ¬¾' : (o.isExpired?'âŒ å·²éæœŸ':`â° å‰© ${o.remainingHours??'-'} å°æ™‚`);
    return `<div class="item">
      <div style="flex:1">
        <div><b>${o.userName||'-'}</b>ã€€<span class="pill">NT$ ${(o.amount||0).toLocaleString('zh-TW')}</span></div>
        <div class="hint">è¨‚å–® ${o.orderId||'-'}ï½œ${status}</div>
      </div>
      <div class="row">
        ${o.status==='paid'?'': (o.isExpired? `<button class="btn btn-ok" onclick="renew('${o.orderId}')">çºŒç´„é‡ç™¼</button>` : `<button class="btn btn-ghost" onclick="copyLink('${o.orderId}')">è¤‡è£½é€£çµ</button><button class="btn btn-ok" onclick="renew('${o.orderId}')">æé†’/çºŒç´„</button>`)}
        <button class="btn btn-danger" onclick="delOrder('${o.orderId}')">åˆªé™¤</button>
      </div>
    </div>`;
  }).join('') : '<div class="hint">å°šç„¡è¨‚å–®</div>';
}
async function renew(id){
  const d = await postJSON('/api/order/'+id+'/renew',{}); 
  if (d.success){ alert('âœ… å·²çºŒç´„ä¸¦é‡æ–°ç™¼é€'); loadOrders(); } else alert('âŒ å¤±æ•—ï¼š'+(d.error||'æœªçŸ¥éŒ¯èª¤'));
}
async function delOrder(id){
  if(!confirm('åˆªé™¤æ­¤è¨‚å–®ï¼Ÿ')) return;
  const d = await del('/api/order/'+id);
  if (d.success){ loadOrders(); } else alert('âŒ å¤±æ•—ï¼š'+(d.error||'æœªçŸ¥éŒ¯èª¤'));
}
function copyLink(id){
  const url = `${location.origin}/payment/linepay/pay/${id}`;
  navigator.clipboard.writeText(url).then(()=>alert('ğŸ“‹ å·²è¤‡è£½ LINE Pay å…¥å£'),()=>alert('è«‹æ‰‹å‹•è¤‡è£½ï¼š'+url));
}
$('#btnRefreshOrders').onclick = loadOrders;
$('#btnSendReminders').onclick = ()=>postJSON('/api/orders/send-reminders',{}).then(d=>{ alert(d.success? (d.message || `å·²ç™¼é€ ${d.sent||0} ç­†`): ('å¤±æ•—ï¼š'+(d.error||'æœªçŸ¥éŒ¯èª¤')) ); loadOrders(); });
$('#btnCleanExpired').onclick = ()=>postJSON('/api/orders/clean-expired',{}).then(d=>{ alert(d.message || 'å·²æ¸…ç†'); loadOrders(); });
</script>
</body>
</html>