<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
<title>C.H ç²¾ç·»æ´—è¡£ â€” ä»˜æ¬¾ç®¡ç†ç³»çµ±</title>
<style>
  :root{
    --bg1:#0b1020; --bg2:#1a1f36; --card:#10172b; --pri:#6ea8fe; --pri-2:#8b5cf6;
    --ok:#22c55e; --warn:#f59e0b; --bad:#ef4444; --txt:#e5e7eb; --mut:#9ca3af;
    --ring:rgba(110,168,254,.25)
  }
  *{box-sizing:border-box}
  html,body{margin:0;height:100%;font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Inter,Roboto,"Noto Sans TC","PingFang TC","Heiti TC",sans-serif;background:
    radial-gradient(1200px 800px at 20% -10%, #3b82f6 0%, transparent 60%),
    radial-gradient(1000px 700px at 120% 10%, #a855f7 0%, transparent 60%),
    linear-gradient(180deg, var(--bg1), var(--bg2));
    color:var(--txt)}
  .wrap{max-width:1100px;margin:24px auto;padding:16px}
  .app{background:rgba(255,255,255,.03);backdrop-filter:blur(6px);border:1px solid rgba(255,255,255,.08);
    border-radius:20px;display:grid;grid-template-columns:1fr 320px;gap:16px;padding:18px}
  header{grid-column:1/-1;display:flex;align-items:center;gap:12px;padding-bottom:8px;border-bottom:1px solid rgba(255,255,255,.08)}
  header .logo{width:34px;height:34px;border-radius:8px;background:#ffcc00;display:grid;place-items:center;color:#0b1020;font-weight:900}
  header h1{font-size:20px;margin:0}
  nav{display:flex;gap:12px;margin-top:10px}
  nav button{background:transparent;border:none;color:var(--mut);font-weight:600;padding:10px 14px;border-radius:10px;cursor:pointer}
  nav button.active{color:#fff;background:rgba(255,255,255,.06);outline:1px solid rgba(255,255,255,.08)}
  .grid{display:grid;gap:16px}
  .card{background:var(--card);border:1px solid rgba(255,255,255,.06);border-radius:14px;padding:14px}
  label{display:block;font-size:12px;color:var(--mut);margin:6px 2px}
  input,textarea,select{width:100%;background:rgba(255,255,255,.04);color:#fff;border:1.5px solid rgba(255,255,255,.08);
    border-radius:12px;padding:12px 14px;font-size:16px}
  input:focus,textarea:focus,select:focus{outline:none;border-color:var(--pri);box-shadow:0 0 0 4px var(--ring)}
  textarea{min-height:120px;resize:vertical}
  .row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  .pay-opts{display:grid;grid-template-columns:repeat(3,1fr);gap:12px}
  .opt{border-radius:16px;border:1.5px solid rgba(255,255,255,.08);padding:18px 12px;text-align:center;cursor:pointer;transition:.2s}
  .opt.active{border-color:var(--pri);box-shadow:0 8px 26px rgba(110,168,254,.15)}
  .opt .emo{font-size:26px;margin-bottom:6px}
  .btn{display:inline-flex;gap:10px;align-items:center;justify-content:center;background:linear-gradient(135deg,var(--pri),var(--pri-2));
    border:none;border-radius:12px;padding:14px 18px;color:#fff;font-weight:700;cursor:pointer}
  .btn:disabled{opacity:.6;cursor:not-allowed}
  .mut{color:var(--mut);font-size:12px}
  .result{margin-top:12px;border-radius:12px;padding:12px 14px;display:none}
  .result.ok{display:block;background:rgba(34,197,94,.15);border:1px solid rgba(34,197,94,.4)}
  .result.err{display:block;background:rgba(239,68,68,.15);border:1px solid rgba(239,68,68,.4)}
  /* å³å´ */
  .side h3{margin:4px 0 10px;font-size:14px;color:#cbd5e1}
  .list{display:flex;flex-direction:column;gap:10px;max-height:520px;overflow:auto}
  .item{display:flex;gap:10px;align-items:center;justify-content:space-between;background:rgba(255,255,255,.03);border:1px solid rgba(255,255,255,.06);border-radius:12px;padding:10px}
  .item .who{cursor:pointer}
  .tag{font-size:12px;background:rgba(255,255,255,.06);padding:4px 8px;border-radius:999px;color:#cbd5e1}
  .danger{background:linear-gradient(135deg,#ef4444,#dc2626)}
  .ghost{background:rgba(255,255,255,.06);color:#e5e7eb}
  .btn.sm{padding:8px 10px;border-radius:10px;font-weight:700}
  .pill{display:inline-block;background:rgba(59,130,246,.2);padding:2px 8px;border-radius:999px;font-size:12px;color:#cfe1ff}
  .stat{display:grid;grid-template-columns:repeat(5,1fr);gap:8px}
  .k{background:rgba(255,255,255,.04);border:1px solid rgba(255,255,255,.06);border-radius:12px;padding:10px;text-align:center}
  .k b{display:block;color:#fff;font-size:18px}
  .k span{color:var(--mut);font-size:12px}
  .searchRow{display:grid;grid-template-columns:1fr 90px;gap:8px}
  @media (max-width: 980px){
    .app{grid-template-columns:1fr}
    .side{order:2}
  }
</style>
</head>
<body>
<div class="wrap">
  <div class="app">
    <header>
      <div class="logo">æ´—</div>
      <div>
        <h1>ä»˜æ¬¾ç®¡ç†ç³»çµ±</h1>
        <nav>
          <button class="tab active" data-tab="send">ç™¼é€ä»˜æ¬¾</button>
          <button class="tab" data-tab="orders">è¨‚å–®ç®¡ç†</button>
          <button class="tab" data-tab="meta">å®¢æˆ¶ç·¨è™Ÿ</button>
          <button class="tab" data-tab="tpl">è¨Šæ¯æ¨¡æ¿</button>
        </nav>
      </div>
    </header>

    <!-- ä¸»å€ -->
    <div id="main" class="grid">
      <!-- ç™¼é€ä»˜æ¬¾ -->
      <section class="card tabpane" id="pane-send">
        <div class="searchRow">
          <div>
            <label>ğŸ” å¿«é€ŸæŸ¥è©¢ï¼ˆè¼¸å…¥ã€Œç·¨è™Ÿã€æˆ–ã€Œå§“åã€ï¼‰</label>
            <input id="quickSearch" placeholder="ä¾‹å¦‚ï¼š625 æˆ– ç‹å°æ˜" />
          </div>
          <button class="btn ghost" id="btnQuick">æŸ¥è©¢</button>
        </div>

        <div class="row" style="margin-top:10px">
          <div>
            <label>å®¢æˆ¶å§“å *</label>
            <input id="userName" placeholder="ç‹å°æ˜" />
          </div>
          <div>
            <label>å®¢æˆ¶ LINE User ID *</label>
            <input id="userId" placeholder="Uxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx" />
          </div>
        </div>

        <div class="row">
          <div>
            <label>é‡‘é¡ï¼ˆNT$ï¼‰ *</label>
            <input id="amount" type="number" min="1" placeholder="1500" />
          </div>
          <div>
            <label class="mut">ã€€</label>
            <div class="pay-opts" id="payOpts">
              <div class="opt active" data-v="both"><div class="emo">ğŸ’™</div>å…©è€…éƒ½ç™¼</div>
              <div class="opt" data-v="ecpay"><div class="emo">ğŸ’³</div>ç¶ ç•Œä¿¡ç”¨å¡</div>
              <div class="opt" data-v="linepay"><div class="emo">ğŸ’š</div>LINE Pay</div>
            </div>
          </div>
        </div>

        <div class="row">
          <div>
            <label>è¨Šæ¯å…§å®¹ï¼ˆå¯å« {amount}ï¼‰</label>
            <textarea id="customMessage" placeholder="ä¾‹å¦‚ï¼šæ‚¨å¥½ï¼Œé‡‘é¡ NT$ {amount}ï¼Œè«‹å„˜é€Ÿä»˜æ¬¾ï¼Œè¬è¬ï¼"></textarea>
            <div class="mut">é»é¸å³å´ã€Œå®¢æˆ¶è¼‰å…¥ã€å¯ç›´æ¥å¸¶å…¥å®¢æˆ¶ï¼›{amount} æœƒè‡ªå‹•æ›¿æ›é‡‘é¡ã€‚</div>
          </div>
          <div>
            <label class="mut">ã€€</label>
            <button class="btn" id="btnSend">ğŸ’™ ç™¼é€ä»˜æ¬¾é€£çµ</button>
            <div id="result" class="result"></div>
          </div>
        </div>
      </section>

      <!-- è¨‚å–®ç®¡ç†ï¼ˆç°¡ç‰ˆçµ±è¨ˆï¼Œç¶­æŒåŸå¾Œç«¯ APIï¼‰ -->
      <section class="card tabpane" id="pane-orders" hidden>
        <div class="row">
          <button class="btn ghost" id="btnReloadOrders">é‡æ–°æ•´ç†</button>
          <button class="btn ghost" id="btnRemind">ç™¼é€ä»˜æ¬¾æé†’</button>
          <button class="btn ghost" id="btnClean">æ¸…ç†éæœŸè¨‚å–®</button>
        </div>
        <div id="stats" class="stat" style="margin-top:10px"></div>
        <div id="ordersWrap" style="margin-top:10px"></div>
      </section>

      <!-- å®¢æˆ¶ç·¨è™Ÿ -->
      <section class="card tabpane" id="pane-meta" hidden>
        <div class="row">
          <div>
            <label>ç·¨è™Ÿï¼ˆå¯ç©ºç™½è‡ªå‹•éå¢ï¼‰</label>
            <input id="metaNo" placeholder="ä¾‹å¦‚ï¼š625" />
          </div>
          <div>
            <label>å§“å *</label>
            <input id="metaName" placeholder="ç‹å°æ˜" />
          </div>
        </div>
        <label>LINE User ID *</label>
        <input id="metaUid" placeholder="Uxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx" />
        <div style="margin-top:10px;display:flex;gap:10px">
          <button class="btn" id="btnSaveMeta">ğŸ’¾ å„²å­˜</button>
          <span class="mut">å„²å­˜æˆåŠŸå¾ŒæœƒåŒæ­¥åˆ°å¾Œç«¯èˆ‡æœ¬æ©Ÿ</span>
        </div>

        <div class="card" style="margin-top:14px">
          <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:8px">
            <h3>å·²å„²å­˜</h3>
            <button class="btn ghost sm" id="btnReloadMeta">é‡æ–°è¼‰å…¥</button>
          </div>
          <div id="metaList" class="list"></div>
        </div>
      </section>

      <!-- æ¨¡æ¿ -->
      <section class="card tabpane" id="pane-tpl" hidden>
        <label>æ–°å¢æ¨¡æ¿ï¼ˆä½¿ç”¨ {amount} ä»£è¡¨é‡‘é¡ï¼‰</label>
        <textarea id="tplNew" placeholder="ä¾‹å¦‚ï¼šæ‚¨å¥½ï¼Œé‡‘é¡ NT$ {amount}ï¼Œè¬è¬ï¼"></textarea>
        <div style="margin-top:10px"><button class="btn" id="btnSaveTpl">ğŸ’¾ å„²å­˜æ¨¡æ¿</button></div>

        <div class="card" style="margin-top:14px">
          <h3>æˆ‘çš„æ¨¡æ¿</h3>
          <div id="tplList" class="list"></div>
        </div>
      </section>
    </div>

    <!-- å´æ¬„ï¼šå®¢æˆ¶è¼‰å…¥ -->
    <aside class="side">
      <div class="card">
        <div style="display:flex;align-items:center;justify-content:space-between">
          <h3>ğŸ‘¥ å®¢æˆ¶è¼‰å…¥ <span id="sideCount" class="pill">0</span></h3>
          <button class="btn ghost sm" id="btnSideReload">é‡æ–°è¼‰å…¥</button>
        </div>
        <div class="mut">é»ä¸€ä¸‹å¸¶å…¥ã€Œå§“åï¼‹User IDã€ã€‚å³é‚Šå¯åˆªé™¤ã€‚</div>
        <div id="sideList" class="list" style="margin-top:10px"></div>
      </div>
      <div class="card">
        <h3>ğŸ“ å¸¸ç”¨æ¨¡æ¿</h3>
        <div id="quickTpls" class="list"></div>
      </div>
    </aside>
  </div>
</div>

<script>
/* ========= å…±ç”¨å·¥å…· ========= */
const API = location.origin;
async function getJSON(url){
  const r = await fetch(API + url, { headers:{'Accept':'application/json'}});
  const ct = r.headers.get('content-type')||'';
  if (!ct.includes('application/json')) {
    const t = await r.text();
    throw new Error(t || ('HTTP '+r.status));
  }
  const d = await r.json();
  if (r.ok) return d;
  throw new Error(d.error||'æœªçŸ¥éŒ¯èª¤');
}
async function postJSON(url, body){
  const r = await fetch(API + url, { method:'POST', headers:{'Content-Type':'application/json','Accept':'application/json'}, body: JSON.stringify(body||{})});
  const ct = r.headers.get('content-type')||'';
  if (!ct.includes('application/json')) { const t = await r.text(); throw new Error(t || ('HTTP '+r.status)); }
  const d = await r.json();
  if (r.ok) return d;
  throw new Error(d.error||'æœªçŸ¥éŒ¯èª¤');
}
async function putJSON(url, body){
  const r = await fetch(API + url, { method:'PUT', headers:{'Content-Type':'application/json','Accept':'application/json'}, body: JSON.stringify(body||{})});
  const ct = r.headers.get('content-type')||'';
  if (!ct.includes('application/json')) { const t = await r.text(); throw new Error(t || ('HTTP '+r.status)); }
  const d = await r.json();
  if (r.ok) return d;
  throw new Error(d.error||'æœªçŸ¥éŒ¯èª¤');
}
async function del(url){
  const r = await fetch(API + url, { method:'DELETE', headers:{'Accept':'application/json'}});
  const ct = r.headers.get('content-type')||'';
  if (!ct.includes('application/json')) { const t = await r.text(); throw new Error(t || ('HTTP '+r.status)); }
  const d = await r.json();
  if (r.ok) return d;
  throw new Error(d.error||'æœªçŸ¥éŒ¯èª¤');
}
function showMsg(ok, html){
  const el = document.getElementById('result');
  el.className='result ' + (ok?'ok':'err');
  el.innerHTML = html;
  el.style.display='block';
  el.scrollIntoView({behavior:'smooth',block:'center'});
}

/* ========= æ¨™ç±¤åˆ‡æ› ========= */
document.querySelectorAll('.tab').forEach(btn=>{
  btn.addEventListener('click',()=>{
    document.querySelectorAll('.tab').forEach(b=>b.classList.remove('active'));
    btn.classList.add('active');
    const tab = btn.dataset.tab;
    document.querySelectorAll('.tabpane').forEach(p=>p.hidden=true);
    document.getElementById('pane-'+tab).hidden=false;

    if(tab==='orders') reloadOrders();
    if(tab==='meta')   reloadMeta();
    if(tab==='tpl')    renderTplList();
  });
});

/* ========= ä»˜æ¬¾æ–¹å¼é¸æ“‡ ========= */
let paymentType='both';
document.getElementById('payOpts').addEventListener('click',e=>{
  const box = e.target.closest('.opt'); if(!box) return;
  document.querySelectorAll('.opt').forEach(o=>o.classList.remove('active'));
  box.classList.add('active');
  paymentType = box.dataset.v;
});

/* ========= å¿«é€ŸæŸ¥è©¢ï¼šæ­£ç¢ºå¸¶å…¥ï¼ˆå§“å -> #userNameã€UserID -> #userIdï¼‰ ========= */
async function quickSearch(){
  const q = document.getElementById('quickSearch').value.trim();
  if(!q){ alert('è«‹è¼¸å…¥ç·¨è™Ÿæˆ–å§“å'); return; }
  // å…ˆç”¨ /api/customer-metaï¼ˆæŒä¹…åŒ–åå–®ï¼‰
  try {
    const meta = await getJSON('/api/customer-meta'); // {success, nextNo, map}
    const map = meta.map || {};
    // 1) ç›´æ¥ä»¥ç·¨è™ŸæŸ¥
    if(map[q]){
      const c = map[q];
      document.getElementById('userName').value = c.name || '';
      document.getElementById('userId').value   = c.userId || '';
      return;
    }
    // 2) ä»¥å§“åæ¨¡ç³Š
    const hit = Object.entries(map).find(([no,c]) => (c.name||'').includes(q));
    if(hit){
      const c = hit[1];
      document.getElementById('userName').value = c.name || '';
      document.getElementById('userId').value   = c.userId || '';
      return;
    }
  }catch(_){}

  // å¾Œå‚™ï¼š/api/users
  try{
    const d = await getJSON('/api/users'); // {users:[{userId,name}]}
    const found = (d.users||[]).find(u=> (u.number===q) || (u.name||'').includes(q));
    if(found){
      document.getElementById('userName').value = found.name || '';
      document.getElementById('userId').value   = found.userId || '';
      return;
    }
  }catch(_){}
  alert('æ‰¾ä¸åˆ°æ­¤å®¢æˆ¶');
}
document.getElementById('btnQuick').addEventListener('click',quickSearch);

/* ========= ç™¼é€ä»˜æ¬¾ï¼ˆå›ºå®šå‘¼å« /send-paymentï¼‰ ========= */
document.getElementById('btnSend').addEventListener('click', async ()=>{
  const userId   = document.getElementById('userId').value.trim();
  const userName = document.getElementById('userName').value.trim();
  const amount   = parseInt(document.getElementById('amount').value,10);
  let customMessage = (document.getElementById('customMessage').value||'').trim();
  if(!userId || !userName || !amount || amount<=0){
    showMsg(false,'è«‹å®Œæ•´è¼¸å…¥ã€Œå§“åã€User IDã€é‡‘é¡ã€'); return;
  }
  customMessage = customMessage.replace('{amount}', amount.toLocaleString());
  const btn = document.getElementById('btnSend'); btn.disabled=true;

  try{
    const d = await postJSON('/send-payment',{ userId, userName, amount, paymentType, customMessage });
    const lab = paymentType==='both' ? 'ç¶ ç•Œä¿¡ç”¨å¡ï¼‹LINE Pay' : (paymentType==='ecpay'?'ç¶ ç•Œä¿¡ç”¨å¡':'LINE Pay');
    showMsg(true, `âœ… å·²ç™¼é€çµ¦ <b>${userName}</b><br>é‡‘é¡ï¼šNT$ ${amount.toLocaleString()}<br>æ–¹å¼ï¼š${lab}`);
    document.getElementById('customMessage').value='';
  }catch(e){
    showMsg(false,'âŒ ç™¼é€å¤±æ•—ï¼š<pre style="white-space:pre-wrap">'+(e.message||e)+'</pre>');
  }finally{ btn.disabled=false; }
});

/* ========= å´æ¬„ï¼šå®¢æˆ¶è¼‰å…¥ï¼ˆè®€ /api/customer-metaï¼‰ ========= */
async function loadSide(){
  const box = document.getElementById('sideList');
  box.innerHTML = '<div class="mut">è¼‰å…¥ä¸­â€¦</div>';
  try{
    const meta = await getJSON('/api/customer-meta');
    const entries = Object.entries(meta.map||{});
    document.getElementById('sideCount').innerText = entries.length;
    if(!entries.length){ box.innerHTML = '<div class="mut">å°šç„¡å®¢æˆ¶è³‡æ–™</div>'; return; }
    box.innerHTML = entries.map(([no,c])=>`
      <div class="item">
        <div class="who" onclick="window.prefill('${(c.userId||'').replace(/'/g,'\\\'')}', '${(c.name||'').replace(/'/g,'\\\'')}')">
          <div><b>${c.name||'-'}</b> <span class="tag">#${no}</span></div>
          <div class="mut" style="font-size:12px">${c.userId||'-'}</div>
        </div>
        <button class="btn danger sm" onclick="window.delMeta('${no}')">åˆªé™¤</button>
      </div>
    `).join('');
  }catch(e){
    box.innerHTML = '<div class="mut">è¼‰å…¥å¤±æ•—ï¼š'+(e.message||e)+'</div>';
  }
}
window.prefill = (uid, name)=>{
  document.getElementById('userId').value   = uid||'';
  document.getElementById('userName').value = name||'';
};
window.delMeta = async (no)=>{
  if(!confirm('åˆªé™¤ç·¨è™Ÿ #'+no+' ï¼Ÿ')) return;
  try{ await del('/api/customer-meta/'+encodeURIComponent(no)); loadSide(); reloadMeta(); }
  catch(e){ alert('åˆªé™¤å¤±æ•—ï¼š'+(e.message||e)); }
};
document.getElementById('btnSideReload').addEventListener('click',loadSide);

/* ========= å®¢æˆ¶ç·¨è™Ÿé ï¼ˆæ–°å¢/åˆ—è¡¨ï¼‰ ========= */
async function reloadMeta(){
  const list = document.getElementById('metaList');
  list.innerHTML = '<div class="mut">è¼‰å…¥ä¸­â€¦</div>';
  try{
    const d = await getJSON('/api/customer-meta');
    const entries = Object.entries(d.map||{});
    if(!entries.length){ list.innerHTML = '<div class="mut">å°šç„¡è³‡æ–™</div>'; return; }
    list.innerHTML = entries.map(([no,c])=>`
      <div class="item">
        <div>
          <div><b>#${no}</b>ã€€${c.name||'-'}</div>
          <div class="mut" style="font-size:12px">${c.userId||''}</div>
        </div>
        <div style="display:flex;gap:8px">
          <button class="btn ghost sm" onclick="window.prefill('${(c.userId||'').replace(/'/g,'\\\'')}','${(c.name||'').replace(/'/g,'\\\'')}')">å¸¶å…¥</button>
          <button class="btn danger sm" onclick="window.delMeta('${no}')">åˆªé™¤</button>
        </div>
      </div>
    `).join('');
  }catch(e){
    list.innerHTML = '<div class="mut">è¼‰å…¥å¤±æ•—ï¼š'+(e.message||e)+'</div>';
  }
}
document.getElementById('btnSaveMeta').addEventListener('click', async ()=>{
  const number = document.getElementById('metaNo').value.trim();
  const name   = document.getElementById('metaName').value.trim();
  const userId = document.getElementById('metaUid').value.trim();
  if(!name || !userId){ alert('è«‹è¼¸å…¥ã€Œå§“åã€LINE User IDã€'); return; }
  try{
    const payload = { name, userId };
    if(number) payload.number = Number(number);
    const d = await postJSON('/api/customer-meta/save', payload);
    alert('å·²å„²å­˜ï¼š#'+d.number+' '+(d.data?.name||'')); 
    document.getElementById('metaNo').value='';
    document.getElementById('metaName').value='';
    document.getElementById('metaUid').value='';
    reloadMeta(); loadSide();
  }catch(e){ alert('å„²å­˜å¤±æ•—ï¼š'+(e.message||e)); }
});
document.getElementById('btnReloadMeta').addEventListener('click', reloadMeta);

/* ========= æ¨¡æ¿ ========= */
let savedTemplates = JSON.parse(localStorage.getItem('messageTemplates') || '[]');
async function fetchTemplates(){
  try{
    const d = await getJSON('/api/templates');
    if(d.success && Array.isArray(d.templates)){
      savedTemplates = d.templates;
      localStorage.setItem('messageTemplates', JSON.stringify(savedTemplates));
    }
  }catch(_){}
}
function renderQuickTpls(){
  const box = document.getElementById('quickTpls');
  if(!savedTemplates.length){ box.innerHTML = '<div class="mut">å°šç„¡æ¨¡æ¿</div>'; return; }
  box.innerHTML = savedTemplates.map((t,i)=>`
    <button class="btn ghost sm" onclick="(function(){
      const el=document.getElementById('customMessage');
      el.value = ${JSON.stringify(t)}; 
    })()">${(t.length>14?t.slice(0,14)+'â€¦':t)}</button>
  `).join('');
}
function renderTplList(){
  const box = document.getElementById('tplList');
  if(!savedTemplates.length){ box.innerHTML = '<div class="mut">å°šç„¡æ¨¡æ¿</div>'; return; }
  box.innerHTML = savedTemplates.map((t,i)=>`
    <div class="item">
      <div style="white-space:pre-wrap">${t}</div>
      <div style="display:flex;gap:8px">
        <button class="btn ghost sm" onclick="window._editTpl(${i})">ç·¨è¼¯</button>
        <button class="btn danger sm" onclick="window._delTpl(${i})">åˆªé™¤</button>
      </div>
    </div>
  `).join('');
}
window._editTpl = async (i)=>{
  const nv = prompt('ä¿®æ”¹æ¨¡æ¿å…§å®¹ï¼š', savedTemplates[i]||''); if(nv===null) return;
  try{
    const d = await putJSON('/api/templates/'+i, { content:nv });
    savedTemplates = d.templates; localStorage.setItem('messageTemplates', JSON.stringify(savedTemplates));
    renderTplList(); renderQuickTpls();
  }catch(e){ alert('æ›´æ–°å¤±æ•—ï¼š'+(e.message||e)); }
};
window._delTpl = async (i)=>{
  if(!confirm('ç¢ºå®šåˆªé™¤é€™å€‹æ¨¡æ¿ï¼Ÿ')) return;
  try{
    const d = await del('/api/templates/'+i);
    savedTemplates = d.templates; localStorage.setItem('messageTemplates', JSON.stringify(savedTemplates));
    renderTplList(); renderQuickTpls();
  }catch(e){ alert('åˆªé™¤å¤±æ•—ï¼š'+(e.message||e)); }
};
document.getElementById('btnSaveTpl').addEventListener('click', async ()=>{
  const val = document.getElementById('tplNew').value.trim(); if(!val){ alert('è«‹è¼¸å…¥å…§å®¹'); return; }
  try{
    const d = await postJSON('/api/templates', { content: val });
    savedTemplates = d.templates; localStorage.setItem('messageTemplates', JSON.stringify(savedTemplates));
    document.getElementById('tplNew').value=''; renderTplList(); renderQuickTpls();
  }catch(e){ alert('å„²å­˜å¤±æ•—ï¼š'+(e.message||e)); }
});

/* ========= è¨‚å–®ï¼ˆæ²¿ç”¨ä½ çš„å¾Œç«¯ï¼‰ ========= */
async function reloadOrders(){
  const statsEl = document.getElementById('stats');
  const wrap = document.getElementById('ordersWrap');
  statsEl.innerHTML = ''; wrap.innerHTML = '<div class="mut">è¼‰å…¥ä¸­â€¦</div>';
  try{
    const d = await getJSON('/api/orders');
    const s = d.statistics || { total:0,pending:0,paid:0,expired:0,needReminder:0 };
    statsEl.innerHTML = `
      <div class="k"><b>${s.total}</b><span>ç¸½è¨‚å–®</span></div>
      <div class="k"><b>${s.pending}</b><span>å¾…ä»˜æ¬¾</span></div>
      <div class="k"><b>${s.paid}</b><span>å·²ä»˜æ¬¾</span></div>
      <div class="k"><b>${s.expired}</b><span>å·²éæœŸ</span></div>
      <div class="k"><b>${s.needReminder}</b><span>éœ€æé†’</span></div>`;
    if(!d.orders?.length){ wrap.innerHTML='<div class="mut">å°šç„¡è¨‚å–®</div>'; return; }
    wrap.innerHTML = d.orders.map(o=>`
      <div class="item">
        <div>
          <div><b>${o.userName||'-'}</b> <span class="tag">NT$ ${(o.amount||0).toLocaleString()}</span></div>
          <div class="mut" style="font-size:12px">#${o.orderId||'-'}ï½œç‹€æ…‹ï¼š${o.status}${o.isExpired?'ï½œå·²éæœŸ':''}</div>
        </div>
      </div>
    `).join('');
  }catch(e){ wrap.innerHTML = '<div class="mut">è¼‰å…¥å¤±æ•—ï¼š'+(e.message||e)+'</div>'; }
}
document.getElementById('btnReloadOrders').addEventListener('click',reloadOrders);
document.getElementById('btnRemind').addEventListener('click', async ()=>{
  try{ const d = await postJSON('/api/orders/send-reminders'); alert(d.message||('å·²ç™¼é€ '+(d.sent||0))); reloadOrders(); }
  catch(e){ alert('å¤±æ•—ï¼š'+(e.message||e)); }
});
document.getElementById('btnClean').addEventListener('click', async ()=>{
  try{ const d = await postJSON('/api/orders/clean-expired'); alert(d.message||'å·²æ¸…ç†'); reloadOrders(); }
  catch(e){ alert('å¤±æ•—ï¼š'+(e.message||e)); }
});

/* ========= å•Ÿå‹•æ™‚ ========= */
(async ()=>{
  try{ await fetchTemplates(); }catch(_){}
  renderQuickTpls(); renderTplList();
  await loadSide();
})();
</script>
</body>
</html>