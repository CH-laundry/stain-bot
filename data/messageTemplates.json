// ===== è¨Šæ¯æ¨¡æ¿ API =====
const TEMPLATES_FILE = path.join(__dirname, 'data', 'messageTemplates.json');

function ensureTemplatesFile() {
  const dataDir = path.join(__dirname, 'data');
  if (!fs.existsSync(dataDir)) fs.mkdirSync(dataDir, { recursive: true });
  if (!fs.existsSync(TEMPLATES_FILE)) {
    const defaults = [
      { id: 1, name: 'ä»˜æ¬¾æé†’', content: 'è¦ªæ„›çš„å®¢æˆ¶ï¼Œæ‚¨æœ‰ä¸€ç­†å¾…ä»˜æ¬¾è¨‚å–®ï¼Œè«‹ç›¡å¿«å®Œæˆä»˜æ¬¾ï¼Œæ„Ÿè¬æ‚¨ï¼' },
      { id: 2, name: 'è¡£ç‰©å·²é€é”', content: 'æ‚¨å¥½ï¼æ‚¨çš„è¡£ç‰©å·²é€é”é–€å¸‚ï¼Œæ­¡è¿Žå–ä»¶ã€‚ç‡Ÿæ¥­æ™‚é–“ï¼šé€±ä¸€è‡³é€±æ—¥ 09:00â€“21:00' },
      { id: 3, name: 'è¡£ç‰©æ¸…æ´—å®Œæˆ', content: 'æ‚¨çš„è¡£ç‰©å·²æ¸…æ´—å®Œæˆï¼è«‹æ–¼ä¸‰æ—¥å…§å–ä»¶ï¼Œè¬è¬ï¼' },
      { id: 4, name: 'ç¯€æ…¶å„ªæƒ ', content: 'ðŸŽ‰ é™æ™‚å„ªæƒ ï¼æœ¬é€±æ´—è¡£æœå‹™å…¨é¢ 8 æŠ˜ï¼æ­¡è¿Žé ç´„ï¼' },
      { id: 5, name: 'æ„Ÿè¬è¨Šæ¯', content: 'æ„Ÿè¬æ‚¨çš„æ”¯æŒï¼æœŸå¾…å†æ¬¡ç‚ºæ‚¨æœå‹™ â¤ï¸' }
    ];
    fs.writeFileSync(TEMPLATES_FILE, JSON.stringify(defaults, null, 2));
  }
}
ensureTemplatesFile();

app.get('/api/templates', (_req, res) => {
  try {
    const templates = JSON.parse(fs.readFileSync(TEMPLATES_FILE, 'utf8'));
    res.json({ success: true, templates });
  } catch (e) {
    res.status(500).json({ success: false, message: e.message });
  }
});

app.post('/api/template', (req, res) => {
  try {
    const { name, content } = req.body || {};
    if (!name || !content) return res.status(400).json({ success: false, message: 'è«‹æä¾› name èˆ‡ content' });
    const templates = JSON.parse(fs.readFileSync(TEMPLATES_FILE, 'utf8'));
    const tpl = { id: Date.now(), name, content, createdAt: Date.now() };
    templates.push(tpl);
    fs.writeFileSync(TEMPLATES_FILE, JSON.stringify(templates, null, 2));
    logger.logToFile(`âœ… æ–°å¢žæ¨¡æ¿: ${name}`);
    res.json({ success: true, template: tpl });
  } catch (e) {
    res.status(500).json({ success: false, message: e.message });
  }
});

app.put('/api/template/:id', (req, res) => {
  try {
    const id = parseInt(req.params.id, 10);
    const { name, content } = req.body || {};
    let templates = JSON.parse(fs.readFileSync(TEMPLATES_FILE, 'utf8'));
    const i = templates.findIndex(t => t.id === id);
    if (i === -1) return res.status(404).json({ success: false, message: 'æ¨¡æ¿ä¸å­˜åœ¨' });
    templates[i] = { ...templates[i], name: name ?? templates[i].name, content: content ?? templates[i].content, updatedAt: Date.now() };
    fs.writeFileSync(TEMPLATES_FILE, JSON.stringify(templates, null, 2));
    res.json({ success: true, template: templates[i] });
  } catch (e) {
    res.status(500).json({ success: false, message: e.message });
  }
});

app.delete('/api/template/:id', (req, res) => {
  try {
    const id = parseInt(req.params.id, 10);
    let templates = JSON.parse(fs.readFileSync(TEMPLATES_FILE, 'utf8'));
    const before = templates.length;
    templates = templates.filter(t => t.id !== id);
    fs.writeFileSync(TEMPLATES_FILE, JSON.stringify(templates, null, 2));
    logger.logToFile(`ðŸ—‘ï¸ åˆªé™¤æ¨¡æ¿: ${id}`);
    res.json({ success: true, deleted: before - templates.length });
  } catch (e) {
    res.status(500).json({ success: false, message: e.message });
  }
});

// ç™¼é€è‡ªè¨‚è¨Šæ¯ï¼ˆå¯ç”¨æ¨¡æ¿ + é™„åŠ æ–‡å­—ï¼‰
app.post('/api/send-message', async (req, res) => {
  try {
    const { userId, message, templateId, additionalText } = req.body || {};
    if (!userId) return res.status(400).json({ success: false, message: 'ç¼ºå°‘ userId' });

    let final = message?.trim() || '';
    if (templateId) {
      const templates = JSON.parse(fs.readFileSync(TEMPLATES_FILE, 'utf8'));
      const tpl = templates.find(t => t.id === Number(templateId));
      if (tpl) final = (tpl.content || '') + (additionalText ? '\n\n' + additionalText : '');
    }
    if (!final) return res.status(400).json({ success: false, message: 'æ²’æœ‰å¯ç™¼é€å…§å®¹' });

    await client.pushMessage(userId, { type: 'text', text: final });
    logger.logToFile(`ðŸ“¤ å·²ç™¼é€è‡ªè¨‚è¨Šæ¯çµ¦ ${userId}`);
    res.json({ success: true });
  } catch (e) {
    logger.logError('ç™¼é€è‡ªè¨‚è¨Šæ¯å¤±æ•—', e);
    res.status(500).json({ success: false, message: e.message });
  }
});

// ä»¥æ¨¡æ¿ç¾¤ç™¼ï¼ˆå‚³å¾…ä»˜æ¬¾æˆ–å…¨éƒ¨å¯è‡ªè¡Œæ“´å……æ¢ä»¶ï¼‰
app.post('/api/broadcast', async (req, res) => {
  try {
    const { templateId, additionalText, scope = 'all' } = req.body || {};
    const templates = JSON.parse(fs.readFileSync(TEMPLATES_FILE, 'utf8'));
    const tpl = templates.find(t => t.id === Number(templateId));
    if (!tpl) return res.status(400).json({ success: false, message: 'æ¨¡æ¿ä¸å­˜åœ¨' });

    const baseMsg = (tpl.content || '') + (additionalText ? '\n\n' + additionalText : '');
    const targets =
      scope === 'pending'
        ? [...new Set(orderManager.getPendingOrders().map(o => o.userId))]
        : customerDB.getAllCustomers().map(c => c.userId);

    let sent = 0;
    for (const uid of targets) {
      try {
        await client.pushMessage(uid, { type: 'text', text: baseMsg });
        sent++;
        await new Promise(r => setTimeout(r, 400));
      } catch (err) {
        logger.logError(`ç¾¤ç™¼å¤±æ•— ${uid}`, err);
      }
    }
    res.json({ success: true, sent, scope });
  } catch (e) {
    res.status(500).json({ success: false, message: e.message });
  }
});
