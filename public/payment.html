<!doctype html>
<html lang="zh-TW">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>C.H ç²¾ç·»æ´—è¡£ï½œä»˜æ¬¾ç®¡ç†ç³»çµ±</title>
<style>
  :root{
    --bg1:#0f172a; --bg2:#1e293b; --card:#111827; --pri:#60a5fa; --ok:#22c55e; --warn:#f59e0b; --err:#ef4444;
  }
  *{box-sizing:border-box} body{margin:0;font-family:-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;background:radial-gradient(80vw 80vh at 10% -10%,#1f2937,#0b1020);}
  .wrap{max-width:1180px;margin:24px auto;padding:16px}
  .title{display:flex;gap:10px;align-items:center;color:#fff;font-weight:800;font-size:28px;margin:6px 0 14px}
  .pane{display:grid;grid-template-columns:1fr 360px;gap:18px}
  .card{background:linear-gradient(180deg,#0b1222,#0a0f1c);border:1px solid #22304d;border-radius:16px;padding:16px;color:#dbeafe}
  .tabs{display:flex;gap:8px;border-bottom:1px solid #21304d;margin-bottom:12px}
  .tab{background:transparent;border:0;color:#9bb7ff;padding:10px 14px;border-bottom:3px solid transparent;cursor:pointer;font-weight:700}
  .tab.act{color:#fff;border-bottom-color:#60a5fa}
  .grid2{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  label{display:block;font-size:13px;color:#94a3b8;margin:12px 4px 6px}
  input,textarea{width:100%;padding:12px 14px;border-radius:10px;border:1px solid #263a66;background:#0d1530;color:#e5e7eb;font-size:16px}
  textarea{min-height:120px;resize:vertical}
  .radio3{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin-top:8px}
  .opt{padding:18px;border-radius:14px;border:2px solid #243558;background:#0b1222;cursor:pointer;text-align:center}
  .opt.sel{border-color:#60a5fa;box-shadow:0 0 0 3px rgba(96,165,250,.15)}
  .btn{padding:14px 18px;border:0;border-radius:12px;background:linear-gradient(135deg,#60a5fa,#7c3aed);color:#fff;font-weight:800;cursor:pointer}
  .btn.small{padding:8px 12px;border-radius:10px}
  .btn.green{background:linear-gradient(135deg,#22c55e,#16a34a)}
  .btn.red{background:linear-gradient(135deg,#ef4444,#b91c1c)}
  .row{display:flex;gap:10px;align-items:center}
  .side h4{margin:.2rem 0 10px;color:#9cc2ff}
  .list{display:flex;flex-direction:column;gap:10px;max-height:560px;overflow:auto}
  .item{padding:10px 12px;border:1px solid #243558;border-radius:12px;background:#0b1222;color:#dbeafe;display:flex;justify-content:space-between;gap:8px}
  .muted{color:#94a3b8;font-size:12px}
  .pill{padding:4px 8px;border-radius:9999px;font-size:12px;font-weight:700}
  .pill.ok{background:#052f18;color:#86efac;border:1px solid #14532d}
  .result{margin-top:12px;padding:12px;border-radius:10px;display:none}
  .result.ok{background:#052f18;border:1px solid #14532d;color:#86efac}
  .result.err{background:#3b0b10;border:1px solid #7f1d1d;color:#fecaca}
  @media (max-width:960px){ .pane{grid-template-columns:1fr} }
</style>
</head>
<body>
  <div class="wrap">
    <div class="title">ğŸ§¾ ä»˜æ¬¾ç®¡ç†ç³»çµ±</div>

    <div class="pane">
      <!-- å·¦ï¼šä¸»æ“ä½œ -->
      <div class="card">
        <div class="tabs">
          <button class="tab act" data-tab="send">ç™¼é€ä»˜æ¬¾</button>
          <button class="tab" data-tab="orders">è¨‚å–®ç®¡ç†</button>
          <button class="tab" data-tab="meta">å®¢æˆ¶ç·¨è™Ÿ</button>
          <button class="tab" data-tab="tpl">è¨Šæ¯æ¨¡æ¿</button>
        </div>

        <!-- ç™¼é€ä»˜æ¬¾ -->
        <section id="tab-send">
          <label>ğŸ” å¿«é€ŸæŸ¥è©¢ï¼ˆè¼¸å…¥ã€Œç·¨è™Ÿã€æˆ–ã€Œå§“åã€ï¼‰</label>
          <div class="row">
            <input id="q" placeholder="ä¾‹å¦‚ 625 æˆ– ç‹å°æ˜"/>
            <button class="btn small" id="btnQ">æŸ¥è©¢</button>
          </div>

          <div class="grid2">
            <div>
              <label>å®¢æˆ¶å§“å *</label>
              <input id="userName" placeholder="ç‹å°æ˜"/>
            </div>
            <div>
              <label>å®¢æˆ¶ LINE User ID *</label>
              <input id="userId" placeholder="Uxxxxxxxxxxxxxxxxxxxxxx"/>
            </div>
          </div>

          <label>é‡‘é¡ï¼ˆNT$ï¼‰ *</label>
          <input id="amount" type="number" min="1" placeholder="1500"/>

          <label>ä»˜æ¬¾æ–¹å¼ *</label>
          <div class="radio3" id="payType">
            <div class="opt sel" data-v="both">ğŸ’™ å…©è€…éƒ½ç™¼</div>
            <div class="opt" data-v="ecpay">ğŸ’³ ç¶ ç•Œä¿¡ç”¨å¡</div>
            <div class="opt" data-v="linepay">ğŸ’š LINE Pay</div>
          </div>

          <label>è¨Šæ¯å…§å®¹ï¼ˆå¯å« {amount}ï¼‰</label>
          <textarea id="msg" placeholder="ä¾‹å¦‚ï¼šæ‚¨å¥½ï¼Œé‡‘é¡ NT$ {amount}ï¼Œè¬è¬ï¼"></textarea>

          <div class="row" style="margin-top:12px;gap:12px">
            <button class="btn" id="btnSend">ç™¼é€ä»˜æ¬¾é€£çµ</button>
            <button class="btn green small" id="btnLoadTpl">è¼‰å…¥æ¨¡æ¿</button>
          </div>

          <div class="result" id="tip"></div>
        </section>

        <!-- è¨‚å–®ç®¡ç† -->
        <section id="tab-orders" style="display:none">
          <div class="row" style="gap:8px;margin:4px 0 10px">
            <button class="btn green small" id="btnReloadOrders">é‡æ–°æ•´ç†</button>
            <button class="btn green small" id="btnRemind">ç™¼é€ä»˜æ¬¾æé†’</button>
          </div>
          <div id="orderList" class="list"></div>
        </section>

        <!-- å®¢æˆ¶ç·¨è™Ÿ -->
        <section id="tab-meta" style="display:none">
          <div class="grid2">
            <div>
              <label>ç·¨è™Ÿï¼ˆå¯ç©ºç™½è‡ªå‹•éå¢ï¼‰</label>
              <input id="mNo" placeholder="ä¾‹å¦‚ 625"/>
            </div>
            <div>
              <label>å§“å *</label>
              <input id="mName" placeholder="ç‹å°æ˜"/>
            </div>
          </div>
          <label>LINE User ID *</label>
          <input id="mUid" placeholder="Uxxxxxxxxxxxxxxxxxxxx"/>

          <div class="row" style="margin-top:12px;gap:8px">
            <button class="btn green" id="btnSaveMeta">å„²å­˜</button>
          </div>

          <h4 style="margin-top:16px">å·²å„²å­˜</h4>
          <div id="savedMeta" class="list"></div>
          <div class="muted" id="metaNone">å°šç„¡è³‡æ–™</div>
        </section>

        <!-- æ¨¡æ¿ -->
        <section id="tab-tpl" style="display:none">
          <label>æ–°å¢æ¨¡æ¿</label>
          <textarea id="newTpl" placeholder="æ‚¨å¥½ï¼Œé‡‘é¡ NT$ {amount}ï¼Œè«‹å„˜é€Ÿä»˜æ¬¾ï¼Œè¬è¬ï¼"></textarea>
          <div class="row" style="margin-top:12px">
            <button class="btn green" id="btnSaveTpl">å„²å­˜æ¨¡æ¿</button>
          </div>
          <h4 style="margin-top:16px">æˆ‘çš„æ¨¡æ¿</h4>
          <div id="tplList" class="list"></div>
        </section>
      </div>

      <!-- å³ï¼šå®¢æˆ¶è¼‰å…¥ -->
      <aside class="card side">
        <div class="row" style="justify-content:space-between">
          <h4>ğŸ‘¥ å®¢æˆ¶è¼‰å…¥</h4>
          <button class="btn small green" id="btnReloadUsers">é‡æ–°è¼‰å…¥</button>
        </div>
        <div class="muted">é»ä¸€ä¸‹ã€Œå§“åã€å³å¯å¸¶å…¥åˆ°ç™¼é€å€ã€‚</div>
        <div id="userList" class="list"></div>
        <div class="muted" id="userNone">å°šç„¡å®¢æˆ¶</div>

        <h4 style="margin-top:16px">ğŸ“Œ å¸¸ç”¨æ¨¡æ¿</h4>
        <div id="quickTpls" class="list"></div>
      </aside>
    </div>
  </div>

<script>
const $ = (id)=>document.getElementById(id);
const API = (p)=>p; // åŒç¶²åŸŸ
let savedTemplates = [];
let meta = { nextNo:1, map:{} };
let allOrders = [];

// tabs
document.querySelectorAll('.tab').forEach(t=>{
  t.onclick = ()=>{
    document.querySelectorAll('.tab').forEach(x=>x.classList.remove('act'));
    t.classList.add('act');
    const k = t.dataset.tab;
    ['send','orders','meta','tpl'].forEach(s=>{
      $('tab-'+s).style.display = (s===k?'block':'none');
    });
    if (k==='orders') loadOrders();
    if (k==='tpl')    renderTpls();
    if (k==='meta')   renderMeta();
  };
});

// pay type
let payType = 'both';
document.querySelectorAll('#payType .opt').forEach(x=>{
  x.onclick = ()=>{
    document.querySelectorAll('#payType .opt').forEach(y=>y.classList.remove('sel'));
    x.classList.add('sel'); payType = x.dataset.v;
  };
});

// å¿«é€ŸæŸ¥è©¢
$('btnQ').onclick = ()=>{
  const q = $('q').value.trim();
  if (!q) return alert('è«‹è¼¸å…¥ç·¨è™Ÿæˆ–å§“å');
  // å…ˆç·¨è™Ÿ
  if (meta.map[q]) {
    const c = meta.map[q];
    $('userName').value = c.name||'';
    $('userId').value = c.userId||'';
    return;
  }
  // æ¨¡ç³Šå§“å
  const hit = Object.values(meta.map).find(v=> (v.name||'').includes(q));
  if (hit) {
    $('userName').value = hit.name||'';
    $('userId').value = hit.userId||'';
  } else alert('æ‰¾ä¸åˆ°');
};

// ç™¼é€
$('btnSend').onclick = async ()=>{
  const userId = $('userId').value.trim();
  const userName = $('userName').value.trim();
  const amount = parseInt($('amount').value,10);
  const customMessage = ($('msg').value||'').replace('{amount}', (amount||0).toLocaleString());
  if (!userId || !userName || !amount) return tip('err','è«‹æŠŠå§“åã€UserIDã€é‡‘é¡å¡«å¥½');

  try{
    $('btnSend').disabled = true;
    const r = await fetch(API('/api/send-payment'),{
      method:'POST', headers:{'Content-Type':'application/json'},
      body: JSON.stringify({ userId, userName, amount, paymentType:payType, customMessage })
    });
    const d = await r.json();
    if (!d.success) throw new Error(d.error||'ç™¼é€å¤±æ•—');
    tip('ok','âœ… å·²ç™¼é€ä»˜æ¬¾é€£çµ'); $('msg').value='';
  }catch(e){ tip('err','âŒ '+e.message); }
  finally{ $('btnSend').disabled = false; }
};

function tip(type, msg){
  const el = $('tip');
  el.className = 'result '+(type==='ok'?'ok':'err');
  el.textContent = msg; el.style.display='block';
  el.scrollIntoView({behavior:'smooth',block:'center'});
}

// æ¨¡æ¿
$('btnLoadTpl').onclick = ()=> renderQuickTpls();
$('btnSaveTpl').onclick = async ()=>{
  const t = $('newTpl').value.trim(); if (!t) return alert('è«‹è¼¸å…¥å…§å®¹');
  const r = await fetch(API('/api/templates'),{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({content:t})});
  const d = await r.json(); if (!d.success) return alert(d.error||'å¤±æ•—');
  savedTemplates = d.templates; $('newTpl').value=''; renderTpls(); renderQuickTpls();
};

async function fetchTpls(){
  const r = await fetch(API('/api/templates')); const d = await r.json();
  if (d.success) savedTemplates = d.templates;
}
function renderTpls(){
  const box = $('tplList');
  if (!savedTemplates.length) { box.innerHTML = '<div class="muted">å°šç„¡æ¨¡æ¿</div>'; return; }
  box.innerHTML = savedTemplates.map((t,i)=>`
    <div class="item">
      <div style="white-space:pre-wrap">${t}</div>
      <div class="row">
        <button class="btn small green" onclick="editTpl(${i})">ç·¨è¼¯</button>
        <button class="btn small red" onclick="delTpl(${i})">åˆªé™¤</button>
      </div>
    </div>`).join('');
}
function renderQuickTpls(){
  const box = $('quickTpls');
  if (!savedTemplates.length){ box.innerHTML='<div class="muted">å°šç„¡æ¨¡æ¿</div>'; return; }
  box.innerHTML = savedTemplates.map((t)=>`
    <div class="item" style="cursor:pointer" onclick="setMsg(${JSON.stringify(t).replace(/"/g,'&quot;')})">
      <div>ğŸ“ ${t.length>38?t.slice(0,38)+'â€¦':t}</div>
    </div>`).join('');
}
function setMsg(t){ $('msg').value = t; }

async function editTpl(i){
  const nv = prompt('ä¿®æ”¹æ¨¡æ¿å…§å®¹ï¼š', savedTemplates[i]||''); if (nv===null) return;
  const r = await fetch(API('/api/templates/'+i),{method:'PUT',headers:{'Content-Type':'application/json'},body:JSON.stringify({content:nv})});
  const d = await r.json(); if (!d.success) return alert(d.error||'å¤±æ•—');
  savedTemplates = d.templates; renderTpls(); renderQuickTpls();
}
async function delTpl(i){
  if(!confirm('ç¢ºå®šåˆªé™¤æ­¤æ¨¡æ¿ï¼Ÿ')) return;
  const r = await fetch(API('/api/templates/'+i),{method:'DELETE'});
  const d = await r.json(); if (!d.success) return alert(d.error||'å¤±æ•—');
  savedTemplates = d.templates; renderTpls(); renderQuickTpls();
}

// å®¢æˆ¶ç·¨è™Ÿ
$('btnSaveMeta').onclick = async ()=>{
  const number = $('mNo').value.trim();
  const name = $('mName').value.trim();
  const userId = $('mUid').value.trim();
  if (!name || !userId) return alert('è«‹è¼¸å…¥ å§“å èˆ‡ LINE User ID');
  const r = await fetch(API('/api/customer-meta/save'),{
    method:'POST', headers:{'Content-Type':'application/json'},
    body: JSON.stringify({ number: number?Number(number):undefined, name, userId })
  });
  const d = await r.json(); if (!d.success) return alert('å„²å­˜å¤±æ•—ï¼š'+(d.error||''));
  await fetchMeta(); renderMeta();
  $('mNo').value=''; $('mName').value=''; $('mUid').value='';
};

async function fetchMeta(){
  const r = await fetch(API('/api/customer-meta')); const d = await r.json();
  if (d.success) meta = { nextNo:d.nextNo, map:d.map||{} };
}
function renderMeta(){
  const keys = Object.keys(meta.map||{});
  const box = $('savedMeta');
  $('metaNone').style.display = keys.length? 'none':'block';
  if (!keys.length) { box.innerHTML=''; return; }
  box.innerHTML = keys.sort((a,b)=>a-b).map(no=>{
    const c = meta.map[no];
    return `<div class="item">
      <div style="cursor:pointer" onclick="prefill('${c.userId}','${c.name}')">
        <div>#${no}ã€€${c.name}</div>
        <div class="muted">User IDï¼š${c.userId}</div>
      </div>
      <button class="btn small red" onclick="delMeta('${no}')">åˆªé™¤</button>
    </div>`;
  }).join('');
}
async function delMeta(no){
  if(!confirm(`åˆªé™¤ç·¨è™Ÿ #${no} ï¼Ÿ`)) return;
  const r = await fetch(API('/api/customer-meta/'+no),{method:'DELETE'});
  const d = await r.json(); if (!d.success) return alert(d.error||'åˆªé™¤å¤±æ•—');
  await fetchMeta(); renderMeta();
}
function prefill(uid,name){
  $('userId').value = uid||''; $('userName').value=name||'';
  document.querySelector('.tab[data-tab="send"]').click();
}

// å³å´è¼‰å…¥å®¢æˆ¶
$('btnReloadUsers').onclick = loadUsers;
async function loadUsers(){
  const r = await fetch(API('/api/users')); const d = await r.json();
  const box = $('userList');
  if (!d.success || !d.users?.length){ box.innerHTML=''; $('userNone').style.display='block'; return; }
  $('userNone').style.display='none';
  box.innerHTML = d.users.map(u=>`
    <div class="item">
      <div style="cursor:pointer" onclick="prefill('${u.userId}','${u.name}')">
        <div>${u.name||'-'}</div>
        <div class="muted">User IDï¼š${u.userId||'-'}${u.number? 'ï½œç·¨è™Ÿï¼š'+u.number:''}</div>
      </div>
      <button class="btn small green" onclick="prefill('${u.userId}','${u.name}')">å¸¶å…¥</button>
    </div>`).join('');
}

// è¨‚å–®
$('btnReloadOrders').onclick = loadOrders;
$('btnRemind').onclick = async ()=>{
  const r = await fetch(API('/api/orders/send-reminders'),{method:'POST'});
  const d = await r.json(); alert(d.success? d.message : d.error||'å¤±æ•—');
};
async function loadOrders(){
  const r = await fetch(API('/api/orders')); const d = await r.json();
  const box = $('orderList');
  if (!d.success){ box.innerHTML='<div class="muted">è¼‰å…¥å¤±æ•—</div>'; return; }
  allOrders = d.orders||[];
  if (!allOrders.length){ box.innerHTML='<div class="muted">å°šç„¡è¨‚å–®</div>'; return; }
  box.innerHTML = allOrders.map(o=>{
    const badge = o.status==='paid'
      ? '<span class="pill ok">å·²ä»˜æ¬¾</span>'
      : (o.isExpired? '<span class="pill" style="background:#2b0d10;color:#fecaca;border:1px solid #7f1d1d">å·²éæœŸ</span>'
                    : `<span class="pill" style="background:#221805;color:#fde68a;border:1px solid #92400e">å‰©é¤˜ ${o.remainingHours} å°æ™‚</span>`);
    return `<div class="item">
      <div>
        <div style="font-weight:700">${o.userName}ã€€${badge}</div>
        <div class="muted">#${o.orderId}ï½œNT$ ${(o.amount||0).toLocaleString()}</div>
      </div>
      <div class="row">
        ${o.status==='paid'?'':`<button class="btn small green" onclick="renew('${o.orderId}')">çºŒç´„é‡ç™¼</button>`}
      </div>
    </div>`;
  }).join('');
}
async function renew(id){
  const r = await fetch(API('/api/order/'+id+'/renew'),{method:'POST'});
  const d = await r.json(); alert(d.success? d.message : d.error||'å¤±æ•—'); loadOrders();
}

// åˆå§‹åŒ–
(async function init(){
  await Promise.all([fetchTpls(), fetchMeta(), loadUsers()]);
  renderTpls(); renderQuickTpls(); renderMeta();
})();
</script>
</body>
</html>