<!doctype html>
<html lang="zh-TW">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>C.H 精緻洗衣 - 付款管理系統</title>
<style>
  body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;background:linear-gradient(135deg,#667eea,#764ba2);min-height:100vh;margin:0;padding:20px}
  .container{max-width:900px;margin:0 auto;background:#111827;color:#e5e7eb;border-radius:18px;padding:24px;box-shadow:0 24px 60px rgba(0,0,0,.4)}
  .tabs{display:flex;gap:16px;border-bottom:1px solid #374151;flex-wrap:wrap}
  .tab{padding:10px 14px;border:0;background:transparent;color:#9ca3af;font-weight:600;cursor:pointer;border-bottom:3px solid transparent}
  .tab.active{color:#60a5fa;border-bottom-color:#60a5fa}
  .tab-content{display:none;padding-top:18px}
  .tab-content.active{display:block}
  label{display:block;margin:10px 0 6px}
  input,textarea,select{width:100%;background:#111827;color:#e5e7eb;border:1px solid #374151;border-radius:10px;padding:12px}
  textarea{min-height:120px}
  .btn{display:inline-block;background:#2563eb;color:#fff;border:0;border-radius:10px;padding:12px 16px;font-weight:700;cursor:pointer}
  .btn:disabled{opacity:.6;cursor:not-allowed}
  .btn.secondary{background:#16a34a}
  .btn.gray{background:#6b7280}
  .btn.danger{background:#dc2626}
  .grid{display:grid;gap:12px}
  .grid.cols-2{grid-template-columns:repeat(2,1fr)}
  .grid.cols-3{grid-template-columns:repeat(3,1fr)}
  .card{background:#0b1220;border:1px solid #1f2937;border-radius:12px;padding:12px}
  .status{margin-top:12px;display:none;border:1px solid #374151;border-radius:10px;padding:12px}
  .status.ok{display:block;border-color:#14532d;background:#052e1a}
  .status.err{display:block;border-color:#7f1d1d;background:#2a0e0e}
  .pill{padding:4px 8px;border-radius:999px;font-size:12px}
  .pill.warn{background:#92400e;color:#fff}
  .pill.ok{background:#065f46;color:#fff}
  .pill.bad{background:#7f1d1d;color:#fff}
  .pay-options{display:grid;grid-template-columns:repeat(3,1fr);gap:12px}
  .pay-tile{border:1px solid #374151;border-radius:12px;padding:14px;text-align:center;cursor:pointer;user-select:none}
  .pay-tile .icon{font-size:26px;margin-bottom:6px}
  .pay-tile.active{border-color:#60a5fa;background:#0f172a;box-shadow:0 0 0 2px rgba(96,165,250,.4) inset}
  @media (max-width:768px){ .grid.cols-3{grid-template-columns:1fr} .grid.cols-2{grid-template-columns:1fr} .pay-options{grid-template-columns:1fr} }
</style>
</head>
<body>
  <div class="container">
    <h2 style="margin:0 0 6px">💳 付款管理系統</h2>
    <div class="tabs">
      <button class="tab active" data-tab="payment">發送付款</button>
      <button class="tab" data-tab="orders">訂單管理</button>
      <button class="tab" data-tab="customers">客戶編號</button>
      <button class="tab" data-tab="templates">訊息模板</button>
    </div>

    <!-- 發送付款 -->
    <section id="payment" class="tab-content active">
      <div class="card">
        <label>🔎 快速查詢（輸入「編號」或「姓名」）</label>
        <div class="grid cols-2">
          <input id="quickInput" placeholder="例如：755 或 王小明"/>
          <button class="btn gray" id="btnQuick">查詢</button>
        </div>
      </div>

      <label>客戶姓名 *</label>
      <input id="userName" placeholder="王小明"/>

      <label>客戶 LINE User ID *</label>
      <input id="userId" placeholder="Uxxxxxxxxxxxxxxxxxxxx"/>

      <label>金額 (NT$) *</label>
      <input id="amount" type="number" min="1" placeholder="1500"/>

      <label>付款方式 *</label>
      <div class="pay-options" id="payOptions">
        <div class="pay-tile active" data-val="both"><div class="icon">💙</div><div>兩者都發</div></div>
        <div class="pay-tile" data-val="ecpay"><div class="icon">💳</div><div>綠界信用卡</div></div>
        <div class="pay-tile" data-val="linepay"><div class="icon">💚</div><div>LINE Pay</div></div>
      </div>

      <label>訊息內容（可含 {amount}）</label>
      <textarea id="customMessage" placeholder="例如：您好，金額 NT$ {amount}，謝謝！"></textarea>

      <div style="margin-top:14px">
        <button class="btn" id="sendBtn">發送付款連結</button>
      </div>

      <div id="status" class="status"></div>
    </section>

    <!-- 訂單管理 -->
    <section id="orders" class="tab-content">
      <div style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:10px">
        <button class="btn secondary" id="btnReload">重新整理</button>
        <button class="btn secondary" id="btnRemind">發送付款提醒</button>
        <button class="btn secondary" id="btnClean">清理過期訂單</button>
      </div>
      <div id="orderStats" class="grid cols-3"></div>
      <div id="orderList" style="margin-top:12px"></div>
    </section>

    <!-- 客戶編號 -->
    <section id="customers" class="tab-content">
      <div class="grid cols-3">
        <div>
          <label>編號</label><input id="newCustomerNumber" placeholder="例如：755"/>
        </div>
        <div>
          <label>姓名</label><input id="newCustomerName" placeholder="例如：王小明"/>
        </div>
        <div>
          <label>User ID</label><input id="newCustomerUserId" placeholder="Uxxxxxxxx"/>
        </div>
      </div>
      <div style="margin:12px 0"><button class="btn secondary" id="btnSaveCustomer">儲存</button></div>
      <div id="savedCustomers"></div>
    </section>

    <!-- 模板 -->
    <section id="templates" class="tab-content">
      <label>新增模板（{amount} 代表金額）</label>
      <textarea id="newTemplateContent"></textarea>
      <div style="margin-top:10px"><button class="btn secondary" id="btnSaveTpl">儲存模板</button></div>
      <div id="templateList" style="margin-top:12px"></div>
    </section>
  </div>

<script>
  const API_BASE = location.origin;          // 確保永遠打到同網域（手機/電腦一致）
  const $ = s => document.querySelector(s);
  const $$ = s => Array.from(document.querySelectorAll(s));
  const ok = (html)=>showStatus(html,true);
  const err= (html)=>showStatus(html,false);
  function showStatus(html, isOk){
    const el = $('#status');
    el.className = 'status ' + (isOk ? 'ok' : 'err');
    el.innerHTML = html;
    el.style.display = 'block';
  }
  async function getJSON(url){ const r = await fetch(API_BASE+url, { credentials:'same-origin' }); return r.json(); }
  async function postJSON(url, body){
    const r = await fetch(API_BASE+url, { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(body||{}) });
    const txt = await r.text();            // 先讀文字，防止不是 JSON 時直接爆掉
    try { return JSON.parse(txt); } 
    catch { throw new Error(txt || `HTTP ${r.status}`); }
  }

  // ====== tabs ======
  $$('.tab').forEach(b=>{
    b.addEventListener('click', ()=>{
      $$('.tab').forEach(t=>t.classList.remove('active'));
      $$('.tab-content').forEach(p=>p.classList.remove('active'));
      b.classList.add('active'); document.getElementById(b.dataset.tab).classList.add('active');
      if (b.dataset.tab==='orders') loadOrders();
      if (b.dataset.tab==='customers') renderCustomers();
      if (b.dataset.tab==='templates') renderTemplates();
    });
  });

  // ====== 付款方式圖塊 ======
  let paymentType = 'both';
  $$('#payOptions .pay-tile').forEach(tile=>{
    tile.addEventListener('click', ()=>{
      $$('#payOptions .pay-tile').forEach(t=>t.classList.remove('active'));
      tile.classList.add('active'); paymentType = tile.dataset.val;
    });
  });

  // ====== 快速查詢：編號 / 姓名 ======
  let savedCustomers = {};
  async function syncCustomers(){
    try{
      const d = await getJSON('/api/customer-meta');
      if (d.success && d.map){ savedCustomers = d.map; localStorage.setItem('customerNumbers', JSON.stringify(savedCustomers)); }
      else { savedCustomers = JSON.parse(localStorage.getItem('customerNumbers')||'{}'); }
    }catch{ savedCustomers = JSON.parse(localStorage.getItem('customerNumbers')||'{}'); }
  }
  $('#btnQuick').addEventListener('click', ()=>{
    const q = $('#quickInput').value.trim();
    if (!q){ err('請輸入編號或姓名'); return; }
    // 1) 先用編號查
    if (savedCustomers[q]){
      const c = savedCustomers[q];
      $('#userName').value = c.name || '';
      $('#userId').value   = c.userId || '';
      ok(`✅ 已帶入：#${q} ${c.name}`);
      return;
    }
    // 2) 再用姓名模糊查
    const found = Object.entries(savedCustomers).find(([no,c])=> (c.name||'').includes(q));
    if (found){
      const [no, c] = found;
      $('#userName').value = c.name || '';
      $('#userId').value   = c.userId || '';
      ok(`✅ 已帶入：#${no} ${c.name}`);
    }else{
      err('找不到此客戶');
    }
  });

  // ====== 發送付款（重點：手機錯誤改良） ======
  $('#sendBtn').addEventListener('click', async ()=>{
    const userId   = $('#userId').value.trim();
    const userName = $('#userName').value.trim();
    const amount   = parseInt($('#amount').value,10);
    const customMessage = ($('#customMessage').value||'').replace('{amount}', (amount||0).toLocaleString());

    if (!userId || !userName || !amount) return err('請完整填寫「姓名 / User ID / 金額」');

    $('#sendBtn').disabled = true;
    try{
      const data = await postJSON('/send-payment', { userId, userName, amount, paymentType, customMessage });
      if (data.success){
        ok(`✅ 已發送。客戶：${userName}｜金額：NT$ ${amount.toLocaleString()}`);
        $('#userId').value = $('#userName').value = $('#amount').value = $('#customMessage').value = '';
      }else{
        err('發送失敗：' + (data.error || '未知錯誤'));
      }
    }catch(e){
      // 這裡會把非 JSON 的 HTML/錯誤頁片段也顯示出來，便於你看問題
      err('連線失敗：' + String(e.message).slice(0,300));
    }finally{
      $('#sendBtn').disabled = false;
    }
  });

  // ====== 訂單管理（精簡） ======
  async function loadOrders(){
    const wrap = $('#orderList'); wrap.innerHTML = '<div class="card">載入中...</div>';
    try{
      const d = await getJSON('/api/orders');
      const arr = d.success ? d.orders : [];
      if (!arr.length){ wrap.innerHTML = '<div class="card">尚無訂單記錄</div>'; return; }
      wrap.innerHTML = arr.map(o=>`
        <div class="card">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <div><b>${o.userName||'-'}</b>　NT$ ${(o.amount||0).toLocaleString()}</div>
            <div>${o.status==='paid' ? '<span class="pill ok">已付款</span>' : (o.isExpired ? '<span class="pill bad">已過期</span>' : '<span class="pill warn">待付款</span>')}</div>
          </div>
          <div style="font-size:12px;opacity:.8;margin-top:6px">#${o.orderId}</div>
          <div style="margin-top:8px;display:flex;gap:8px;flex-wrap:wrap">
            <button class="btn secondary" onclick="renewOrder('${o.orderId}')">續期重發</button>
            <button class="btn danger" onclick="deleteOrder('${o.orderId}')">刪除</button>
          </div>
        </div>
      `).join('');
    }catch(e){ wrap.innerHTML = '<div class="card">載入失敗：'+e.message+'</div>'; }
  }
  async function renewOrder(id){
    try{ const d = await postJSON(`/api/order/${id}/renew`); if (d.success) ok('✅ 已續期並重新發送'); else err('續期失敗：'+(d.error||'')); }
    catch(e){ err('續期錯誤：'+e.message); }
  }
  async function deleteOrder(id){
    if (!confirm('刪除此訂單？')) return;
    try{
      const d = await fetch(API_BASE+`/api/order/${id}`, { method:'DELETE' }).then(r=>r.json());
      if (d.success){ ok('🗑️ 已刪除'); loadOrders(); } else err('刪除失敗');
    }catch(e){ err('刪除錯誤：'+e.message); }
  }
  $('#btnReload').onclick = loadOrders;
  $('#btnRemind').onclick = ()=> postJSON('/api/orders/send-reminders').then(d=>ok(d.message)).catch(e=>err(e.message));
  $('#btnClean').onclick  = ()=> postJSON('/api/orders/clean-expired').then(d=>ok(d.message)).catch(e=>err(e.message));

  // ====== 客戶編號 ======
  function renderCustomers(){
    const wrap = $('#savedCustomers');
    const list = Object.entries(savedCustomers||{});
    if (!list.length){ wrap.innerHTML='<div class="card">尚無資料</div>'; return; }
    wrap.innerHTML = list.map(([no,c])=>`
      <div class="card" style="display:flex;justify-content:space-between;align-items:center">
        <div><b>#${no}</b>　${c.name}　<span style="opacity:.7">(${c.userId})</span></div>
        <button class="btn" onclick="prefill('${c.userId}','${c.name}')">帶入</button>
      </div>
    `).join('');
  }
  window.prefill = (uid,name)=>{ $('#userId').value=uid; $('#userName').value=name; document.querySelector('.tab[data-tab="payment"]').click(); };
  $('#btnSaveCustomer').onclick = async ()=>{
    const number = $('#newCustomerNumber').value.trim();
    const name   = $('#newCustomerName').value.trim();
    const userId = $('#newCustomerUserId').value.trim();
    if (!name || !userId) return err('請輸入 姓名 / User ID');
    try{
      const d = await postJSON('/api/customer-meta/save', { number:number?Number(number):undefined, name, userId });
      if (d.success){ savedCustomers[d.number]=d.data; localStorage.setItem('customerNumbers', JSON.stringify(savedCustomers)); $('#newCustomerNumber').value=$('#newCustomerName').value=$('#newCustomerUserId').value=''; renderCustomers(); ok('✅ 已儲存'); }
      else err('儲存失敗：'+(d.error||''));
    }catch(e){ err('儲存錯誤：'+e.message); }
  };

  // ====== 模板 ======
  let savedTemplates = [];
  async function syncTemplates(){
    try{
      const d = await getJSON('/api/templates');
      if (d.success && Array.isArray(d.templates)){ savedTemplates=d.templates; localStorage.setItem('messageTemplates', JSON.stringify(savedTemplates)); }
      else { savedTemplates = JSON.parse(localStorage.getItem('messageTemplates')||'[]'); }
    }catch{ savedTemplates = JSON.parse(localStorage.getItem('messageTemplates')||'[]'); }
  }
  function renderTemplates(){
    const wrap = $('#templateList');
    if (!savedTemplates.length){ wrap.innerHTML='<div class="card">尚無模板</div>'; return; }
    wrap.innerHTML = savedTemplates.map((t,i)=>`
      <div class="card">
        <div style="white-space:pre-wrap">${t}</div>
        <div style="margin-top:8px;display:flex;gap:8px">
          <button class="btn" onclick="useTpl(${i})">使用</button>
          <button class="btn danger" onclick="delTpl(${i})">刪除</button>
        </div>
      </div>`).join('');
  }
  window.useTpl = i => { const a=parseInt($('#amount').value||'0',10); $('#customMessage').value = (savedTemplates[i]||'').replace('{amount}', a.toLocaleString()); document.querySelector('.tab[data-tab="payment"]').click(); };
  window.delTpl = async i => { if(!confirm('刪除此模板？'))return; const d = await fetch(API_BASE+`/api/templates/${i}`,{method:'DELETE'}).then(r=>r.json()); if (d.success){ savedTemplates=d.templates; localStorage.setItem('messageTemplates', JSON.stringify(savedTemplates)); renderTemplates(); } };

  // ====== 初始化 ======
  (async function init(){
    await syncCustomers();
    await syncTemplates();
  })();
</script>
</body>
</html>