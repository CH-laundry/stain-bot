// ============== æ–°å¢ AI å®¢æœåŠŸèƒ½ ==============
async function getCustomerServiceResponse(userMessage) {
  const keywords = {
    "ç‡Ÿæ¥­": "æˆ‘å€‘çš„ç‡Ÿæ¥­æ™‚é–“ç‚º 10:30 - 20:00ï¼Œé€±å…­å›ºå®šå…¬ä¼‘å–”ï¼ğŸ˜Š",
    "é–‹é–€": "æˆ‘å€‘æ¯å¤© 10:30 é–‹é–€ï¼Œæ­¡è¿éš¨æ™‚ä¾†æ‰¾æˆ‘å€‘ï¼ğŸŒŸ",
    "ä¼‘æ¯": "é€±å…­æ˜¯æˆ‘å€‘çš„å…¬ä¼‘æ—¥ï¼Œå…¶ä»–æ™‚é–“éƒ½ç‚ºæ‚¨æœå‹™å–”ï¼ğŸ’–",
    "é–‹åº—": "æˆ‘å€‘æ¯å¤© 10:30 é–‹åº—ï¼ŒæœŸå¾…æ‚¨çš„å…‰è‡¨ï¼ğŸŒ¸",
    "æœ‰é–‹": "æˆ‘å€‘æ¯å¤© 10:30 - 20:00 éƒ½æœ‰é–‹ï¼Œé€±å…­ä¼‘æ¯å–”ï¼ğŸ˜„",
    "æ”¶é€": "æˆ‘å€‘æœ‰å…è²»åˆ°åºœæ”¶é€æœå‹™ï¼Œå¯ä»¥ LINE æˆ–å®˜ç¶²é ç´„å–”ï¼ğŸšš æ±Ÿç¿ åŒ—èŠ³é„°ä¸€ä»¶å°±å¯ä»¥å…è²»æ”¶é€ï¼Œæ¿æ©‹ã€æ–°èŠã€ä¸‰é‡ã€ä¸­å’Œã€æ°¸å’Œæ»¿ä¸‰ä»¶æˆ– 500 å…ƒï¼Œæ”¾ç½®ç®¡ç†å®¤è·Ÿæˆ‘å€‘èªªå°±å¯ä»¥äº†ï¼",
    "åˆ°åºœ": "æˆ‘å€‘æä¾›å…è²»åˆ°åºœæ”¶é€æœå‹™ï¼Œæ­¡è¿é ç´„ï¼ğŸ“¦",
    "ä¸Šé–€": "æˆ‘å€‘å¯ä»¥åˆ°åºœæ”¶é€è¡£ç‰©ï¼Œä¸€ä»¶å°±å…è²»å–”ï¼ğŸ˜Š",
    "æ”¶è¡£": "æˆ‘å€‘æœ‰å…è²»æ”¶è¡£æœå‹™ï¼Œæ­¡è¿é ç´„ï¼ğŸ‘•",
    "é ç´„": "å¯ä»¥é€é LINE æˆ–å®˜ç¶²é ç´„æˆ‘å€‘çš„åˆ°åºœæ”¶é€æœå‹™å–”ï¼ğŸ“…",
    "æ¸…æ´—": "æˆ‘å€‘çš„æ¸…æ½”æ™‚é–“ç´„ 7-10 å€‹å·¥ä½œå¤©ï¼Œå®Œæˆå¾Œæœƒè‡ªå‹•é€šçŸ¥æ‚¨å–”ï¼â³",
    "æ¸…æ½”": "æ¸…æ½”æ™‚é–“ç´„ 7-10 å€‹å·¥ä½œå¤©ï¼Œè«‹è€å¿ƒç­‰å¾…ï¼ğŸ˜Š",
    "æ´—å¤šä¹…": "æ¸…æ´—æ™‚é–“ç´„ 7-10 å€‹å·¥ä½œå¤©ï¼Œå®Œæˆå¾Œæœƒé€šçŸ¥æ‚¨ï¼â°",
    "å¤šä¹…": "æ¸…æ´—æ™‚é–“ç´„ 7-10 å€‹å·¥ä½œå¤©ï¼Œè«‹æ”¾å¿ƒäº¤çµ¦æˆ‘å€‘ï¼ğŸ’ª",
    "æœƒå¥½": "æ¸…æ½”å®Œæˆå¾Œæœƒè‡ªå‹•é€šçŸ¥æ‚¨ï¼Œè«‹ç¨ç­‰å–”ï¼ğŸ˜„",
    "é€æ´—æ™‚é–“": "æˆ‘å€‘çš„é€æ´—æ™‚é–“ç´„ 7-10 å€‹å·¥ä½œå¤©ï¼Œå®Œæˆå¾Œæœƒé€šçŸ¥æ‚¨ï¼ğŸ“…",
    "åƒ¹æ ¼": "å¯ä»¥åƒè€ƒæˆ‘å€‘çš„æœå‹™åƒ¹ç›®è¡¨ï¼ŒåŒ…åŒ…é¡éº»ç…©æ‚¨ä¸Šå‚³ç…§ç‰‡ï¼Œæˆ‘å€‘æœƒå›è¦†æ¸…æ´—åƒ¹æ ¼å–”ï¼ğŸ’°",
    "è²»ç”¨": "åƒ¹æ ¼æœƒæ ¹æ“šè¡£ç‰©ç¨®é¡å’Œæ¸…æ´—æ–¹å¼æœ‰æ‰€ä¸åŒï¼ŒåŒ…åŒ…é¡è«‹ä¸Šå‚³ç…§ç‰‡ï¼Œæˆ‘å€‘æœƒç‚ºæ‚¨å ±åƒ¹ï¼ğŸ’µ",
    "å¤šå°‘éŒ¢": "æ‚¨å¯ä»¥åƒè€ƒæˆ‘å€‘çš„æœå‹™åƒ¹ç›®è¡¨ï¼Œå¦‚å…¶å®ƒè¡£ç‰©é€™é‚Šå†è·Ÿæ‚¨å›è¦†çš„ï¼Œè¬è¬æ‚¨ï¼ğŸ’³", // æ¸…æ´—å‰çš„è©¢å•
    "ä»˜è²»": "æˆ‘å€‘æ¥å—ç¾é‡‘ã€ä¿¡ç”¨å¡ã€LINE Pay å’Œè½‰å¸³ä»˜æ¬¾å–”ï¼ğŸ’³",
    "ä»˜æ¬¾": "ä»˜æ¬¾æ–¹å¼æœ‰ç¾é‡‘ã€ä¿¡ç”¨å¡ã€LINE Pay å’Œè½‰å¸³ï¼Œæ–¹ä¾¿åˆå®‰å…¨ï¼ğŸ’µ",
    "æ´—å¥½äº†å—": "æ­£åœ¨æŸ¥è©¢æ‚¨çš„æ¸…æ´—é€²åº¦ï¼Œç¨å¾Œå›è¦†æ‚¨ï¼ğŸ”",
    "æ´—å¥½": "æˆ‘å€‘æœƒç›¡å¿«ç¢ºèªæ‚¨çš„æ¸…æ´—é€²åº¦ï¼Œç¨å¾Œé€šçŸ¥æ‚¨ï¼ğŸ˜Š",
    "é€å›": "æ¸…æ´—å®Œæˆå¾Œæœƒé€å›çµ¦æ‚¨ï¼Œé€é”æ™‚ä¹Ÿæœƒé€šçŸ¥æ‚¨å–”ï¼ğŸšš",
    "æ‹¿å›": "è¡£ç‰©æ¸…æ´—å®Œæˆå¾Œæœƒé€å›ï¼Œè«‹æ”¾å¿ƒï¼ğŸ˜„",
    "æ´—çš„æ‰": "æˆ‘å€‘æœƒé‡å°æ±¡æ¼¬åšå°ˆé–€è™•ç†ï¼Œå¤§éƒ¨åˆ†æ±¡æ¼¬éƒ½å¯ä»¥è®Šæ·¡ï¼Œä½†æˆåŠŸç‡è¦–æ±¡æ¼¬ç¨®é¡èˆ‡è¡£ç‰©æè³ªè€Œå®šå–”ï¼âœ¨",
    "æ´—æ‰": "æˆ‘å€‘æœƒç›¡åŠ›è™•ç†æ±¡æ¼¬ï¼Œä½†æ»²é€åˆ°çº–ç¶­æˆ–æ™‚é–“è¼ƒä¹…çš„æ±¡æ¼¬å¯èƒ½ç„¡æ³•å®Œå…¨å»é™¤ï¼Œè«‹è¦‹è«’ï¼ğŸ˜Š",
    "æŸ“è‰²": "æŸ“è‰²å•é¡Œæˆ‘å€‘æœƒç›¡é‡è™•ç†ï¼Œä½†å¦‚æœæ»²é€åˆ°è¡£ç‰©çº–ç¶­æˆ–é¢ç©è¼ƒå¤§ï¼Œä¸èƒ½ä¿è­‰å®Œå…¨è™•ç†å–”ï¼ğŸŒˆ",
    "é€€è‰²": "å·²ç¶“é€€è‰²çš„è¡£ç‰©æ˜¯ç„¡æ³•æ¢å¾©çš„ï¼Œè«‹è¦‹è«’ï¼ğŸ¨",
    "æ²¹æ¼¬": "æ²¹æ¼¬æˆ‘å€‘æœ‰å°ˆé–€çš„è™•ç†æ–¹å¼ï¼Œå¤§éƒ¨åˆ†éƒ½å¯ä»¥è®Šæ·¡ï¼Œè«‹æ”¾å¿ƒï¼ğŸ³",
    "è¡€æ¼¬": "è¡€æ¼¬æˆ‘å€‘æœƒç›¡åŠ›è™•ç†ï¼Œä½†æˆåŠŸç‡è¦–æ²¾æŸ“æ™‚é–“å’Œæè³ªè€Œå®šå–”ï¼ğŸ’‰",
    "é†¬æ²¹": "é†¬æ²¹æ±¡æ¼¬æˆ‘å€‘æœ‰å°ˆé–€çš„è™•ç†æ–¹å¼ï¼Œå¤§éƒ¨åˆ†éƒ½å¯ä»¥è®Šæ·¡ï¼Œè«‹æ”¾å¿ƒï¼ğŸ¶"
  };

  // æª¢æŸ¥æ˜¯å¦æœ‰åŒ¹é…çš„é—œéµå­—
  for (const [keyword, response] of Object.entries(keywords)) {
    if (userMessage.includes(keyword)) {
      return response;
    }
  }

  // å¦‚æœæ²’æœ‰åŒ¹é…çš„é—œéµå­—ï¼Œèª¿ç”¨ OpenAI ç”Ÿæˆå›è¦†
  try {
    const response = await openaiClient.chat.completions.create({
      model: "gpt-4o",
      messages: [
        {
          role: "system",
          content: "ä½ æ˜¯ä¸€å€‹æ´—è¡£åº—å®¢æœæ©Ÿå™¨äººï¼Œè«‹ç”¨ç°¡æ½”æ˜ç¢ºçš„æ–¹å¼å›ç­”å®¢æˆ¶çš„å•é¡Œï¼Œä¸è¦æä¾›é¡å¤–çš„æ¸…æ´—å»ºè­°ã€‚ä¾‹å¦‚ï¼š\nå®¢æˆ¶ï¼šå¯ä»¥æ´—çª—ç°¾å—ï¼Ÿ\nå›æ‡‰ï¼šå¯ä»¥çš„ï¼Œæˆ‘å€‘æœ‰çª—ç°¾æ¸…æ½”æœå‹™å–”ï¼\n\nå®¢æˆ¶ï¼šé€™ä»¶è¡£æœæ´—å¾—æ‰å—ï¼Ÿ\nå›æ‡‰ï¼šæˆ‘å€‘æœƒç›¡åŠ›è™•ç†ï¼Œä½†æˆåŠŸç‡è¦–æ±¡æ¼¬èˆ‡æè³ªè€Œå®šã€‚\n\nè«‹ä»¥é€™ç¨®ç°¡æ½”æ ¼å¼å›ç­”å•é¡Œã€‚"
        },
        { role: "user", content: userMessage }
      ]
    });

    return response.choices[0].message.content;
  } catch (error) {
    console.error("âŒ OpenAI API å¤±æ•—: ", error);
    return "ç›®å‰å®¢æœç³»çµ±ç¹å¿™ï¼Œè«‹ç¨å¾Œå†è©¦ ğŸ™";
  }
}

// ============== æ ¸å¿ƒé‚è¼¯ ==============
app.post('/webhook', async (req, res) => {
  res.status(200).end(); // ç¢ºä¿ LINE æ”¶åˆ°å›èª¿

  try {
    const events = req.body.events;
    console.log(JSON.stringify(events, null, 2));
    for (const event of events) {
      if (event.type !== 'message' || !event.source.userId) continue;

      const userId = event.source.userId;

      // æ–‡å­—è¨Šæ¯
      if (event.message.type === 'text') {
        const text = event.message.text.trim().toLowerCase();

        if (text === process.env.STARTUP_MESSAGE) {
          startup_store.set(userId, Date.now() + 180e3);
          console.log(`ç”¨æˆ¶ ${userId} é–‹å§‹ä½¿ç”¨`);
          await client.pushMessage(userId, { type: 'text', text: 'è«‹ä¸Šå‚³åœ–ç‰‡' });
          continue;
        }

        // è™•ç†ã€Œå¤šå°‘éŒ¢ã€çš„å…©ç¨®æƒ…å¢ƒ
        if (text.includes("å¤šå°‘éŒ¢")) {
          // æƒ…å¢ƒ 1ï¼šæ¸…æ´—å‰çš„è©¢å•
          if (text.includes("æ¸…æ´—") || text.includes("é€æ´—")) {
            await client.pushMessage(userId, { type: 'text', text: 'æ‚¨å¯ä»¥åƒè€ƒæˆ‘å€‘çš„æœå‹™åƒ¹ç›®è¡¨ï¼Œå¦‚å…¶å®ƒè¡£ç‰©é€™é‚Šå†è·Ÿæ‚¨å›è¦†çš„ï¼Œè¬è¬æ‚¨ï¼ğŸ’³' });
          }
          // æƒ…å¢ƒ 2ï¼šé€å›è¡£ç‰©å¾Œçš„ä»˜æ¬¾è©¢å•
          else {
            await client.pushMessage(userId, { type: 'text', text: 'ç¨å¾Œè·Ÿæ‚¨èªªï¼Œè¬è¬æ‚¨ï¼ğŸ˜Š' });
          }
          continue;
        }

        // èª¿ç”¨ AI å®¢æœåŠŸèƒ½
        const responseMessage = await getCustomerServiceResponse(text);
        await client.pushMessage(userId, { type: 'text', text: responseMessage });
      }

      // åœ–ç‰‡è¨Šæ¯
      if (event.message.type === 'image') {
        try {
          if (!startup_store.get(userId) || startup_store.get(userId) < Date.now()){
            console.log(`ç”¨æˆ¶ ${userId} ä¸Šä¼ äº†å›¾ç‰‡ï¼Œä½†æ˜¯æœªå¼€å§‹ä½¿ç”¨`);
            startup_store.delete(userId);
            continue;
          }

          console.log(`æ”¶åˆ°ä¾†è‡ª ${userId} çš„åœ–ç‰‡è¨Šæ¯, æ­£åœ¨è™•ç†...`);

          startup_store.delete(userId);

          if (!(await isUserAllowed(userId)) && (process.env.ADMIN && !process.env.ADMIN.includes(userId))) {
            console.log(`ç”¨æˆ¶ ${userId} ä½¿ç”¨æ¬¡æ•¸åˆ°é”ä¸Šé™`);
            await client.pushMessage(userId, { type: 'text', text: 'æ‚¨å·²ç¶“é”åˆ°æ¯é€±å…©æ¬¡ä½¿ç”¨æ¬¡æ•¸ä¸Šé™ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚' });
            continue;
          }

          console.log(`æ­£åœ¨ä¸‹è¼‰ä¾†è‡ª ${userId} çš„åœ–ç‰‡...`);
          const stream = await client.getMessageContent(event.message.id);
          const chunks = [];

          for await (const chunk of stream) {
            chunks.push(chunk);
          }

          const buffer = Buffer.concat(chunks);
          const base64Image = buffer.toString('base64');
          const imageHash = createHash('sha256').update(buffer).digest('hex');

          console.log('åœ–ç‰‡å·²æ¥æ”¶ï¼Œhashå€¼:', imageHash, `æ¶ˆæ¯ID: ${event.message.id}`);

          // èª¿ç”¨ OpenAI API é€²è¡Œåœ–ç‰‡åˆ†æ
          const openaiResponse = await openaiClient.chat.completions.create({
            model: 'gpt-4o',
            messages: [
              {
                role: 'system',
                content: [
                  'ä½ æ˜¯å°ˆæ¥­çš„æ´—è¡£åŠ©æ‰‹ï¼Œä½ çš„ä»»å‹™æ˜¯åˆ†æä½¿ç”¨è€…æä¾›çš„è¡£ç‰©æ±¡æ¼¬åœ–ç‰‡ï¼Œæä¾›æ¸…æ´—æˆåŠŸçš„æ©Ÿç‡ï¼ŒåŒæ™‚æ©Ÿç‡è¼¸å‡ºå¿…é ˆæ˜¯ç™¾åˆ†æ¯”ï¼ˆä¾‹å¦‚50%ï¼‰ï¼Œå’Œå…·ä½“çš„æ±¡æ¸ç±»å‹ä¿¡æ¯ï¼Œä½†æ˜¯ä¸è¦æä¾›æ¸…æ´—å»ºè®®ï¼Œæ¯å¥è¯ç»“å°¾åŠ ä¸Š â€œæˆ‘å€‘æœƒä»¥ä¸å‚·å®³æè³ªç›¡é‡åšæ¸…æ½”è™•ç†ã€‚â€ã€‚',
                  'ä½ çš„å›å¤å†…å®¹å¯ä»¥å‚è€ƒè¿™æ®µæ–‡æœ¬ï¼šâ€œé€™å¼µåœ–ç‰‡é¡¯ç¤ºç™½è‰²è¡£ç‰©ä¸Šæœ‰å¤§ç‰‡å’–å•¡è‰²æ±¡æ¼¬ã€‚é€™é¡æ±¡æ¼¬é€šå¸¸æ˜¯ç”±æ–¼å’–å•¡ã€èŒ¶æˆ–é†¬æ±ç­‰æ¶²é«”é€ æˆçš„ï¼Œæ¸…æ½”æˆåŠŸçš„æ©Ÿç‡å¤§ç´„åœ¨70-80%ã€‚ç”±æ–¼é¡è‰²è¼ƒæ·±ï¼Œå¯¦éš›æ¸…æ½”æ•ˆæœæœƒä¾æ±¡æ¼¬çš„æ»²é€ç¨‹åº¦ã€æ²¾æŸ“æ™‚é–“èˆ‡é‹æç‰¹æ€§è€Œå®šã€‚æŸäº›æ±¡æ¼¬å¯èƒ½æœƒè®Šæ·¡ä½†ç„¡æ³•å®Œå…¨å»é™¤ï¼Œæˆ‘å€‘æœƒä»¥ä¸å‚·å®³æè³ªç›¡é‡åšæ¸…æ½”è™•ç†ã€‚â€'
                ].join("\n")
              },
              {
                role: 'user',
                content: [
                  {
                    type: 'text',
                    text: 'è«‹åˆ†æé€™å¼µè¡£ç‰©æ±¡æ¼¬åœ–ç‰‡ï¼Œä¸¦çµ¦äºˆæ¸…æ½”å»ºè­°ã€‚'
                  },
                  {
                    type: "image_url",
                    image_url: {
                      url: `data:image/png;base64,${base64Image}`
                    }
                  }
                ]
              }
            ]
          });

          console.log('OpenAI å›æ‡‰:', openaiResponse.choices[0].message.content);
          await client.pushMessage(userId, [
            { type: 'text', text: openaiResponse.choices[0].message.content }
          ]);
        } catch (err) {
          console.log("OpenAI æœå‹™å‡ºç¾éŒ¯èª¤: ");
          console.error(err);
          console.log(`ç”¨æˆ¶ID: ${userId}`);

          await client.pushMessage(userId, [
            { type: 'text', text: 'æœå‹™æš«æ™‚ä¸å¯ç”¨ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚' }
          ]);
        }
      }
    }
  } catch (err) {
    console.error('å…¨å±€éŒ¯èª¤:', err);
  }
});