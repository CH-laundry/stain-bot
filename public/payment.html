<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>C.H 精緻洗衣 - 付款管理系統</title>
<style>
  :root{
    --bg:#0f1442; --bg2:#1a215c; --card:#0f162e; --pri:#5e8bff; --pri2:#7b6cff;
    --ok:#21c17a; --warn:#ffc107; --err:#ff5d6c; --text:#e9eefb; --sub:#a7b0d6; --line:#29315b;
  }
  *{box-sizing:border-box}
  body{margin:0;font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Helvetica,Arial,sans-serif;background:radial-gradient(1200px 800px at 20% -10%,#2f3da8 0%,transparent 60%), radial-gradient(1000px 700px at 110% 10%,#6a35c1 0%,transparent 50%), var(--bg);color:var(--text)}
  .wrap{max-width:1100px;margin:24px auto;padding:16px}
  .panel{background:linear-gradient(180deg,var(--bg2),#0c1138);border:1px solid var(--line);border-radius:18px;box-shadow:0 10px 40px rgba(0,0,0,.3);padding:24px}
  h1{display:flex;gap:10px;align-items:center;margin:0 0 8px;font-size:22px}
  .tabs{display:flex;gap:16px;margin:12px 0 20px;border-bottom:1px solid var(--line);flex-wrap:wrap}
  .tab{appearance:none;background:none;border:none;color:var(--sub);padding:12px 4px;font-weight:700;cursor:pointer;border-bottom:3px solid transparent}
  .tab.active{color:var(--text);border-bottom-color:var(--pri)}
  .grid{display:grid;grid-template-columns:1fr 340px;gap:18px}
  @media (max-width: 920px){.grid{grid-template-columns:1fr}}
  label{display:block;font-size:13px;color:var(--sub);margin:14px 0 6px}
  input,textarea,select{width:100%;padding:14px 12px;border-radius:12px;background:#0b1030;border:1px solid var(--line);color:var(--text);outline:none}
  textarea{min-height:120px;resize:vertical}
  input:focus,textarea:focus,select:focus{border-color:#3a54ff;box-shadow:0 0 0 3px rgba(90,120,255,.25)}
  .row{display:flex;gap:10px}
  .btn{display:inline-flex;align-items:center;justify-content:center;gap:8px;padding:14px 18px;border-radius:12px;border:1px solid transparent;cursor:pointer;font-weight:800;letter-spacing:.5px}
  .btn-primary{background:linear-gradient(135deg,var(--pri),var(--pri2));color:white}
  .btn-ghost{background:#0b1030;border-color:var(--line);color:var(--text)}
  .btn-danger{background:linear-gradient(135deg,#ff4d6d,#ff2550);color:#fff}
  .btn-ok{background:linear-gradient(135deg,#18ba84,#00a56a);color:#fff}
  .btn:disabled{opacity:.5;cursor:not-allowed}
  .radio3{display:grid;grid-template-columns:repeat(3,1fr);gap:12px}
  .payopt{border:1px solid var(--line);border-radius:14px;padding:14px 10px;text-align:center;background:#0b1030;cursor:pointer}
  .payopt.active{outline:3px solid rgba(94,139,255,.45);border-color:transparent}
  .payopt .emoji{font-size:28px;margin-bottom:6px}
  .templates{display:grid;grid-template-columns:1fr 1fr;gap:10px}
  .tpl{background:#0b1030;border:1px solid var(--line);border-radius:10px;padding:10px;text-align:left;cursor:pointer}
  .tpl:hover{border-color:#3a54ff}
  .card{background:#0b1030;border:1px solid var(--line);border-radius:14px;padding:16px}
  .list{display:flex;flex-direction:column;gap:10px;max-height:460px;overflow:auto;margin-top:10px}
  .item{display:flex;gap:10px;align-items:center;justify-content:space-between;background:#0f1438;border:1px solid var(--line);border-radius:12px;padding:10px}
  .hint{font-size:12px;color:var(--sub)}
  .pill{display:inline-block;padding:6px 10px;border-radius:999px;background:#14205a;color:var(--sub);font-size:12px}
  .result{margin-top:14px;border-radius:12px;padding:14px 12px;display:none}
  .result.ok{display:block;background:rgba(24,186,132,.15);border:1px solid #22c38a}
  .result.err{display:block;background:rgba(255,93,108,.15);border:1px solid #ff6c7a}
  .stat{display:grid;grid-template-columns:repeat(5,1fr);gap:10px}
  .chip{background:#0b1030;border:1px solid var(--line);border-radius:12px;padding:10px;text-align:center}
  .chip b{display:block;font-size:22px;margin-bottom:2px}
</style>
</head>
<body>
<div class="wrap">
  <div class="panel">
    <h1>💳 付款管理系統</h1>
    <div class="tabs">
      <button class="tab active" data-tab="send">發送付款</button>
      <button class="tab" data-tab="orders">訂單管理</button>
      <button class="tab" data-tab="customers">客戶編號</button>
      <button class="tab" data-tab="templates">訊息模板</button>
    </div>

    <!-- 內容 -->
    <div id="tab-send" class="grid">
      <!-- 左：表單 -->
      <div>
        <div class="card">
          <label>🔎 快速查詢（輸入「編號」或「姓名」）</label>
          <div class="row">
            <input id="quickSearch" placeholder="例如：625 或 王小明" />
            <button class="btn btn-ghost" id="btnQuickSearch">查詢</button>
          </div>

          <label>客戶姓名 *</label>
          <input id="userName" placeholder="王小明" />

          <label>客戶 LINE User ID *</label>
          <input id="userId" placeholder="Uxxxxxxxxxxxxxxxxxxxx" />

          <label>金額（NT$）*</label>
          <input id="amount" type="number" min="1" placeholder="1500" />

          <label>付款方式 *</label>
          <div class="radio3" id="payGroup">
            <div class="payopt active" data-v="both"><div class="emoji">💙</div>兩者都發</div>
            <div class="payopt" data-v="ecpay"><div class="emoji">💳</div>綠界信用卡</div>
            <div class="payopt" data-v="linepay"><div class="emoji">💚</div>LINE Pay</div>
          </div>

          <label>訊息內容（可含 {amount}）</label>
          <div class="row" style="align-items:center">
            <textarea id="customMessage" placeholder="例如：您好，金額 NT$ {amount}，謝謝！"></textarea>
            <button class="btn btn-ghost" id="btnLoadTpl">載入模板</button>
          </div>

          <button class="btn btn-primary" id="btnSend">發送付款連結</button>
          <div id="sendResult" class="result"></div>
        </div>

        <div class="card" style="margin-top:14px">
          <div class="stat" id="stats">
            <div class="chip"><b>0</b>總訂單數</div>
            <div class="chip"><b>0</b>待付款</div>
            <div class="chip"><b>0</b>已付款</div>
            <div class="chip"><b>0</b>已過期</div>
            <div class="chip"><b>0</b>需提醒</div>
          </div>
        </div>
      </div>

      <!-- 右：客戶載入 / 模板 -->
      <div>
        <div class="card">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <div>👥 客戶載入 <span class="pill" id="custCount">共 0 筆</span></div>
            <button class="btn btn-ok" id="btnReloadCustomers">重新載入</button>
          </div>
          <div class="list" id="customerList"><div class="hint">尚無客戶</div></div>
        </div>

        <div class="card" style="margin-top:14px">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <div>📝 常用模板</div>
            <button class="btn btn-ok" id="btnAddTpl">新增模板</button>
          </div>
          <div class="templates" id="tplList" style="margin-top:10px"></div>
        </div>
      </div>
    </div>

    <!-- 訂單管理 -->
    <div id="tab-orders" style="display:none">
      <div class="row" style="gap:10px;margin-bottom:10px">
        <button class="btn btn-ok" id="btnRefreshOrders">重新整理</button>
        <button class="btn btn-ok" id="btnSendReminders">發送付款提醒</button>
        <button class="btn btn-danger" id="btnCleanExpired">清理過期訂單</button>
      </div>
      <div id="orderList" class="list card"></div>
    </div>

    <!-- 客戶編號 -->
    <div id="tab-customers" style="display:none">
      <div class="grid">
        <div class="card">
          <label>編號（可空白自動遞增）</label>
          <input id="newNo" placeholder="例如：625" />
          <label>姓名 *</label>
          <input id="newName" placeholder="王小明" />
          <label>LINE User ID *</label>
          <input id="newUid" placeholder="Uxxxxxxxxxxxxxxxxxxxx" />
          <button class="btn btn-ok" id="btnSaveNo">儲存</button>
          <div class="hint">儲存成功後會同步到後端與本機</div>
        </div>
        <div class="card">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <div>已儲存</div>
            <button class="btn btn-ghost" id="btnReloadMeta">重新載入</button>
          </div>
          <div id="metaList" class="list" style="margin-top:10px"></div>
        </div>
      </div>
    </div>

    <!-- 模板管理 -->
    <div id="tab-templates" style="display:none">
      <div class="card">
        <label>新增模板</label>
        <div class="row">
          <input id="newTpl" placeholder="內容可含 {amount}" />
          <button class="btn btn-ok" id="btnCreateTpl">新增</button>
        </div>
        <div id="tplAdmin" class="list" style="margin-top:12px"></div>
      </div>
    </div>

  </div>
</div>

<script>
/* ----------------- 全域狀態 ----------------- */
let savedCustomers = JSON.parse(localStorage.getItem('customerNumbers') || '{}'); // { no: {name,userId} }
let savedTemplates = JSON.parse(localStorage.getItem('messageTemplates') || '[]');
let allOrders = [];
const $ = sel => document.querySelector(sel);

/* ----------------- 工具：安全取 JSON（避免 Unexpected token '<'） ----------------- */
async function safeJSON(res){
  const txt = await res.text();
  try { return JSON.parse(txt); } catch(e){
    return { success:false, error: txt?.slice(0,180) || '非 JSON 回應' };
  }
}
/* API 根：與同網域部署最保險 */
const API = location.origin;

/* 基本 fetch helpers */
async function getJSON(url){ const r = await fetch(API+url); return safeJSON(r); }
async function postJSON(url, body){ const r = await fetch(API+url,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(body||{})}); return safeJSON(r); }
async function putJSON(url, body){ const r = await fetch(API+url,{method:'PUT',headers:{'Content-Type':'application/json'},body:JSON.stringify(body||{})}); return safeJSON(r); }
async function del(url){ const r = await fetch(API+url,{method:'DELETE'}); return safeJSON(r); }

/* ----------------- Tab 切換 ----------------- */
document.querySelectorAll('.tab').forEach(b=>{
  b.addEventListener('click',()=>{
    document.querySelectorAll('.tab').forEach(x=>x.classList.remove('active'));
    b.classList.add('active');
    const key = b.dataset.tab;
    ['send','orders','customers','templates'].forEach(k=>$('#tab-'+k).style.display = (k===key)?'block':'none');
    if(key==='orders') loadOrders();
    if(key==='customers') renderMeta();
    if(key==='templates') renderTplAdmin();
  });
});

/* ----------------- 付款方式選擇 ----------------- */
let payType='both';
document.querySelectorAll('#payGroup .payopt').forEach(el=>{
  el.addEventListener('click',()=>{
    document.querySelectorAll('#payGroup .payopt').forEach(x=>x.classList.remove('active'));
    el.classList.add('active');
    payType = el.dataset.v;
  });
});

/* ----------------- 初始載入：模板 + 客戶Meta ----------------- */
async function init(){
  await fetchTemplates();
  await fetchCustomerMeta();
  loadTemplatesPanel();
  renderMeta();
  loadOrders();
}
document.addEventListener('DOMContentLoaded', init);

/* ----------------- 模板：讀/增/修/刪 ----------------- */
async function fetchTemplates(){
  const d = await getJSON('/api/templates');
  if (d.success && Array.isArray(d.templates)){
    savedTemplates = d.templates;
    localStorage.setItem('messageTemplates', JSON.stringify(savedTemplates));
  } else if (savedTemplates.length===0){
    savedTemplates = ['您好，金額 NT$ {amount}，請儘速付款，謝謝！','衣物已完成，費用 NT$ {amount}，可來店取件喔！'];
    localStorage.setItem('messageTemplates', JSON.stringify(savedTemplates));
  }
}
function loadTemplatesPanel(){
  const list = $('#tplList');
  list.innerHTML = savedTemplates.map((t,i)=>`<button class="tpl" onclick="$('#customMessage').value=\`${t.replace(/`/g,'\\`')}\`">${(t.length>36?t.slice(0,36)+'…':t)}</button>`).join('') || '<div class="hint">尚無模板</div>';
}
function renderTplAdmin(){
  const wrap = $('#tplAdmin');
  wrap.innerHTML = savedTemplates.map((t,i)=>`
    <div class="item">
      <div style="flex:1;white-space:pre-wrap">${t}</div>
      <div class="row">
        <button class="btn btn-ghost" onclick="editTpl(${i})">編輯</button>
        <button class="btn btn-danger" onclick="delTpl(${i})">刪除</button>
      </div>
    </div>
  `).join('') || '<div class="hint">尚無模板</div>';
}
$('#btnCreateTpl').onclick = async ()=>{
  const c = $('#newTpl').value.trim(); if(!c) return alert('請輸入內容');
  const d = await postJSON('/api/templates', { content:c });
  if (d.success){ savedTemplates=d.templates; localStorage.setItem('messageTemplates', JSON.stringify(savedTemplates)); $('#newTpl').value=''; renderTplAdmin(); loadTemplatesPanel(); alert('✅ 已新增模板');}
  else alert('❌ 失敗：'+(d.error||'未知錯誤'));
};
function editTpl(i){
  const nv = prompt('修改模板內容：', savedTemplates[i]||''); if(nv===null) return;
  putJSON('/api/templates/'+i,{content:nv}).then(d=>{
    if(d.success){ savedTemplates=d.templates; localStorage.setItem('messageTemplates', JSON.stringify(savedTemplates)); renderTplAdmin(); loadTemplatesPanel(); }
    else alert('❌ 失敗：'+(d.error||'未知錯誤'));
  });
}
function delTpl(i){
  if(!confirm('確定刪除此模板？')) return;
  del('/api/templates/'+i).then(d=>{
    if(d.success){ savedTemplates=d.templates; localStorage.setItem('messageTemplates', JSON.stringify(savedTemplates)); renderTplAdmin(); loadTemplatesPanel(); }
    else alert('❌ 失敗：'+(d.error||'未知錯誤'));
  });
}
/* 快捷按鈕：載入模板 */
$('#btnLoadTpl').onclick = loadTemplatesPanel;

/* ----------------- 客戶編號（Meta） ----------------- */
async function fetchCustomerMeta(){
  const d = await getJSON('/api/customer-meta');
  if (d.success && d.map){
    savedCustomers = d.map;
    localStorage.setItem('customerNumbers', JSON.stringify(savedCustomers));
  }
  renderMeta();
}
function renderMeta(){
  const L = Object.entries(savedCustomers);
  $('#custCount').textContent = '共 '+L.length+' 筆';
  /* 右側簡表 */
  $('#customerList').innerHTML = L.length? L.map(([no,c])=>`
    <div class="item">
      <div style="flex:1;cursor:pointer" onclick="fill('${c.name||''}','${c.userId||''}')">
        <b>#${no}</b>　${c.name||'-'} <span class="pill">${(c.userId||'').slice(0,6)}…</span>
      </div>
      <button class="btn btn-danger" onclick="removeNo('${no}')">刪除</button>
    </div>
  `).join('') : '<div class="hint">尚無客戶</div>';

  /* 客戶編號頁 tab */
  $('#metaList').innerHTML = L.length? L.map(([no,c])=>`
    <div class="item">
      <div style="flex:1">
        <div><b>#${no}</b>　${c.name||'-'}</div>
        <div class="hint">${c.userId||'-'}</div>
      </div>
      <div class="row">
        <button class="btn btn-ghost" onclick="fill('${c.name||''}','${c.userId||''}'); document.querySelector('[data-tab=send]').click();">帶入</button>
        <button class="btn btn-danger" onclick="removeNo('${no}')">刪除</button>
      </div>
    </div>
  `).join('') : '<div class="hint">尚無資料</div>';
}
function fill(name, uid){ $('#userName').value=name; $('#userId').value=uid; }
async function saveNo(){
  const number = $('#newNo').value.trim();
  const name = $('#newName').value.trim();
  const userId = $('#newUid').value.trim();
  if (!name || !userId) return alert('請完整輸入 姓名 / User ID');
  const d = await postJSON('/api/customer-meta/save',{ number:number?Number(number):undefined, name, userId });
  if (d.success){
    savedCustomers[d.number]=d.data; localStorage.setItem('customerNumbers', JSON.stringify(savedCustomers));
    $('#newNo').value=''; $('#newName').value=''; $('#newUid').value='';
    renderMeta(); alert('✅ 已儲存');
  } else alert('❌ 失敗：'+(d.error||'未知錯誤'));
}
async function removeNo(no){
  if(!confirm(`刪除編號 #${no} ?`)) return;
  const d = await del('/api/customer-meta/'+no);
  if(d.success){ delete savedCustomers[no]; localStorage.setItem('customerNumbers', JSON.stringify(savedCustomers)); renderMeta(); }
  else alert('❌ 失敗：'+(d.error||'未知錯誤'));
}
$('#btnSaveNo').onclick = saveNo;
$('#btnReloadMeta').onclick = fetchCustomerMeta;
$('#btnReloadCustomers').onclick = fetchCustomerMeta;

/* 快速查詢 */
$('#btnQuickSearch').onclick = ()=>{
  const q = $('#quickSearch').value.trim(); if(!q) return alert('請輸入編號或姓名');
  if (savedCustomers[q]){ const c=savedCustomers[q]; fill(c.name||'', c.userId||''); return; }
  const found = Object.entries(savedCustomers).find(([no,c])=> (c.name||'').includes(q));
  if (found){ const [,c]=found; fill(c.name||'', c.userId||''); return; }
  alert('找不到此客戶');
};

/* ----------------- 發送付款連結 ----------------- */
// 注意：你的後端是 POST /send-payment（不是 /api/send-payment）
$('#btnSend').onclick = async ()=>{
  const userId = $('#userId').value.trim();
  const userName = $('#userName').value.trim();
  const amount = parseInt($('#amount').value,10);
  const customMessage = ($('#customMessage').value||'').trim().replace('{amount}', (amount||0).toLocaleString('zh-TW'));
  if(!userId || !userName || !amount){ return showResult(false,'請把必填欄位填好'); }
  $('#btnSend').disabled = true;
  const d = await postJSON('/send-payment',{ userId, userName, amount, paymentType: payType, customMessage });
  $('#btnSend').disabled = false;
  if (d && d.success){ showResult(true, `✅ 已發送給 ${userName}。金額 NT$ ${amount.toLocaleString('zh-TW')}`); $('#customMessage').value=''; }
  else showResult(false, d?.error||'發送失敗');
};
function showResult(ok, msg){
  const el = $('#sendResult'); el.className='result '+(ok?'ok':'err'); el.innerHTML = msg; el.style.display='block'; el.scrollIntoView({behavior:'smooth',block:'center'});
}

/* ----------------- 訂單管理 ----------------- */
async function loadOrders(){
  const d = await getJSON('/api/orders');
  if (!d.success){ $('#orderList').innerHTML='<div class="hint">載入失敗</div>'; return; }
  allOrders = d.orders||[];
  const s = d.statistics||{total:0,pending:0,paid:0,expired:0,needReminder:0};
  const statDom = $('#stats').querySelectorAll('.chip b');
  [s.total,s.pending,s.paid,s.expired,s.needReminder].forEach((v,i)=>statDom[i].textContent=v);

  $('#orderList').innerHTML = allOrders.length? allOrders.map(o=>{
    const status = o.status==='paid' ? '✅ 已付款' : (o.isExpired?'❌ 已過期':`⏰ 剩 ${o.remainingHours??'-'} 小時`);
    return `<div class="item">
      <div style="flex:1">
        <div><b>${o.userName||'-'}</b>　<span class="pill">NT$ ${(o.amount||0).toLocaleString('zh-TW')}</span></div>
        <div class="hint">訂單 ${o.orderId||'-'}｜${status}</div>
      </div>
      <div class="row">
        ${o.status==='paid'?'': (o.isExpired? `<button class="btn btn-ok" onclick="renew('${o.orderId}')">續約重發</button>` : `<button class="btn btn-ghost" onclick="copyLink('${o.orderId}')">複製連結</button><button class="btn btn-ok" onclick="renew('${o.orderId}')">提醒/續約</button>`)}
        <button class="btn btn-danger" onclick="delOrder('${o.orderId}')">刪除</button>
      </div>
    </div>`;
  }).join('') : '<div class="hint">尚無訂單</div>';
}
async function renew(id){
  const d = await postJSON('/api/order/'+id+'/renew',{}); 
  if (d.success){ alert('✅ 已續約並重新發送'); loadOrders(); } else alert('❌ 失敗：'+(d.error||'未知錯誤'));
}
async function delOrder(id){
  if(!confirm('刪除此訂單？')) return;
  const d = await del('/api/order/'+id);
  if (d.success){ loadOrders(); } else alert('❌ 失敗：'+(d.error||'未知錯誤'));
}
function copyLink(id){
  const url = `${location.origin}/payment/linepay/pay/${id}`;
  navigator.clipboard.writeText(url).then(()=>alert('📋 已複製 LINE Pay 入口'),()=>alert('請手動複製：'+url));
}
$('#btnRefreshOrders').onclick = loadOrders;
$('#btnSendReminders').onclick = ()=>postJSON('/api/orders/send-reminders',{}).then(d=>{ alert(d.success? (d.message || `已發送 ${d.sent||0} 筆`): ('失敗：'+(d.error||'未知錯誤')) ); loadOrders(); });
$('#btnCleanExpired').onclick = ()=>postJSON('/api/orders/clean-expired',{}).then(d=>{ alert(d.message || '已清理'); loadOrders(); });
</script>
</body>
</html>