<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>C.H 精緻洗衣 - 付款管理系統</title>
  <style>
    :root{
      --bg1:#1e1f2a; --bg2:#2a2b3a; --card:#0f1324; --primary:#6ea8fe; --accent:#9b8cff;
      --ok:#2ecc71; --warn:#f1c40f; --danger:#e74c3c; --muted:#9aa0ad; --ring:rgba(110,168,254,.25);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; font-family: ui-sans-serif, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial;
      background: radial-gradient(1200px 800px at 20% -10%, #2b2e4a 0%, #1b1d32 40%, #0c0f1f 100%),
                  linear-gradient(135deg, #3b82f6 0%, #8b5cf6 100%);
      background-blend-mode: overlay;
      color:#e6e9ef; padding:24px;
    }
    .shell{max-width:1100px;margin:0 auto;background:rgba(15,19,36,.7);backdrop-filter: blur(10px);border-radius:20px;box-shadow:0 30px 80px rgba(0,0,0,.4);overflow:hidden}
    .header{padding:22px 24px;border-bottom:1px solid rgba(255,255,255,.06);display:flex;align-items:center;gap:14px}
    .header .logo{font-size:28px}
    .header h1{margin:0;font-size:22px;letter-spacing:.5px}
    .tabs{display:flex;gap:18px;padding:14px 24px;border-bottom:1px solid rgba(255,255,255,.06);overflow:auto}
    .tab{background:none;border:none;color:#b7c1d6;cursor:pointer;font-weight:700;letter-spacing:.3px;padding:10px 8px;border-bottom:3px solid transparent}
    .tab.active{color:#fff;border-color:var(--primary)}
    .layout{display:grid;grid-template-columns: 1.2fr .8fr;gap:18px;padding:20px}
    @media (max-width: 900px){ .layout{grid-template-columns:1fr} }
    .card{background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));border:1px solid rgba(255,255,255,.08);border-radius:16px;padding:18px}
    .title{margin:0 0 12px;font-size:16px;color:#cbd5e1;letter-spacing:.4px}
    .row{display:grid;gap:12px;margin-bottom:12px}
    label{font-size:13px;color:#9aa5b1;margin-bottom:6px}
    input,textarea,select{
      width:100%;padding:13px 14px;border-radius:12px;border:1.5px solid rgba(255,255,255,.12);background:#0f1324;color:#e6e9ef;font-size:16px;
      outline:none; transition:.25s border, .25s box-shadow;
    }
    input:focus,textarea:focus,select:focus{border-color:var(--primary);box-shadow:0 0 0 6px var(--ring)}
    textarea{min-height:120px;resize:vertical}
    .grid3{display:grid;grid-template-columns:repeat(3,1fr);gap:10px}
    @media (max-width: 560px){ .grid3{grid-template-columns:1fr} }
    .paybtn{border:1.5px solid rgba(255,255,255,.12);background:#0f1324;border-radius:14px;cursor:pointer;padding:18px 10px;text-align:center}
    .paybtn.active{border-color:var(--primary);box-shadow:0 8px 26px rgba(110,168,254,.25), inset 0 0 0 999px rgba(110,168,254,.08)}
    .paybtn .ico{font-size:28px;margin-bottom:6px}
    .paybtn .name{font-weight:800;letter-spacing:.5px}
    .btn{display:inline-block;background:linear-gradient(135deg,#60a5fa,#8b5cf6);border:none;color:white;font-weight:800;
         padding:14px 18px;border-radius:12px;cursor:pointer;box-shadow:0 12px 35px rgba(99,102,241,.35);transition:transform .1s}
    .btn:active{transform:translateY(1px)}
    .btn.secondary{background:linear-gradient(135deg,#22c55e,#16a34a)}
    .muted{color:#94a3b8}
    .result{margin-top:12px;border-radius:12px;padding:14px;display:none}
    .result.success{background:rgba(34,197,94,.12);border:1px solid rgba(34,197,94,.3)}
    .result.error{background:rgba(239,68,68,.12);border:1px solid rgba(239,68,68,.3)}
    .searchLine{display:grid;grid-template-columns:1fr 140px;gap:10px}
    .kpi{display:grid;grid-template-columns:repeat(5,1fr);gap:10px;margin-bottom:8px}
    .kpi .k{background:#0b0f1e;border:1px solid rgba(255,255,255,.08);border-radius:12px;padding:14px;text-align:center}
    .k .n{font-size:22px;font-weight:900}
    .k .t{font-size:12px;color:#9aa5b1}
    .templ-grid{display:grid;grid-template-columns:1fr;gap:8px}
    .templ{background:#0b0f1e;border:1px dashed rgba(255,255,255,.14);padding:10px;border-radius:10px}
    .list{max-height:520px;overflow:auto;display:grid;gap:10px}
    .cust{background:#0b0f1e;border:1px solid rgba(255,255,255,.08);border-radius:12px;padding:12px;display:flex;justify-content:space-between;align-items:center}
    .cust .info{cursor:pointer}
    .pill{display:inline-block;padding:4px 8px;border-radius:999px;background:#111627;border:1px solid rgba(255,255,255,.08);font-size:12px;color:#9aa5b1}
  </style>
</head>
<body>
  <div class="shell">
    <div class="header">
      <div class="logo">💳</div>
      <h1>付款管理系統</h1>
    </div>

    <div class="tabs">
      <button class="tab active" data-tab="payment">發送付款</button>
      <button class="tab" data-tab="orders">訂單管理</button>
      <button class="tab" data-tab="customers">客戶編號</button>
      <button class="tab" data-tab="templates">訊息模板</button>
      <span class="pill">手機優化 ✓</span>
    </div>

    <!-- 主要 layout：左側表單 + 右側客戶清單 -->
    <div id="payment" class="layout">
      <div class="card">
        <h3 class="title">發送付款</h3>

        <div class="row">
          <label>🔎 快速查詢（輸入「編號」或「姓名」）</label>
          <div class="searchLine">
            <input id="quickSearch" placeholder="例如：625 或 王小明">
            <button class="btn secondary" id="btnQuick">查詢</button>
          </div>
        </div>

        <form id="paymentForm">
          <div class="row">
            <label>客戶姓名 *</label>
            <input id="userName" placeholder="王小明" required>
          </div>

          <div class="row">
            <label>客戶 LINE User ID *</label>
            <input id="userId" placeholder="Uxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx" required>
          </div>

          <div class="row">
            <label>金額 (NT$) *</label>
            <input id="amount" type="number" min="1" inputmode="numeric" placeholder="1500" required>
          </div>

          <div class="row">
            <label>付款方式 *</label>
            <div class="grid3" id="payGrid">
              <div class="paybtn active" data-val="both">
                <div class="ico">💙</div>
                <div class="name">兩者都發</div>
              </div>
              <div class="paybtn" data-val="ecpay">
                <div class="ico">💳</div>
                <div class="name">綠界信用卡</div>
              </div>
              <div class="paybtn" data-val="linepay">
                <div class="ico">💚</div>
                <div class="name">LINE Pay</div>
              </div>
            </div>
          </div>

          <div class="row">
            <label>訊息內容（可含 {amount}）</label>
            <div style="display:grid;grid-template-columns:1fr 140px;gap:10px;align-items:start">
              <textarea id="customMessage" placeholder="例如：您好，金額 NT$ {amount}，謝謝！"></textarea>
              <div>
                <button type="button" class="btn" id="btnLoadT">載入模板</button>
                <div class="muted" style="font-size:12px;margin-top:8px">在右側有「客戶載入」清單</div>
              </div>
            </div>
          </div>

          <button class="btn" type="submit">發送付款連結</button>
          <div id="result" class="result"></div>
        </form>
      </div>

      <!-- 右側：客戶載入 / 模板速選 -->
      <div class="card">
        <h3 class="title">👥 客戶載入</h3>
        <div style="display:flex;gap:8px;margin-bottom:10px">
          <button class="btn secondary" id="btnReloadUsers">重新載入</button>
          <span class="muted" id="usersCount">—</span>
        </div>
        <div id="userList" class="list">
          <div class="muted">尚未載入（點「重新載入」）</div>
        </div>

        <h3 class="title" style="margin-top:18px">📝 常用模板</h3>
        <div id="templList" class="templ-grid"></div>
      </div>
    </div>

    <!-- 其它分頁：簡化骨架（可保留你原有內容） -->
    <div id="orders" class="layout" style="display:none">
      <div class="card">
        <h3 class="title">訂單管理</h3>
        <div class="kpi">
          <div class="k"><div class="n" id="kTotal">0</div><div class="t">總訂單</div></div>
          <div class="k"><div class="n" id="kPending">0</div><div class="t">待付款</div></div>
          <div class="k"><div class="n" id="kPaid">0</div><div class="t">已付款</div></div>
          <div class="k"><div class="n" id="kExpired">0</div><div class="t">已過期</div></div>
          <div class="k"><div class="n" id="kNeed">0</div><div class="t">需提醒</div></div>
        </div>
        <div id="orderList" class="list"></div>
      </div>
      <div class="card">
        <h3 class="title">群組動作</h3>
        <button class="btn" id="btnRefreshOrders">重新整理</button>
        <button class="btn secondary" id="btnRemind">發送付款提醒</button>
        <button class="btn" id="btnClean">清理過期訂單</button>
      </div>
    </div>

    <div id="customers" class="layout" style="display:none">
      <div class="card">
        <h3 class="title">新增/更新 客戶編號</h3>
        <div class="row"><label>編號</label><input id="newNo" placeholder="如 625"></div>
        <div class="row"><label>姓名</label><input id="newName" placeholder="王小明"></div>
        <div class="row"><label>LINE User ID</label><input id="newUid" placeholder="Uxxxxxxxxxx"></div>
        <button class="btn secondary" id="btnSaveNo">儲存</button>
      </div>
      <div class="card">
        <h3 class="title">已儲存</h3>
        <div id="savedCustomers" class="list"></div>
      </div>
    </div>

    <div id="templates" class="layout" style="display:none">
      <div class="card">
        <h3 class="title">新增模板</h3>
        <div class="row"><textarea id="newTpl" placeholder="您好，金額 NT$ {amount}，謝謝！"></textarea></div>
        <button class="btn secondary" id="btnSaveTpl">儲存模板</button>
      </div>
      <div class="card">
        <h3 class="title">我的模板</h3>
        <div id="tplManage" class="list"></div>
      </div>
    </div>
  </div>

  <script>
    // ===== 狀態 =====
    const API_BASE = location.origin;
    let savedCustomers = {};
    let savedTemplates = [];
    let allOrders = [];
    let allUsers = [];

    // ===== 小工具 =====
    const $ = sel => document.querySelector(sel);
    const $all = sel => Array.from(document.querySelectorAll(sel));
    function showResult(type, msg){
      const el = $('#result');
      el.className = 'result ' + (type==='success'?'success':'error');
      el.innerHTML = msg;
      el.style.display = 'block';
      el.scrollIntoView({behavior:'smooth', block:'center'});
    }
    async function getJSON(u){ const r=await fetch(u); if(!r.ok) throw new Error(await r.text()); return r.json(); }
    async function postJSON(u,b){ const r=await fetch(u,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(b||{})}); let t=''; try{t=await r.text()}catch{}; try{const j=JSON.parse(t); if(!r.ok) throw new Error(j.error||t); return j;}catch{ if(!r.ok) throw new Error(t||'HTTP '+r.status); return {success:false, raw:t}; } }
    async function putJSON(u,b){ const r=await fetch(u,{method:'PUT',headers:{'Content-Type':'application/json'},body:JSON.stringify(b||{})}); return r.json(); }
    async function del(u){ const r=await fetch(u,{method:'DELETE'}); return r.json(); }

    // ===== 分頁 =====
    $all('.tab').forEach(btn=>{
      btn.addEventListener('click',()=>{
        $all('.tab').forEach(b=>b.classList.remove('active')); btn.classList.add('active');
        const id = btn.dataset.tab;
        ['payment','orders','customers','templates'].forEach(t => { document.getElementById(t).style.display = (t===id?'grid':'none'); });
        if(id==='orders') loadOrders();
        if(id==='customers') renderSavedCustomers();
        if(id==='templates') renderTplManage();
      });
    });

    // ===== 支付選擇 =====
    let paymentType = 'both';
    $('#payGrid').addEventListener('click', e=>{
      const card = e.target.closest('.paybtn'); if(!card) return;
      $all('.paybtn').forEach(x=>x.classList.remove('active'));
      card.classList.add('active');
      paymentType = card.dataset.val;
    });

    // ===== 快速查詢（編號/姓名）→ 套入姓名 + UID（注意：姓名與 UID 已修正為正確對應）=====
    $('#btnQuick').addEventListener('click', ()=>{
      const q = $('#quickSearch').value.trim();
      if(!q){ alert('請輸入編號或姓名'); return; }
      // 先用「編號」找
      if(savedCustomers[q]){
        const c = savedCustomers[q];
        $('#userName').value = c.name || '';
        $('#userId').value = c.userId || '';
        return;
      }
      // 再用「姓名」找
      const found = Object.entries(savedCustomers).find(([no,c]) => (c.name||'').includes(q));
      if(found){
        const [, c] = found;
        $('#userName').value = c.name || '';
        $('#userId').value = c.userId || '';
      }else{
        alert('找不到此客戶');
      }
    });

    // ===== 送出付款 =====
    $('#paymentForm').addEventListener('submit', async (e)=>{
      e.preventDefault();
      const userId = $('#userId').value.trim();
      const userName = $('#userName').value.trim();
      const amount = parseInt($('#amount').value,10);
      const msg = ($('#customMessage').value||'').replace('{amount}', (amount||0).toLocaleString());

      if(!userId || !userName || !amount){ showResult('error','請完整填寫：姓名、User ID、金額'); return; }

      try{
        const d = await postJSON(`${API_BASE}/api/send-payment`, { userId, userName, amount, paymentType, customMessage: msg });
        if(d.success){
          showResult('success', `✅ 已發送！<br>訂單：${d.orderId}<br>可重複點擊：<br>綠界信用卡、LINE Pay 按鈕`);
          $('#paymentForm').reset(); paymentType='both'; $all('.paybtn').forEach(x=>x.classList.remove('active')); $all('.paybtn')[0].classList.add('active');
        }else{
          showResult('error', `❌ 失敗：${d.error||'未知錯誤'}`);
        }
      }catch(err){
        showResult('error', `連線失敗：${err.message}`);
      }
    });

    // ===== 客戶清單（右側） =====
    async function loadUsers(){
      $('#userList').innerHTML = '<div class="muted">載入中...</div>';
      try{
        const d = await getJSON(`${API_BASE}/api/users`);
        allUsers = Array.isArray(d.users)? d.users : [];
        $('#usersCount').textContent = `共 ${allUsers.length} 筆`;
        if(allUsers.length===0){ $('#userList').innerHTML = '<div class="muted">尚無客戶</div>'; return; }
        $('#userList').innerHTML = allUsers.map(u=>`
          <div class="cust">
            <div class="info" data-uid="${u.userId||''}" data-name="${u.name||''}">
              <div style="font-weight:800">${u.name||'-'}</div>
              <div class="muted" style="font-size:12px">${u.userId||''}${u.number? '｜編號 '+u.number : ''}</div>
            </div>
            <button class="btn" data-fill="${u.userId||''}" data-n="${u.name||''}">帶入</button>
          </div>
        `).join('');
      }catch{
        // 後端取不到就用 meta
        const list = Object.entries(savedCustomers).map(([no,c])=>({userId:c.userId,name:c.name,number:no}));
        $('#usersCount').textContent = `共 ${list.length} 筆（離線）`;
        if(list.length===0){ $('#userList').innerHTML = '<div class="muted">尚無客戶</div>'; return; }
        $('#userList').innerHTML = list.map(u=>`
          <div class="cust">
            <div class="info" data-uid="${u.userId||''}" data-name="${u.name||''}">
              <div style="font-weight:800">${u.name||'-'}</div>
              <div class="muted" style="font-size:12px">${u.userId||''}${u.number? '｜編號 '+u.number : ''}</div>
            </div>
            <button class="btn" data-fill="${u.userId||''}" data-n="${u.name||''}">帶入</button>
          </div>
        `).join('');
      }
    }
    $('#userList').addEventListener('click', e=>{
      const info = e.target.closest('.info');
      const btn = e.target.closest('button[data-fill]');
      const uid = info?.dataset.uid || btn?.dataset.fill;
      const name = info?.dataset.name || btn?.dataset.n;
      if(uid!==undefined){
        $('#userId').value = uid || '';
        $('#userName').value = name || '';
        // 切回表單分頁（若不在）
        $all('.tab').forEach(b=>b.classList.remove('active')); document.querySelector('.tab[data-tab="payment"]').classList.add('active');
        ['payment','orders','customers','templates'].forEach(t => { document.getElementById(t).style.display = (t==='payment'?'grid':'none'); });
      }
    });
    $('#btnReloadUsers').addEventListener('click', loadUsers);

    // ===== 模板 =====
    async function fetchTemplates(){
      try{
        const d = await getJSON(`${API_BASE}/api/templates`);
        if(d.success && Array.isArray(d.templates)){ savedTemplates = d.templates; }
      }catch{}
      if(!savedTemplates || savedTemplates.length===0){
        savedTemplates = [
          '您好，金額 NT$ {amount}，請儘速付款，謝謝！',
          '衣物已完成清洗，費用 NT$ {amount}，可來店取件囉！'
        ];
      }
      renderTemplates();
      renderTplManage();
    }
    function renderTemplates(){
      const box = $('#templList');
      box.innerHTML = savedTemplates.map((t,i)=>`
        <div class="templ">
          <div style="white-space:pre-wrap;font-size:14px">${t}</div>
          <div style="margin-top:8px"><button class="btn" data-usetpl="${i}">套用</button></div>
        </div>
      `).join('');
    }
    $('#templList').addEventListener('click', e=>{
      const i = e.target.getAttribute('data-usetpl');
      if(i!==null){
        $('#customMessage').value = savedTemplates[Number(i)] || '';
        $('#customMessage').focus();
      }
    });
    $('#btnLoadT').addEventListener('click', renderTemplates);

    function renderTplManage(){
      const wrap = $('#tplManage');
      wrap.innerHTML = savedTemplates.map((t,i)=>`
        <div class="cust">
          <div style="white-space:pre-wrap;max-width:70%">${t}</div>
          <div style="display:flex;gap:8px">
            <button class="btn" data-edit="${i}">編輯</button>
            <button class="btn" data-del="${i}">刪除</button>
          </div>
        </div>
      `).join('');
    }
    $('#tplManage').addEventListener('click', async e=>{
      const di = e.target.getAttribute('data-del');
      const ei = e.target.getAttribute('data-edit');
      if(di!==null){
        const i = Number(di);
        await del(`${API_BASE}/api/templates/${i}`);
        await fetchTemplates();
      }else if(ei!==null){
        const i = Number(ei);
        const nv = prompt('修改模板：', savedTemplates[i]||'');
        if(nv===null) return;
        await putJSON(`${API_BASE}/api/templates/${i}`, { content:nv });
        await fetchTemplates();
      }
    });
    $('#btnSaveTpl').addEventListener('click', async ()=>{
      const c = $('#newTpl').value.trim();
      if(!c) return alert('請輸入模板內容');
      await postJSON(`${API_BASE}/api/templates`, { content:c });
      $('#newTpl').value='';
      await fetchTemplates();
    });

    // ===== 客戶編號（後端同步） =====
    async function fetchCustomerMeta(){
      try{
        const d = await getJSON(`${API_BASE}/api/customer-meta`);
        if(d.success && d.map){ savedCustomers = d.map; }
      }catch{}
      renderSavedCustomers();
    }
    function renderSavedCustomers(){
      const wrap = $('#savedCustomers');
      const items = Object.entries(savedCustomers);
      if(!wrap) return;
      if(items.length===0){ wrap.innerHTML = '<div class="muted">尚無資料</div>'; return; }
      wrap.innerHTML = items.map(([no,c])=>`
        <div class="cust">
          <div class="info" data-uid="${c.userId||''}" data-name="${c.name||''}">
            <div style="font-weight:800">#${no} ${c.name||'-'}</div>
            <div class="muted" style="font-size:12px">User ID：${c.userId||''}</div>
          </div>
          <button class="btn" data-delno="${no}">刪除</button>
        </div>
      `).join('');
    }
    $('#savedCustomers')?.addEventListener('click', async e=>{
      const d = e.target.getAttribute('data-delno');
      const info = e.target.closest('.info');
      if(d){
        if(!confirm(`刪除編號 #${d} ?`)) return;
        await del(`${API_BASE}/api/customer-meta/${d}`);
        await fetchCustomerMeta();
      }else if(info){
        $('#userId').value = info.dataset.uid || '';
        $('#userName').value = info.dataset.name || '';
        // 切回表單
        $all('.tab').forEach(b=>b.classList.remove('active')); document.querySelector('.tab[data-tab="payment"]').classList.add('active');
        ['payment','orders','customers','templates'].forEach(t => { document.getElementById(t).style.display = (t==='payment'?'grid':'none'); });
      }
    });
    $('#btnSaveNo').addEventListener('click', async ()=>{
      const number = ($('#newNo').value||'').trim();
      const name   = ($('#newName').value||'').trim();
      const userId = ($('#newUid').value||'').trim();
      if(!name || !userId){ alert('請輸入 姓名 / User ID'); return; }
      const d = await postJSON(`${API_BASE}/api/customer-meta/save`, { number: number? Number(number):undefined, name, userId });
      if(d.success){
        $('#newNo').value=''; $('#newName').value=''; $('#newUid').value='';
        await fetchCustomerMeta();
        alert('✅ 已儲存');
      }else alert(d.error||'儲存失敗');
    });

    // ===== 訂單（簡版） =====
    async function loadOrders(){
      $('#orderList').innerHTML = '<div class="muted">載入中...</div>';
      try{
        const d = await getJSON(`${API_BASE}/api/orders`);
        if(!d.success) throw new Error(d.error||'載入失敗');
        allOrders = d.orders||[];
        $('#kTotal').textContent = d.statistics?.total ?? 0;
        $('#kPending').textContent = d.statistics?.pending ?? 0;
        $('#kPaid').textContent = d.statistics?.paid ?? 0;
        $('#kExpired').textContent = d.statistics?.expired ?? 0;
        $('#kNeed').textContent = d.statistics?.needReminder ?? 0;
        if(allOrders.length===0){ $('#orderList').innerHTML = '<div class="muted">尚無訂單</div>'; return; }
        $('#orderList').innerHTML = allOrders.map(o=>`
          <div class="cust">
            <div>
              <div style="font-weight:800">${o.userName||'-'}　<span class="muted" style="font-size:12px">${o.orderId||''}</span></div>
              <div class="muted" style="font-size:12px">NT$ ${(o.amount||0).toLocaleString()}｜${o.status|| (o.isExpired?'expired':'pending')}</div>
            </div>
            <div style="display:flex;gap:8px">
              ${o.isExpired? `<button class="btn" data-renew="${o.orderId}">續約重發</button>` :
                              `<button class="btn" data-copy="${o.orderId}">複製連結</button>`}
              <button class="btn" data-del="${o.orderId}">刪除</button>
            </div>
          </div>
        `).join('');
      }catch(e){
        $('#orderList').innerHTML = `<div class="muted">載入失敗：${e.message}</div>`;
      }
    }
    $('#orderList').addEventListener('click', async e=>{
      const r = e.target.getAttribute('data-renew');
      const d = e.target.getAttribute('data-del');
      const c = e.target.getAttribute('data-copy');
      if(r){
        const j = await postJSON(`${API_BASE}/api/order/${r}/renew`, {});
        alert(j.success? '已續約並重發' : `失敗：${j.error||'未知錯誤'}`);
        loadOrders();
      }else if(d){
        if(!confirm('刪除此訂單？')) return;
        const j = await del(`${API_BASE}/api/order/${d}`);
        alert(j.success? '已刪除' : `失敗：${j.error||'未知錯誤'}`);
        loadOrders();
      }else if(c){
        const base = location.origin;
        const txt = `【綠界信用卡】\n${base}/pay/ec/${c}\n\n【LINE Pay】\n${base}/pay/line/${c}`;
        try{ await navigator.clipboard.writeText(txt); alert('已複製'); }catch{ alert('複製失敗'); }
      }
    });
    $('#btnRefreshOrders').addEventListener('click', loadOrders);
    $('#btnRemind').addEventListener('click', async ()=>{
      const j = await postJSON(`${API_BASE}/api/orders/send-reminders`, {});
      alert(j.message||'已發送'); loadOrders();
    });
    $('#btnClean').addEventListener('click', async ()=>{
      const j = await postJSON(`${API_BASE}/api/orders/clean-expired`, {});
      alert(j.message||'已清理'); loadOrders();
    });

    // ===== 初始化 =====
    document.addEventListener('DOMContentLoaded', async ()=>{
      await fetchCustomerMeta();
      await fetchTemplates();
      await loadUsers();
    });
  </script>
</body>
</html>