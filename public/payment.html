<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>ä»˜æ¬¾ç®¡ç†ç³»çµ±</title>
  <style>
    :root{
      --bg:#0f172a; --panel:#111827; --panel2:#0b1220; --text:#e5e7eb;
      --muted:#94a3b8; --primary:#60a5fa; --ok:#22c55e; --warn:#f59e0b; --err:#ef4444;
      --card:#1f2937; --chip:#0ea5e9;
    }
    *{box-sizing:border-box}
    body{margin:0;background:radial-gradient(1200px 800px at 20% -20%,#1e3a8a11,transparent),linear-gradient(180deg,#0b1220,#0f172a);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,"Noto Sans TC","PingFang TC",sans-serif}
    .wrap{max-width:1100px;margin:24px auto;padding:16px}
    .nav{display:flex;gap:16px;flex-wrap:wrap;margin-bottom:16px}
    .tab{padding:10px 14px;border-radius:12px;background:var(--panel);color:var(--text);text-decoration:none;opacity:.9}
    .tab.active{background:#1d2a44}
    .grid{display:grid;grid-template-columns:1fr 340px;gap:16px}
    @media (max-width:960px){.grid{grid-template-columns:1fr}}
    .card{background:linear-gradient(180deg,#101827,#0c1424);border:1px solid #1f2a44;border-radius:16px;padding:16px}
    h1{display:flex;align-items:center;gap:10px;font-size:22px;margin:0 0 12px}
    label{display:block;font-size:13px;color:var(--muted);margin:8px 2px}
    input,select,textarea{width:100%;background:#0b1220;border:1px solid #1f2a44;color:var(--text);border-radius:12px;padding:12px 14px;outline:none}
    textarea{min-height:120px;resize:vertical}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .btn{display:inline-flex;align-items:center;justify-content:center;gap:8px;padding:12px 16px;border-radius:12px;background:#22304f;color:#eaf2ff;border:1px solid #2a3a62;cursor:pointer}
    .btn.primary{background:#2a5ad7}
    .btn.success{background:#0f9d58}
    .btn.warn{background:#d97706}
    .btn.danger{background:#b91c1c}
    .btn.block{width:100%}
    .btnGroup{display:grid;grid-template-columns:repeat(3,1fr);gap:12px}
    .pill{display:inline-flex;align-items:center;gap:8px;padding:10px 14px;border-radius:14px;background:#10203a;border:1px solid #1f3258;cursor:pointer;text-align:center}
    .pill.active{outline:2px solid #3b82f6;background:#122a52}
    .list{display:flex;flex-direction:column;gap:10px}
    .item{display:flex;align-items:center;justify-content:space-between;background:#0b1220;border:1px solid #1f2a44;border-radius:12px;padding:10px 12px;font-size:14px}
    .muted{color:var(--muted);font-size:12px}
    .chips{display:flex;flex-wrap:wrap;gap:8px}
    .chip{background:#093144;border:1px solid #0b4b66;color:#9ae6ff;padding:8px 10px;border-radius:999px;font-size:12px}
    .rightSticky{position:sticky;top:12px}
    .tag{font-size:12px;color:#a1cdfc;background:#0e2344;border:1px solid #1b3c76;padding:6px 8px;border-radius:999px}
    .hr{height:1px;background:#1f2a44;margin:12px 0}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>ğŸ§¾ ä»˜æ¬¾ç®¡ç†ç³»çµ±</h1>

    <div class="grid">
      <!-- å·¦ï¼šä¸»è¦æ“ä½œ -->
      <div class="col-left">
        <!-- ç™¼é€ä»˜æ¬¾ -->
        <div class="card">
          <div class="nav">
            <span class="tab active">ç™¼é€ä»˜æ¬¾</span>
            <a class="tab" href="#orders">è¨‚å–®ç®¡ç†</a>
            <a class="tab" href="#meta">å®¢æˆ¶ç·¨è™Ÿ</a>
            <a class="tab" href="#tpl">è¨Šæ¯æ¨¡æ¿</a>
          </div>

          <label>ğŸ” å¿«é€ŸæŸ¥è©¢ï¼ˆè¼¸å…¥ã€Œç·¨è™Ÿã€æˆ–ã€Œå§“åã€ï¼‰</label>
          <div class="row">
            <input id="q" placeholder="ä¾‹å¦‚ï¼š625 æˆ– ç‹å°æ˜" />
            <button class="btn" id="btnQ">æŸ¥è©¢</button>
          </div>

          <div class="row" style="margin-top:10px">
            <div>
              <label>å®¢æˆ¶å§“å *</label>
              <input id="name" placeholder="å§“å" />
            </div>
            <div>
              <label>å®¢æˆ¶ LINE User ID *</label>
              <input id="uid" placeholder="Uxxxxxxxxxxxxxxxxxxxx" />
            </div>
          </div>

          <div class="row">
            <div>
              <label>é‡‘é¡ï¼ˆNT$ï¼‰*</label>
              <input id="amount" inputmode="numeric" placeholder="ä¾‹å¦‚ï¼š1500" />
            </div>
            <div>
              <label>ä»˜æ¬¾æ–¹å¼ *</label>
              <div class="btnGroup" id="payGroup">
                <div class="pill active" data-type="both">ğŸ’™ å…©è€…éƒ½ç™¼</div>
                <div class="pill" data-type="ecpay">ğŸ’³ ç¶ ç•Œä¿¡ç”¨å¡</div>
                <div class="pill" data-type="linepay">ğŸ’š LINE Pay</div>
              </div>
            </div>
          </div>

          <label style="margin-top:6px">è¨Šæ¯å…§å®¹ï¼ˆå¯å« {amount}ï¼‰</label>
          <textarea id="msg" placeholder="ä¾‹å¦‚ï¼šæ‚¨å¥½ï¼Œé‡‘é¡ NT$ {amount}ï¼Œè«‹å„˜é€Ÿä»˜æ¬¾ï¼Œè¬è¬ï¼"></textarea>

          <div class="row" style="margin-top:10px">
            <button class="btn primary block" id="btnSend">ç™¼é€ä»˜æ¬¾é€£çµ</button>
            <button class="btn" id="btnTpl">è¼‰å…¥æ¨¡æ¿</button>
          </div>

          <div class="hr"></div>
          <div>
            <div class="muted">åœ¨å³å´æœ‰ã€Œå®¢æˆ¶è¼‰å…¥ã€æ¸…å–®</div>
          </div>
        </div>

        <!-- å®¢æˆ¶ç·¨è™Ÿï¼šæ–°å¢/åˆªé™¤ -->
        <div class="card" id="meta">
          <div class="nav"><span class="tab active">å®¢æˆ¶ç·¨è™Ÿ</span></div>

          <div class="row">
            <div>
              <label>ç·¨è™Ÿï¼ˆå¯ç©ºç™½è‡ªå‹•éå¢ï¼‰</label>
              <input id="mNo" placeholder="ä¾‹å¦‚ï¼š625ï¼ˆç©ºç™½æœƒè‡ªå‹•çµ¦ï¼‰" />
            </div>
            <div>
              <label>å§“å *</label>
              <input id="mName" placeholder="ç‹å°æ˜" />
            </div>
          </div>
          <label>LINE User ID *</label>
          <input id="mUid" placeholder="Uxxxxxxxxxxxxxxxxxxxx" />

          <div style="margin-top:10px">
            <button class="btn success" id="btnSaveMeta">å„²å­˜</button>
          </div>

          <div class="hr"></div>
          <div>
            <div class="muted">å·²å„²å­˜</div>
            <div class="list" id="metaList"></div>
            <div style="margin-top:8px">
              <button class="btn" id="btnReloadMeta">é‡æ–°è¼‰å…¥</button>
            </div>
          </div>
        </div>

        <!-- è¨Šæ¯æ¨¡æ¿ -->
        <div class="card" id="tpl">
          <div class="nav"><span class="tab active">è¨Šæ¯æ¨¡æ¿</span></div>
          <div class="chips" id="tplList"></div>
          <div class="muted" style="margin-top:10px">é»ä¸€ä¸‹æ¨¡æ¿å³å¯å¥—ç”¨åˆ°ä¸Šæ–¹è¨Šæ¯æ¡†ã€‚</div>
        </div>
      </div>

      <!-- å³ï¼šå®¢æˆ¶è¼‰å…¥ -->
      <div class="col-right">
        <div class="card rightSticky">
          <div style="display:flex;align-items:center;justify-content:space-between">
            <span class="tag">å®¢æˆ¶è¼‰å…¥</span>
            <button class="btn" id="btnReloadSide">é‡æ–°è¼‰å…¥</button>
          </div>
          <div class="hr"></div>
          <div id="sideCustomers" class="list"></div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // å°å·¥å…·
    const $ = (id)=>document.getElementById(id);
    const state = { payType:'both', templates:[], meta:null };

    // ä»˜æ¬¾æ–¹å¼åˆ‡æ›
    document.querySelectorAll('#payGroup .pill').forEach(p=>{
      p.addEventListener('click', ()=>{
        document.querySelectorAll('#payGroup .pill').forEach(x=>x.classList.remove('active'));
        p.classList.add('active');
        state.payType = p.dataset.type;
      });
    });

    // æŸ¥è©¢ï¼ˆè¼¸å…¥ç·¨è™Ÿæˆ–å§“åï¼‰
    $('btnQ').onclick = async ()=>{
      const q = $('q').value.trim();
      if (!q) return;

      // å…ˆç”¨ /api/customer-meta å–å¾— map
      try{
        const r = await fetch('/api/customer-meta');
        const txt = await r.text();
        let d;
        try{ d = JSON.parse(txt) } catch(e){ alert('è®€å–å®¢æˆ¶è³‡æ–™å¤±æ•—ï¼š\n'+txt); return; }
        if (!d.success) return alert('è®€å–å®¢æˆ¶è³‡æ–™å¤±æ•—ï¼š'+(d.error||''));
        const { map } = d;
        // ä¾ç·¨è™Ÿæˆ–å§“åæ‰¾
        if (map[q]) {
          $('name').value = map[q].name || '';
          $('uid').value  = map[q].userId || '';
        } else {
          // ä»¥å§“ååæŸ¥
          const entry = Object.entries(map).find(([no,v]) => (v.name||'').includes(q));
          if (entry){
            $('name').value = entry[1].name || '';
            $('uid').value  = entry[1].userId || '';
          } else {
            alert('æ‰¾ä¸åˆ°ç›¸ç¬¦è³‡æ–™');
          }
        }
      }catch(e){ alert('é€£ç·šéŒ¯èª¤ï¼š'+e.message); }
    };

    // ç™¼é€ä»˜æ¬¾é€£çµ
    $('btnSend').onclick = async ()=>{
      const name = $('name').value.trim();
      const userId = $('uid').value.trim();
      const amount = $('amount').value.trim();
      const customMessage = $('msg').value.trim();
      if (!name || !userId || !amount) return alert('å§“åã€User IDã€é‡‘é¡å¿…å¡«');

      try{
        const r = await fetch('/send-payment',{
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify({
            userId, userName:name, amount,
            paymentType: state.payType,
            customMessage
          })
        });
        const txt = await r.text();
        let d;
        try{ d = JSON.parse(txt) } catch(e){ alert('ä¼ºæœå™¨æœªå› JSONï¼ŒåŸæ–‡ï¼š\n'+txt); return; }
        if (!d.success) return alert('ç™¼é€å¤±æ•—ï¼š'+(d.error||''));
        alert('âœ… å·²ç™¼é€ï¼');
      }catch(e){ alert('é€£ç·šéŒ¯èª¤ï¼š'+e.message); }
    };

    // è¼‰å…¥æ¨¡æ¿ï¼ˆé»æŒ‰éˆ•æœƒæŠŠç¬¬ä¸€ç­†æ”¾å…¥ï¼‰
    $('btnTpl').onclick = async ()=>{
      await fetchTemplates();
      if (state.templates.length){
        $('msg').value = state.templates[0];
      }else{
        alert('æ²’æœ‰æ¨¡æ¿è³‡æ–™');
      }
    };

    // å„²å­˜å®¢æˆ¶ç·¨è™Ÿï¼ˆâ† é€™æ®µæ˜¯é‡é»ï¼Œå…ˆç”¨ text å† JSON.parseï¼‰
    $('btnSaveMeta').onclick = async ()=>{
      const number = $('mNo').value.trim();
      const name   = $('mName').value.trim();
      const userId = $('mUid').value.trim();
      if (!name || !userId) return alert('è«‹è¼¸å…¥ å§“å èˆ‡ LINE User ID');

      try{
        const r = await fetch('/api/customer-meta/save',{
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ number: number?Number(number):undefined, name, userId })
        });
        const txt = await r.text();
        let d;
        try{ d = JSON.parse(txt) } catch(e){ alert('ä¼ºæœå™¨æœªå› JSONï¼ŒåŸå§‹å…§å®¹ï¼š\n'+txt); return; }
        if (!d.success) return alert('å„²å­˜å¤±æ•—ï¼š'+(d.error||''));
        await fetchMeta(); renderMeta(); renderSide();
        $('mNo').value=''; $('mName').value=''; $('mUid').value='';
      }catch(e){ alert('é€£ç·šéŒ¯èª¤ï¼š'+e.message); }
    };

    $('btnReloadMeta').onclick = async ()=>{ await fetchMeta(); renderMeta(); };
    $('btnReloadSide').onclick = async ()=>{ await fetchMeta(); renderSide(); };

    // åˆªé™¤å–®ç­†
    async function deleteMeta(no){
      if (!confirm(`ç¢ºå®šåˆªé™¤ #${no} ?`)) return;
      try{
        const r = await fetch(`/api/customer-meta/${encodeURIComponent(no)}`,{method:'DELETE'});
        const txt = await r.text();
        let d; try{ d=JSON.parse(txt) }catch(e){ alert('ä¼ºæœå™¨æœªå› JSONï¼š\n'+txt); return; }
        if (!d.success) return alert('åˆªé™¤å¤±æ•—ï¼š'+(d.error||''));
        await fetchMeta(); renderMeta(); renderSide();
      }catch(e){ alert('é€£ç·šéŒ¯èª¤ï¼š'+e.message); }
    }

    // è®€å–æ¨¡æ¿
    async function fetchTemplates(){
      try{
        const r = await fetch('/api/templates');
        const txt = await r.text();
        let d; try{ d=JSON.parse(txt) }catch(e){ alert('è®€å–æ¨¡æ¿éŒ¯èª¤ï¼š\n'+txt); return; }
        if (!d.success) return alert('è®€å–æ¨¡æ¿å¤±æ•—ï¼š'+(d.error||''));
        state.templates = d.templates || [];
        renderTpl();
      }catch(e){ alert('é€£ç·šéŒ¯èª¤ï¼š'+e.message); }
    }
    function renderTpl(){
      const box = $('tplList'); box.innerHTML='';
      (state.templates||[]).forEach((t,i)=>{
        const b = document.createElement('div');
        b.className='chip'; b.textContent = t; b.title='é»æ“Šå¥—ç”¨';
        b.onclick = ()=>{ $('msg').value = t; };
        box.appendChild(b);
      });
    }

    // è®€å– / æ¸²æŸ“å®¢æˆ¶ç·¨è™Ÿ
    async function fetchMeta(){
      try{
        const r = await fetch('/api/customer-meta');
        const txt = await r.text();
        let d; try{ d=JSON.parse(txt) }catch(e){ alert('è®€å–å®¢æˆ¶è³‡æ–™éŒ¯èª¤ï¼š\n'+txt); return; }
        if (!d.success) return alert('è®€å–å®¢æˆ¶è³‡æ–™å¤±æ•—ï¼š'+(d.error||''));
        state.meta = d;
      }catch(e){ alert('é€£ç·šéŒ¯èª¤ï¼š'+e.message); }
    }
    function renderMeta(){
      const list = $('metaList'); list.innerHTML='';
      if (!state.meta || !state.meta.map || !Object.keys(state.meta.map).length){
        const x = document.createElement('div'); x.className='muted'; x.textContent='å°šç„¡è³‡æ–™';
        list.appendChild(x); return;
      }
      Object.entries(state.meta.map).sort((a,b)=>Number(a[0])-Number(b[0])).forEach(([no,v])=>{
        const el = document.createElement('div'); el.className='item';
        const left = document.createElement('div');
        left.innerHTML = `<strong>#${no}</strong>ã€€${v.name||''}<div class="muted">${v.userId||''}</div>`;
        const del = document.createElement('button'); del.className='btn danger'; del.textContent='åˆªé™¤';
        del.onclick = ()=>deleteMeta(no);
        el.appendChild(left); el.appendChild(del); list.appendChild(el);
      });
    }
    function renderSide(){
      const box = $('sideCustomers'); box.innerHTML='';
      if (!state.meta || !state.meta.map || !Object.keys(state.meta.map).length){
        const x = document.createElement('div'); x.className='muted'; x.textContent='å°šç„¡å®¢æˆ¶';
        box.appendChild(x); return;
      }
      Object.entries(state.meta.map).sort((a,b)=>Number(a[0])-Number(b[0])).forEach(([no,v])=>{
        const el = document.createElement('div'); el.className='item';
        const btn = document.createElement('button'); btn.className='btn'; btn.textContent='å¥—ç”¨';
        btn.onclick = ()=>{
          $('name').value = v.name||''; $('uid').value = v.userId||'';
        };
        el.innerHTML = `<div><strong>#${no}</strong>ã€€${v.name||''}<div class="muted">${v.userId||''}</div></div>`;
        el.appendChild(btn);
        box.appendChild(el);
      });
    }

    // åˆå§‹åŒ–
    (async ()=>{
      await fetchTemplates();
      await fetchMeta(); renderMeta(); renderSide();
    })();
  </script>
</body>
</html>