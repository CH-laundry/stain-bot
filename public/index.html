<!doctype html>
<html lang="zh-TW">
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>C.H ç²¾ç·»æ´—è¡£ â€“ ä»˜æ¬¾ç®¡ç†</title>
<style>
  *{box-sizing:border-box} body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;background:#f6f7fb;margin:0}
  .wrap{max-width:1100px;margin:0 auto;padding:16px}
  .grid{display:grid;grid-template-columns:1.2fr .8fr;gap:16px}
  @media (max-width:900px){.grid{grid-template-columns:1fr}}
  .card{background:#fff;border-radius:16px;box-shadow:0 8px 30px rgba(0,0,0,.06);padding:16px}
  h2{margin:0 0 12px;color:#334}
  label{font-size:14px;color:#445;margin-top:10px;display:block}
  input,textarea,select{width:100%;padding:12px;border:2px solid #e5e7eb;border-radius:10px;font-size:16px}
  textarea{min-height:110px}
  .row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  .btn{display:inline-flex;align-items:center;justify-content:center;padding:12px 18px;border-radius:10px;border:none;color:#fff;background:#6366f1;font-weight:600;cursor:pointer;transition:all .2s}
  .btn:hover{opacity:.9;transform:translateY(-1px)}
  .btn:disabled{opacity:.6;cursor:not-allowed;transform:none}
  .btn-sec{background:#10b981}
  .btn-danger{background:#ef4444}
  .list{display:grid;gap:10px;max-height:60vh;overflow:auto}
  .item{border:1px solid #e5e7eb;border-radius:10px;padding:10px;display:flex;justify-content:space-between;align-items:center}
  .pill{display:inline-block;padding:2px 8px;border-radius:999px;background:#eef;color:#445;font-size:12px}
  .mt{margin-top:12px}
  .flex{display:flex;gap:8px;flex-wrap:wrap}
  .hint{font-size:12px;color:#6b7280}
  .rightHead{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
  .status-badge{display:inline-block;padding:4px 10px;border-radius:20px;font-size:11px;font-weight:600}
  .status-pending{background:#fef3c7;color:#92400e}
  .status-paid{background:#d1fae5;color:#065f46}
  .status-expired{background:#fee2e2;color:#7f1d1d}
</style>

<div class="wrap">
  <div class="grid">
    <!-- å·¦ï¼šç™¼é€ / æ¨¡æ¿ / ç·¨è™Ÿ -->
    <div class="card">
      <h2>ğŸ“¤ ç™¼é€ä»˜æ¬¾</h2>

      <div class="row">
        <div>
          <label>å®¢æˆ¶å§“å *</label>
          <input id="userName" placeholder="ç‹å°æ˜">
        </div>
        <div>
          <label>LINE User ID *</label>
          <input id="userId" placeholder="Uxxxxxxxxxxxxxxxxxxxx">
        </div>
      </div>

      <div class="row">
        <div>
          <label>é‡‘é¡ (NT$) *</label>
          <input id="amount" type="number" min="1" placeholder="1500">
        </div>
        <div>
          <label>ä»˜æ¬¾æ–¹å¼</label>
          <select id="paymentType">
            <option value="both">å…©è€…éƒ½ç™¼</option>
            <option value="ecpay">ç¶ ç•Œä¿¡ç”¨å¡</option>
            <option value="linepay">LINE Pay</option>
          </select>
        </div>
      </div>

      <label class="mt">è¨Šæ¯æ¨¡æ¿</label>
      <div id="tplBtns" class="flex"></div>
      <label class="mt">è¨Šæ¯å…§å®¹ï¼ˆ{amount} æœƒæ›æˆé‡‘é¡ï¼‰</label>
      <textarea id="customMessage" placeholder="æ‚¨å¥½ï¼Œé‡‘é¡ NT$ {amount}ï¼Œè«‹é»æ“Šä»˜æ¬¾ï¼Œè¬è¬ï¼"></textarea>

      <div class="mt flex">
        <button class="btn" id="sendBtn">ğŸ’™ ç™¼é€ä»˜æ¬¾é€£çµ</button>
        <span id="status" class="hint"></span>
      </div>

      <hr class="mt">

      <h2>ğŸ—‚ï¸ å®¢æˆ¶ç·¨è™Ÿ</h2>
      <div class="row">
        <div>
          <label>ç·¨è™Ÿï¼ˆå¯ç•™ç©ºè‡ªå‹•éå¢ï¼‰</label>
          <input id="newNo" placeholder="å¦‚ 755">
        </div>
        <div>
          <label>å§“å *</label>
          <input id="newName" placeholder="ç‹å°æ˜">
        </div>
      </div>
      <div class="row">
        <div>
          <label>LINE User ID *</label>
          <input id="newUid" placeholder="Uxxxxxxxxxxxxxxxxxxxx">
        </div>
        <div class="mt" style="display:flex;align-items:end">
          <button id="saveNoBtn" class="btn-sec btn" style="width:100%">ğŸ’¾ å„²å­˜å®¢æˆ¶</button>
        </div>
      </div>

      <div class="mt">
        <label>å¿«é€ŸæŸ¥è©¢ï¼ˆç·¨è™Ÿæˆ–å§“åï¼‰</label>
        <div class="row">
          <input id="q" placeholder="è¼¸å…¥ç·¨è™Ÿæˆ–å§“å">
          <button id="qBtn" class="btn">æŸ¥è©¢ / å¸¶å…¥</button>
        </div>
      </div>
    </div>

    <!-- å³ï¼šå®¢æˆ¶æ¸…å–® + æ¨¡æ¿ç®¡ç† + è¨‚å–®æŸ¥è©¢ -->
    <div class="card">
      <div class="rightHead">
        <h2>ğŸ‘¥ å®¢æˆ¶æ¸…å–®</h2>
        <button id="reloadUsers" class="btn" style="padding:8px 12px;font-size:13px">é‡æ–°è¼‰å…¥</button>
      </div>
      <div id="userList" class="list"><div class="hint">å°šç„¡è³‡æ–™</div></div>

      <hr class="mt">

      <h2>ğŸ“ æ¨¡æ¿ç®¡ç†</h2>
      <div class="row">
        <input id="newTpl" placeholder="è¼¸å…¥æ¨¡æ¿ï¼Œä¾‹ï¼šæ‚¨å¥½ï¼Œé‡‘é¡ NT$ {amount}">
        <button id="addTplBtn" class="btn-sec btn">æ–°å¢æ¨¡æ¿</button>
      </div>
      <div id="tplList" class="list mt"></div>

      <hr class="mt">

      <h2>ğŸ“Š è¨‚å–®çµ±è¨ˆ</h2>
      <div id="stats" style="display:grid;grid-template-columns:1fr 1fr;gap:8px;font-size:13px">
        <div><strong>ç¸½è¨‚å–®</strong>: <span id="stat-total">0</span></div>
        <div><strong>å¾…ä»˜</strong>: <span id="stat-pending">0</span></div>
        <div><strong>å·²ä»˜</strong>: <span id="stat-paid">0</span></div>
        <div><strong>å¾…æé†’</strong>: <span id="stat-remind">0</span></div>
      </div>
    </div>
  </div>
</div>

<script>
const $ = (id)=>document.getElementById(id);

// API helpers
async function getJSON(url){ const r=await fetch(url); return r.json(); }
async function postJSON(url, body){
  const r=await fetch(url,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(body||{})});
  return r.json();
}
async function del(url){ const r=await fetch(url,{method:'DELETE'}); return r.json(); }

// ===== æ¨¡æ¿ =====
let templates=[];
async function loadTemplates(){
  try{
    const d = await getJSON('/api/templates');
    if (d.success) templates = d.templates || [];
  }catch{ templates = []; }
  drawTplButtons(); drawTplList();
}
function drawTplButtons(){
  const box = $('tplBtns'); box.innerHTML='';
  templates.forEach((t,i)=>{
    const b=document.createElement('button');
    b.className='btn';
    b.style.fontSize='13px';
    b.style.padding='8px 12px';
    b.textContent = (t.length>16? t.slice(0,16)+'â€¦':t);
    b.onclick=()=>{ $('customMessage').value = t; };
    box.appendChild(b);
  });
}
function drawTplList(){
  const box = $('tplList'); box.innerHTML='';
  if (!templates.length){ box.innerHTML='<div class="hint">å°šç„¡æ¨¡æ¿</div>'; return; }
  templates.forEach((t,i)=>{
    const div=document.createElement('div'); div.className='item';
    div.innerHTML = `<div style="white-space:pre-wrap;max-width:70%;font-size:13px">${t}</div>`;
    const r=document.createElement('div'); r.className='flex';
    const delBtn=document.createElement('button'); delBtn.className='btn-danger btn'; delBtn.textContent='åˆªé™¤'; delBtn.style.padding='6px 10px'; delBtn.style.fontSize='12px';
    delBtn.onclick=async()=>{ const d=await del('/api/templates/'+i); if(d.success){ templates=d.templates; drawTplButtons(); drawTplList(); } };
    r.appendChild(delBtn);
    div.appendChild(r);
    box.appendChild(div);
  });
}
$('addTplBtn').onclick = async ()=>{
  const t = $('newTpl').value.trim(); if (!t) return;
  const d = await postJSON('/api/templates', { content:t });
  if (d.success){ templates=d.templates; $('newTpl').value=''; drawTplButtons(); drawTplList(); }
};

// ===== å®¢æˆ¶ç·¨è™Ÿ =====
let customerMap = {};
async function loadCustomerMeta(){
  const d = await getJSON('/api/customer-meta');
  if (d.success){ customerMap = d.map||{}; drawUsers(); }
}
$('saveNoBtn').onclick = async ()=>{
  const number = $('newNo').value.trim();
  const name   = $('newName').value.trim();
  const userId = $('newUid').value.trim();
  if (!name || !userId){ alert('è«‹å¡«å§“åèˆ‡ User ID'); return; }
  const d = await postJSON('/api/customer-meta/save',{ number: number?Number(number):undefined, name, userId });
  if (d.success){
    customerMap[d.number] = d.data;
    $('newNo').value=''; $('newName').value=''; $('newUid').value='';
    drawUsers();
  } else alert('å„²å­˜å¤±æ•—ï¼š'+(d.error||''));
};
function drawUsers(){
  const box = $('userList'); box.innerHTML='';
  const entries = Object.entries(customerMap);
  if (!entries.length){ box.innerHTML='<div class="hint">å°šç„¡å®¢æˆ¶</div>'; return; }
  entries.sort((a,b)=> Number(a[0])-Number(b[0]));
  entries.forEach(([no, c])=>{
    const row = document.createElement('div'); row.className='item';
    const left = document.createElement('div');
    left.innerHTML = `<div><strong>#${no}</strong>ã€€<span class="pill">${c.name||'-'}</span></div><div class="hint" style="margin-top:2px">${(c.userId||'-').slice(0,20)}â€¦</div>`;
    const right = document.createElement('div'); right.className='flex';
    const fill = document.createElement('button'); fill.className='btn'; fill.textContent='å¸¶å…¥'; fill.style.padding='6px 10px'; fill.style.fontSize='12px';
    fill.onclick=()=>{ $('userName').value=c.name||''; $('userId').value=c.userId||''; window.scrollTo({top:0,behavior:'smooth'}); };
    const delBtn = document.createElement('button'); delBtn.className='btn-danger btn'; delBtn.textContent='åˆªé™¤'; delBtn.style.padding='6px 10px'; delBtn.style.fontSize='12px';
    delBtn.onclick=async()=>{ if(!confirm(`åˆªé™¤ #${no}?`))return; const d=await del('/api/customer-meta/'+no); if(d.success){ delete customerMap[no]; drawUsers(); } };
    right.appendChild(fill); right.appendChild(delBtn);
    row.appendChild(left); row.appendChild(right);
    box.appendChild(row);
  });
}
$('qBtn').onclick = ()=>{
  const q = $('q').value.trim(); if(!q) return;
  if (customerMap[q]) {
    const c=customerMap[q]; $('userName').value=c.name||''; $('userId').value=c.userId||''; return;
  }
  const found = Object.entries(customerMap).find(([no,c])=> (c.name||'').includes(q));
  if (found){ const [,c]=found; $('userName').value=c.name||''; $('userId').value=c.userId||''; }
  else alert('æ‰¾ä¸åˆ°æ­¤å®¢æˆ¶');
};
$('reloadUsers').onclick = loadCustomerMeta;

// ===== ç™¼é€ä»˜æ¬¾ =====
$('sendBtn').onclick = async ()=>{
  const userId = $('userId').value.trim();
  const userName = $('userName').value.trim();
  const amount = parseInt($('amount').value,10);
  const paymentType = $('paymentType').value;
  const customMessage = $('customMessage').value.trim().replace('{amount}', (amount||0).toLocaleString());
  if (!userId || !userName || !amount){ $('status').textContent='âŒ ç¼ºå°‘å¿…è¦æ¬„ä½'; return; }
  $('status').textContent='ç™¼é€ä¸­â€¦';
  try{
    const d = await postJSON('/api/send-payment', { userId, userName, amount, paymentType, customMessage });
    if (d.success){ 
      $('status').textContent='âœ… å·²ç™¼é€åˆ° LINE'; 
      setTimeout(()=>{ $('status').textContent=''; }, 3000);
      $('userName').value=''; $('userId').value=''; $('amount').value=''; $('customMessage').value='';
      loadStats();
    }
    else { $('status').textContent='âŒ å¤±æ•—ï¼š'+(d.error||''); }
  }catch(e){ $('status').textContent='âŒ ç¶²è·¯éŒ¯èª¤'; }
};

// ===== è¨‚å–®çµ±è¨ˆ =====
async function loadStats(){
  try{
    const d = await getJSON('/api/orders');
    if (d.success && d.statistics){
      $('stat-total').textContent = d.statistics.total;
      $('stat-pending').textContent = d.statistics.pending;
      $('stat-paid').textContent = d.statistics.paid;
      $('stat-remind').textContent = d.statistics.needReminder;
    }
  }catch(e){ console.error('è¼‰å…¥çµ±è¨ˆå¤±æ•—', e); }
}

// ===== åˆæ¬¡è¼‰å…¥ + å®šæœŸæ›´æ–° =====
(async ()=>{
  await loadTemplates();
  await loadCustomerMeta();
  await loadStats();
  // æ¯ 30 ç§’æ›´æ–°ä¸€æ¬¡çµ±è¨ˆ
  setInterval(loadStats, 30000);
})();
</script>