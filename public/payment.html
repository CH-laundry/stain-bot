<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>C.H ç²¾ç·»æ´—è¡£ - ä»˜æ¬¾ç®¡ç†ç³»çµ±</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: 'Segoe UI', sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; padding: 20px; }
    .container { max-width: 900px; margin: 0 auto; background: #fff; border-radius: 20px; padding: 30px; box-shadow: 0 20px 60px rgba(0,0,0,.3); }
    h1 { color: #667eea; text-align: center; margin-bottom: 10px; font-size: 28px; }
    .subtitle { text-align: center; color: #666; margin-bottom: 30px; font-size: 14px; }
    .tabs { display: flex; gap: 10px; margin-bottom: 30px; border-bottom: 2px solid #e0e0e0; flex-wrap: wrap; }
    .tab { padding: 12px 20px; background: none; border: none; color: #666; font-size: 15px; font-weight: 600; cursor: pointer; border-bottom: 3px solid transparent; transition: all .3s; }
    .tab:hover { color: #667eea; }
    .tab.active { color: #667eea; border-bottom-color: #667eea; }
    .tab-content { display: none; }
    .tab-content.active { display: block; }
    .form-group { margin-bottom: 20px; }
    label { display: block; margin-bottom: 8px; color: #333; font-weight: 600; font-size: 14px; }
    input, textarea, select { width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 10px; font-size: 16px; transition: all .3s; font-family: inherit; }
    textarea { min-height: 120px; resize: vertical; }
    input:focus, textarea:focus, select:focus { outline: none; border-color: #667eea; box-shadow: 0 0 0 3px rgba(102,126,234,.1); }
    .quick-search { display: flex; gap: 10px; }
    .btn { width: 100%; padding: 15px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: #fff; border: none; border-radius: 12px; font-size: 18px; font-weight: 600; cursor: pointer; transition: all .3s; }
    .btn:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(102,126,234,.6); }
    .btn:disabled { background: #ccc; cursor: not-allowed; transform: none; }
    .btn-small { padding: 10px 20px; font-size: 14px; width: auto; }
    .btn-secondary { background: linear-gradient(135deg, #52c41a 0%, #389e0d 100%); }
    .btn-danger { background: linear-gradient(135deg, #dc3545 0%, #c82333 100%); }
    .payment-options { display: grid; grid-template-columns: repeat(3,1fr); gap: 15px; margin-bottom: 20px; }
    .payment-option { position: relative; }
    .payment-option input[type="radio"] { position: absolute; opacity: 0; }
    .payment-option label { display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 15px; border: 2px solid #e0e0e0; border-radius: 15px; cursor: pointer; transition: all .3s; text-align: center; height: 100%; }
    .payment-option input[type="radio"]:checked + label { border-color: #667eea; background: #f0f4ff; transform: translateY(-2px); box-shadow: 0 5px 15px rgba(102,126,234,.2); }
    .payment-icon { font-size: 28px; margin-bottom: 5px; }
    .payment-name { font-size: 13px; font-weight: 600; color: #333; }
    .message-templates { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; margin-bottom: 15px; }
    .template-btn { padding: 12px; background: #f5f5f5; border: 2px solid #e0e0e0; border-radius: 8px; cursor: pointer; font-size: 14px; transition: all .3s; text-align: left; }
    .template-btn:hover { border-color: #667eea; background: #f0f4ff; }
    .template-btn.active { border-color: #667eea; background: #e7f0ff; }
    .result { margin-top: 20px; padding: 20px; border-radius: 12px; display: none; }
    .result.success { background: #d4edda; border: 2px solid #28a745; color: #155724; }
    .result.error { background: #f8d7da; border: 2px solid #dc3545; color: #721c24; }
    .loading { display: none; text-align: center; margin-top: 20px; }
    .loading-spinner { border: 4px solid #f3f3f3; border-top: 4px solid #667eea; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin: 0 auto 10px; }
    @keyframes spin { 0%{transform:rotate(0)} 100%{transform:rotate(360deg)} }
    .user-item { background: #f8f9fa; padding: 15px; margin-bottom: 10px; border-radius: 8px; border: 1px solid #e0e0e0; transition: all .3s; display: flex; align-items: center; gap: 15px; }
    .user-item:hover { border-color: #667eea; box-shadow: 0 2px 8px rgba(102,126,234,.2); }
    .user-info { flex: 1; cursor: pointer; }
    .user-info strong { color: #333; font-size: 16px; display: block; margin-bottom: 5px; }
    .user-info small { display: block; color: #999; font-size: 12px; margin-top: 3px; }
    .customer-card { background: #f0f4ff; padding: 15px; border-radius: 10px; margin-bottom: 20px; border-left: 4px solid #667eea; }
    .customer-card h4 { color: #667eea; margin-bottom: 10px; }
    .customer-card p { margin: 5px 0; font-size: 14px; color: #333; }
    .template-item { background: #fff; padding: 12px; margin-bottom: 10px; border-radius: 8px; border: 1px solid #e0e0e0; }
    @media (max-width: 768px){
      .container{padding:20px}
      h1{font-size:24px}
      .payment-options{grid-template-columns:1fr}
      .message-templates{grid-template-columns:1fr}
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>ğŸ’³ ä»˜æ¬¾ç®¡ç†ç³»çµ±</h1>
    <p class="subtitle">C.H ç²¾ç·»æ´—è¡£ - ç™¼é€ä»˜æ¬¾é€£çµçµ¦å®¢æˆ¶</p>

    <div class="tabs">
      <button class="tab active" onclick="switchTab(event,'payment')">ğŸ’³ ç™¼é€ä»˜æ¬¾</button>
      <button class="tab" onclick="switchTab(event,'orders')">ğŸ“¦ è¨‚å–®ç®¡ç†</button>
      <button class="tab" onclick="switchTab(event,'customers')">ğŸ“‹ å®¢æˆ¶ç·¨è™Ÿ</button>
      <button class="tab" onclick="switchTab(event,'templates')">ğŸ“ è¨Šæ¯æ¨¡æ¿</button>
      <button class="tab" onclick="switchTab(event,'users')">ğŸ‘¥ å®¢æˆ¶åˆ—è¡¨</button>
      <button class="tab" onclick="switchTab(event,'pickup')">ğŸ§º å–ä»¶è¿½è¹¤</button>
    </div>

    <div id="payment-tab" class="tab-content active">
      <div class="form-group">
        <label>ğŸ” å¿«é€ŸæŸ¥è©¢</label>
        <div class="quick-search">
          <input type="text" id="quickSearch" placeholder="è¼¸å…¥ç·¨è™Ÿæˆ–å§“å">
          <button class="btn btn-small" onclick="quickSearchCustomer()">æŸ¥è©¢</button>
        </div>
      </div>

      <div id="customerCard" class="customer-card" style="display:none;">
        <h4>âœ… å®¢æˆ¶è³‡è¨Š</h4>
        <p><strong>ç·¨è™Ÿ:</strong> <span id="cardNumber"></span></p>
        <p><strong>å§“å:</strong> <span id="cardName"></span></p>
        <p><strong>User ID:</strong> <span id="cardUserId"></span></p>
      </div>

      <form id="paymentForm">
        <div class="form-group">
          <label>å®¢æˆ¶ LINE User ID *</label>
          <input type="text" id="userId" placeholder="U1234567890abcdef" required>
        </div>
        <div class="form-group">
          <label>å®¢æˆ¶å§“å *</label>
          <input type="text" id="userName" placeholder="ç‹å°æ˜" required>
        </div>
        <div class="form-group">
          <label>ä»˜æ¬¾é‡‘é¡ (NT$) *</label>
          <input type="number" id="amount" placeholder="1500" min="1" required>
        </div>

        <div class="form-group">
          <label>ä»˜æ¬¾æ–¹å¼ *</label>
          <div class="payment-options">
            <div class="payment-option">
              <input type="radio" id="both" name="paymentType" value="both" checked>
              <label for="both"><div class="payment-icon">ğŸ’™</div><div class="payment-name">å…©è€…éƒ½ç™¼</div></label>
            </div>
            <div class="payment-option">
              <input type="radio" id="ecpay" name="paymentType" value="ecpay">
              <label for="ecpay"><div class="payment-icon">ğŸ’³</div><div class="payment-name">ç¶ ç•Œæ”¯ä»˜</div></label>
            </div>
            <div class="payment-option">
              <input type="radio" id="linepay" name="paymentType" value="linepay">
              <label for="linepay"><div class="payment-icon">ğŸ’š</div><div class="payment-name">LINE Pay</div></label>
            </div>
          </div>
        </div>

        <div class="form-group">
          <label>è¨Šæ¯å…§å®¹</label>
          <div id="customTemplates" class="message-templates"></div>
          <textarea id="customMessage" placeholder="è¼¸å…¥è¨Šæ¯å…§å®¹,ä½¿ç”¨ {amount} æœƒè‡ªå‹•æ›¿æ›æˆé‡‘é¡&#10;&#10;ä¾‹å¦‚: æ‚¨å¥½,å·²æ”¶å›è¡£ç‰©,é‡‘é¡ NT$ {amount},è«‹å„˜é€Ÿä»˜æ¬¾,è¬è¬!"></textarea>
        </div>

       <button type="submit" class="btn" id="submitBtn">ğŸ’™ ç™¼é€ä»˜æ¬¾é€£çµ</button>
      </form>

      <!-- â­â­â­ æ–°å¢ï¼šç´”æ–‡å­—é€šçŸ¥åŠŸèƒ½ â­â­â­ -->
      <div style="margin-top: 40px; padding-top: 30px; border-top: 3px dashed #e0e0e0;">
        <h3 style="color: #667eea; margin-bottom: 20px;">ğŸ“¢ ç´”æ–‡å­—é€šçŸ¥ï¼ˆç„¡ä»˜æ¬¾é€£çµï¼‰</h3>
        <p style="color: #666; font-size: 14px; margin-bottom: 15px;">é©ç”¨æ–¼ï¼šå·²ä»˜æ¬¾å®¢æˆ¶ã€åƒ…éœ€é€šçŸ¥é€é”ç­‰æƒ…æ³</p>
        
        <form id="notificationForm">
          <div class="form-group">
            <label>å®¢æˆ¶ User ID *</label>
            <input type="text" id="notifyUserId" placeholder="U1234567890abcdef" required>
          </div>
          <div class="form-group">
            <label>å®¢æˆ¶å§“å *</label>
            <input type="text" id="notifyUserName" placeholder="ç‹å°æ˜" required>
          </div>
          
          <div class="form-group">
            <label>é€šçŸ¥è¨Šæ¯æ¨¡æ¿</label>
            <div id="notifyTemplates" class="message-templates"></div>
            <textarea id="notifyMessage" placeholder="è¼¸å…¥é€šçŸ¥å…§å®¹ï¼Œä¾‹å¦‚ï¼š&#10;&#10;è¦ªæ„›çš„å®¢æˆ¶æ‚¨å¥½ï¼Œæ‚¨çš„è¡£ç‰©å·²é€é”åº—å…§ï¼Œæ­¡è¿å–ä»¶ï¼Œè¬è¬ï¼" required></textarea>
          </div>

          <div style="display: flex; gap: 10px; margin-bottom: 15px;">
            <button type="button" class="btn btn-secondary btn-small" onclick="saveNotifyTemplate()">ğŸ’¾ å„²å­˜æ­¤è¨Šæ¯ç‚ºæ¨¡æ¿</button>
            <button type="button" class="btn btn-small" style="background: #ff9800;" onclick="loadNotifyTemplates()">ğŸ”„ é‡æ–°è¼‰å…¥æ¨¡æ¿</button>
          </div>

          <button type="submit" class="btn" style="background: linear-gradient(135deg, #52c41a 0%, #389e0d 100%);">ğŸ“¢ ç™¼é€ç´”æ–‡å­—é€šçŸ¥</button>
        </form>
      </div>
      <!-- â­â­â­ ç´”æ–‡å­—é€šçŸ¥çµæŸ â­â­â­ -->

      <div class="loading" id="loading">
        <div class="loading-spinner"></div>
        <p>æ­£åœ¨ç™¼é€...</p>
      </div>
      <div class="result" id="result"></div>
    </div>

    <div id="orders-tab" class="tab-content">
      <h3 style="color:#667eea; margin-bottom:20px;">ğŸ“¦ è¨‚å–®ç®¡ç†</h3>
      <div style="display:flex; gap:10px; margin-bottom:20px; flex-wrap:wrap;">
        <button class="btn btn-secondary btn-small" onclick="loadOrders()">ğŸ”„ é‡æ–°æ•´ç†</button>
        <button class="btn btn-secondary btn-small" onclick="sendReminders()">â° ç™¼é€ä»˜æ¬¾æé†’</button>
        <button class="btn btn-secondary btn-small" onclick="cleanExpired()">ğŸ§¹ æ¸…ç†éæœŸè¨‚å–®</button>
      </div>

      <div id="orderStats" style="display:grid; grid-template-columns:repeat(auto-fit, minmax(150px, 1fr)); gap:15px; margin-bottom:20px;"></div>

      <div class="form-group">
        <label>ğŸ” å¿«é€Ÿæœå°‹è¨‚å–®</label>
        <input type="text" id="orderSearchInput" placeholder="è¼¸å…¥è¨‚å–®ç·¨è™Ÿæˆ–å®¢æˆ¶å§“å" oninput="searchOrders()">
      </div>

      <div style="margin-bottom:15px;">
        <label style="font-size:14px; color:#666;">ç¯©é¸ç‹€æ…‹:</label>
        <select id="orderStatusFilter" onchange="filterOrders()" style="padding:8px; border-radius:8px; border:2px solid #e0e0e0;">
          <option value="">å…¨éƒ¨è¨‚å–®</option>
          <option value="pending">å¾…ä»˜æ¬¾</option>
          <option value="paid">å·²ä»˜æ¬¾</option>
          <option value="expired">å·²éæœŸ</option>
        </select>
      </div>

      <div id="orderList"><p style="text-align:center; color:#999;">å°šæœªè¼‰å…¥è¨‚å–®ï¼Œè«‹é»ã€Œé‡æ–°æ•´ç†ã€ã€‚</p></div>

      <div id="customerHistoryModal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,.5); z-index:1000; padding:20px; overflow:auto;">
        <div style="background:#fff; max-width:800px; margin:50px auto; border-radius:20px; padding:30px; position:relative;">
          <button onclick="closeCustomerHistory()" style="position:absolute; top:15px; right:15px; background:#dc3545; color:#fff; border:none; padding:8px 15px; border-radius:5px; cursor:pointer; font-size:16px;">âœ•</button>
          <h3 style="color:#667eea; margin-bottom:20px;">ğŸ‘¤ å®¢æˆ¶ä»˜æ¬¾æ­·å²</h3>
          <div id="customerHistoryContent"></div>
        </div>
      </div>
    </div>

    <div id="customers-tab" class="tab-content">
      <h3 style="color:#667eea; margin-bottom:20px;">ğŸ“‹ å®¢æˆ¶ç·¨è™Ÿç®¡ç†</h3>
      ### å®¢æˆ¶ç·¨è™Ÿç®¡ç†
    <input id="user-id-input" placeholder="User ID (e.g. Uxxxxxx)" style="width:300px;margin:5px;">
    <input id="user-name-input" placeholder="å§“å" style="width:150px;margin:5px;">
    <button id="save-user" style="margin:5px;">å„²å­˜ User ID</button>
    <button id="send-payment" style="margin:5px;">ç™¼é€æ”¯ä»˜é€£çµ</button>
    <input id="amount" type="number" placeholder="é‡‘é¡" style="width:120px;margin:5px;">

<div id="customer-list" style="margin-top:15px; max-height:200px; overflow-y:auto; border:1px solid #ccc; padding:10px;"></div>
      <div class="form-group">
        <label>å®¢æˆ¶ç·¨è™Ÿ</label>
        <input type="text" id="newCustomerNumber" placeholder="ä¾‹å¦‚: 755">
      </div>
      <div class="form-group">
        <label>å®¢æˆ¶å§“å</label>
        <input type="text" id="newCustomerName" placeholder="ä¾‹å¦‚: ç‹å°æ˜">
      </div>
      <div class="form-group">
        <label>User ID</label>
        <input type="text" id="newCustomerUserId" placeholder="U1234567890abcdef">
      </div>
      <button class="btn btn-secondary" onclick="saveCustomerNumber()">ğŸ’¾ å„²å­˜å®¢æˆ¶ç·¨è™Ÿ</button>

      <div style="margin-top:30px;">
        <h4 style="color:#667eea; margin-bottom:15px;">å·²å„²å­˜çš„å®¢æˆ¶ç·¨è™Ÿ</h4>
        <div id="savedCustomers"></div>
      </div>
    </div>

    <div id="templates-tab" class="tab-content">
      <h3 style="color:#667eea; margin-bottom:20px;">ğŸ“ è¨Šæ¯æ¨¡æ¿ç®¡ç†</h3>
      <div class="form-group">
        <label>æ–°å¢æ¨¡æ¿ (ä½¿ç”¨ {amount} ä»£è¡¨é‡‘é¡)</label>
        <textarea id="newTemplateContent" placeholder="ä¾‹å¦‚: æ‚¨å¥½,å·²æ”¶å›è¡£ç‰©,é‡‘é¡ NT$ {amount},è«‹å„˜é€Ÿä»˜æ¬¾,è¬è¬!"></textarea>
      </div>
      <button class="btn btn-secondary" onclick="saveTemplate()">ğŸ’¾ å„²å­˜æ¨¡æ¿</button>

      <div style="margin-top:30px;">
        <h4 style="color:#667eea; margin-bottom:15px;">æˆ‘çš„æ¨¡æ¿</h4>
        <div id="templateList"></div>
      </div>
    </div>

    <div id="users-tab" class="tab-content">
      <h3 style="color:#667eea; margin-bottom:20px;">ğŸ‘¥ å®¢æˆ¶åˆ—è¡¨</h3>
      <button class="btn btn-secondary btn-small" onclick="loadUsers()" style="margin-bottom:20px;">ğŸ”„ é‡æ–°è¼‰å…¥</button>
      <div id="userList"><p style="text-align:center; color:#999;">å°šæœªè¼‰å…¥ï¼Œè«‹é»ã€Œé‡æ–°è¼‰å…¥ã€ã€‚</p></div>
    </div>
  </div>
<!-- ğŸ§º å–ä»¶è¿½è¹¤åˆ†é  -->
    <div id="pickup-tab" class="tab-content">
      <h3 style="color:#667eea; margin-bottom:20px;">ğŸ§º å–ä»¶è¿½è¹¤ç®¡ç†</h3>
      
      <div class="form-group">
        <label>ğŸ” å¿«é€ŸæŸ¥è©¢å®¢æˆ¶ï¼ˆç”¨å®¢æˆ¶ç·¨è™Ÿï¼‰</label>
        <div class="quick-search">
          <input type="text" id="pickupSearch" placeholder="è¼¸å…¥ç·¨è™Ÿï¼ˆä¾‹å¦‚: 001ã€625ï¼‰">
          <button class="btn btn-small" onclick="searchForPickup()">æŸ¥è©¢</button>
        </div>
      </div>

      <div id="pickupCustomerCard" class="customer-card" style="display:none;">
        <h4>âœ… å®¢æˆ¶è³‡è¨Š</h4>
        <p><strong>ç·¨è™Ÿ:</strong> <span id="pickupCardNumber"></span></p>
        <p><strong>å§“å:</strong> <span id="pickupCardName"></span></p>
        <p><strong>User ID:</strong> <span id="pickupCardUserId"></span></p>
      </div>

      <div style="background:#f8f9fa; padding:20px; border-radius:10px; margin-bottom:20px;">
        <h4 style="color:#667eea; margin-bottom:15px;">â• æ–°å¢å–ä»¶è¿½è¹¤</h4>
        <div class="form-group">
          <label>å®¢æˆ¶ç·¨è™Ÿ *</label>
          <input type="text" id="pickupNumber" placeholder="001">
        </div>
        <div class="form-group">
          <label>å®¢æˆ¶å§“å *</label>
          <input type="text" id="pickupName" placeholder="ç‹å°æ˜">
        </div>
        <div class="form-group">
          <label>User ID *</label>
          <input type="text" id="pickupUserId" placeholder="U123...">
        </div>
        <button class="btn btn-secondary" onclick="startPickup()">ğŸ¯ é–‹å§‹è¿½è¹¤ï¼ˆ7å¤©å¾Œ11é»æé†’ï¼‰</button>
      </div>

      <div style="display:flex; gap:10px; margin-bottom:20px; flex-wrap:wrap;">
        <button class="btn btn-small btn-secondary" onclick="loadPickups()">ğŸ”„ é‡æ–°æ•´ç†</button>
        <button class="btn btn-small btn-secondary" onclick="editTemplate()">ğŸ“ ç·¨è¼¯æ¨¡æ¿</button>
      </div>

      <div id="pickupList"><p style="text-align:center; color:#999;">å°šæœªè¼‰å…¥ï¼Œè«‹é»ã€Œé‡æ–°æ•´ç†ã€ã€‚</p></div>
    </div>

    <!-- æ¨¡æ¿ç·¨è¼¯ Modal -->
    <div id="templateModal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,.6); z-index:9999;">
      <div style="background:#fff; max-width:600px; margin:50px auto; padding:30px; border-radius:15px;">
        <h3>ğŸ“ ç·¨è¼¯æé†’æ¨¡æ¿</h3>
        <p style="font-size:13px; color:#666; margin-bottom:15px;">å¯ç”¨è®Šæ•¸ï¼š{å®¢æˆ¶å§“å}ã€{å®¢æˆ¶ç·¨è™Ÿ}ã€{å·²éå¤©æ•¸}</p>
        <textarea id="templateText" style="width:100%; min-height:120px; padding:10px; margin:15px 0; border:2px solid #e0e0e0; border-radius:8px;"></textarea>
        <div style="display:flex; gap:10px;">
          <button class="btn btn-secondary" onclick="saveTemplatePickup()">ğŸ’¾ å„²å­˜</button>
          <button class="btn" onclick="closeTemplateModal()">å–æ¶ˆ</button>
        </div>
      </div>
    </div>
  <script>
    var allUsers = [];
    var allOrders = [];
    var savedCustomers = {};
    var savedTemplates = [];
    var allPickupOrders = [];

    async function initLoad() {
      try {
        await loadCustomerNumbers();
        await loadTemplates();
        loadCustomTemplates();
      } catch (error) {
        console.error('åˆå§‹åŒ–å¤±æ•—:', error);
      }
    }

    function switchTab(evt, tabName) {
      document.querySelectorAll('.tab').forEach(function(tab) { tab.classList.remove('active'); });
      document.querySelectorAll('.tab-content').forEach(function(content) { content.classList.remove('active'); });
      if (evt && evt.currentTarget) evt.currentTarget.classList.add('active');
      var pane = document.getElementById(tabName + '-tab');
      if (pane) pane.classList.add('active');

      if (tabName === 'payment') loadCustomTemplates();
      if (tabName === 'customers') displaySavedCustomers();
      if (tabName === 'templates') displayTemplates();
      if (tabName === 'users') loadUsers();
      if (tabName === 'orders') loadOrders();
      if (tabName === 'pickup') loadPickups();
    }

    async function loadCustomerNumbers() {
      try {
        var res = await fetch('/api/customer-numbers');
        var data = await res.json();
        if (data.success) {
          savedCustomers = {};
          (data.customers || []).forEach(function(c) {
            savedCustomers[c.number] = { name: c.name, userId: c.userId };
          });
        }
      } catch (error) {
        console.error('è¼‰å…¥å®¢æˆ¶ç·¨è™Ÿå¤±æ•—:', error);
      }
    }

   async function saveCustomerNumber() {
     var number = document.getElementById('newCustomerNumber').value.trim();
     var name = document.getElementById('newCustomerName').value.trim();
     var userId = document.getElementById('newCustomerUserId').value.trim();
     if (!number || !name || !userId) {
       alert('è«‹å®Œæ•´è¼¸å…¥ ç·¨è™Ÿ / å§“å / User ID');
       return;
     }

     // â­ æ–°å¢ï¼šæª¢æŸ¥ç·¨è™Ÿæ˜¯å¦é‡è¤‡
     if (savedCustomers[number]) {
       showResult('error', 'âŒ æ­¤ç·¨è™Ÿå·²å­˜åœ¨ï¼š#' + number + ' (' + savedCustomers[number].name + ')');
       return;
     }

     // â­ æ–°å¢ï¼šæª¢æŸ¥ User ID æ˜¯å¦é‡è¤‡
     var existingUser = Object.entries(savedCustomers).find(function(item) {
       return item[1].userId === userId;
     });
     if (existingUser) {
       showResult('error', 'âŒ æ­¤ User ID å·²å­˜åœ¨ï¼š#' + existingUser[0] + ' (' + existingUser[1].name + ')');
       return;
     }

      try {
        var res = await fetch('/api/customer-numbers', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ number: number, name: name, userId: userId })
        });
        var data = await res.json();
        if (data.success) {
          showResult('success', 'âœ… å·²å„²å­˜å®¢æˆ¶ç·¨è™Ÿ');
          document.getElementById('newCustomerNumber').value = '';
          document.getElementById('newCustomerName').value = '';
          document.getElementById('newCustomerUserId').value = '';
          await loadCustomerNumbers();
          displaySavedCustomers();
        } else {
          showResult('error', 'âŒ å„²å­˜å¤±æ•—: ' + (data.error || 'æœªçŸ¥éŒ¯èª¤'));
        }
      } catch (error) {
        showResult('error', 'âŒ é€£ç·šå¤±æ•—: ' + error.message);
      }
    }

   function displaySavedCustomers() {
      var wrap = document.getElementById('savedCustomers');
      
      // âœ… æŒ‰ç·¨è™Ÿæ’åºï¼ˆ001, 002, 003...ï¼‰
      var entries = Object.entries(savedCustomers).sort(function(a, b) {
        return parseInt(a[0]) - parseInt(b[0]);
      });
      
      if (entries.length === 0) {
        wrap.innerHTML = '<p style="color:#999;">å°šç„¡è³‡æ–™</p>';
        return;
      }
      
      wrap.innerHTML = entries.map(function(item) {
        var no = item[0];
        var c = item[1];
        return '<div class="user-item" style="justify-content:space-between;">' +
          '<div class="user-info" onclick="fillCustomer(\'' + c.userId + '\',\'' + c.name + '\')">' +
          '<strong>#' + no + ' - ' + c.name + '</strong>' +
          '<small>User ID: ' + c.userId + '</small>' +
          '</div>' +
          '<button class="btn btn-small btn-danger" onclick="removeSavedCustomer(\'' + no + '\')">åˆªé™¤</button>' +
          '</div>';
      }).join('');
    }

    async function removeSavedCustomer(number) {
      if (!confirm('åˆªé™¤ç·¨è™Ÿ #' + number + ' ?')) return;
      try {
        var res = await fetch('/api/customer-numbers/' + encodeURIComponent(number), { method: 'DELETE' });
        var data = await res.json();
        if (data.success) {
          await loadCustomerNumbers();
          displaySavedCustomers();
        } else {
          alert('åˆªé™¤å¤±æ•—: ' + (data.error || 'æœªçŸ¥éŒ¯èª¤'));
        }
      } catch (error) {
        alert('é€£ç·šå¤±æ•—: ' + error.message);
      }
    }

    function fillCustomer(userId, name) {
      document.getElementById('userId').value = userId;
      document.getElementById('userName').value = name;
      switchTab({ currentTarget: document.querySelector('.tab') }, 'payment');
    }

    async function loadTemplates() {
      try {
        var res = await fetch('/api/templates');
        var data = await res.json();
        if (data.success) {
          savedTemplates = data.templates || [];
        }
      } catch (error) {
        console.error('è¼‰å…¥æ¨¡æ¿å¤±æ•—:', error);
      }
    }

    function loadCustomTemplates() {
      var container = document.getElementById('customTemplates');
      if (!container) return;
      var html = '';
      savedTemplates.forEach(function(template, index) {
        var preview = template.length > 30 ? template.substring(0, 30) + '...' : template;
        html += '<button type="button" class="template-btn" onclick="selectTemplate(event, ' + index + ')">' + preview + '</button>';
      });
      container.innerHTML = html;
    }

    function selectTemplate(evt, index) {
      var el = document.getElementById('customMessage');
      if (el) el.value = savedTemplates[index] || '';
      document.querySelectorAll('.template-btn').forEach(function(btn) { btn.classList.remove('active'); });
      if (evt && evt.currentTarget) evt.currentTarget.classList.add('active');
    }

    async function saveTemplate() {
      var content = document.getElementById('newTemplateContent').value.trim();
      if (!content) {
        alert('è«‹è¼¸å…¥æ¨¡æ¿å…§å®¹');
        return;
      }

      try {
        var res = await fetch('/api/templates', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ content: content })
        });
        var data = await res.json();
        if (data.success) {
          showResult('success', 'âœ… å·²æ–°å¢æ¨¡æ¿');
          document.getElementById('newTemplateContent').value = '';
          await loadTemplates();
          displayTemplates();
          loadCustomTemplates();
        } else {
          showResult('error', 'âŒ å„²å­˜å¤±æ•—: ' + (data.error || 'æœªçŸ¥éŒ¯èª¤'));
        }
      } catch (error) {
        showResult('error', 'âŒ é€£ç·šå¤±æ•—: ' + error.message);
      }
    }

    function displayTemplates() {
      var wrap = document.getElementById('templateList');
      if (savedTemplates.length === 0) {
        wrap.innerHTML = '<p style="color:#999;">å°šç„¡æ¨¡æ¿</p>';
        return;
      }
      wrap.innerHTML = savedTemplates.map(function(t, i) {
        return '<div class="template-item">' +
          '<div style="white-space:pre-wrap;">' + t + '</div>' +
          '<div style="margin-top:10px; display:flex; gap:10px;">' +
          '<button class="btn btn-small btn-secondary" onclick="editTemplate(' + i + ')">ç·¨è¼¯</button>' +
          '<button class="btn btn-small btn-danger" onclick="deleteTemplate(' + i + ')">åˆªé™¤</button>' +
          '</div>' +
          '</div>';
      }).join('');
    }

    async function editTemplate(index) {
      var newContent = prompt('ä¿®æ”¹æ¨¡æ¿å…§å®¹ï¼š', savedTemplates[index] || '');
      if (newContent === null) return;

      try {
        var res = await fetch('/api/templates/' + index, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ content: newContent })
        });
        var data = await res.json();
        if (data.success) {
          await loadTemplates();
          displayTemplates();
          loadCustomTemplates();
        } else {
          alert('æ›´æ–°å¤±æ•—: ' + (data.error || 'æœªçŸ¥éŒ¯èª¤'));
        }
      } catch (error) {
        alert('é€£ç·šå¤±æ•—: ' + error.message);
      }
    }

    async function deleteTemplate(index) {
      if (!confirm('ç¢ºå®šåˆªé™¤æ­¤æ¨¡æ¿ï¼Ÿ')) return;

      try {
        var res = await fetch('/api/templates/' + index, { method: 'DELETE' });
        var data = await res.json();
        if (data.success) {
          await loadTemplates();
          displayTemplates();
          loadCustomTemplates();
        } else {
          alert('åˆªé™¤å¤±æ•—: ' + (data.error || 'æœªçŸ¥éŒ¯èª¤'));
        }
      } catch (error) {
        alert('é€£ç·šå¤±æ•—: ' + error.message);
      }
    }

    function quickSearchCustomer() {
      var query = document.getElementById('quickSearch').value.trim();
      if (!query) {
        alert('è«‹è¼¸å…¥ç·¨è™Ÿæˆ–å§“å');
        return;
      }

      if (savedCustomers[query]) {
        var c = savedCustomers[query];
        document.getElementById('userId').value = c.userId || '';
        document.getElementById('userName').value = c.name || '';
        showCustomerCard(query, c.name, c.userId);
        return;
      }

      var found = Object.entries(savedCustomers).find(function(item) {
        return (item[1].name || '').includes(query);
      });
      if (found) {
        var number = found[0];
        var c = found[1];
        document.getElementById('userId').value = c.userId || '';
        document.getElementById('userName').value = c.name || '';
        showCustomerCard(number, c.name, c.userId);
        return;
      }

      alert('æ‰¾ä¸åˆ°æ­¤å®¢æˆ¶');
    }

    function showCustomerCard(number, name, userId) {
      document.getElementById('cardNumber').textContent = number;
      document.getElementById('cardName').textContent = name;
      document.getElementById('cardUserId').textContent = userId;
      document.getElementById('customerCard').style.display = 'block';
    }

    document.getElementById('paymentForm').addEventListener('submit', async function(e) {
      e.preventDefault();
      var userId = document.getElementById('userId').value.trim();
      var userName = document.getElementById('userName').value.trim();
      var amount = parseInt(document.getElementById('amount').value, 10);
      var paymentType = document.querySelector('input[name="paymentType"]:checked').value;
      var customMessage = document.getElementById('customMessage').value.trim().replace('{amount}', (amount || 0).toLocaleString());

      if (!userId || !userName || !amount) {
        showResult('error', 'è«‹å¡«å¯«æ‰€æœ‰å¿…å¡«æ¬„ä½!');
        return;
      }

      document.getElementById('submitBtn').disabled = true;
      document.getElementById('loading').style.display = 'block';
      document.getElementById('result').style.display = 'none';

      try {
        var res = await fetch('/send-payment', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ userId: userId, userName: userName, amount: amount, paymentType: paymentType, customMessage: customMessage })
        });
        var data = {};
        try {
          data = await res.json();
        } catch {
          data = { success: false, error: 'å¾Œç«¯æœªå›å‚³ JSON' };
        }

        if (data.success) {
          var msg = 'âœ… ä»˜æ¬¾é€£çµå·²ç™¼é€çµ¦ ' + userName + '!<br><br>é‡‘é¡: NT$ ' + amount.toLocaleString() + '<br>';
          if (paymentType === 'both') msg += 'ä»˜æ¬¾æ–¹å¼: ä¿¡ç”¨å¡ + LINE Pay<br>';
          else if (paymentType === 'ecpay') msg += 'ä»˜æ¬¾æ–¹å¼: ç¶ ç•Œæ”¯ä»˜<br>';
          else msg += 'ä»˜æ¬¾æ–¹å¼: LINE Pay<br>';
          if (customMessage) msg += '<br>é™„åŠ è¨Šæ¯: ' + customMessage;
          showResult('success', msg);
          document.getElementById('paymentForm').reset();
          document.getElementById('customerCard').style.display = 'none';
        } else {
          showResult('error', 'âŒ ç™¼é€å¤±æ•—: ' + (data.error || 'ä¼ºæœå™¨ç„¡å›æ‡‰'));
        }
      } catch (err) {
        showResult('error', 'âŒ éŒ¯èª¤: ' + err.message);
      } finally {
        document.getElementById('submitBtn').disabled = false;
        document.getElementById('loading').style.display = 'none';
      }
    });
   async function loadOrders() {
      var orderListDiv = document.getElementById('orderList');
      orderListDiv.innerHTML = '<p style="text-align:center; color:#999;">è¼‰å…¥ä¸­...</p>';
      try {
        var res = await fetch('/api/orders');
        var data = await res.json();
        if (!data.success) throw new Error(data.error || 'è¼‰å…¥å¤±æ•—');
        allOrders = Array.isArray(data.orders) ? data.orders : [];
        displayOrderStats(data.statistics || { total: 0, pending: 0, paid: 0, expired: 0, needReminder: 0 });
        displayOrders(allOrders);
      } catch (err) {
        allOrders = [];
        displayOrderStats({ total: 0, pending: 0, paid: 0, expired: 0, needReminder: 0 });
        orderListDiv.innerHTML = '<p style="color:#dc3545; text-align:center;">è¼‰å…¥å¤±æ•—ï¼š' + err.message + '</p>';
      }
    }

    function displayOrderStats(stats) {
      var s = stats || {};
      var el = document.getElementById('orderStats');
      el.innerHTML = 
        '<div style="background:#f0f4ff; padding:15px; border-radius:10px; text-align:center;">' +
        '<div style="font-size:24px; font-weight:bold; color:#667eea;">' + (s.total || 0) + '</div>' +
        '<div style="font-size:14px; color:#666;">ç¸½è¨‚å–®æ•¸</div>' +
        '</div>' +
        '<div style="background:#fff3cd; padding:15px; border-radius:10px; text-align:center;">' +
        '<div style="font-size:24px; font-weight:bold; color:#ffc107;">' + (s.pending || 0) + '</div>' +
        '<div style="font-size:14px; color:#666;">å¾…ä»˜æ¬¾</div>' +
        '</div>' +
        '<div style="background:#d4edda; padding:15px; border-radius:10px; text-align:center;">' +
        '<div style="font-size:24px; font-weight:bold; color:#28a745;">' + (s.paid || 0) + '</div>' +
        '<div style="font-size:14px; color:#666;">å·²ä»˜æ¬¾</div>' +
        '</div>' +
        '<div style="background:#f8d7da; padding:15px; border-radius:10px; text-align:center;">' +
        '<div style="font-size:24px; font-weight:bold; color:#dc3545;">' + (s.expired || 0) + '</div>' +
        '<div style="font-size:14px; color:#666;">å·²éæœŸ</div>' +
        '</div>' +
        '<div style="background:#e7f0ff; padding:15px; border-radius:10px; text-align:center;">' +
        '<div style="font-size:24px; font-weight:bold; color:#0066cc;">' + (s.needReminder || 0) + '</div>' +
        '<div style="font-size:14px; color:#666;">éœ€æé†’</div>' +
        '</div>';
    }

    function displayOrders(orders) {
      var wrap = document.getElementById('orderList');
      if (!orders || orders.length === 0) {
        wrap.innerHTML = '<p style="text-align:center; color:#999;">å°šç„¡è¨‚å–®è¨˜éŒ„</p>';
        return;
      }
      var html = '';
      orders.forEach(function(order) {
        var createdDate = order.createdAt ? new Date(order.createdAt).toLocaleString('zh-TW') : '-';
        var expiryDate = order.expiryTime ? new Date(order.expiryTime).toLocaleString('zh-TW') : '-';
        var statusBadge = '';
        var actionButtons = '';

        if (order.status === 'paid') {
          statusBadge = '<span style="background:#28a745; color:#fff; padding:5px 10px; border-radius:5px; font-size:12px;">âœ… å·²ä»˜æ¬¾</span>';
        } else if (order.isExpired) {
          statusBadge = '<span style="background:#dc3545; color:#fff; padding:5px 10px; border-radius:5px; font-size:12px;">âŒ å·²éæœŸ</span>';
          actionButtons = '<button class="btn btn-small btn-secondary" onclick="renewOrder(\'' + (order.orderId || '') + '\')">ğŸ”„ çºŒç´„é‡ç™¼</button>';
        } else {
          statusBadge = '<span style="background:#ffc107; color:#fff; padding:5px 10px; border-radius:5px; font-size:12px;">â° å‰©é¤˜ ' + (order.remainingHours || '-') + ' å°æ™‚</span>';
          actionButtons = 
            '<button class="btn btn-small btn-secondary" onclick="copyPaymentLink(\'' + (order.orderId || '') + '\')">ğŸ“‹ è¤‡è£½é€£çµ</button>' +
            '<button class="btn btn-small btn-secondary" onclick="sendSingleReminder(\'' + (order.orderId || '') + '\')">â° æé†’</button>';
        }
        actionButtons += ' <button class="btn btn-small btn-danger" onclick="deleteOrder(\'' + (order.orderId || '') + '\')">åˆªé™¤</button>';

        html += 
          '<div class="user-item" style="display:block;">' +
          '<div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">' +
          '<div>' +
          '<strong style="font-size:16px; cursor:pointer; color:#667eea;" onclick="showCustomerHistory(\'' + (order.userId || '') + '\', \'' + (order.userName || '') + '\')" title="é»æ“ŠæŸ¥çœ‹ä»˜æ¬¾æ­·å²">' + (order.userName || '-') + '</strong>' +
          statusBadge +
          '</div>' +
          '<div style="font-size:18px; font-weight:bold; color:#667eea;">NT$ ' + ((order.amount || 0).toLocaleString()) + '</div>' +
          '</div>' +
          '<div style="font-size:13px; color:#666; margin-bottom:10px;">' +
          '<div>è¨‚å–®ç·¨è™Ÿ: ' + (order.orderId || '-') + '</div>' +
          '<div>å»ºç«‹æ™‚é–“: ' + createdDate + '</div>' +
          '<div>éæœŸæ™‚é–“: ' + expiryDate + '</div>' +
          (order.retryCount > 0 ? '<div>é‡è©¦æ¬¡æ•¸: ' + order.retryCount + '</div>' : '') +
          (order.paymentMethod ? '<div>ä»˜æ¬¾æ–¹å¼: <span style="color:#28a745; font-weight:bold;">' + order.paymentMethod + '</span></div>' : '') +
          '</div>' +
          '<div style="display:flex; gap:10px; flex-wrap:wrap;">' +
          actionButtons +
          '</div>' +
          '</div>';
      });
      wrap.innerHTML = html;
    }

    function searchOrders() {
      var q = (document.getElementById('orderSearchInput').value || '').toLowerCase().trim();
      if (!q) {
        filterOrders();
        return;
      }
      var filtered = (allOrders || []).filter(function(o) {
        return (o.orderId || '').toLowerCase().includes(q) || (o.userName || '').toLowerCase().includes(q);
      });
      displayOrders(filtered);
      if (filtered.length === 0) {
        document.getElementById('orderList').innerHTML = '<p style="text-align:center; color:#999;">æ‰¾ä¸åˆ°ç¬¦åˆçš„è¨‚å–®</p>';
      }
    }

    function filterOrders() {
      var status = document.getElementById('orderStatusFilter').value;
      if (!status) {
        displayOrders(allOrders);
        return;
      }
      var filtered = (allOrders || []).filter(function(o) {
        if (status === 'expired') return !!o.isExpired;
        return (o.status || '') === status;
      });
      displayOrders(filtered);
    }

    async function sendReminders() {
      try {
        var r = await fetch('/api/orders/send-reminders', { method: 'POST' });
        var d = await r.json();
        if (d.success) {
          showResult('success', d.message || ('âœ… å·²ç™¼é€æé†’ï¼š' + (d.sent || 0) + ' ç­†'));
          loadOrders();
        } else {
          showResult('error', 'âŒ ç™¼é€å¤±æ•—ï¼š' + (d.error || 'æœªçŸ¥éŒ¯èª¤'));
        }
      } catch (e) {
        showResult('error', 'âŒ ç„¡æ³•é€£ç·šæé†’ APIï¼š' + e.message);
      }
    }

    async function cleanExpired() {
      try {
        var r = await fetch('/api/orders/clean-expired', { method: 'POST' });
        var d = await r.json();
        if (d.success) {
          showResult('success', d.message || ('ğŸ§¹ å·²æ¸…ç† ' + (d.cleaned || 0) + ' ç­†éæœŸè¨‚å–®'));
          loadOrders();
        } else {
          showResult('error', 'âŒ æ¸…ç†å¤±æ•—ï¼š' + (d.error || 'æœªçŸ¥éŒ¯èª¤'));
        }
      } catch (e) {
        showResult('error', 'âŒ ç„¡æ³•é€£ç·šæ¸…ç† APIï¼š' + e.message);
      }
    }

    async function renewOrder(orderId) {
      if (!orderId) return alert('æ‰¾ä¸åˆ°è¨‚å–®ç·¨è™Ÿ');
      try {
        var r = await fetch('/api/order/' + orderId + '/renew', { method: 'POST' });
        var d = await r.json();
        if (d.success) {
          showResult('success', 'ğŸ”„ å·²çºŒç´„ä¸¦é‡æ–°ç™¼é€ä»˜æ¬¾é€£çµ');
          loadOrders();
        } else {
          showResult('error', 'âŒ çºŒç´„å¤±æ•—ï¼š' + (d.error || 'æœªçŸ¥éŒ¯èª¤'));
        }
      } catch (e) {
        showResult('error', 'âŒ ç„¡æ³•é€£ç·šçºŒç´„ APIï¼š' + e.message);
      }
    }

    function copyPaymentLink(orderId) {
      var url = window.location.origin + '/payment/linepay/pay/' + orderId;
      navigator.clipboard.writeText(url).then(
        function() { showResult('success', 'ğŸ“‹ å·²è¤‡è£½ä»˜æ¬¾é€£çµ'); },
        function() { showResult('error', 'âŒ è¤‡è£½å¤±æ•—ï¼Œè«‹æ‰‹å‹•è¤‡è£½ï¼š<br>' + url); }
      );
    }

    function sendSingleReminder(orderId) {
      return renewOrder(orderId);
    }

    async function deleteOrder(orderId) {
      if (!confirm('ç¢ºå®šè¦åˆªé™¤è¨‚å–®ï¼š' + orderId + ' å—ï¼Ÿ')) return;
      try {
        var r = await fetch('/api/order/' + orderId, { method: 'DELETE' });
        var d = await r.json();
        if (d.success) {
          showResult('success', 'ğŸ—‘ï¸ è¨‚å–®å·²åˆªé™¤');
          loadOrders();
        } else {
          showResult('error', 'âŒ åˆªé™¤å¤±æ•—ï¼š' + (d.error || 'æœªçŸ¥éŒ¯èª¤'));
        }
      } catch (e) {
        showResult('error', 'âŒ ç„¡æ³•é€£ç·šåˆªé™¤ APIï¼š' + e.message);
      }
    }

    async function showCustomerHistory(userId, userName) {
      var modal = document.getElementById('customerHistoryModal');
      var content = document.getElementById('customerHistoryContent');
      modal.style.display = 'block';
      content.innerHTML = '<p style="text-align:center; color:#999;">è¼‰å…¥ä¸­...</p>';

      try {
        var hist = (allOrders || []).filter(function(o) { return o.userId === userId; });
        if (!hist || hist.length === 0) {
          content.innerHTML = '<p style="text-align:center; color:#999;">å®¢æˆ¶ ' + userName + ' å°šç„¡è¨‚å–®è¨˜éŒ„</p>';
          return;
        }
        var html = '<div class="customer-card"><h4>' + userName + '</h4><p>User IDï¼š' + userId + '</p></div>';
        hist.forEach(function(o) {
          var created = o.createdAt ? new Date(o.createdAt).toLocaleString('zh-TW') : '-';
          var status = o.status || (o.isExpired ? 'expired' : 'pending');
          html += 
            '<div class="template-item">' +
            '<div><strong>è¨‚å–®ç·¨è™Ÿï¼š</strong>' + (o.orderId || '-') + '</div>' +
            '<div><strong>é‡‘é¡ï¼š</strong>NT$ ' + ((o.amount || 0).toLocaleString()) + '</div>' +
            '<div><strong>ç‹€æ…‹ï¼š</strong>' + status + '</div>' +
            '<div><strong>å»ºç«‹æ™‚é–“ï¼š</strong>' + created + '</div>' +
            '</div>';
        });
        content.innerHTML = html;
      } catch (e) {
        content.innerHTML = '<p style="color:#dc3545;">è¼‰å…¥å¤±æ•—ï¼š' + e.message + '</p>';
      }
    }

    function closeCustomerHistory() {
      document.getElementById('customerHistoryModal').style.display = 'none';
    }

    async function loadUsers() {
      var wrap = document.getElementById('userList');
      wrap.innerHTML = '<p style="text-align:center; color:#999;">è¼‰å…¥ä¸­...</p>';
      
      // âœ… ç›´æ¥å¾ savedCustomers è®€å–ä¸¦æ’åº
      var entries = Object.entries(savedCustomers).sort(function(a, b) {
        return parseInt(a[0]) - parseInt(b[0]);
      });
      
      if (entries.length === 0) {
        wrap.innerHTML = '<p style="text-align:center; color:#999;">å°šç„¡å®¢æˆ¶è³‡æ–™</p>';
        return;
      }
      
      wrap.innerHTML = entries.map(function(item) {
        var no = item[0];
        var c = item[1];
        return '<div class="user-item">' +
          '<div class="user-info" onclick="fillCustomer(\'' + c.userId + '\',\'' + c.name + '\')">' +
          '<strong>#' + no + ' - ' + c.name + '</strong>' +
          '<small>User ID: ' + c.userId + '</small>' +
          '</div>' +
          '<button class="btn btn-small btn-secondary" onclick="fillCustomer(\'' + c.userId + '\',\'' + c.name + '\')">å¸¶å…¥</button>' +
          '</div>';
      }).join('');
    }

    function showResult(type, html) {
      var el = document.getElementById('result');
      el.className = 'result ' + (type === 'success' ? 'success' : 'error');
      el.innerHTML = html;
      el.style.display = 'block';
      el.scrollIntoView({ behavior: 'smooth', block: 'center' });
    }

    document.addEventListener('DOMContentLoaded', function() {
      initLoad();
    });
    // ========================================
    // ğŸ§º å–ä»¶è¿½è¹¤åŠŸèƒ½
    // ========================================

    function searchForPickup() {
      var num = document.getElementById('pickupSearch').value.trim();
      if (!num) return alert('è«‹è¼¸å…¥ç·¨è™Ÿ');
      
      if (savedCustomers[num]) {
        var c = savedCustomers[num];
        document.getElementById('pickupNumber').value = num;
        document.getElementById('pickupName').value = c.name;
        document.getElementById('pickupUserId').value = c.userId;
        document.getElementById('pickupCardNumber').textContent = num;
        document.getElementById('pickupCardName').textContent = c.name;
        document.getElementById('pickupCardUserId').textContent = c.userId;
        document.getElementById('pickupCustomerCard').style.display = 'block';
      } else {
        alert('æ‰¾ä¸åˆ°æ­¤å®¢æˆ¶ç·¨è™Ÿ');
      }
    }

    async function startPickup() {
      var num = document.getElementById('pickupNumber').value.trim();
      var name = document.getElementById('pickupName').value.trim();
      var userId = document.getElementById('pickupUserId').value.trim();
      
      if (!num || !name || !userId) return alert('è«‹å¡«å¯«å®Œæ•´');
      
      try {
        var res = await fetch('/api/pickup/add', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ customerNumber: num, customerName: name, userId: userId })
        });
        var data = await res.json();
        
        if (data.success) {
          showResult('success', 'âœ… å·²é–‹å§‹è¿½è¹¤ï¼7å¤©å¾Œ11é»è‡ªå‹•æé†’');
          document.getElementById('pickupNumber').value = '';
          document.getElementById('pickupName').value = '';
          document.getElementById('pickupUserId').value = '';
          document.getElementById('pickupCustomerCard').style.display = 'none';
          loadPickups();
        } else {
          showResult('error', 'âŒ ' + data.message);
        }
      } catch (e) {
        showResult('error', 'âŒ é€£ç·šå¤±æ•—');
      }
    }

    async function loadPickups() {
      try {
        var res = await fetch('/api/pickup/orders');
        var data = await res.json();
        
        if (data.success) {
          allPickupOrders = data.orders || [];
          var html = '';
          if (allPickupOrders.length === 0) {
            html = '<p style="color:#999; text-align:center;">å°šç„¡è¿½è¹¤è¨‚å–®</p>';
          } else {
            allPickupOrders.forEach(function(o) {
              var status = o.pickedUp ? 'âœ… å·²ç°½æ”¶' : 'â° è¿½è¹¤ä¸­ (' + o.daysPassed + 'å¤©)';
              html += '<div class="user-item" style="display:block; opacity:' + (o.pickedUp ? '0.6' : '1') + ';">' +
                '<div style="margin-bottom:10px;"><strong style="font-size:16px;">#' + o.customerNumber + ' - ' + o.customerName + '</strong> <span style="background:' + (o.pickedUp ? '#28a745' : '#ffc107') + '; color:#fff; padding:5px 10px; border-radius:5px; font-size:12px;">' + status + '</span></div>' +
                '<div style="font-size:13px; color:#666; margin-bottom:10px;">' +
                'ä¸‹æ¬¡æé†’: ' + new Date(o.nextReminderAt).toLocaleString('zh-TW') + '<br>' +
                'å·²æé†’: ' + o.reminderCount + ' æ¬¡</div>' +
                '<div style="display:flex; gap:5px; flex-wrap:wrap;">';
              
              if (!o.pickedUp) {
                html += '<button class="btn btn-small btn-secondary" onclick="remindNow(\'' + o.customerNumber + '\')">ğŸ”” ç«‹å³æé†’</button>' +
                        '<button class="btn btn-small" style="background:#ff9800;color:#fff;" onclick="delay14(\'' + o.customerNumber + '\')">â° å»¶14å¤©</button>' +
                        '<button class="btn btn-small btn-secondary" onclick="markDone(\'' + o.customerNumber + '\')">âœ… ç°½æ”¶</button>';
              }
              html += '<button class="btn btn-small btn-danger" onclick="deletePick(\'' + o.customerNumber + '\')">åˆªé™¤</button>' +
                      '</div></div>';
            });
          }
          document.getElementById('pickupList').innerHTML = html;
        }
      } catch (e) {
        showResult('error', 'âŒ è¼‰å…¥å¤±æ•—');
      }
    }

    async function remindNow(num) {
      try {
        var res = await fetch('/api/pickup/remind/' + num, { method: 'POST' });
        var data = await res.json();
        if (data.success) {
          showResult('success', 'âœ… æé†’å·²ç™¼é€');
          loadPickups();
        } else {
          showResult('error', 'âŒ ' + data.message);
        }
      } catch (e) {
        showResult('error', 'âŒ ç™¼é€å¤±æ•—');
      }
    }

    async function delay14(num) {
      if (!confirm('å»¶é²14å¤©å¾Œæé†’ï¼Ÿ')) return;
      try {
        var res = await fetch('/api/pickup/delay', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ customerNumber: num })
        });
        var data = await res.json();
        if (data.success) {
          showResult('success', 'âœ… å·²å»¶é²14å¤©');
          loadPickups();
        } else {
          showResult('error', 'âŒ ' + data.message);
        }
      } catch (e) {
        showResult('error', 'âŒ æ“ä½œå¤±æ•—');
      }
    }

    async function markDone(num) {
      if (!confirm('æ¨™è¨˜ç‚ºå·²ç°½æ”¶ï¼Ÿ')) return;
      try {
        var res = await fetch('/api/pickup/complete', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ customerNumber: num })
        });
        var data = await res.json();
        if (data.success) {
          showResult('success', 'âœ… å·²ç°½æ”¶');
          loadPickups();
        } else {
          showResult('error', 'âŒ ' + data.message);
        }
      } catch (e) {
        showResult('error', 'âŒ æ“ä½œå¤±æ•—');
      }
    }

    async function deletePick(num) {
      if (!confirm('åˆªé™¤æ­¤è¿½è¹¤ï¼Ÿ')) return;
      try {
        var res = await fetch('/api/pickup/order/' + num, { method: 'DELETE' });
        var data = await res.json();
        if (data.success) {
          showResult('success', 'âœ… å·²åˆªé™¤');
          loadPickups();
        } else {
          showResult('error', 'âŒ ' + data.message);
        }
      } catch (e) {
        showResult('error', 'âŒ åˆªé™¤å¤±æ•—');
      }
    }

    async function editTemplate() {
      try {
        var res = await fetch('/api/pickup/template');
        var data = await res.json();
        if (data.success) {
          document.getElementById('templateText').value = data.template;
          document.getElementById('templateModal').style.display = 'block';
        }
      } catch (e) {
        showResult('error', 'âŒ è¼‰å…¥å¤±æ•—');
      }
    }

    function closeTemplateModal() {
      document.getElementById('templateModal').style.display = 'none';
    }

    async function saveTemplatePickup() {
      var text = document.getElementById('templateText').value.trim();
      if (!text) return alert('è«‹è¼¸å…¥æ¨¡æ¿');
      
      try {
        var res = await fetch('/api/pickup/template', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ template: text })
        });
        var data = await res.json();
        if (data.success) {
          showResult('success', 'âœ… æ¨¡æ¿å·²å„²å­˜');
          closeTemplateModal();
        } else {
          showResult('error', 'âŒ å„²å­˜å¤±æ•—');
        }
      } catch (e) {
        showResult('error', 'âŒ é€£ç·šå¤±æ•—');
      }
    }
    // ========================================
    // ğŸ“¢ ç´”æ–‡å­—é€šçŸ¥åŠŸèƒ½
    // ========================================

    var notifyTemplatesData = [];

    // è¼‰å…¥é€šçŸ¥æ¨¡æ¿
    async function loadNotifyTemplates() {
      try {
        var res = await fetch('/api/notify-templates');
        var data = await res.json();
        if (data.success) {
          notifyTemplatesData = data.templates || [];
          displayNotifyTemplates();
        }
      } catch (error) {
        console.error('è¼‰å…¥é€šçŸ¥æ¨¡æ¿å¤±æ•—:', error);
      }
    }

    // é¡¯ç¤ºé€šçŸ¥æ¨¡æ¿æŒ‰éˆ•
    function displayNotifyTemplates() {
      var container = document.getElementById('notifyTemplates');
      if (!container) return;
      
      if (notifyTemplatesData.length === 0) {
        container.innerHTML = '<p style="color:#999; font-size:13px;">å°šç„¡æ¨¡æ¿ï¼Œç™¼é€å¾Œå¯å„²å­˜ç‚ºæ¨¡æ¿</p>';
        return;
      }
      
      var html = '';
      notifyTemplatesData.forEach(function(template, index) {
        var preview = template.length > 25 ? template.substring(0, 25) + '...' : template;
        html += '<button type="button" class="template-btn" onclick="selectNotifyTemplate(' + index + ')">' + preview + '</button>';
      });
      container.innerHTML = html;
    }

    // é¸æ“‡é€šçŸ¥æ¨¡æ¿
    function selectNotifyTemplate(index) {
      var el = document.getElementById('notifyMessage');
      if (el) el.value = notifyTemplatesData[index] || '';
      document.querySelectorAll('#notifyTemplates .template-btn').forEach(function(btn) {
        btn.classList.remove('active');
      });
      document.querySelectorAll('#notifyTemplates .template-btn')[index].classList.add('active');
    }

    // å„²å­˜é€šçŸ¥æ¨¡æ¿
    async function saveNotifyTemplate() {
      var content = document.getElementById('notifyMessage').value.trim();
      if (!content) {
        alert('è«‹å…ˆè¼¸å…¥è¨Šæ¯å…§å®¹');
        return;
      }

      try {
        var res = await fetch('/api/notify-templates', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ content: content })
        });
        var data = await res.json();
        if (data.success) {
          showResult('success', 'âœ… å·²å„²å­˜ç‚ºé€šçŸ¥æ¨¡æ¿');
          await loadNotifyTemplates();
        } else {
          showResult('error', 'âŒ å„²å­˜å¤±æ•—: ' + (data.error || 'æœªçŸ¥éŒ¯èª¤'));
        }
      } catch (error) {
        showResult('error', 'âŒ é€£ç·šå¤±æ•—: ' + error.message);
      }
    }

    // ç™¼é€ç´”æ–‡å­—é€šçŸ¥
    document.getElementById('notificationForm').addEventListener('submit', async function(e) {
      e.preventDefault();
      
      var userId = document.getElementById('notifyUserId').value.trim();
      var userName = document.getElementById('notifyUserName').value.trim();
      var message = document.getElementById('notifyMessage').value.trim();

      if (!userId || !userName || !message) {
        showResult('error', 'âŒ è«‹å¡«å¯«æ‰€æœ‰æ¬„ä½ï¼');
        return;
      }

      try {
        var res = await fetch('/send-notification', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            userId: userId,
            userName: userName,
            message: message
          })
        });

        var data = await res.json();

        if (data.success) {
          showResult('success', 'âœ… é€šçŸ¥å·²æˆåŠŸç™¼é€çµ¦ ' + userName + 'ï¼<br><br>è¨Šæ¯å…§å®¹ï¼š<br>' + message);
          document.getElementById('notificationForm').reset();
        } else {
          showResult('error', 'âŒ ç™¼é€å¤±æ•—: ' + (data.error || 'ä¼ºæœå™¨ç„¡å›æ‡‰'));
        }
      } catch (err) {
        showResult('error', 'âŒ éŒ¯èª¤: ' + err.message);
      }
    });

    // é é¢è¼‰å…¥æ™‚åˆå§‹åŒ–é€šçŸ¥æ¨¡æ¿
    document.addEventListener('DOMContentLoaded', function() {
      initLoad();
      loadNotifyTemplates(); // â­ æ–°å¢
    });
    
  </script>
   <script src="/payment.js"></script>
</body> 
</body>
</html>
